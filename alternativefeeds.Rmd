---
title: "Alternative aquafeeds"
author: "Richard Cottrell"
date: "11 May 2018"
output: word_document
---

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(devtools)
library(readr)
library(broom)
library(stringr)
library(ggsci)
library(ggforce)
library(png)
library(grid) 
library(taxize)

```

#IMPORT AND TIDY AQUACULTURE DATA

```{r cars}

aqua.raw<-read.csv("aquaculture-prod-raw.csv", header=T)
summary(aqua.raw)
names(aqua.raw)[names(aqua.raw)=="Country..Country."]<-"Country"
names(aqua.raw)[names(aqua.raw)=="Species..ASFIS.species."]<-"Species"
names(aqua.raw)[names(aqua.raw)=="Aquaculture.area..FAO.major.fishing.area."]<-"Area"
names(aqua.raw)[names(aqua.raw)=="Environment..Environment."]<-"Environment"

aqua.raw2<-aqua.raw %>% gather(Year, Value, -c(Country, Species, Area, Environment, Unit))
head(aqua.raw2)
levels(aqua.raw2$Unit)

aqua.raw2$Year<-gsub("X", "", aqua.raw2$Year)
aqua.raw2$Year<-as.numeric(aqua.raw2$Year)

#Sort the symbols in values out
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information
aqua.raw2$Value[aqua.raw2$Value=="0 0"] <- 0.5
aqua.raw2$Value[aqua.raw2$Value=="-"] <- 0

#exclude unavailable data
aqua.raw2 <- aqua.raw2[aqua.raw2$Value!="...",]
aqua.raw2 <- aqua.raw2[aqua.raw2$Value!="",]

#Use estimates as data
aqua.raw2$Value <- gsub(' F', '', aqua.raw2$Value)
head(aqua.raw2)
aqua.raw2$Value <- as.numeric(aqua.raw2$Value)

prod.aqua<-aqua.raw2
prod.aqua

#Exclude totals and weird country values
levels(prod.aqua$Country)
prod.aqua<- prod.aqua[prod.aqua$Country!="FAO. 2017. Fishery and Aquaculture Statistics. Global aquaculture production 1950-2015 (FishstatJ). In: FAO Fisheries and Aquaculture Department [online]. Rome. Updated 2017. www.fao.org/fishery/statistics/software/fishstatj/en",]
prod.aqua<- prod.aqua[prod.aqua$Country!="Totals",]

write.csv(prod.aqua, "Aquaculture production tidy.csv", row.names = F)




```


#ISOLATE FED SPECIES

```{r}


prod.aqua[grep("River eel", prod.aqua$Species),]
unique(prod.aqua$Species[grep("River eel", prod.aqua$Species)])

Fed_Spp <-c("Grass carp(=White amur)", "Common carp", "Crucian carp", "Wuchang bream", "Black carp", "Silver barb", "Mrigal carp", "Roho labeo", "Catla", "Nile tilapia", "Blue-Nile tilapia, hybrid", "Striped catfish", "Pangas catfish", "Pangas catfishes nei", "Channel catfish", "Africa-bighead catfish, hybrid", "North African catfish", "Amur catfish", "Yellow catfish", "Snakeheads(=Murrels) nei", "Snakehead","Mandarin fish", "Asian swamp eel", "River eels nei", "Pacu", "Pirapatinga", "Cachama", "Atlantic salmon", "Rainbow trout", "Milkfish", "European flounder",  "Lefteye flounders nei" ,  "Righteye flounders nei", "Turbot","Barramundi(=Giant seaperch)", "Atlantic cod" , "European seabass", "Gilthead seabream", "Groupers nei", "Greasy grouper", "Hong Kong grouper","Black grouper","Giant grouper", "Spotted coralgrouper","Areolate grouper", "Orange-spotted grouper", "Brown-marbled grouper", "Malabar grouper",  "Humpback grouper", "Groupers, seabasses nei","Red drum", "Flathead grey mullet" ,"Squaretail mullet"   , "Thinlip grey mullet" , "So-iuy mullet"   ,     "Bluespot mullet"   ,   "Lebranche mullet", "Mullets nei", "Japanese amberjack", "Chinese mitten crab", "Red claw crayfish", "Giant river prawn", "Oriental river prawn", "Whiteleg shrimp", "Giant tiger prawn", "Fleshy prawn")




# Sci_Spp<-c("Ctenopharyngodon idella", "Megalobrama amblycephala", "Cyprinus carpio", "Carassius carassius", "Mylopharyngodon piceus", "Barbonymus gonionotus", "Catla catla", "Labeo rohita", "Cirrhinus cirrhosus", "Oreochromis niloticus", "Oreochromis aureus x O. niloticus", "Ictalurus punctatus", "Ictalurus punctatus x I. furcatus", "Clarias gariepinus x C. macrocephalus", "Clarias gariepinus",  "Silurus asotus" , "Pelteobagrus fulvidraco", "Channa spp",   "Channa argus" , "Siniperca chuatsi", "Monopterus albus", "Piaractus brachypomus", "Colossoma macropomum","Piaractus mesopotamicus", "Anguilla spp", "Salmo salar", "Oncorhynchus mykiss", "Chanos chanos", "Lates calcarifer", "Platichthys flesus", "Bothidae", "Pleuronectidae", "Psetta maxima", "Gadus morhua", "Dicentrarchus labrax", "Sparus aurata", "Epinephelus spp", "Serranidae", "Sciaenops ocellatus", "Mugil cephalus", "Liza vaigiensis", "Liza ramada", "Mugil soiuy", "Valamugil seheli", "Mugil liza", "Seriola quinqueradiata", "Eriocheir sinensis", "Cherax quadricarinatus", "Macrobrachium rosenbergii", "Macrobrachium nipponense", "Penaeus vannamei", "Penaeus monodon", "Penaeus chinensis")


fed_aqua <-prod.aqua[prod.aqua$Species %in% Fed_Spp,]

write.csv(fed_aqua, "Fed aquaculture tidy.csv", row.names = F)




```

## Plotting changes in production over time of species groups and projections based on IMPACT model projections

```{r}

fed_aqua<-read.csv("Fed aquaculture tidy.csv", header = T)

taxons<-read.csv("CL_FI_SPECIES_GROUPS.csv", header = T)
names(taxons)[names(taxons)=="Name_en"]<-"Species"



fed_aqua <- dplyr::left_join(fed_aqua, taxons, by="Species")
fed_aqua <- fed_aqua[,c(1:7, 15:23)]

# diets<-read.csv("fishmeal diet data.csv", header = T)
# 
# fed_aqua<-dplyr::left_join(fed_aqua, diets, by="Scientific_Name")


#exclude non-fed and amphib/reptile species
# fed_aqua<-fed_aqua[fed_aqua$Major_Group=="CRUSTACEA" | fed_aqua$Major_Group=="PISCES",]



#add IMPACT groups

fed_aqua$Broad_group <-NA
fed_aqua$Broad_group<-as.character(fed_aqua$Broad_group)
fed_aqua$Broad_group[fed_aqua$Species %in% c("Grass carp(=White amur)","Common carp", "Crucian carp", "Wuchang bream", "Black carp", "Silver barb", "Mrigal carp", "Roho labeo", "Catla", "Milkfish")] <- "Carp"
fed_aqua$Broad_group[fed_aqua$Species %in% c("Nile tilapia", "Blue-Nile tilapia, hybrid")] <- "Tilapia"
fed_aqua$Broad_group[fed_aqua$Species %in% c("Striped catfish", "Pangas catfish", "Pangas catfishes nei", "Channel catfish", "Africa-bighead catfish, hybrid", "North African catfish", "Amur catfish", "Yellow catfish")] <- "Catfish"
fed_aqua$Broad_group[fed_aqua$Species %in% c("Snakeheads(=Murrels) nei", "Snakehead","Mandarin fish", "Pacu", "Pirapatinga", "Cachama")] <- "Freshwater spp., other"
fed_aqua$Broad_group[fed_aqua$Species %in% c("Atlantic salmon", "Rainbow trout")] <- "Salmonids"
fed_aqua$Broad_group[fed_aqua$Species %in% c("European flounder",  "Lefteye flounders nei" ,  "Righteye flounders nei", "Turbot", "European seabass", "Gilthead seabream", "Barramundi(=Giant seaperch)")] <- "Major demersal spp."
fed_aqua$Broad_group[fed_aqua$Species %in% c("Atlantic cod", "Groupers nei", "Greasy grouper", "Hong Kong grouper","Black grouper","Giant grouper", "Spotted coralgrouper","Areolate grouper", "Orange-spotted grouper", "Brown-marbled grouper", "Malabar grouper",  "Humpback grouper", "Groupers, seabasses nei","Red drum")] <- "Marine spp., other"
fed_aqua$Broad_group[fed_aqua$Species %in% c("Flathead grey mullet" ,"Squaretail mullet", "Thinlip grey mullet", "So-iuy mullet", "Bluespot mullet",  "Lebranche mullet", "Mullets nei")] <- "Mullet"
fed_aqua$Broad_group[fed_aqua$Species %in% c("Chinese mitten crab", "Red claw crayfish")] <- "Crustaceans, other"
fed_aqua$Broad_group[fed_aqua$Species %in% c("Giant river prawn", "Oriental river prawn", "Whiteleg shrimp", "Giant tiger prawn", "Fleshy prawn")] <- "Shrimp"
fed_aqua$Broad_group[fed_aqua$Species %in% c("Asian swamp eel", "River eels nei")] <- "Eels"
fed_aqua$Broad_group[fed_aqua$Species %in% c("Japanese amberjack")] <- "Pelagic spp., other"

fed_aqua$Broad_group[fed_aqua$Broad_group=="Marine spp., other" & fed_aqua$Environment=="Freshwater"] <- "Freshwater spp., other"
fed_aqua$Broad_group <- as.factor(fed_aqua$Broad_group)


#aggregate by broad category for every year
fed_aqua.global<-aggregate(fed_aqua$Value~fed_aqua$Year+fed_aqua$Broad_group,FUN=sum)

names(fed_aqua.global)[1]<-"Year"
names(fed_aqua.global)[2]<-"Group"
names(fed_aqua.global)[3]<-"Value"

arrange(fed_aqua.global, desc(Year), desc(Value))


#relevel the group factor
levels(fed_aqua.global$Group)
fed_aqua.global$Group<-factor(fed_aqua.global$Group, levels(fed_aqua.global$Group)[c(1,11,12,2,10, 5, 3, 6, 4, 7, 8, 9)])


#Look at the ISCAAP production data
ggplot(data = fed_aqua.global, aes(x=Year, y=(Value), colour=Group))+geom_line()+
  theme_bw()+theme(panel.grid = element_blank())
ggsave("fishsummary.tiff", device = "tiff", dpi=600, width = 12, height = 5)

ordered<-fed_aqua.global[fed_aqua.global$Year==2015,]
ordered<-ordered[order(-ordered$Value),]

cols<-

ggplot(data = fed_aqua.global[,c(1,3,4)], aes(x=Year, y=Value, colour=IMPACT_species))+geom_line()




diets
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
