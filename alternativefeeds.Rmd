---
title: "Alternative aquafeeds"
author: "Richard Cottrell"
date: "11 May 2018"
output: word_document
---
#LIBRARIES
```{r}
#devtools::install_github("dill/beyonce")

library(gridExtra)
library(data.table)
library(purrr)
library(plyr)
library(mgcv)
library(visreg)
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(devtools)
library(readr)
library(broom)
library(stringr)
library(ggsci)
library(ggforce) #geom circle and others
library(ggpubr) #ggarrange
library(png) #load png files
library(grid) 
library(taxize)
library(zoo)
library(colorspace)
library(grDevices)
library(RColorBrewer)
library(scales)
library(viridis)
library(car)
library(sme)
library(beyonce)

```

#IMPORT AND TIDY AQUACULTURE DATA

```{r}

aqua.raw<-read.csv("aquaculture-prod-raw.csv", header=T)
summary(aqua.raw)
names(aqua.raw)[names(aqua.raw)=="Country..Country."]<-"Country"
names(aqua.raw)[names(aqua.raw)=="Species..ASFIS.species."]<-"Species"
names(aqua.raw)[names(aqua.raw)=="Aquaculture.area..FAO.major.fishing.area."]<-"Area"
names(aqua.raw)[names(aqua.raw)=="Environment..Environment."]<-"Environment"

aqua.raw2<-aqua.raw %>% 
  gather(Year, Value, -c(Country, Species, Area, Environment, Unit))
head(aqua.raw2)
levels(aqua.raw2$Unit)

aqua.raw2$Year<-gsub("X", "", aqua.raw2$Year)
aqua.raw2$Year<-as.numeric(aqua.raw2$Year)

#Sort the symbols in values out
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information
aqua.raw2$Value[aqua.raw2$Value=="0 0"] <- 0.5
aqua.raw2$Value[aqua.raw2$Value=="-"] <- 0

#exclude unavailable data
aqua.raw2 <- aqua.raw2[aqua.raw2$Value!="...",]
aqua.raw2 <- aqua.raw2[aqua.raw2$Value!="",]

#Use estimates as data
aqua.raw2$Value <- gsub(' F', '', aqua.raw2$Value)
head(aqua.raw2)
aqua.raw2$Value <- as.numeric(aqua.raw2$Value)

prod.aqua<-aqua.raw2
prod.aqua

#Exclude totals and weird country values
levels(prod.aqua$Country)
prod.aqua<- prod.aqua[prod.aqua$Country!="FAO. 2017. Fishery and Aquaculture Statistics. Global aquaculture production 1950-2015 (FishstatJ). In: FAO Fisheries and Aquaculture Department [online]. Rome. Updated 2017. www.fao.org/fishery/statistics/software/fishstatj/en",]
prod.aqua<- prod.aqua[prod.aqua$Country!="Totals",]

write.csv(prod.aqua, "Aquaculture production tidy.csv", row.names = F)

rm(list = c("aqua.raw", "aqua.raw2"))


```


#ISOLATE FED SPECIES

```{r}

# levels(prod.aqua$Species)
# prod.aqua[grep("Salmonoid", prod.aqua$Species),]
# unique(prod.aqua$Species[grep("salmonid", prod.aqua$Species)]) #, , 

Fed_Spp <-c( #CARPS
"Grass carp(=White amur)", "Common carp", "Crucian carp", "Wuchang bream", "Black carp", "Silver barb", "Mrigal carp", "Roho labeo", "Catla", 

#TILAPIA
"Nile tilapia", "Blue-Nile tilapia, hybrid", "Redbelly tilapia", "Blackchin tilapia", "Mango tilapia", "Mozambique tilapia", "Longfin tilapia", "Redbreast tilapia", "Sabaki tilapia", "Three spotted tilapia", "Blue tilapia", "Tilapias nei",  

#CATFISH
"Striped catfish", "Pangas catfish", "Pangas catfishes nei", "Channel catfish", "Africa-bighead catfish, hybrid", "North African catfish", "Amur catfish", "Yellow catfish", "Torpedo-shaped catfishes nei", "Philippine catfish", "Upsidedown catfishes", "Asian redtail catfish", "Stinging catfish", "South American catfish", "Wels(=Som) catfish", "Hong Kong catfish", "Bagrid catfish", "Black catfishes nei", "Chinese longsnout catfish", "Duckbill catfish", "Naked catfishes","Amazon sailfin catfish" ,"Suckermouth catfish", 

#FW FISHES
"Japanese seabass", "Snakeheads(=Murrels) nei", "Snakehead","Mandarin fish", "Asian swamp eel",   "Pacu", "Pirapatinga", "Cachama", "Largemouth black bass", "Giant gourami", "Tambacu, hybrid", "Snakeskin gourami", "Indonesian snakehead", "Tambatinga, hybrid", "Pond smelt", "Striped snakehead", "Nile perch", 

#SALMONIDS
"Atlantic salmon", "Coho(=Silver) salmon", "Chinook(=Spring=King) salmon", "Pacific salmons nei"," Chinook(=Spring=King) salmon", "Masu(=Cherry) salmon", "Chum(=Keta=Dog) salmon", "Sockeye(=Red) salmon", "Salmonids nei", "Salmonoids nei", "Rainbow trout", "Rainbow trout", "Sea trout", "Brook trout", "Sevan trout", "Trouts nei", "Golden trout", 

#DIADROMOUS
"Milkfish", "Barramundi(=Giant seaperch)", "Striped bass", "Three-spined stickleback",

##EELS,
"Japanese eel", "Short-finned eel", "European eel", "River eels nei", 

#MARINE FISHES
"European flounder",  "Lefteye flounders nei" ,  "Righteye flounders nei", "Turbot","Marine fishes nei", "Groundfishes nei" , "Finfishes nei",  "Gilthead seabream", "Goldlined seabream", "Silver seabream", "Blackhead seabream", "Crimson seabream", "Filefishes nei", "Mangrove red snapper", "Sixfinger threadfin" , "Emperor red snapper", "Croakers, drums nei",  "Fourfinger threadfin", "Green humphead parrotfish",
"White-spotted spinefoot", "Snappers nei", "Yellowfin seabream",  "Yellowback seabream",  "Meagre",  "Drums nei", "Sobaity seabream", "Red porgy" , "Sharpsnout seabream", "Shi drum",  "Red drum" , "White seabream",   "Okhotsk atka mackerel" , "Porgies, seabreams nei",  "Common snook", "Mojarras(=Silver-biddies) nei", "Percoids nei", "Sargo breams nei" , "Common dentex" ,"Great blue spotted mudskipper", "Snooks(=Robalos) nei", "Common pandora", "Filefishes, leatherjackets nei", "Spinefeet(=Rabbitfishes) nei" , "Common two-banded seabream", "Gobies nei", "Spotted seabass", "Scats", "Snappers, jobfishes nei", "Pargo breams nei", "Goldsilk seabream",  "Russell's snapper", "Marbled spinefoot","Blackspot(=red) seabream" , "Brown meagre",  "Large yellow croaker","Obscure pufferfish", "John's snapper","Papuan black snapper", "Black seabass", "Spotted rose snapper",  "Trumpet emperor", "Two-spot red snapper" , "Streaked spinefoot", "Waigieu seaperch", "Atlantic spadefish", "Japanese seabream"  , "Whitemouth croaker" , "Mi-iuy (brown) croaker", "Tarpon", "Orbicular batfish" , "Sciaenas nei", "Japanese meagre" , "Pink dentex" , "Pufferfishes nei", "Japanese amberjack", "Greater amberjack", "Yellowtail amberjack", "Atlantic cod" , "European seabass", "Flathead grey mullet" , "Squaretail mullet", "Thinlip grey mullet" , "So-iuy mullet",   "Bluespot mullet", "Lebranche mullet", "Mullets nei",  "Red drum", "Japanese seabass", "Large yellow croaker", "Bastard halibut", "Bastard halibuts nei", "Cobia", "Korean rockfish", "Tiger pufferfish", "Amberjacks nei", "Groupers nei", "Greasy grouper", "Hong Kong grouper","Black grouper","Giant grouper", "Spotted coralgrouper","Areolate grouper", "Orange-spotted grouper", "Brown-marbled grouper", "Malabar grouper",  "Humpback grouper", "Groupers, seabasses nei", "Atlantic wolffish", "Spotted wolffish", "Daggertooth pike conger", "Korean rockfish", "Scorpionfishes nei","Cobia", "Japanese jack mackerel",   "White trevally" , "Bigeye trevally"  , "Giant trevally", "Snubnose pompano" , "Silversides(=Sand smelts) nei", "Jacks, crevalles nei", "Bluefish"   , "Crevalle jack" , "Mackerels nei" , "Florida pompano", "Longfin yellowtail", "Golden trevally" ,  "Big-scale sand smelt",  "Malabar trevally",      

#TUNAS
"Atlantic bluefin tuna", "Yellowfin tuna", "Southern bluefin tuna", "Pacific bluefin tuna",

#FW CRUSTCEANS
"Freshwater crustaceans nei", "Sawtooth caridina", "Chinese mitten crab", "Red claw crayfish", "Danube crayfish", "Marron crayfish", "Red swamp crawfish", "River prawns nei", "Yabby crayfish", "Euro-American crayfishes nei",  "Signal crayfish", "Noble crayfish", "Indo-Pacific swamp crab", "Portunus swimcrabs nei", "Gazami crab" , "Callinectes swimcrabs nei","Marine crabs nei", "Blue crab", "Spinous spider crab", "Swimming crabs, etc. nei",  "Blue swimming crab", "Orange mud crab" , "Mediterranean shore crab", "Green crab", "Caribbean spiny lobster",  "Spiny lobsters nei",  "Mud spiny lobster",  "Flathead lobster",  "Japanese spiny lobster", "Palinurid spiny lobsters nei", "Tropical spiny lobsters nei",

#SHRIMPS PRAWNS
"Giant river prawn", "Freshwater prawns, shrimps nei", "Oriental river prawn", "Monsoon river prawn","Penaeus shrimps nei", "Kuruma prawn", "Metapenaeus shrimps nei", "Indian white prawn", "Monkey river prawn",  "Speckled shrimp", "Caramote prawn", "Green tiger prawn", "Brown tiger prawn", "Banana prawn", "Eastern king prawn", "Redtail prawn", "Baltic prawn", "Common prawn", "Greasyback shrimp", "Natantian decapods nei", "Whiteleg shrimp", "Blue shrimp", "Giant tiger prawn", "Fleshy prawn", "Southern white shrimp", "Brine shrimp", "Northern white shrimp", "Eastern school shrimp","Palaemonid shrimps nei","Atlantic ditch shrimp", "Akiami paste shrimp")

# length(Fed_Spp)
# length(Fed_Spp[grep("nei", Fed_Spp)])
# length(Fed_Spp)-length(Fed_Spp[grep("nei", Fed_Spp)])
# 
# levels(prod.aqua2$ISSCAAP_Group)
# unique(prod.aqua2$Species[prod.aqua2$ISSCAAP_Group=="Miscellaneous freshwater fishes"])


# Sci_Spp<-c("Ctenopharyngodon idella", "Megalobrama amblycephala", "Cyprinus carpio", "Carassius carassius", "Mylopharyngodon piceus", "Barbonymus gonionotus", "Catla catla", "Labeo rohita", "Cirrhinus cirrhosus", "Oreochromis niloticus", "Oreochromis aureus x O. niloticus", "Ictalurus punctatus", "Ictalurus punctatus x I. furcatus", "Clarias gariepinus x C. macrocephalus", "Clarias gariepinus",  "Silurus asotus" , "Pelteobagrus fulvidraco", "Channa spp",   "Channa argus" , "Siniperca chuatsi", "Monopterus albus", "Piaractus brachypomus", "Colossoma macropomum","Piaractus mesopotamicus", "Anguilla spp", "Salmo salar", "Oncorhynchus mykiss", "Chanos chanos", "Lates calcarifer", "Platichthys flesus", "Bothidae", "Pleuronectidae", "Psetta maxima", "Gadus morhua", "Dicentrarchus labrax", "Sparus aurata", "Epinephelus spp", "Serranidae", "Sciaenops ocellatus", "Mugil cephalus", "Liza vaigiensis", "Liza ramada", "Mugil soiuy", "Valamugil seheli", "Mugil liza", "Seriola quinqueradiata", "Eriocheir sinensis", "Cherax quadricarinatus", "Macrobrachium rosenbergii", "Macrobrachium nipponense", "Penaeus vannamei", "Penaeus monodon", "Penaeus chinensis")


fed_aqua <-prod.aqua[prod.aqua$Species %in% Fed_Spp,]

write.csv(fed_aqua, "Fed aquaculture tidy.csv", row.names = F)

```


# IMPORT SPECIES PICS

```{r}

# IMPORT AND NAME IMAGES

carp_img<- readPNG("carp.png")
carp_img <- rasterGrob(carp_img, interpolate = T)

shrimp_img<- readPNG("shrimp.png")
shrimp_img <- rasterGrob(shrimp_img, interpolate = T)

salmon_img<- readPNG("salmon.png")
salmon_img <- rasterGrob(salmon_img, interpolate = T)
 
tilapia_img<- readPNG("tilapia.png")
tilapia_img <- rasterGrob(tilapia_img, interpolate = T)

catfish_img<- readPNG("catfish.png")
catfish_img <- rasterGrob(catfish_img, interpolate = T)

snakehead_img<- readPNG("snakehead.png")
snakehead_img <- rasterGrob(snakehead_img, interpolate = T)

crab_img<- readPNG("crab.png")
crab_img <- rasterGrob(crab_img, interpolate = T)

bass_img<- readPNG("bass.png")
bass_img <- rasterGrob(bass_img, interpolate = T)

eel_img<- readPNG("eel.png")
eel_img <- rasterGrob(eel_img, interpolate = T)

grouper_img<- readPNG("grouper.png")
grouper_img <- rasterGrob(grouper_img, interpolate = T)

mullet_img<- readPNG("mullet.png")
mullet_img <- rasterGrob(mullet_img, interpolate = T)

jack_img<- readPNG("jack.png")
jack_img <- rasterGrob(jack_img, interpolate = T)


aqua_img<- readPNG("Aquapen.png")
aqua_img <- rasterGrob(aqua_img, interpolate = T)

```




## Figure 1a - Plotting changes in production over time of species groups and species based projections

```{r}


fed_aqua<-read.csv("Fed aquaculture tidy.csv", header = T)

taxons<-read.csv("CL_FI_SPECIES_GROUPS.csv", header = T)
names(taxons)[names(taxons)=="Name_en"]<-"Species"

class(taxons$Species)
taxons$Species <- as.character(taxons$Species)
class(prod.aqua$Species)
prod.aqua$Species <- as.character(prod.aqua$Species)

prod.aqua2 <- plyr::join(prod.aqua, taxons, by="Species", type="left")
prod.aqua2 <- prod.aqua2[,c(1:7, 15:23)]

# diets<-read.csv("fishmeal diet data.csv", header = T)
# 
# fed_aqua<-dplyr::left_join(fed_aqua, diets, by="Scientific_Name")

#exclude algae and amphib/reptile species
prod.aqua2<-prod.aqua2[!(prod.aqua2$Major_Group=="MAMMALIA" | prod.aqua2$Major_Group=="PLANTAE AQUATICAE" |  prod.aqua2$Major_Group=="AMPHIBIA, REPTILIA"),]

prod.aqua2 <-  prod.aqua2[!is.na(prod.aqua2$Value),]



#add broad groups based off Tacon and Metain
fed_aqua$Broad_group <-NA
fed_aqua$Broad_group<-as.character(fed_aqua$Broad_group)
fed_aqua$Broad_group[fed_aqua$Species %in% c("Grass carp(=White amur)", "Common carp", "Crucian carp", "Wuchang bream", "Black carp", "Silver barb", "Mrigal carp", "Roho labeo", "Catla")] <- "Carps"

fed_aqua$Broad_group[fed_aqua$Species %in% c("Nile tilapia", "Blue-Nile tilapia, hybrid", "Redbelly tilapia", "Blackchin tilapia", "Mango tilapia", "Mozambique tilapia", "Longfin tilapia", "Redbreast tilapia", "Sabaki tilapia", "Three spotted tilapia", "Blue tilapia", "Tilapias nei")] <- "Tilapias"

fed_aqua$Broad_group[fed_aqua$Species %in% c("Striped catfish", "Pangas catfish", "Pangas catfishes nei", "Channel catfish", "Africa-bighead catfish, hybrid", "North African catfish", "Amur catfish", "Yellow catfish", "Torpedo-shaped catfishes nei", "Philippine catfish", "Upsidedown catfishes", "Asian redtail catfish", "Stinging catfish", "South American catfish", "Wels(=Som) catfish", "Hong Kong catfish", "Bagrid catfish", "Black catfishes nei", "Chinese longsnout catfish", "Duckbill catfish", "Naked catfishes","Amazon sailfin catfish" ,"Suckermouth catfish")] <- "Catfishes"

fed_aqua$Broad_group[fed_aqua$Species %in% c("Japanese seabass", "Snakeheads(=Murrels) nei", "Snakehead","Mandarin fish", "Asian swamp eel",   "Pacu", "Pirapatinga", "Cachama", "Largemouth black bass", "Giant gourami", "Tambacu, hybrid", "Snakeskin gourami", "Indonesian snakehead", "Tambatinga, hybrid", "Pond smelt", "Striped snakehead", "Nile perch")] <- "FW fishes"

fed_aqua$Broad_group[fed_aqua$Species %in% c("Milkfish", "Striped bass", "Three-spined stickleback")] <- "Diadromous fishes"

fed_aqua$Broad_group[fed_aqua$Species %in% c("Atlantic salmon", "Coho(=Silver) salmon", "Chinook(=Spring=King) salmon", "Pacific salmons nei"," Chinook(=Spring=King) salmon", "Masu(=Cherry) salmon", "Chum(=Keta=Dog) salmon", "Sockeye(=Red) salmon", "Salmonids nei", "Salmonoids nei", "Rainbow trout", "Rainbow trout", "Sea trout", "Brook trout", "Sevan trout", "Trouts nei", "Golden trout")] <- "Salmonids"


fed_aqua$Broad_group[fed_aqua$Species %in% c("European flounder",  "Lefteye flounders nei" ,  "Righteye flounders nei", "Turbot","Marine fishes nei", "Groundfishes nei" , "Finfishes nei",  "Gilthead seabream", "Goldlined seabream", "Silver seabream", "Blackhead seabream", "Crimson seabream", "Filefishes nei", "Mangrove red snapper", "Sixfinger threadfin" , "Emperor red snapper", "Croakers, drums nei",  "Fourfinger threadfin", "Green humphead parrotfish",
"White-spotted spinefoot", "Snappers nei", "Yellowfin seabream",  "Yellowback seabream",  "Meagre",  "Drums nei", "Sobaity seabream", "Red porgy" , "Sharpsnout seabream", "Shi drum",  "Red drum" , "White seabream",   "Okhotsk atka mackerel" , "Porgies, seabreams nei",  "Common snook", "Mojarras(=Silver-biddies) nei", "Percoids nei", "Sargo breams nei" , "Common dentex" ,"Great blue spotted mudskipper", "Snooks(=Robalos) nei", "Common pandora", "Filefishes, leatherjackets nei", "Spinefeet(=Rabbitfishes) nei" , "Common two-banded seabream", "Gobies nei", "Spotted seabass", "Scats", "Snappers, jobfishes nei", "Pargo breams nei", "Goldsilk seabream",  "Russell's snapper", "Marbled spinefoot","Blackspot(=red) seabream" , "Brown meagre",  "Large yellow croaker","Obscure pufferfish", "John's snapper","Papuan black snapper", "Black seabass", "Spotted rose snapper",  "Trumpet emperor", "Two-spot red snapper" , "Streaked spinefoot", "Waigieu seaperch", "Atlantic spadefish", "Japanese seabream"  , "Whitemouth croaker" , "Mi-iuy (brown) croaker", "Tarpon", "Orbicular batfish" , "Sciaenas nei", "Japanese meagre" , "Pink dentex" , "Pufferfishes nei", "Japanese amberjack", "Greater amberjack", "Yellowtail amberjack", "Atlantic cod" , "European seabass", "Flathead grey mullet" , "Squaretail mullet", "Thinlip grey mullet" , "So-iuy mullet",   "Bluespot mullet", "Lebranche mullet", "Mullets nei",  "Red drum", "Japanese seabass", "Large yellow croaker", "Bastard halibut", "Bastard halibuts nei", "Cobia", "Korean rockfish", "Tiger pufferfish", "Amberjacks nei", "Groupers nei", "Greasy grouper", "Hong Kong grouper","Black grouper","Giant grouper", "Spotted coralgrouper","Areolate grouper", "Orange-spotted grouper", "Brown-marbled grouper", "Malabar grouper",  "Humpback grouper", "Groupers, seabasses nei", "Atlantic wolffish", "Spotted wolffish", "Daggertooth pike conger", "Korean rockfish", "Scorpionfishes nei","Cobia", "Japanese jack mackerel",   "White trevally" , "Bigeye trevally"  , "Giant trevally", "Snubnose pompano" , "Silversides(=Sand smelts) nei", "Jacks, crevalles nei", "Bluefish"   , "Crevalle jack" , "Mackerels nei" , "Florida pompano", "Longfin yellowtail", "Golden trevally" ,  "Big-scale sand smelt",  "Malabar trevally", "Barramundi(=Giant seaperch)")] <- "Marine fishes"


fed_aqua$Broad_group[fed_aqua$Species %in% c("Atlantic bluefin tuna", "Yellowfin tuna", "Southern bluefin tuna", "Pacific bluefin tuna")] <- "Tunas"

fed_aqua$Broad_group[fed_aqua$Species %in% c("Freshwater crustaceans nei", "Sawtooth caridina", "Chinese mitten crab", "Red claw crayfish", "Danube crayfish", "Marron crayfish", "Red swamp crawfish", "River prawns nei", "Yabby crayfish", "Euro-American crayfishes nei",  "Signal crayfish", "Noble crayfish", "Indo-Pacific swamp crab", "Portunus swimcrabs nei", "Gazami crab" , "Callinectes swimcrabs nei","Marine crabs nei", "Blue crab", "Spinous spider crab", "Swimming crabs, etc. nei",  "Blue swimming crab", "Orange mud crab" , "Mediterranean shore crab", "Green crab", "Caribbean spiny lobster",  "Spiny lobsters nei",  "Mud spiny lobster",  "Flathead lobster",  "Japanese spiny lobster", "Palinurid spiny lobsters nei", "Tropical spiny lobsters nei")] <- "FW Crustaceans"

fed_aqua$Broad_group[fed_aqua$Species %in% c("Giant river prawn", "Freshwater prawns, shrimps nei", "Oriental river prawn", "Monsoon river prawn","Penaeus shrimps nei", "Kuruma prawn", "Metapenaeus shrimps nei", "Indian white prawn", "Monkey river prawn",  "Speckled shrimp", "Caramote prawn", "Green tiger prawn", "Brown tiger prawn", "Banana prawn", "Eastern king prawn", "Redtail prawn", "Baltic prawn", "Common prawn", "Greasyback shrimp", "Natantian decapods nei", "Whiteleg shrimp", "Blue shrimp", "Giant tiger prawn", "Fleshy prawn", "Southern white shrimp", "Brine shrimp", "Northern white shrimp", "Eastern school shrimp","Palaemonid shrimps nei","Atlantic ditch shrimp", "Akiami paste shrimp")] <- "Shrimps"

fed_aqua$Broad_group[fed_aqua$Species %in% c("Japanese eel", "Short-finned eel", "European eel", "River eels nei")] <- "Eels"


#fed_aqua[fed_aqua$Broad_group=="Marine fishes" & fed_aqua$Environment=="Freshwater",] <- "FW fishes"
fed_aqua$Broad_group <- as.factor(fed_aqua$Broad_group)


##for the Indian Major carps - assume 10% are fed as per Pahlow 2015 so adjust production value here
fed_aqua$Value[fed_aqua$Species %in% c("Mrigal carp", "Roho labeo", "Catla")] <- fed_aqua$Value[fed_aqua$Species %in% c("Mrigal carp", "Roho labeo", "Catla")]*0.1





### Projections based off of FAO SOFIA 2018, Tilman and Clark, and Froehlich 2018
levels(fed_aqua$Country)
MEDCs <- c("Canada", "United States of America", "Austria", "Belgium", "Denmark", "Finland", "France", "Germany", "Greece", "Ireland", "Italy", "Luxembourg", "Netherlands", "Portugal",  "Spain", "Sweden", "United Kingdom", "Bulgaria", "Croatia", "Cyprus","Czechia", "Estonia", "Hungary", "Latvia", "Lithuania", "Malta", "Poland", "Romania", "Slovakia", "Slovenia", "Iceland","Norway", "Switzerland", "Australia", "Japan", "New Zealand")

LDCs<- c("Angola", "Benin", "Burkina Faso" ,"Burundi","Central African Republic", "Chad", "Comoros", "Congo, Dem. Rep. of the",  "Djibouti", "Eritrea", "Ethiopia", "Gambia" , "Guinea", "Guinea-Bissau", "Lesotho", "Liberia", "Madagascar", "Malawi", "Mali", "Mauritania", "Mozambique", "Niger", "Rwanda", "Sao Tome and Principe", "Senegal", "Sierra Leone", "Somalia", "South Sudan", "Sudan", "Togo", "Uganda", "Tanzania, United Rep. of", "Zambia", "Cambodia", "Kiribati", "Lao People's Dem. Rep.", "Myanmar", "Solomon Islands", "Timor Leste", "Tuvalu", "Vanuatu", "Afghanistan", "Bangladesh", "Bhutan", "Nepal", "Yemen", "Haiti")

#check out production for 2015 only 

fed_aqua.2015 <- fed_aqua %>%
  filter(Year==2015) %>%
  group_by(Year, Broad_group) %>%
  summarise(Value= sum(Value))

arrange(fed_aqua.2015, desc(Value))
sum(fed_aqua.2015$Value) #39 million in 2015 



#create projections

fed_aqua_proj <- fed_aqua %>% 
  filter(Year==2015) %>%
  group_by(Country, Year, Broad_group) %>%
  summarise(Value=sum(Value))%>%
  mutate(bau = Value*1.37) #37% increase overall and in developing countries

sum(fed_aqua_proj$bau)
fed_aqua_proj$bau[fed_aqua_proj$Country %in% MEDCs] <- fed_aqua_proj$Value[fed_aqua_proj$Country %in% MEDCs]*1.281  #28% increase in developed countries
fed_aqua_proj$bau[fed_aqua_proj$Country %in% LDCs] <-fed_aqua_proj$Value[fed_aqua_proj$Country %in% LDCs]*1.463 #46% increase in least developed (FAO SOFIA 2018)3

fed_aqua_proj$chn <- fed_aqua_proj$bau*1
fed_aqua_proj$chn[fed_aqua_proj$Broad_group %in% c("Salmonids", "Shrimps", "FW Crustaceans", "Tunas")] <- fed_aqua_proj$bau[fed_aqua_proj$Broad_group %in% c("Salmonids", "Shrimps", "FW Crustaceans", "Tunas")]*3# FROM WORLD BANK FISH TO 2030 3 times increase relative to bau for shrimps tunas salmonids and crustaceans

sum(fed_aqua_proj$chn)#83 million under chn scenario
sum(fed_aqua_proj$chn)/sum(fed_aqua_proj$bau) # 53% greater production than under the baseline 2030 scenario


fed_aqua_proj$faq <- fed_aqua_proj$bau*1.5
sum(fed_aqua_proj$faq)#82 million under faq scenario - 50% increase in production


#DATA FOR PLOTTING UNTIL 2015

fed_aqua.data <- fed_aqua %>%
  group_by(Year, Broad_group) %>%
  summarise(Value=sum(Value))

#relevel the group factor
levels(fed_aqua.data$Broad_group)
#fed_aqua.global$Group<-factor(fed_aqua.global$Group, levels(fed_aqua.global$Group)[c(1,11,12,2,10, 6, 3, 4, 5, 7, 8, 9)])


#Look at the group production data to present day
ggplot(data = fed_aqua.data, aes(x=Year, y=(Value), colour=Broad_group))+
  geom_line()+
  theme_bw()+
  theme(panel.grid = element_blank(), 
        legend.text = element_text(size=6),
        legend.title = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8))+
  scale_x_continuous(limits = c(1950,2015))+
  scale_y_continuous()+
  geom_vline(xintercept = 2015, lty=2)+
  labs(y=bquote(Production~(T~x10^6)))

ggsave("fishsummary.tiff", device = "tiff", dpi=600, width = 12, height = 6, unit="cm")



#OLD METHOD
# #how well do our fed spp data match up to IMPACT model in terms of proportions of total aquaculture for 2008 and what do these translate into with growth rates stated by IMPACT model
# 
# # - Proportions are respectably similar
# 
# Props <- matrix(data = NA, nrow = length(levels(fed_aqua$Broad_group)), ncol=7)
# rownames(Props) <- levels(fed_aqua$Broad_group)
# colnames(Props) <- c("Prop_global", "bau_global", "Bau_prop", "BAU", "CHN", "FAQ", "2030_mean")
# 
# for (i in 1: length(levels(fed_aqua$Broad_group))){
#   Props[i,1]<- sum(fed_aqua$Value[fed_aqua$Broad_group==levels(fed_aqua$Broad_group)[i] & fed_aqua$Year==2015])/ sum(prod.aqua2$Value[prod.aqua2$Year==2015])
#   Props[i,2] <- 93612000
#   Props[i,3]<- c(Props[i,1]+0.02,Props[i,1], Props[i,1], Props[i,1], Props[i,1], Props[i,1], Props[i,1], Props[i,1],Props[i,1]+0.02, Props[i,1]+0.02, Props[i,1])[i]
#   Props[i,4] <- Props[i,2]*Props[i,3]
#   Props[i,5] <- Props[i,4]* c(1,1,1,1,3,1,1,3,3,1,3)[i]
#   Props[i,6] <- Props[i,4]*c(1.04, 1.01,1.01, 1.02, 1.09, 1.01, 1.06, 1.11, 1.1, 1.29, 1.06)[i]
#   Props[i,7] <- mean(c(Props[i,4], Props[i,5], Props[i,6]))
# }
# sum(fed_aqua$Value[fed_aqua$Broad_group=="Shrimps" &fed_aqua$Year==2008])/sum(prod.aqua2$Value[prod.aqua2$Year==2015])
# sum(Props[,4])/sum(fed_aqua$Value[fed_aqua$Year==2015]) #approximately 42% increase in fed aquaculture by 2030 under bau
# sum(Props[,6])


#BAU - FAO 2018 SOFIA suggests total aquaculture will increase from 2016 of 37% - but growth will slow down from 5.7% to 2.1% between 2017 and 2030 due to chinese aquaculture. So this gives us a baseline growth for all fed aquaculture:

# sum(fed_aqua$Value[fed_aqua$Year==2015])*1.37# FAO suggest 55 million by 2030 - our estimate from Props matrix above (52 million)
# sum(Props[,4])
# 
# 
# #how much of fed aquaculture does our data represent 
# sum(fed_aqua$Value[fed_aqua$Year==2012])/35.7e+06 #denominator taken from Tacon and Metian 2015
# length(Fed_Spp) #280 species or nei
# length(Fed_Spp)-length(Fed_Spp[grep("nei", Fed_Spp)]) # 225 species/ 55 nei categories
# # Comparing production of these 225 species in 2012 to the Tacon Metian estimare = 95% of their estimate of total fed aquaculture
# 
# 
# #how is fed aquaculture changing as a proportion of total fisheries aquaculture
# prop <- c()
# for (i in 1950:2015){
#   prop <- c(prop, sum(fed_aqua$Value[fed_aqua$Year==i])/ sum(prod.aqua2$Value[prod.aqua2$Year==i]))
# }
# 
# plot(prop, type="o")
# 
# 
fed_aqua_plot <- fed_aqua.data %>% 
   group_by(Broad_group, Year)%>%
   summarise(Value=sum(Value))




#GAMS for fit to data based off of the future calculations

fed_aqua.2015$Year <- as.numeric(fed_aqua.2015$Year)
#plot(x= fed_aqua.global$Year, y=fed_aqua.global$Value, col=fed_aqua.global$Group, type="p")

#Set data frame with years, scenarios, groups and Values
Proj_data <- data.frame(Scenario = rep(c("BAU", "CHN", "FAQ"), each=length(seq(2016,2030))*length(levels(fed_aqua_plot$Broad_group))), Broad_group=rep(levels(fed_aqua_plot$Broad_group), each=length(seq(2016,2030)), 3), Year=rep(seq(2016,2030),3*length(levels(fed_aqua_plot$Broad_group))))

fed_aqua_proj2 <- fed_aqua_proj %>%
  group_by(Broad_group)%>%
  summarise(bau=sum(bau), chn=sum(chn), faq=sum(faq))



#Insert production values from the Props matrix 
Proj_data$Value <- NA

for (i in 1:length(levels(Proj_data$Scenario))){
  for (j in 1:length(levels(Proj_data$Broad_group))){
    Proj_data$Value[Proj_data$Year==2030 & Proj_data$Scenario==levels(Proj_data$Scenario)[i] & Proj_data$Broad_group==levels(Proj_data$Broad_group)[j]] <- as.numeric(fed_aqua_proj2[j,i+1])
  }
}


#Join projections to data
Proj_data <- Proj_data[,c(3,2,4,1)]
fed_aqua.data$Scenario <- "Data"



fed_aqua_combo <- rbind.data.frame(fed_aqua.data, Proj_data)
fed_aqua_combo$Scenario <- as.factor(fed_aqua_combo$Scenario)
fed_aqua_combo$Scenario <- factor(fed_aqua_combo$Scenario, levels(fed_aqua_combo$Scenario)[c(3,1,2,4)])

(fed_aqua_combo <- arrange(fed_aqua_combo, Broad_group, Year))


plot(y=fed_aqua_combo$Value, x=fed_aqua_combo$Year, col=fed_aqua_combo$Broad_group, pch=16, cex=0.5)


#assemble GAM data for each group
for (i in 1:length(levels(fed_aqua_combo$Broad_group))){
  df <- fed_aqua_combo[fed_aqua_combo$Broad_group==levels(fed_aqua_combo$Broad_group)[i],]
  model <- gam(Value ~ s(Year), data=df, family = "gaussian"(link = "identity"))
  plotdata <-visreg(model, type = "contrast", plot =F)
  assign(paste("df",i, sep = ""),data.frame(Broad_group = rep(levels(fed_aqua_combo$Broad_group)[i]), x=plotdata$fit[[plotdata$meta$x]], y=plotdata$fit$visregFit+plotdata$fit$Value,lwr=plotdata$fit$visregLwr+plotdata$fit$Value,upper=plotdata$fit$visregUpr+plotdata$fit$Value))
  assign(paste("resids",i, sep = ""),data.frame(Broad_group = rep(levels(fed_aqua_combo$Broad_group)[i]), x=plotdata$res[[plotdata$meta$x]], y=plotdata$res$visregRes+plotdata$res$Value))
}

fit_df <- rbind(df1, df2, df3, df4, df5, df6, df7, df8, df9, df10, df11)
res_df <- rbind(resids1, resids2, resids3, resids4, resids5, resids6, resids7, resids8, resids9, resids10, resids11)

fit_df$y[fit_df$y <0] <-0
fit_df$lwr[fit_df$lwr <0] <-0
fit_df$upper[fit_df$upper <0] <-0

res_df$y[res_df$y <0] <-0

res_df2<-res_df[res_df$x < 2030,]

fit_df$Broad_group <- factor(fit_df$Broad_group,levels(fit_df$Broad_group)[c(1, 9, 10, 8, 2, 5, 7, 6, 3, 4,11)])
res_df$Broad_group <- factor(res_df$Broad_group,levels(res_df$Broad_group)[c(1, 9, 10, 8, 2, 5, 7, 6, 3, 4,11)])

cbbPalette <- c("#000000", "#009E73", "#e79f00", "#9ad0f3", "#0072B2", "#D55E00", "#CC79A7", "#F0E442")
 
colourCount <- length(levels(fed_aqua_combo$Broad_group))

getPalette = colorRampPalette(cbbPalette)


#"#000000" "#006449" "#7DBEE7" "#D29E0A" "#BCB984" "#3F9E53" "#1C83BD" "#606861" "#D4600F" "#CE7179" #"#D99F82" "#F0E442"

#c("#000000" ,"#006449", "#7DBEE7", "#D29E0A", "#BCB984", "#3F9E53", "#1C83BD", "#D4600F", "#CE7179", "#D99F82", "#F0E442")
#c("#000000" ,"#006449", "#7DBEE7", "#D29E0A", "#BCB984", "#3F9E53", "#1C83BD",  "#D4600F", "#CE7179", "#D99F82", "#F0E442")

fig1a <- ggplot(fit_df, aes(x=x,y=y))+geom_line(aes(colour=Broad_group), linetype="dashed", size=0.3)+
  geom_ribbon(aes(x=x, ymin = lwr, ymax=upper, fill=Broad_group), alpha=0.1)+
  geom_point(data = res_df2, aes(x=x, y=y, colour=Broad_group), size=0.5)+
  scale_x_continuous(limits = c(1970,2030), breaks = c(1950,1970,1990,2010, 2030), labels = c(1950, 1970, 1990, 2010, 2030))+
  scale_y_continuous(limits = c(0,20e+06), breaks=c(0, 5e+06, 10e+6, 15e+06), labels = c(0,5,10,15))+
  labs(x=bquote(Year), y=bquote(Production~(T~x10^6)))+
  scale_colour_manual(values=getPalette(colourCount))+
  scale_fill_manual(values=getPalette(colourCount))+
  geom_vline(xintercept = 2015, linetype="dotted", size=0.25)+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        legend.title = element_blank(),
        legend.key.size = unit(0.3, "cm"),
        legend.text = element_text(size=6),
        legend.position = c(0.3,0.8),
        legend.background = element_blank())+
  guides(colour= guide_legend(ncol=2))
  

ggsave("fig1 - draft.tiff", device = "tiff", dpi=600, width = 10, height = 7, units="cm")
ggsave("fig1 - draft.pdf", device = pdf, dpi=600, width = 10, height = 7, units="cm")

Proj_mean <- c(sum(Proj_data$Value[Proj_data$Year==2030 & Proj_data$Scenario=="BAU"]), sum(Proj_data$Value[Proj_data$Year==2030 & Proj_data$Scenario=="CHN"]), sum(Proj_data$Value[Proj_data$Year==2030 & Proj_data$Scenario=="FAQ"]))

Now_2030  <- data.frame(Year=as.factor(c("2015", "2030")),Mean=c(sum(fed_aqua.data$Value[fed_aqua.data$Year==2015]), mean(Proj_mean)), sd=c(NA, sd(Proj_mean)))

# fig1b <- ggplot(data = Now_2030, aes(x=Year, y=Mean, fill=Year))+
#   geom_bar(stat="identity", width = 0.4)+
#   geom_errorbar(aes(ymin=Mean-sd, ymax=Mean+sd), width=0.1, size=0.5)+
#   theme_bw()+
#   scale_fill_manual(values = c("dodgerblue4", "dodgerblue"))+
#   scale_y_continuous(breaks = c(0, 2.5e+07, 5e+07, 7.5e+07), labels=c(0,25,50,75))+
#   theme(panel.grid = element_blank(),
#         axis.text = element_text(size=8),
#         axis.title = element_text(size=8))+
#   guides(fill=F)+
#   labs(x="", y=bquote(Production~(T~x10^6)))
# 
# ggarrange(fig1b, fig1a, labels=c("a", "b"), nrow = 2, ncol=1)
# ggsave("Fig1.tiff", device = "tiff", dpi=600, height=11, width = 9, unit="cm")
# ggsave("Fig1.pdf", device = pdf, dpi=600, height=12, width = 10, unit="cm")

```




#Fig 1b-d - Fishmeal consumption of each group under different scenarios current vs 2030
```{r}
# Construct diet information table for FCRs and fishmeal inclusion and percentage fed


feeds <- data.frame(Broad_group=levels(fed_aqua$Broad_group), FCR_min=NA, FCR_max=NA, FM_min=NA, FM_max=NA, FO_min=NA, FO_max=NA, FMFO_min = NA, FMFO_max = NA, Fed_min = NA, Fed_max=NA)

#Tacon and Metain 2015 Feed matters - Pahlow 2015 Water footprint - Tacon and Metian 2008 Fishmeal inclusion - Chiu 2013 Fishmeal use in China

#feeds[["animal name"]][["df"]]

feeds$FCR_min <- c(1.1, 1.1, 1.1, 1.1, 1.1, 1.1, 1.1, 1.1, 1.1, 1.1, 4.6)
feeds$FCR_max <- c(1.7, 1.5, 1.8, 1.5, 1.8, 1.7, 1.7, 1.3, 1.6, 1.6, 7.4)
feeds$FM_min <- c(0.02, 0.02, 0.02, 0.25, 0.05, 0.15, 0.08, 0.08, 0.05, 0.00, 0.05)
feeds$FM_max <- c(0.04, 0.03, 0.04, 0.30, 0.10, 0.25, 0.16, 0.16, 0.16, 0.03, 0.1)
feeds$FO_min <- c(0.00, 0.00, 0.00, 0.00, 0.00, 0.03, 0.01, 0.04, 0.01, 0.00, 0.05)
feeds$FO_max <- c(0.01, 0.01, 0.01, 0.03, 0.01, 0.04, 0.04, 0.08, 0.02, 0.01, 0.10)
# feeds$FMFO_min <- c(0.02, 0.06, 0.02, 0.24, 0.04, 0.06, 0.08, 0.1, 0.06, 0.01, 0.1)
# feeds$FMFO_max <- c(0.05, 0.11, 0.02, 0.33, 0.09, 0.11, 0.15, 0.2, 0.09, 0.02, 0.2)
feeds$Fed_min <- c(0.55, 0.80, 0.40, 0.97, 0.55, 0.4, 0.8, 1.00, 0.95, 0.9, 1)
feeds$Fed_max <- c(0.65, 0.85, 0.60, 1.00, 0.65, 0.6, 0.9, 1.00, 0.95, 1.00, 1)

feeds_as_list <- split(feeds, feeds$Broad_group)




#FOR LOOP METHOD

# fed_aqua_proj$Repeat <- NA
# fed_aqua_proj$fcr <- NA
# fed_aqua_proj$fm <- NA
# fed_aqua_proj$fo <-NA
# fed_aqua_proj$fed <- NA
# 
# fed_aqua_proj$fm_demand <- NA
# fed_aqua_proj$fm_biomass <- NA
# fed_aqua_proj$fo_demand <- NA
# fed_aqua_proj$fo_from_fm <- NA
# fed_aqua_proj$surplus <- NA
# fed_aqua_proj$consumption <- NA



# fed_aqua_list <- fed_aqua_proj %>% 
#   group_by(Country, Broad_group, Value, bau, chn, faq) %>%
#   split(.,.$Country)
# 
# 
# repeats <- 500
# df_list <- vector("list", repeats*length(fed_aqua_list))
# 
# 
# for (r in 1:repeats){
#   countries <- vector("list", length(fed_aqua_list))
#   for (i in 1:length(fed_aqua_list)){
#     for (j in 1:nrow(feeds)){
#       
#       fed_aqua_list[[i]]$Repeat[fed_aqua_list[[i]]$Broad_group==feeds$Broad_group[j]] <- r
#       
#       fed_aqua_list[[i]]$fcr[fed_aqua_list[[i]]$Broad_group==feeds$Broad_group[j]] <- runif(1, feeds$FCR_min[j], feeds$FCR_max[j])
#       
#       fed_aqua_list[[i]]$fm[fed_aqua_list[[i]]$Broad_group==feeds$Broad_group[j]] <- runif(1, feeds$FM_min[j], feeds$FM_max[j])
#       
#       fed_aqua_list[[i]]$fo[fed_aqua_list[[i]]$Broad_group==feeds$Broad_group[j]] <- runif(1, feeds$FO_min[j], feeds$FO_max[j])
#       
#       fed_aqua_list[[i]]$fed[fed_aqua_list[[i]]$Broad_group==feeds$Broad_group[j]] <- runif(1, feeds$Fed_min[j], feeds$Fed_max[j])
#       
#       fed_aqua_list[[i]]$fm_demand <- fed_aqua_list[[i]]$fcr*fed_aqua_list[[i]]$fm*fed_aqua_list[[i]]$fed*fed_aqua_list[[i]]$Value
#       
#       fed_aqua_list[[i]]$fm_biomass <- fed_aqua_list[[i]]$fm_demand/0.225
#       
#       fed_aqua_list[[i]]$fo_demand <- fed_aqua_list[[i]]$fcr*fed_aqua_list[[i]]$fo*fed_aqua_list[[i]]$fed*fed_aqua_list[[i]]$Value
#       
#       fed_aqua_list[[i]]$fo_from_fm <- fed_aqua_list[[i]]$fm_biomass*0.05
#         
#       fed_aqua_list[[i]]$surplus <- (fed_aqua_list[[i]]$fo_demand - fed_aqua_list[[i]]$fo_from_fm)/0.05
#       
#       fed_aqua_list[[i]]$consumption <- fed_aqua_list[[i]]$fm_biomass+fed_aqua_list[[i]]$surplus
#     }
#     countries[[i]] <-fed_aqua_list[[i]]
#   }
#   df <- dplyr::bind_rows(countries)
#   df_list[[r]] <- df
# }

# df_new <- dplyr::bind_rows(df_list)
# #df_new$consumption[df_new$surplus< 0] <- df_new$fm_biomass[df_new$surplus< 0]
# 
# #Consumption for other scenarios
# #bau
# df_new$bau_fm_demand <- df_new$bau*df_new$fcr*df_new$fm
# df_new$bau_fm_biomass <- df_new$bau_fm_demand/0.225
# df_new$bau_fo_demand <- df_new$bau*df_new$fcr*df_new$fo
# df_new$bau_from_fm <- df_new$bau_fm_biomass*0.05
# df_new$bau_surplus <- (df_new$bau_fo_demand- df_new$bau_from_fm)/0.05
# df_new$bau_consumption <- df_new$bau_fm_biomass + df_new$bau_surplus
# #df_new$bau_consumption[df_new$bau_surplus< 0] <- df_new$bau_fm_biomass[df_new$bau_surplus< 0]
# 
# #chn
# df_new$chn_fm_demand <- df_new$chn*df_new$fcr*df_new$fm
# df_new$chn_fm_biomass <- df_new$chn_fm_demand/0.225
# df_new$chn_fo_demand <- df_new$chn*df_new$fcr*df_new$fo
# df_new$chn_from_fm <- df_new$chn_fm_biomass*0.05
# df_new$chn_surplus <- (df_new$chn_fo_demand- df_new$chn_from_fm)/0.05
# df_new$chn_consumption <- df_new$chn_fm_biomass + df_new$chn_surplus
# #df_new$chn_consumption[df_new$chn_surplus< 0] <- df_new$chn_fm_biomass[df_new$chn_surplus< 0]
# 
# #faq
# df_new$faq_fm_demand <- df_new$faq*df_new$fcr*df_new$fm
# df_new$faq_fm_biomass <- df_new$faq_fm_demand/0.225
# df_new$faq_fo_demand <- df_new$faq*df_new$fcr*df_new$fo
# df_new$faq_from_fm <- df_new$faq_fm_biomass*0.05
# df_new$faq_surplus <- (df_new$faq_fo_demand- df_new$faq_from_fm)/0.05
# df_new$faq_consumption <- df_new$faq_fm_biomass + df_new$faq_surplus
# #df_new$faq_consumption[df_new$faq_surplus< 0] <- df_new$faq_fm_biomass[df_new$faq_surplus< 0]




#LAPPLY METHOD 

a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Broad_group"]]]] 
    
    #assign consumption parameters
    b <- runif(n = 1, min = a[["FCR_min"]], max = a[["FCR_max"]])  # assign random fcr from group range
    c <- runif(n = 1, min = a[["FM_min"]], max = a[["FM_max"]])   # assign random fishmeal inclusion from range 
    d <- runif(n = 1, min = a[["FO_min"]], max = a[["FO_max"]])   #assign random fish oil inclusion from range
    e <- runif(n = 1, min = a[["Fed_min"]], max = a[["Fed_max"]])    #assign random fed proportion from 2015 -2025 range
    f <- a[["Fed_max"]]    # assume highest proportion are fed for future scenarios
    
    #Consumption calculations
    
    #current consumption
    g <- target_row[["Value"]]*b*c*e    #fm demand
    h <- g/0.225       # forage fish biomass needed for fm demand
    i <- target_row[["Value"]]*b*d*e    #fo demand
    j <- h*0.05   # amount of fish oil coming from the fm biomass
    k <- (i-j)/0.05
    l <- case_when(k>=0 ~ h+k,
                   k<0 ~ h)
    
    #baseline consumption (from FAO 37%)
    m <- target_row[["bau"]]*b*c*f    #fm demand
    n <- m/0.225       # forage fish biomass needed for fm demand
    o <- target_row[["bau"]]*b*d*f    #fo demand
    p <- n*0.05   # amount of fish oil coming from the fm biomass
    q <- (o-p)/0.05
    r <- case_when(q>=0 ~ n+q,
                   q<0 ~ n)
    
    #pescatarian diets
    s <- target_row[["faq"]]*b*c*f    #fm demand
    t <- s/0.225       # forage fish biomass needed for fm demand
    u <- target_row[["faq"]]*b*d*f    #fo demand
    v <- t*0.05   # amount of fish oil coming from the fm biomass
    w <- (u-v)/0.05
    x <- case_when(w>=0 ~ t+w,
                   w<0 ~ t)
    
    # chinese dietary shift
    aa <- target_row[["chn"]]*b*c*f    #fm demand
    bb <- aa/0.225       # forage fish biomass needed for fm demand
    cc <- target_row[["chn"]]*b*d*f    #fo demand
    dd <- bb*0.05   # amount of fish oil coming from the fm biomass
    ee <- (cc-dd)/0.05
    ff <- case_when(ee>=0 ~ bb+ee,
                   ee<0 ~ bb)
    
    #chinese + more efficient scenario (fcrs decrease by 0.2)
    gg <- target_row[["chn"]]*(b-0.2)*c*f    #fm demand
    hh <- gg/0.225       # forage fish biomass needed for fm demand
    ii <- target_row[["chn"]]*(b-0.2)*d*f    #fo demand
    jj <- hh*0.05   # amount of fish oil coming from the fm biomass
    kk <- (ii-jj)/0.05
    ll <- case_when(kk>=0 ~ hh+kk,
                   kk<0 ~ hh)
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        #params
        fcr=b, 
        fm=c, 
        fo=d,  
        fed=e, 
        fed_future = f, 
        
        #2015 consumption
        fm_demand = g, 
        fm_biomass = h,
        fo_demand = i,
        fo_from_fm = j, 
        surplus = k,
        current_consumption = l,
        
        #baseline consumption
        baseline_demand = m, 
        baseline_fm_biomass = n,
        baseline_fo_demand = o,
        baseline_from_fm = p, 
        baseline_surplus = q,
        baseline_consumption = r,
        
        #pesc consumption
        pesc_demand = s, 
        pesc_fm_biomass = t,
        pesc_fo_demand = u,
        pesc_from_fm = v, 
        pesc_surplus = w,
        pesc_consumption = x,
        
        #chinese consumption
        chn_demand = aa, 
        chn_fm_biomass = bb,
        chn_fo_demand = cc,
        chn_from_fm = dd, 
        chn_surplus = ee,
        chn_consumption = ff,
        
        #chinese diets and more efficient
        effchn_demand = gg, 
        effchn_fm_biomass = hh,
        effchn_fo_demand = ii,
        effchn_from_fm = jj, 
        effchn_surplus = kk,
        effchn_consumption = ll))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows

write_csv(a_test, "forage fish consumption.csv")




#iINSET PIC FOR CONSUMPTION PLOT

#feed supply data from FAOSTAT
feed_fish <- read_csv("forage_feed.csv")

feed_fish <- feed_fish %>%
  group_by(Year) %>%
  summarise(Value = sum(Value)*1000)

mean(feed_fish$Value[feed_fish$Year==2013])*0.75 #reasonably similar to our 2015 aquaculture usage

ggplot(feed_fish, aes(x=Year, y=Value))+geom_line()


#Capture production
forage_fish <- read_csv("Marine fisheries Production 1950-2014.csv")

unique(forage_fish$TaxonName)[grep("sardin", unique(forage_fish$TaxonName))]
unique(forage_fish$CommonName)[grep("pilchard", unique(forage_fish$CommonName))]

#From Froelich

feed_spp <- c("Engraulis ringens",  "Clupea harengus", "Engraulis japonicus", "Decapterus", "Decapterus macrosoma" ,"Decapterus maruadsi" , "Decapterus russelli",  "Sardina pilchardus", "Mallotus villosus",   "Sardinella",  "Mallotus villosus", "Brevoortia patronus", "Engraulis encrasicolus", "Cololabis saira", "Clupea pallasii pallasii", "Trachurus murphyi", "Larimichthys polyactis", "Clupeidae", "Sprattus sprattus", "Sardinops sagax", "Trachurus", "Trachurus trecae" , "Trachurus capensis","Trachurus lathami", "Trachurus declivis", "Trachurus trachurus", "Trachurus murphyi" , "Trachurus mediterraneus", "Trachurus symmetricus","Trachurus japonicus", "Trachurus picturatus") 


forage_fish <- forage_fish %>%
  filter(forage_fish$TaxonName %in% feed_spp) %>%
  group_by(Year) %>%
  summarise(Value=sum(Value))


ggplot(data = forage_fish, aes(x=Year, y=Value))+geom_line(colour="firebrick", linetype=1)+
  geom_line(data = feed_fish, aes(x=Year, y=Value), colour="black", linetype=1)+
  #annotate("segment", x=2000, xend = 2015, y=mean(forage_fish$Value[forage_fish$Year>1999]), yend = mean(forage_fish$Value[forage_fish$Year>1999]), colour="firebrick", linetype=2)+
  #annotate("segment", x=2000, xend = 2015, y=mean(feed_fish$Value[feed_fish$Year>2010])*0.75, yend = mean(feed_fish$Value[feed_fish$Year>2010])*0.75, colour="black", linetype=2)+
  # scale_x_continuous(limits=c(1960,2016), breaks = c(1985, 2015), labels = c(1985, 2015))+
  # scale_y_continuous(limits = c(0,4e+07), labels = c(0,40), breaks = c(0,  4e+07))+
  labs(x=bquote(Year), y=bquote(Biomass~(T~x10^6)))+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=10),
        axis.title = element_text(size=10))+
  #annotate("text", x=1983, y=5e+06, label="c", size=11)+
  ggsave("total forage fish landings plot.tiff", device="tiff", dpi=600, width = 11, height=9, units = "cm")

tile<-ggplot(data = forage_fish, aes(x=Year, y=Value))+geom_line(colour="firebrick", linetype=1)+
  geom_line(data = feed_fish, aes(x=Year, y=Value), colour="black", linetype=1)+
  annotate("segment", x=2000, xend = 2015, y=mean(forage_fish$Value[forage_fish$Year>1999]), yend = mean(forage_fish$Value[forage_fish$Year>1999]), colour="firebrick", linetype=2)+
  annotate("segment", x=2000, xend = 2015, y=mean(feed_fish$Value[feed_fish$Year>2010])*0.75, yend = mean(feed_fish$Value[feed_fish$Year>2010])*0.75, colour="black", linetype=2)+
  scale_x_continuous(limits=c(1980,2016), breaks = c(1985, 2015), labels = c(1985, 2015))+
  scale_y_continuous(limits = c(0,4e+07), labels = c(0,40), breaks = c(0,  4e+07))+
  labs(x=bquote(Year), y=bquote(Production~(T~x10^6)))+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=14),
        axis.title = element_text(size=14))+
  annotate("text", x=1983, y=5e+06, label="c", size=11)


ggsave( "foragefishsupply.png", device="png", dpi=300, width = 8, height = 5.5, units = "cm")

supplyimg <-readPNG("foragefishsupply.png")
supplyimg <-rasterGrob(supplyimg)


Consumption_df <- read_csv("forage fish consumption.csv")

# CONSUMPTION DATA BY SCENARIO
Scenario_consump_df <- bind_rows(Current <- Consumption_df %>%
  group_by(rep_id) %>%
  summarise(Scenario="2015", Value= sum(current_consumption)),
Baseline <- Consumption_df %>%
  group_by(rep_id) %>%
  summarise(Scenario="Baseline", Value= sum(baseline_consumption)),
Pesc<- Consumption_df %>%
  group_by(rep_id) %>%
  summarise(Scenario="PESC", Value=sum(pesc_consumption)),
Chn_diets <- Consumption_df %>%
  group_by(rep_id) %>%
  summarise(Scenario="CHN",Value= sum(chn_consumption)),
Chn_Eff <- Consumption_df %>%
  group_by(rep_id) %>%
  summarise(Scenario="CHN_FCR", Value=sum(effchn_consumption))) %>%
  group_by(Scenario) %>%
  summarise(Mean=mean(Value), sd=sd(Value))

Scenario_consump_df$Scenario <-as.factor(Scenario_consump_df$Scenario)
Scenario_consump_df$Scenario <- factor(Scenario_consump_df$Scenario, levels(Scenario_consump_df$Scenario)[c(1,2,5,3,4)])

fig1b <- ggplot(data= Scenario_consump_df, aes(x=Scenario, y=Mean))+
  geom_hline(yintercept = mean(feed_fish$Value[feed_fish$Year>2010])*0.75, lty=2, colour="black")+
  #annotation_custom(supplyimg, xmin = 3, xmax = 5.5, ymin = 3.2e+07, ymax = 6e+07)+
  geom_bar(stat="identity", fill="dodgerblue", width=0.75)+
  geom_errorbar(aes(ymin=Mean-sd, ymax=Mean+sd), width=0.2)+
  #coord_flip()+
  labs(y=bquote(Forage~fish~consumption~(T~x10^6)), x="")+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.title = element_text(size = 8),
        axis.text  = element_text(size = 7),
        plot.margin = unit(c(0.2, 0.2, 0.2, 0.2), units = "cm"))+
  scale_y_continuous(limits = c(0, 6e+07), labels = c(0,  20,  40,  60), breaks = c(0,  20e+06,  40e+06, 60e+06))+
  geom_hline(yintercept = mean(forage_fish$Value[forage_fish$Year>1980]), lty=2, colour="firebrick")
  

ggarrange(fig1a, fig1b, labels = c("a", "b"), widths = c(1,0.7), nrow = 1, ncol = 2, align="h")
  
ggsave("Fig1.tiff", device = "tiff", dpi=600, width=18, height = 7, units="cm")
ggsave("Fig1.pdf", device = pdf, dpi=600, width=18, height = 7, units="cm")



  mean(feed_fish$Value[feed_fish$Year>1989])*0.75
mean(forage_fish$Value[forage_fish$Year>1999])





#Mean consumption by group
current_consumption <- df_new %>%
  group_by(Broad_group, Repeat) %>%
  summarise(Sum = sum(consumption)) %>%
  group_by(Broad_group) %>%
  summarise(Consumption= mean(Sum), sd=sd(Sum))


sum(current_consumption$Consumption)


ggplot(current_consumption, aes(x=reorder(Broad_group, -Consumption), y=Consumption)) +
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymin=Consumption-sd, ymax=Consumption+sd), width=0.3)+
  coord_flip()

bau_consumption <- df_new %>%
  group_by(Broad_group, Repeat) %>%
  summarise(Sum = sum(bau_consumption)) %>%
  group_by(Broad_group) %>%
  summarise(Consumption= mean(Sum), sd=sd(Sum))


sum(bau_consumption$Consumption)


ggplot(bau_consumption, aes(x=reorder(Broad_group, -Consumption), y=Consumption)) +
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymin=Consumption-sd, ymax=Consumption+sd), width=0.3)+
  coord_flip()


chn_consumption <- df_new %>%
  group_by(Broad_group, Repeat) %>%
  summarise(Sum = sum(chn_consumption)) %>%
  group_by(Broad_group) %>%
  summarise(Consumption= mean(Sum), sd=sd(Sum))

sum(chn_consumption$Consumption)




ggplot(chn_consumption, aes(x=reorder(Broad_group, -Consumption), y=Consumption)) +
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymin=Consumption-sd, ymax=Consumption+sd), width=0.3)+
  coord_flip()


faq_consumption <- df_new %>%
  group_by(Broad_group, Repeat) %>%
  summarise(Sum = sum(faq_consumption)) %>%
  group_by(Broad_group) %>%
  summarise(Consumption= mean(Sum), sd=sd(Sum))

sum(faq_consumption$Consumption)


ggplot(faq_consumption, aes(x=reorder(Broad_group, -Consumption), y=Consumption)) +
  geom_bar(stat="identity")+
  geom_errorbar(aes(ymin=Consumption-sd, ymax=Consumption+sd), width=0.3)+
  coord_flip()

```

#not sure what this code is

```{r}

## Current forage fish use

FF_consumption <- vector("list", 100000)
  
  #matrix(data = NA, ncol = 14)
#colnames(FF_consumption) <- c("Repeat", "Country", "Group", "Prod", "fcr", "fm", "fo",  "fed",  "fm_demand",  "fm_biomass", " fo_demand" ,"fo_from_fm", "surplus", "consumption")
#if(levels(fed_aqua_proj$Broad_group)[4] %in% unique(data$Broad_group)){

for (i in 1:length(levels(fed_aqua_proj$Country))){
  for (j in 1:length(levels(fed_aqua_proj$Broad_group))){
    dat <- fed_aqua_proj[fed_aqua_proj$Country==levels(fed_aqua_proj$Country)[i],]
    Prod <-  sum(dat$Value[dat$Broad_group==levels(fed_aqua_proj$Broad_group)[j]])
    Country <-levels(fed_aqua_proj$Country)[i]
    Group <- levels(fed_aqua_proj$Broad_group)[j]
    fcr <- runif(1, feeds$FCR_min[j], feeds$FCR_max[j])
    fm <-runif(1, feeds$FM_min[j], feeds$FM_max[j])
    fo <- runif(1, feeds$FO_min[j], feeds$FO_max[j])
    fed <- runif(1, feeds$Fed_min[j], feeds$Fed_max[j])
    Repeat <- r
    
    #Consumption calculations
    fm_demand <- Prod*fcr*fm*fed
    fm_biomass <- fm_demand/0.225
    fo_demand <- Prod*fcr*fo*fed
    fo_from_fm <- fm_biomass*0.05
    surplus <- (fo_demand-fo_from_fm)/0.05
    if(surplus>0){
      consumption <- fm_biomass+surplus
    } else {
      consumption <- fm_biomass
    }
    
    new <- c(Repeat, Country, Group, Prod, fcr, fm, fo, fed, fm_demand, fm_biomass, fo_demand, fo_from_fm, surplus, consumption)
    FF_consumption[[i*j]] <- new
  }
}


FF_consumption <- data.frame(matrix(unlist(FF_consumption), ncol=14, byrow=T))



FF_consumption<- as.data.frame(FF_consumption, row.names = F)
FF_consumption<-FF_consumption[2:nrow(FF_consumption),]

#make numeric
for (i in 4:ncol(FF_consumption)){
  FF_consumption[,i] <- as.numeric(levels(FF_consumption[,i]))[FF_consumption[,i]]
}

nrow(FF_consumption)

sum(FF_consumption$consumption)


Consump_summ <- FF_consumption %>%
  group_by(Group) %>%
  summarise(Value=sum(consumption), sd=sd(consumption))

ggplot(data = Consump_summ, aes(x=reorder(Group, -Value), y=Value, fill=Group))+geom_bar(stat = "identity")+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=0.3)+
  coord_flip()


Consump_summ <- FF_consumption %>%
  group_by(Country) %>%
  summarise(Value=sum(consumption), sd=sd(consumption))

ggplot(data = Consump_summ[Consump_summ$Value>0.1e+06,], aes(x=reorder(Country, Value), y=Value))+geom_bar(stat = "identity")+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=0.3)+
  coord_flip()






Consump_summ$Scenario <- factor(Consump_summ$Scenario, levels(Consump_summ$Scenario)[c(3,1,2,4)])
Consump_summ$Scenario <- factor(Consump_summ$Scenario, levels(Consump_summ$Scenario)[c(3,1,2,4)])

sum(Consump_summ$mean[Consump_summ$Scenario=="DATA"])
  
#plot all facets in ascending order
names <- levels(Consump_summ$Scenario)

for (i in 1:length(names)) {
    dat <- subset(Consump_summ, Scenario == names[i])
    dat$Group <- factor(dat$Group, levels=dat[order(-dat$mean),]$Group)

    assign(paste("p",i, sep = ""), ggplot(dat, aes(x = Group, y = mean, fill = Scenario, width=0.75)) + 
    labs(y = bquote(Forage~fish~consumption~(T~x10^6)), x = NULL, fill = NULL) +
    geom_bar(stat = "identity") +
    geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=0.2)+
    facet_wrap(~Scenario) +
    coord_flip() +
    scale_y_continuous(limits = c(0,6e+07))+
    guides(fill=FALSE) +
    theme_bw() + 
    theme(panel.grid = element_blank(),
    panel.border = element_blank()) +
    scale_fill_brewer(palette="Set2"))
}   


ggarrange(p1, p2, p3, p4, ncol = 2, nrow = 2)
#ggsave("FMFO consumption.tiff", device = "tiff", dpi=600, width=18, height=13, units = "cm")

class(dat$mean)
FF_consumption[FF_consumption$X2=="Albania",]

fed_aqua_proj
data$Broad_group
df
```


#Growth data from metaanalysis

```{r}
#Tidy - uniqu/levels etc

relative_FCR <- function(x){
  fcr <- x$FCR/(x$FCR[1])
}


growth_data <- 
  fread("growth_data.csv", header=T) %>% 
  select(-c(V24, V25, V26, Author, Journal, Supplement_type)) %>% 
  filter(Year>2007 & Study_id!= 206.1) %>% 
  mutate(Amino_supp = case_when(Amino_supp=="" ~ "N",
                                T ~ Amino_supp)) %>% 
  mutate(Fish_group = case_when(Fish_group=="Shrimp" ~ "Shrimps",
                                Fish_group=="Tilapia" ~ "Tilapias",
                                Fish_group=="Carp" ~ "Carps",
                                Fish_group=="Diadromous fish" ~ "Diadromous fishes",
                                Fish_group=="Catfish" ~ "Catfishes",
                                T ~ Fish_group)) %>% 
  mutate(Fish_sp = case_when(Fish_sp == "Chinese Mittern Crab" ~ "Chinese Mitten Crab",
                             T~ Fish_sp)) %>% 
  mutate(Fish_scientific = case_when(Fish_scientific == "Acanthopagrus schlegeli" ~ "Acanthopagrus schlegelii",
                                     Fish_scientific =="Cyprinus carpio var.  Jian"~ "Cyprinus carpio var. Jian",
                                     Fish_scientific %in% c("Machrobrachium rosenbergii", "Macrobrachium rosenbergiiS" ) ~ "Macrobrachium rosenbergii",
                                     Fish_scientific =="Morone chrysops x Morone saxatilis"~ "Morone chrysops x M. saxatilis",
                                     Fish_scientific =="Oreochromis niolticus"~ "Oreochromis niloticus",
                                     Fish_scientific =="Sciaenops ocellatus:" ~ "Sciaenops ocellatus",
                                     T ~ Fish_scientific)) %>% 
  mutate(Life_stage = case_when(Life_stage %in% c("Juveniles") ~  "Juvenile",
                                Life_stage == "Smolts" ~ "Smolt",
                                T ~ Life_stage)) %>% 
  mutate(Tissue = case_when(Tissue == "Total lipids" ~ "Whole body",
                            T ~ Tissue)) %>% 
  group_by(Feed_general, Fish_group,  Study_id) %>% 
  nest() %>% 
  mutate(Relative_FCR = purrr::map(data, relative_FCR)) %>% 
  unnest(data, Relative_FCR) 

names(growth_data)



#Exploration

fishmeal <- growth_data %>% 
  filter(FM_FO == "FM")




fish_oil <- growth_data %>% 
  filter(FM_FO == "FO")
complete <- growth_data %>% 
  filter(FM_FO == "Both")
  

ggplot(data = fishmeal, aes(x=Replacement, y=Relative_FCR))+
  #geom_line(aes(colour=Feed_general, group=Study_id, alpha=Year))+
  geom_point(alpha=.2)+
  facet_grid(cols = vars(Feed_general), rows= vars(Fish_group), scales="free")+
  geom_smooth(method="loess", aes(colour=interaction(Feed_general, Fish_group)))+
  guides(colour=F)+
  theme_bw()+
  theme(panel.grid = element_blank())+
  labs(x= "Fishmeal replacement (%)", y=bquote(Relative~FCR))+
  #scale_y_continuous(limits = c(0,80))+
  ggsave("growth_fishmeal.tiff", device="tiff", dpi=300, width=20, height=22, units = "cm")

  ggplot(data = fish_oil, aes(x=Replacement, y=Relative_FCR))+
    geom_point(alpha=.4)+
    #geom_line(aes(colour=Feed_general, group=Study_id))+
    facet_grid(cols = vars(Feed_general), rows= vars(Fish_group), scales="free")+
  geom_smooth(method="loess", aes(colour=interaction(Feed_general, Fish_group)))+
  guides(colour=F)+
  theme_bw()+
  theme(panel.grid = element_blank())+
  labs(x= "Fish oil replacement (%)", y=bquote(Relative~FCR))+
  ggsave("growth_fish-oil.tiff", device="tiff", dpi=300, width=11, height=7)

ggplot(data = complete, aes(x=Replacement, y=FCR, colour=Feed_general))+geom_point(alpha=.7)+
  facet_grid(rows = vars(Fish_group), cols= vars(Feed_general), scales="free")+
  ggsave("both_growth.tiff", device="tiff", dpi=150, width=7, height=10)

ggplot(data = fish_oil, aes(x=Replacement, y=n3n6))+geom_point(alpha=.7)+geom_line(aes(colour=Feed_general, group=Study_id))+
  facet_grid(rows = vars(Feed_general), cols= vars(Fish_group), scales="free")+
  ggsave("nutrition_fish_oil.tiff", device="tiff", dpi=300, width=11, height=7)

ggplot(data = fish_oil, aes(x=Replacement, y=n3n6, colour=Feed_general))+geom_point(alpha=.7)+geom_line(aes(colour=Feed_general, group=Study_id))+
  facet_grid(rows = vars(Fish_group), cols= vars(Feed_general), scales="free")+
  ggsave("nutrition_both.tiff", device="tiff", dpi=150, width=7, height=10)

#fish oil change with fishmeal replacement

ggplot(data = fishmeal, aes(x=Replacement, y=Marine_ingredient_change))+geom_point(alpha=.7)+geom_line(aes(colour=Feed_general, group=Study_id))+
  facet_grid(rows = vars(Feed_general), cols= vars(Fish_group), scales="free")+
  ggsave("fish_oil trade off.tiff", device="tiff", dpi=300, width=11, height=7)


ggplot(data = fish_oil, aes(x=Replacement, y=Marine_ingredient_change))+geom_point(alpha=.7)+geom_line(aes(colour=Feed_general, group=Study_id))+
  facet_grid(rows = vars(Feed_general), cols= vars(Fish_group), scales="free")+
  ggsave("fishmeal trade off.tiff", device="tiff", dpi=300, width=11, height=7)


arrange(fishmeal, Feed_general, Fish_group)

```


#SPECIES PLOTS AND MODEL FITTING - FISHMEAL


#Plotting settings

```{r}
#Smoothing splines mixed effects models. SME package


######   BEFORE PLOTTING GO INTO BACKDOOR OF plotSmeModel TO MANUALLY STANDARDISE X AXIS LIMITS (EQUIVALENT OF XLIM=C(0,100)) AND MAKE SURE THAT YLIM IS AT LEAST WITHIN 5% OF ORIGINAL FCR

fix(plotSmeModel) 
#original xlim code - range(as.numeric(colnames(x$coefficients)))
#change xlim code -  range(as.numeric(c(colnames(x$coefficients),100)))

#original ylim code - range(x$data$y, mu$y, sapply(fs, "[[", "y"))
#change ylim with this code - range(c(x$data$y, mu$y, sapply(fs, "[[", "y"),1.05))

#show individual studies makes it clearer
#old code - lines(fs[[i]], lty = "dashed")
#change code - lines(fs[[i]], lty = "dotted", col=alpha("grey80", 1))




#Colours to use for species grousp

brewer.pal(10, "Spectral")

#[1] "#9E0142" "#D53E4F" "#F46D43" "#FDAE61" "#FEE08B" "#E6F598"
# [7] "#ABDDA4" "#66C2A5" "#3288BD" "#5E4FA2"


viridisLite::viridis(n=10)
[1] "#440154FF" "#482878FF" "#3E4A89FF" "#31688EFF" "#26828EFF" "#1F9E89FF"
 [7] "#35B779FF" "#6DCD59FF" "#B4DE2CFF" "#FDE725FF"

viridisLite::viridis(n=9)
[1] "#440154FF" "#472D7BFF" "#3B528BFF" "#2C728EFF" "#21908CFF" "#27AD81FF"
[7] "#5DC863FF" "#AADC32FF" "#FDE725FF"



```



#Carps


```{r}


#=======================================

#Carps and Algae - model looks good

carp_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Carps" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(carp_algae$Replacement), max(carp_algae$Replacement), length.out = 10)[-c(1,10)]
fit_carp_algae <- sme(object = carp_algae$Relative_FCR, tme = carp_algae$Replacement, ind = carp_algae$Study_id,criteria = "AICc", knots = myknots)

plotSmeModel(fit_carp_algae, xlab="", ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#9E0142", lwd=3, col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_carp_algae$info
plot(fit_carp_algae, type="diagnostic")




#============================================

#carps and bacteria - insufficient data for model to converge

carp_bacteria <- 
  fishmeal %>% 
  filter(Fish_group=="Carps" & Feed_general=="Bacteria") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(carp_bacteria$Replacement), max(carp_bacteria$Replacement), length.out = 5)[-c(1,5)]
fit_carp_bacteria <- sme(object = carp_bacteria$Relative_FCR, tme = carp_bacteria$Replacement, ind = carp_bacteria$Study_id, criteria = "AICc", deltaEM=.1, knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_carp_bacteria$info
plot(fit_carp_bacteria, "diagnostic")


plotSmeModel(fit_carp_bacteria, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#9E0142", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))






#==========================================================

#carps and yeast - x limits need sorting




carp_yeast <- 
  fishmeal %>% 
  filter(Fish_group=="Carps" & Feed_general=="Yeast") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(carp_yeast$Replacement), max(carp_yeast$Replacement), length.out = 8)[-c(1,8)]
fit_carp_yeast <- sme(object = carp_yeast$Relative_FCR, tme = carp_yeast$Replacement, ind = carp_yeast$Study_id,criteria = "AICc", knots = myknots)

#Diagnostics 
fit_carp_yeast$info
plot(fit_carp_yeast, type="diagnostic")


plotSmeModel(fit_carp_yeast, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#9E0142', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=66, lty=2, lwd=1, col='black')) ))






#==========================================================


#carps and soy - model is satisfactory


carp_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Carps" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(carp_soy$Replacement), max(carp_soy$Replacement), length.out = 4)[-c(1,4)]
fit_carp_soy <- sme(object = carp_soy$Relative_FCR, tme = carp_soy$Replacement, ind = carp_soy$Study_id,criteria = "AICc",  deltaEM=.1, knots = myknots)

#Diagnostics 
fit_carp_soy$info
plot(fit_carp_soy, type="diagnostic")


plotSmeModel(fit_carp_soy,xlab="",ylab="", showIndividuals=T,  xaxs="i", showConfidenceBands=T, col.meanCurve='#9E0142', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=37, lty=2, lwd=1, col='black'))))





#carps and insects - model looks good


carp_insects <- 
  fishmeal %>% 
  filter(Fish_group=="Carps" & Feed_general=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(carp_insects$Replacement), max(carp_insects$Replacement), length.out = 7)[-c(1,7)]
fit_carp_insects <- sme(object = carp_insects$Relative_FCR, tme = carp_insects$Replacement, ind = carp_insects$Study_id,criteria = "AICc", knots=myknots)

#Diagnostics - no real patterns in residuals or in qq-plot except in the extremes - which is largely to be expected with diverging data sets. No difference between AIC and BICn lambda selection. Use data points as knots creates better fit 


fit_carp_insects$info
plot(fit_carp_insects, type="diagnostic")

plotSmeModel(fit_carp_insects,xlab="",ylab="Relative FCR", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#9E0142", pch=16, col=alpha("grey50", 0.5),  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black'))))


op<-par(mfrow=c(1,5))



par(op)




?png
```

#Catfishes

```{r}

#Catfish and Algae - model looks good

catfish_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Catfishes" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(catfish_algae$Replacement), max(catfish_algae$Replacement), length.out = 10)[-c(1,10)]

fit_catfish_algae <- sme(object = catfish_algae$Relative_FCR, tme = catfish_algae$Replacement, ind = catfish_algae$Study_id,criteria = "AICc")

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_catfish_algae$info
plot(fit_catfish_algae, type="diagnostic")



#PLOT
plotSmeModel(fit_catfish_algae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#D53E4F', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=10, lty=2, lwd=1, col='black'))))


#====================================================

#Catfish and bacteria



catfish_bacteria <- 
  fishmeal %>% 
  filter(Fish_group=="Catfishes" & Feed_general=="Bacteria") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(catfish_bacteria$Replacement), max(catfish_bacteria$Replacement), length.out = 4)[-c(1,4)]

fit_catfish_bacteria <- sme(object = catfish_bacteria$Relative_FCR, tme = catfish_bacteria$Replacement, ind = catfish_bacteria$Study_id,criteria = "AICc", knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_catfish_bacteria$info
plot(fit_catfish_bacteria, type="diagnostic") ##NUP linear model for trends of thre points

#plotSmeModel(fit_catfish_bacteria, xlab="",ylab="Relative FCR", showIndividuals=F,  showConfidenceBands=T, col.meanCurve='#2c7bb6', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=10, lty=2, lwd=1, col='black'))))



#PLOT

plot(x=catfish_bacteria$Replacement, y=catfish_bacteria$Relative_FCR, xlab="",ylab="", col=alpha("grey50", 0.5), pch=16, xlim=c(0,100), ylim=c(min(catfish_bacteria$Relative_FCR),1.05))+
  abline(lm(Relative_FCR~Replacement, data = catfish_bacteria), col="#D53E4F", lwd=3)+
  abline(h=1.05, lwd=1, lty=2)







#===========================================================
##Catfish and yeast

catfish_yeast <- 
  fishmeal %>% 
  filter(Fish_group=="Catfishes" & Feed_general=="Yeast") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)



#Analysis
myknots <- seq(min(catfish_yeast$Replacement), max(catfish_yeast$Replacement), length.out = 4)[-c(1,4)]

fit_catfish_yeast <- sme(object = catfish_yeast$Relative_FCR, tme = catfish_yeast$Replacement, ind = catfish_yeast$Study_id,criteria = "AICc",  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_catfish_yeast$info
plot(fit_catfish_yeast, type="diagnostic")


plotSmeModel(fit_catfish_yeast, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#D53E4F', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=94, lty=2, lwd=1, col='grey20'))))



#=========================================================

#Catfish and Soy



catfish_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Catfishes" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(Replacement==0 ~ 1,
                                  T ~ Relative_FCR))




#Analysis
myknots <- seq(min(catfish_soy$Replacement), max(catfish_soy$Replacement), length.out = 4)[-c(1,4)]

fit_catfish_soy <- sme(object = catfish_soy$Relative_FCR, tme = catfish_soy$Replacement, ind = catfish_soy$Study_id,criteria = "AICc")
#,  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_catfish_yeast$info
plot(fit_catfish_yeast, type="diagnostic")


plotSmeModel(fit_catfish_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#D53E4F', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='grey20'))))



#==================================================

#Catfish and Insects

catfish_insects <- 
  fishmeal %>% 
  filter(Fish_group=="Catfishes" & Feed_general=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) 


#Analysis
myknots <- seq(min(catfish_insects$Replacement), max(catfish_insects$Replacement), length.out = 6)[-c(1,6)]

fit_catfish_insects <- sme(object = catfish_insects$Relative_FCR, tme = catfish_insects$Replacement, ind = catfish_insects$Study_id,criteria = "AICc")#,  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_catfish_insects$info
plot(fit_catfish_insects, type="diagnostic")


plotSmeModel(fit_catfish_insects, xlab="",ylab="Relative FCR", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#D53E4F', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='grey20'))))



```


#FW fishes


```{r}

#FW fishes & Algae (no data)

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)

#FW fishes & Bacteria (no data)
FW_bateria <- 
  fishmeal %>% 
  filter(Fish_group=="Freshwater fishes" & Feed_general=="Bacteria") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(FW_bateria$Replacement), max(FW_bateria$Replacement), length.out = 4)[-c(1,4)]

fit_FW_bacteria <- sme(object = FW_bateria$Relative_FCR, tme = FW_bateria$Replacement, ind = FW_bateria$Study_id,criteria = "AICc")#,  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_FW_bacteria$info
plot(fit_FW_bacteria, type="diagnostic")


plotSmeModel(fit_FW_bacteria, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#F46D43', col=alpha("grey50", 0.5), pch=16)#, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=10, lty=2, lwd=1, col='grey20'))))





#FW fishes & Yeast (no data)

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)


#FW fishes & Soy 


FW_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Freshwater fishes" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(FW_soy$Replacement), max(FW_soy$Replacement), length.out = 4)[-c(1,4)]

fit_FW_soy <- sme(object = FW_soy$Relative_FCR, tme = FW_soy$Replacement, ind = FW_soy$Study_id,criteria = "AICc")#,  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_FW_soy$info
plot(fit_FW_soy, type="diagnostic")


plotSmeModel(fit_FW_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#F46D43', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=57, lty=2, lwd=1, col='grey20'))))



#FW fishes & Insects (no data)

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)




```

#Tilapias 

```{r}

#Tilapias and algae


tilapia_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Tilapias" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(tilapia_algae$Replacement), max(tilapia_algae$Replacement), length.out = 9)[-c(1,9)]

fit_tilapia_algae <- sme(object = tilapia_algae$Relative_FCR, tme = tilapia_algae$Replacement, ind = tilapia_algae$Study_id,criteria = "AICc",  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_tilapia_algae$info
plot(fit_tilapia_algae, type="diagnostic")


plotSmeModel(fit_tilapia_algae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#FDAE61', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=62, lty=2, lwd=1, col='grey20'))))



#Tilapias and bacteria

tilapia_bacteria <- 
  fishmeal %>% 
  filter(Fish_group=="Tilapias" & Feed_general=="Bacteria") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(tilapia_bacteria$Replacement), max(tilapia_bacteria$Replacement), length.out = 4)[-c(1,4)]

fit_tilapia_bacteria <- sme(object = tilapia_bacteria$Relative_FCR, tme = tilapia_bacteria$Replacement, ind = tilapia_bacteria$Study_id,criteria = "AICc",  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_tilapia_bacteria$info
plot(fit_tilapia_bacteria, type="diagnostic")


plotSmeModel(fit_tilapia_bacteria, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#FDAE61', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='grey20'))))





#Tilapias and yeast


tilapia_yeast <- 
  fishmeal %>% 
  filter(Fish_group=="Tilapias" & Feed_general=="Yeast") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(tilapia_yeast$Replacement), max(tilapia_yeast$Replacement), length.out = 11)[-c(1,11)]

fit_tilapia_yeast <- sme(object = tilapia_yeast$Relative_FCR, tme = tilapia_yeast$Replacement, ind = tilapia_yeast$Study_id,criteria = "AIC",  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_tilapia_yeast$info
plot(fit_tilapia_yeast, type="diagnostic")


plotSmeModel(fit_tilapia_yeast, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#FDAE61', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=38, lty=2, lwd=1, col='grey20'))))




#Tilapias and soy


tilapia_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Tilapias" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(tilapia_soy$Replacement), max(tilapia_soy$Replacement), length.out = 4)[-c(1,4)]

fit_tilapia_soy <- sme(object = tilapia_soy$Relative_FCR, tme = tilapia_soy$Replacement, ind = tilapia_soy$Study_id,criteria = "AICc",  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_tilapia_soy$info
plot(fit_tilapia_soy, type="diagnostic")


plotSmeModel(fit_tilapia_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#FDAE61', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=71, lty=2, lwd=1, col='grey20'))))






#Tilapias and insects


tilapia_insect <- 
  fishmeal %>% 
  filter(Fish_group=="Tilapias" & Feed_general=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(tilapia_insect$Replacement), max(tilapia_insect$Replacement), length.out = 5)[-c(1,5)]

fit_tilapia_insect <- sme(object = tilapia_insect$Relative_FCR, tme = tilapia_insect$Replacement, ind = tilapia_insect$Study_id,criteria = "AICc",  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_tilapia_insect$info
plot(fit_tilapia_insect, type="diagnostic")


plotSmeModel(fit_tilapia_insect, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#FDAE61', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=95, lty=2, lwd=1, col='grey20'))))





```
#CRUSTACEANS

```{r}



#Crustaceans and algae

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)

#Crustaceans and bacteria

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)

#Crustaceans and yeast

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)

#Crustaceans and Soy


crustaceans_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Crustaceans" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(crustaceans_soy$Replacement), max(crustaceans_soy$Replacement), length.out = 5)[-c(1,5)]

fit_crustaceans_soy <- sme(object = crustaceans_soy$Relative_FCR, tme = crustaceans_soy$Replacement, ind = crustaceans_soy$Study_id,criteria = "AICc",  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_crustaceans_soy$info
plot(fit_crustaceans_soy, type="diagnostic")


plotSmeModel(fit_crustaceans_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#FEE08B', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=69, lty=2, lwd=1, col='grey20'))))




#Crustaceans and insects

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)

```


#DIADROMOUS FISHES

```{r}

#DIADROMOUS FISHES


#Diadromous fishes and algae

diadromous_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Diadromous fishes" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(diadromous_algae$Replacement), max(diadromous_algae$Replacement), length.out = 10)[-c(1,10)]

fit_diadromous_algae <- sme(object = diadromous_algae$Relative_FCR, tme = diadromous_algae$Replacement, ind = diadromous_algae$Study_id,criteria = "AICc")

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_diadromous_algae$info
plot(fit_diadromous_algae, type="diagnostic")



#PLOT
plotSmeModel(fit_diadromous_algae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#E6F598', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=9, lty=2, lwd=1, col='grey20'))))



#Diadromous fishes and bacteria

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)

#Diadromous fishes and yeast

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)





#Diadromous fishes and soy

diadromous_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Diadromous fishes" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(diadromous_soy$Replacement), max(diadromous_soy$Replacement), length.out = 10)[-c(1,10)]

fit_diadromous_soy <- sme(object = diadromous_soy$Relative_FCR, tme = diadromous_soy$Replacement, ind = diadromous_soy$Study_id,criteria = "AICc")#, knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_diadromous_soy$info
plot(fit_diadromous_soy, type="diagnostic")



#PLOT
plotSmeModel(fit_diadromous_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, lwd=2, col.meanCurve='#D9EF8B', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=70, lty=2, lwd=1, col='grey20'))))



#Diadromous fishes and insect


diadromous_insects <- 
  fishmeal %>% 
  filter(Fish_group=="Diadromous fishes" & Feed_general=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(diadromous_insects$Replacement), max(diadromous_insects$Replacement), length.out = 4)[-c(1,4)]

fit_diadromous_insect <- sme(object = diadromous_insects$Relative_FCR, tme = diadromous_insects$Replacement, ind = diadromous_insects$Study_id,criteria = "AICc", knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_diadromous_insect$info
plot(fit_diadromous_insect, type="diagnostic")



#PLOT
plotSmeModel(fit_diadromous_insect, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, lwd=2, col.meanCurve='#D9EF8B', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=73, lty=2, lwd=1, col='grey20'))))


```

#Salmonids

```{r}
salmon_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Salmonids" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(salmon_algae$Replacement), max(salmon_algae$Replacement), length.out = 10)[-c(1,10)]

fit_salmon_algae <- sme(object = salmon_algae$Relative_FCR, tme = salmon_algae$Replacement, ind = salmon_algae$Study_id,criteria = "AICc")

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_salmon_algae$info
plot(fit_salmon_algae, type="diagnostic")



#PLOT
plotSmeModel(fit_salmon_algae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#ABDDA4', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=30, lty=2, lwd=1, col='grey20'))))



#Bacteria - no data 

#Yeast

salmon_yeast <- 
  fishmeal %>% 
  filter(Fish_group=="Salmonids" & Feed_general=="Yeast") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(salmon_yeast$Replacement), max(salmon_yeast$Replacement), length.out = 6)[-c(1,6)]

fit_salmon_yeast <- sme(object = salmon_yeast$Relative_FCR, tme = salmon_yeast$Replacement, ind = salmon_yeast$Study_id,criteria = "AICc", knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_salmon_yeast$info
plot(fit_salmon_yeast, type="diagnostic")



#PLOT
plotSmeModel(fit_salmon_yeast, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#ABDDA4', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=56, lty=2, lwd=1, col='grey20'))))



# Salmon and Soy


salmon_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Salmonids" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(salmon_soy$Replacement), max(salmon_soy$Replacement), length.out = 4)[-c(1,4)]

fit_salmon_soy <- sme(object = salmon_soy$Relative_FCR, tme = salmon_soy$Replacement, ind = salmon_soy$Study_id,criteria = "AICc", knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_salmon_soy$info
plot(fit_salmon_soy, type="diagnostic")



#PLOT
plotSmeModel(fit_salmon_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#ABDDA4', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='grey20'))))


#Salmon and insects


salmon_insect <- 
  fishmeal %>% 
  filter(Fish_group=="Salmonids" & Feed_general=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(salmon_insect$Replacement), max(salmon_insect$Replacement), length.out = 8)[-c(1,8)]

fit_salmon_insect <- sme(object = salmon_insect$Relative_FCR, tme = salmon_insect$Replacement, ind = salmon_insect$Study_id,criteria = "AICc")#, knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_salmon_insect$info
plot(fit_salmon_insect, type="diagnostic")



#PLOT
plotSmeModel(fit_salmon_insect, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#ABDDA4', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='grey20'))))



```


#Shrimps

```{r}

#Shrimp and Algae

shrimps_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Shrimps" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(shrimps_algae$Replacement), max(shrimps_algae$Replacement), length.out = 10)[-c(1,10)]

fit_shrimps_algae <- sme(object = shrimps_algae$Relative_FCR, tme = shrimps_algae$Replacement, ind = shrimps_algae$Study_id,criteria = "AICc")

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_shrimps_algae$info
plot(fit_shrimps_algae, type="diagnostic")



#PLOT
plotSmeModel(fit_shrimps_algae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#66C2A5', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=90, lty=2, lwd=1, col='grey20'))))


# SHrimps and Bacteria

shrimps_bacteria <- 
  fishmeal %>% 
  filter(Fish_group=="Shrimps" & Feed_general=="Bacteria") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(shrimps_bacteria$Replacement), max(shrimps_bacteria$Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_bacteria <- sme(object = shrimps_bacteria$Relative_FCR, tme = shrimps_bacteria$Replacement, ind = shrimps_bacteria$Study_id,criteria = "AICc", knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_shrimps_bacteria$info
plot(fit_shrimps_bacteria, type="diagnostic")



#PLOT
plotSmeModel(fit_shrimps_bacteria, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#66C2A5', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='grey20'))))




#shrimps and yeast

shrimps_yeast <- 
  fishmeal %>% 
  filter(Fish_group=="Shrimps" & Feed_general=="Yeast") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(shrimps_yeast$Replacement), max(shrimps_yeast$Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_yeast <- sme(object = shrimps_yeast$Relative_FCR, tme = shrimps_yeast$Replacement, ind = shrimps_yeast$Study_id,criteria = "AICc", knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_shrimps_yeast$info
plot(fit_shrimps_yeast, type="diagnostic")



#PLOT
plotSmeModel(fit_shrimps_yeast, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#66C2A5', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=19, lty=2, lwd=1, col='grey20'))))




# SHrimps and soy



shrimps_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Shrimps" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(shrimps_soy$Replacement), max(shrimps_soy$Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_soy <- sme(object = shrimps_soy$Relative_FCR, tme = shrimps_soy$Replacement, ind = shrimps_soy$Study_id,criteria = "AICc")#, knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_shrimps_soy$info
plot(fit_shrimps_soy, type="diagnostic")



#PLOT
plotSmeModel(fit_shrimps_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#66C2A5', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='grey20'))))





#Shrimps and insects 



shrimps_insect <- 
  fishmeal %>% 
  filter(Fish_group=="Shrimps" & Feed_general=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(shrimps_insect$Replacement), max(shrimps_insect$Replacement), length.out = 5)[-c(1,5)]

fit_shrimps_insect <- sme(object = shrimps_insect$Relative_FCR, tme = shrimps_insect$Replacement, ind = shrimps_insect$Study_id,criteria = "AICc", knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_shrimps_insect$info
plot(fit_shrimps_insect, type="diagnostic")



#PLOT
plotSmeModel(fit_shrimps_insect, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#66C2A5', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=19, lty=2, lwd=1, col='grey20'))))







```

#Marine fishes

```{r}

#Marine fishes and algae

marine_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Marine fishes" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(marine_algae$Replacement), max(marine_algae$Replacement), length.out = 10)[-c(1,10)]

fit_marine_algae <- sme(object = marine_algae$Relative_FCR, tme = marine_algae$Replacement, ind = marine_algae$Study_id,criteria = "AICc")

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_marine_algae$info
plot(fit_marine_algae, type="diagnostic")



#PLOT
plotSmeModel(fit_marine_algae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3288BD', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=47, lty=2, lwd=1, col='grey20'))))




#Marine fishes and bacteria




marine_bacteria <- 
  fishmeal %>% 
  filter(Fish_group=="Marine fishes" & Feed_general=="Bacteria") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(marine_bacteria$Replacement), max(marine_bacteria$Replacement), length.out = 6)[-c(1,6)]

fit_marine_bacteria <- sme(object = marine_bacteria$Relative_FCR, tme = marine_bacteria$Replacement, ind = marine_bacteria$Study_id,criteria = "AICc")#, knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_marine_bacteria$info
plot(fit_marine_bacteria, type="diagnostic")



#PLOT
plotSmeModel(fit_marine_bacteria, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3288BD', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=49, lty=2, lwd=1, col='grey20'))))


#Marine fishes and yeast



marine_yeast <- 
  fishmeal %>% 
  filter(Fish_group=="Marine fishes" & Feed_general=="Yeast") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(marine_yeast$Replacement), max(marine_yeast$Replacement), length.out = 4)[-c(1,4)]

fit_marine_yeast <- sme(object = marine_yeast$Relative_FCR, tme = marine_yeast$Replacement, ind = marine_yeast$Study_id,criteria = "AICc",knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_marine_yeast$info
plot(fit_marine_yeast, type="diagnostic")


#PLOT
plotSmeModel(fit_marine_yeast, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3288BD', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=73, lty=2, lwd=1, col='grey20'))))



#marine fishes and soy



marine_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Marine fishes" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(marine_soy$Replacement), max(marine_soy$Replacement), length.out = 10)[-c(1,10)]

fit_marine_soy <- sme(object = marine_soy$Relative_FCR, tme = marine_soy$Replacement, ind = marine_soy$Study_id,criteria = "AICc", deltaNM = 0.001)#,knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_marine_soy$info
plot(fit_marine_soy, type="diagnostic")


#PLOT
plotSmeModel(fit_marine_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3288BD', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='grey20'))))





#MARINE FISHES AND INSECTS


marine_insect <- 
  fishmeal %>% 
  filter(Fish_group=="Marine fishes" & Feed_general=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(marine_insect$Replacement), max(marine_insect$Replacement), length.out = 6)[-c(1,6)]

fit_marine_insect <- sme(object = marine_insect$Relative_FCR, tme = marine_insect$Replacement, ind = marine_insect$Study_id,criteria = "AICc",knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_marine_insect$info
plot(fit_marine_insect, type="diagnostic")


#PLOT
plotSmeModel(fit_marine_insect, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3288BD', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=78, lty=2, lwd=1, col='grey20'))))




```



#Tunas

```{r}

tuna_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Tunas" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(tuna_soy$Replacement), max(tuna_soy$Replacement), length.out = 4)[-c(1,4)]

fit_tuna_soy <- sme(object = tuna_soy$Relative_FCR, tme = tuna_soy$Replacement, ind = tuna_soy$Study_id, criteria = "AICc", knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_tuna_soy$info
plot(fit_tuna_soy, type="diagnostic")


#PLOT
plotSmeModel(fit_tuna_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3288BD', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=18, lty=2, lwd=1, col='grey20'))))



```



#Figure 2 - Fishmeal FCR 

```{r}

pdf("Fig 2 - FCR and fishmeal replacement.pdf", 
    width=7.20472441,
    height=8.1)
op <- par(mfrow=c(9,5), 
          mai=c(0.2,0.3,0.1,0.1), #spacing around each plot
          mgp=c(3,0.5,0), # middle value distance of labels to ticks
          oma = c(3, 3, 3, 3)) #space for the overall x and y axis titles
#carp_algae
plotSmeModel(fit_carp_algae, xlab=F, ylab=F, xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#FDE725FF", lwd=3, col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#carps bacteria
plotSmeModel(fit_carp_bacteria, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#FDE725FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#carp_yeast
plotSmeModel(fit_carp_yeast, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#FDE725FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=66, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#carp_soy
plotSmeModel(fit_carp_soy,xlab="",ylab="",  xaxt="n",showIndividuals=T,  xaxs="i", showConfidenceBands=T, col.meanCurve='#FDE725FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=37, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#carp_insects
plotSmeModel(fit_carp_insects,xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#FDE725FF", pch=16, col=alpha("grey50", 0.5),  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#catfish algae
plotSmeModel(fit_catfish_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#AADC32FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=10, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#catfish_bacteria
plot(x=catfish_bacteria$Replacement, y=catfish_bacteria$Relative_FCR, xlab="",ylab="",  xaxt="n",col=alpha("grey50", 0.5), pch=16, xlim=c(0,100), ylim=c(min(catfish_bacteria$Relative_FCR),1.05))+
  abline(lm(Relative_FCR~Replacement, data = catfish_bacteria, lwd=.8), col="#AADC32FF", lwd=3)+
  abline(h=1.05, lwd=1, lty=2, col="red")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#catfish yeast
plotSmeModel(fit_catfish_yeast, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#AADC32FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=94, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#catfish soy
plotSmeModel(fit_catfish_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#AADC32FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#catfish_insects
plotSmeModel(fit_catfish_insects, xlab="",ylab="",  xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#AADC32FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#FW fishes algae
plot(1, type="n", xlab="", ylab="", xaxt="n", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#FW fishes_bacteria
plotSmeModel(fit_FW_bacteria, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#5DC863FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=10, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#FW fishes yeast
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#FW fishes soy
plotSmeModel(fit_FW_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#5DC863FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=57, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#FW fishes_insects
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#tilapias algae
plotSmeModel(fit_tilapia_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#27AD81FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=62, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias_bacteria
plotSmeModel(fit_tilapia_bacteria, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#27AD81FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#tilapias yeast
plotSmeModel(fit_tilapia_yeast, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#27AD81FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=38, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#tilapias soy
plotSmeModel(fit_tilapia_soy, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#27AD81FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=71, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#tilapias_insects
plotSmeModel(fit_tilapia_insect, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#27AD81FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=95, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#crustaceans algae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#crustaceans_bacteria
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#crustaceans yeast
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#crustaceans soy
plotSmeModel(fit_crustaceans_soy, xlab="",ylab="",  xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#21908CFF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=69, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#crustaceans_insects
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#diadromous fishes algae
plotSmeModel(fit_diadromous_algae, xlab="",ylab="",  xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#2C728EFF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=9, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#diadromous fishes_bacteria
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#diadromous fishes yeast
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#diadromous fishes soy
plotSmeModel(fit_diadromous_soy, xlab="",ylab="",  xaxt="n", showIndividuals=T,  showConfidenceBands=T, lwd=2, col.meanCurve='#2C728EFF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=70, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#diadromous fishes_insects
plotSmeModel(fit_diadromous_insect, xlab="",ylab="",  xaxt="n", showIndividuals=T,  showConfidenceBands=T, lwd=2, col.meanCurve='#2C728EFF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=73, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#salmonids algae
plotSmeModel(fit_salmon_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3B528BFF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=30, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#salmonids_bacteria
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#salmonids yeast
plotSmeModel(fit_salmon_yeast, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3B528BFF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=56, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#salmonids soy
plotSmeModel(fit_salmon_soy, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3B528BFF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#salmonids_insects
plotSmeModel(fit_salmon_insect, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3B528BFF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#shrimps algae
plotSmeModel(fit_shrimps_algae, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#472D7BFF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=90, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#shrimps_bacteria
plotSmeModel(fit_shrimps_bacteria, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#472D7BFF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#shrimps yeast
plotSmeModel(fit_shrimps_yeast, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#472D7BFF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=19, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#shrimps soy
plotSmeModel(fit_shrimps_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#472D7BFF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#shrimps_insects
plotSmeModel(fit_shrimps_insect, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#472D7BFF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#marine fishes algae
plotSmeModel(fit_marine_algae, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#440154FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=47, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#marine fishes_bacteria
plotSmeModel(fit_marine_bacteria, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#440154FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=49, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#marine fishes yeast
plotSmeModel(fit_marine_yeast, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#440154FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=73, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#marine fishes soy
plotSmeModel(fit_marine_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#440154FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#marine fishes_insects
plotSmeModel(fit_marine_insect, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#440154FF', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=78, lty=2, lwd=1, col='red'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#tunas algae
# plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
#   abline(0,1, col="grey90")
# axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
# #tunas_bacteria
# plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n")+
#   abline(0,1, col="grey90")
# axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
# #tunas yeast
# plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n")+
#   abline(0,1, col="grey90")
# axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
# #tunas soy
# plotSmeModel(fit_tuna_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3288BD', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=18, lty=2, lwd=1, col='grey20'))))
# axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
# 
# #tunas_insects
# plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n")+
#   abline(0,1, col="grey90")
# axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

mtext("Fishmeal replacement (%)", side = 1, line=1, outer = T)
mtext("Relative feed conversion ratio",side = 2, line=1, outer = T)
mtext(c("Algae", "Bacteria", "Yeast", "Soy", "Insects"), side=3, line = 0, outer = T, at=c(.12, .32, .52, .72, .92), cex = 0.8, font=3)
mtext(c("Carps", "Catfishes", "FW fishes", "Tilapias", "Crustaceans", "Diad.fishes", "Salmonids", "Shrimps", "Marine fishes"), side=4, line = 0, outer = T, at=rev(seq(from =.06, to=.95, length.out = 9)), cex = 0.75, font=3)


par(op)
dev.off()








```


#FISH OIL SUBSTITUTION _ FCR

#catfishes 

```{r}
catfishes_algae <- 
  fish_oil %>% 
  filter(Fish_group=="Catfishes" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(catfishes_algae$Replacement), max(catfishes_algae$Replacement), length.out = 4)[-c(1,4)]

fit_catfishes_algae <- sme(object = catfishes_algae$Relative_FCR, tme = catfishes_algae$Replacement, ind = catfishes_algae$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_catfishes_algae$info
plot(fit_catfishes_algae, "diagnostic")


plotSmeModel(fit_catfishes_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#D53E4F", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=50, lty=2, lwd=1, col='black')) ))




```


#FRESHWATER FISHES

```{r}

#NOT ENOUGH DATA

fwfishes_soy <- 
  fish_oil %>% 
  filter(Fish_group=="Freshwater fishes" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(fwfishes_soy$Replacement), max(fwfishes_soy$Replacement), length.out = 4)[-c(1,4)]

fit_fwfishes_soy <- sme(object = fwfishes_soy$Relative_FCR, tme = fwfishes_soy$Replacement, ind = fwfishes_soy$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_fwfishes_soy$info
plot(fit_fwfishes_soy, "diagnostic")


plotSmeModel(fit_fwfishes_soy, xlab="",ylab="", showIndividuals=F, showConfidenceBands=F, col.meanCurve="#F46D43", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=50, lty=2, lwd=1, col='black')) ))






```

#SALMONIDS 

```{r}
salmonids_algae <- 
  fish_oil %>% 
  filter(Fish_group=="Salmonids" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) 


myknots <- seq(min(salmonids_algae$Replacement), max(salmonids_algae$Replacement), length.out = 4)[-c(1,4)]

fit_salmonids_algae <- sme(object = salmonids_algae$Relative_FCR, tme = salmonids_algae$Replacement, ind = salmonids_algae$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_algae$info
plot(fit_salmonids_algae, "diagnostic")


plotSmeModel(fit_salmonids_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#ABDDA4", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=15, lty=2, lwd=1, col='black')) ))


#Salmonids and soy


salmonids_soy <- 
  fish_oil %>% 
  filter(Fish_group=="Salmonids" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) %>% 
  na.omit(Relative_FCR)


myknots <- seq(min(salmonids_soy$Replacement), max(salmonids_soy$Replacement), length.out = 4)[-c(1,4)]

fit_salmonids_soy <- sme(object = salmonids_soy$Relative_FCR, tme = salmonids_soy$Replacement, ind = salmonids_soy$Study_id, criteria = "AICc",knots = myknots)


#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_soy$info #won't converge - plotting model to describe trend
plot(fit_salmonids_soy, "diagnostic")


plotSmeModel(fit_salmonids_soy, xlab="",ylab="", showIndividuals=F, showConfidenceBands=F, col.meanCurve="#ABDDA4", col=alpha("grey50", 0.5), pch=16, lwd=2, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))


#Won't converge two few data points  - leave out?

salmonids_yeast <- 
  fish_oil %>% 
  filter(Fish_group=="Salmonids" & Feed_general=="Yeast") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) %>% 
  na.omit(Relative_FCR)


myknots <- seq(min(salmonids_yeast$Replacement), max(salmonids_yeast$Replacement), length.out = 4)[-c(1,4)]

fit_salmonids_yeast <- sme(object = salmonids_yeast$Relative_FCR, tme = salmonids_yeast$Replacement, ind = salmonids_yeast$Study_id, criteria = "AICc",knots = myknots)


#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_yeast$info #won't converge - plotting model to describe trend
plot(fit_salmonids_yeast, "diagnostic")


plotSmeModel(fit_salmonids_yeast, xlab="",ylab="", showIndividuals=F, showConfidenceBands=F, col.meanCurve="#ABDDA4", col=alpha("grey50", 0.5), pch=16, lwd=2, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black'))))




```


#SHRIMPS

```{r}

shrimpy_algae <- 
  fish_oil %>% 
  filter(Fish_group=="Shrimps" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) %>% 
  na.omit(Relative_FCR)


myknots <- seq(min(shrimpy_algae$Replacement), max(shrimpy_algae$Replacement), length.out = 4)[-c(1,4)]

fit_shrimpy_algae <- sme(object = shrimpy_algae$Relative_FCR, tme = shrimpy_algae$Replacement, ind = shrimpy_algae$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimpy_algae$info
plot(fit_shrimpy_algae, "diagnostic")


plotSmeModel(fit_shrimpy_algae, xlab="",ylab="", showIndividuals=F, showConfidenceBands=F, col.meanCurve="#ABDDA4", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))


#Shrimps and soy

shrimpy_soy <- 
  fish_oil %>% 
  filter(Fish_group=="Shrimps" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) %>% 
  na.omit(Relative_FCR)


myknots <- seq(min(shrimpy_soy$Replacement), max(shrimpy_soy$Replacement), length.out = 4)[-c(1,4)]

fit_shrimpy_soy <- sme(object = shrimpy_soy$Relative_FCR, tme = shrimpy_soy$Replacement, ind = shrimpy_soy$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimpy_soy$info
plot(fit_shrimpy_soy, "diagnostic")


plotSmeModel(fit_shrimpy_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#ABDDA4", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))






```


#MARINE FISHES

```{r}
marinefishes_algae <- 
  fish_oil %>% 
  filter(Fish_group=="Marine fishes" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) %>% 
  na.omit(Relative_FCR)

#Analysis
myknots <- seq(min(marinefishes_algae$Replacement), max(marinefishes_algae$Replacement), length.out = 7)[-c(1,7)]

fit_marinefishes_algae <- sme(object = marinefishes_algae$Relative_FCR, tme = marinefishes_algae$Replacement, ind = marinefishes_algae$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marinefishes_algae$info
plot(fit_marinefishes_algae, "diagnostic")


plotSmeModel(fit_marinefishes_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3288BD", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))




#marine fishes and soy

marinefishes_soy <- 
  fish_oil %>% 
  filter(Fish_group=="Marine fishes" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) %>% 
  na.omit(Relative_FCR)

#Analysis
myknots <- seq(min(marinefishes_soy$Replacement), max(marinefishes_soy$Replacement), length.out = 5)[-c(1,5)]

fit_marinefishes_soy <- sme(object = marinefishes_soy$Relative_FCR, tme = marinefishes_soy$Replacement, ind = marinefishes_soy$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marinefishes_soy$info
plot(fit_marinefishes_soy, "diagnostic")


plotSmeModel(fit_marinefishes_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3288BD", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))


```

#SUPPLEMENTARY FIG - FISH OIL SUBSTITUTION ON FCR

```{r}
pdf("Supplementary Figure 1 - FCR and fish oil replacement.pdf", 
    width=3.5,
    height=3.7)
op <- par(mfrow=c(5,3), 
          mai=c(0.2,0.2,0.05,0.05), #spacing around each plot
          mgp=c(3,0.5,0), # middle value distance of labels to ticks
          oma = c(2, 2, 1.5, 2)) #space for the overall x and y axis titles

#Catfish and algae
plotSmeModel(fit_catfishes_algae, xlab="",ylab="", xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#AADC32FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=50, lty=2, lwd=1, col='black'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
# #catfish yeast
plot(1, type="n", xlab="", ylab="", xaxt="n", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#catfish soy 
plot(1, type="n", xlab="", ylab="", xaxt="n", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#Freshwater fishes and algae
plot(1, type="n", xlab="", ylab="", xaxt="n", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#Freshwater fishes and yeast
plot(1, type="n", xlab="", ylab="", xaxt="n", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Freshwater fishes and soy
plotSmeModel(fit_fwfishes_soy, xlab="",ylab="", xaxt="n", showIndividuals=F, showConfidenceBands=F, col.meanCurve="#5DC863FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#Salmonids and algae 
plotSmeModel(fit_salmonids_algae, xlab="",ylab="", xaxt="n",showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=15, lty=2, lwd=1, col='black')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#Salmon and yeast
plotSmeModel(fit_salmonids_yeast, xlab="",ylab="", xaxt="n", showIndividuals=F, showConfidenceBands=F, col.meanCurve="#ABDDA4", col=alpha("grey50", 0.5), pch=16, lwd=2, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black'))))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#Salmonids and soy 
plotSmeModel(fit_salmonids_soy, xlab="",ylab="",xaxt="n", showIndividuals=F, showConfidenceBands=F, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, lwd=2, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

# 
# 

#Shrimps and algae 
plotSmeModel(fit_shrimpy_algae, xlab="",ylab="",xaxt="n", showIndividuals=F, showConfidenceBands=F, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#Shrimps and yeast 
plot(1, type="n", xlab="", ylab="", xaxt="n", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Shrimps and soy 
plotSmeModel(fit_shrimpy_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#Marine fishes and algae
plotSmeModel(fit_marinefishes_algae, xlab="",ylab="", xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3288BD", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Marine fishes and yeast
plot(1, type="n", xlab="", ylab="", xaxt="n", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#Marine fishes and soy
plotSmeModel(fit_marinefishes_soy, xlab="",ylab="", xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3288BD", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



mtext("Fish oil replacement (%)", side = 1, line=1, outer = T, cex=0.9)
mtext("Relative feed conversion ratio",side = 2, line=.8, outer = T, cex=0.9)
mtext(c("Algae", "Yeast", "Soy"), side=3, line = 0, outer = T, at=c(0.2,0.52,0.86), cex = 0.6, font=3)
mtext(c( "Catfishes", "FW fishes", "Salmonids", "Shrimps", "Marine fishes"), side=4, line = 0.3, outer = T, at=rev(seq(from =.115, to=.92, length.out = 5)), cex = 0.6, font=3)
par(op)
dev.off()


```


# Human health trade-offs of fish oil substitution

#sort fish oil nutrition data first
```{r}

FO <- 
  fish_oil %>% 
  mutate(n3n6 = as.numeric(n3n6))%>% 
  filter(!is.na(n3n6)) %>% 
  group_by(Study_id) %>% 
  nest() %>% 
  mutate(Relative_nutrition = purrr::map(data, ~(.$n3n6/.$n3n6[1]))) %>% 
  unnest(data, Relative_nutrition)


```



#SALMONIDS 

```{r}

#Salmonids and algae

salmon_algae_n3 <- 
  FO %>% 
  filter(Fish_group=="Salmonids" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)


myknots <- c(13,70)
  
#  seq(min(salmon_algae_n3$Replacement), max(salmon_algae_n3$Replacement), length.out = 4)[-c(1,4)]

fit_salmonids_algae_n3 <- sme(object = salmon_algae_n3$Relative_nutrition, tme = salmon_algae_n3$Replacement, ind = salmon_algae_n3$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_algae_n3$info
plot(fit_salmonids_algae_n3, "diagnostic")


plotSmeModel(fit_salmonids_algae_n3, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=55, lty=2, lwd=1, col='black')) ))



#Salmonids and soy

salmon_soy_n3 <- 
  FO %>% 
  filter(Fish_group=="Salmonids" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) %>% 
  filter(!Study_id==286.3) #this outlier study omitted. Model will not converge with it - will when omitted - no other study in this group has the same effect.  

unique(salmon_soy_n3$Study_id)
myknots <-  seq(min(salmon_soy_n3$Replacement), max(salmon_soy_n3$Replacement), length.out = 4)[-c(1,4)]

fit_salmon_soy_n3 <- sme(object = salmon_soy_n3$Relative_nutrition, tme = salmon_soy_n3$Replacement, ind = salmon_soy_n3$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmon_soy_n3$info
plot(fit_salmon_soy_n3, "diagnostic")


plotSmeModel(fit_salmon_soy_n3, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=8, lty=2, lwd=1, col='black')) ))




```


#SHRIMPS

```{r}

#shrimps and algae
shrimps_algae_n3 <- 
  FO %>% 
  filter(Fish_group=="Shrimps" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)


myknots <- c(60, 90)
  
  
  #seq(min(shrimps_algae_n3$Replacement), max(shrimps_algae_n3$Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_algae_n3 <- sme(object = shrimps_algae_n3$Relative_nutrition, tme = shrimps_algae_n3$Replacement, ind = shrimps_algae_n3$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimps_algae_n3$info
plot(fit_shrimps_algae_n3, "diagnostic")


plotSmeModel(fit_shrimps_algae_n3, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))




#SHRIMPS AND SOY

shrimps_soy_n3 <- 
  FO %>% 
  filter(Fish_group=="Shrimps" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)


myknots <- seq(min(shrimps_soy_n3$Replacement), max(shrimps_soy_n3$Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_soy_n3 <- sme(object = shrimps_soy_n3$Relative_nutrition, tme = shrimps_soy_n3$Replacement, ind = shrimps_soy_n3$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics 
fit_shrimps_soy_n3$info
plot(fit_shrimps_soy_n3, "diagnostic")


plotSmeModel(fit_shrimps_soy_n3, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=32, lty=2, lwd=1, col='black')) ))






```


#MARINE FISHES

```{r}

#Marine fishes and algae

marine_algae_n3 <- 
  FO %>% 
  filter(Fish_group=="Marine fishes" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)


myknots <- seq(min(marine_algae_n3$Replacement), max(marine_algae_n3$Replacement), length.out = 7)[-c(1,7)]

fit_marine_algae_n3 <- sme(object = marine_algae_n3$Relative_nutrition, tme = marine_algae_n3$Replacement, ind = marine_algae_n3$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_algae_n3$info
plot(fit_marine_algae_n3, "diagnostic")


plotSmeModel(fit_marine_algae_n3, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))

#Marine and soy


marine_soy_n3 <- 
  FO %>% 
  filter(Fish_group=="Marine fishes" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)


myknots <- seq(min(marine_soy_n3$Replacement), max(marine_soy_n3$Replacement), length.out = 7)[-c(1,7)]

fit_marine_soy_n3 <- sme(object = marine_soy_n3$Relative_nutrition, tme = marine_soy_n3$Replacement, ind = marine_soy_n3$Study_id, criteria = "AICc")#,knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_soy_n3$info
plot(fit_marine_soy_n3, "diagnostic")


plotSmeModel(fit_marine_soy_n3, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))



```


#FIG 3 - FISH OIL REPLACEMENT HEALTH TRADE_OFFS


```{r}

pdf("Fig 3  - n3n6 and fish oil replacement.pdf", 
    width=3.5,
    height=3.7)
op <- par(mfrow=c(3,2), 
          mai=c(0.2,0.2,0.05,0.05), #spacing around each plot
          mgp=c(3,0.5,0), # middle value distance of labels to ticks
          oma = c(2, 2, 1.5, 2)) #space for the overall x and y axis titles


#Salmonids algae n3
plotSmeModel(fit_salmonids_algae_n3, xlab="",ylab="", xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=55, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Salmonids soy n3
plotSmeModel(fit_salmon_soy_n3, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=8, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Shrimps and algae
plotSmeModel(fit_shrimps_algae_n3, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Shrimps and soy
plotSmeModel(fit_shrimps_soy_n3, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=32, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes and algae
plotSmeModel(fit_marine_algae_n3, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes and soy
plotSmeModel(fit_marine_soy_n3, xlab="",ylab="", xaxt="n",showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

mtext("Fish oil replacement (%)", side = 1, line=1, outer = T, cex=1)
mtext("Relative n3:n6 fatty acid content",side = 2, line=.8, outer = T, cex=1)
mtext(c("Algae", "Soy"), side=3, line = 0, outer = T, at=c(0.27,0.77), cex = 0.75, font=3)
mtext(c( "Salmonids", "Shrimps", "Marine fishes"), side=4, line = 0.3, outer = T, at=rev(seq(from =.2, to=.85, length.out = 3)), cex = 0.75, font=3)
par(op)
dev.off()



```


# FIGURE X 
# Change in fish oil from fishmeal replacement


#Plotting settings
```{r}
#Smoothing splines mixed effects models. SME package


######   BEFORE PLOTTING GO INTO BACKDOOR OF plotSmeModel TO MANUALLY STANDARDISE X AXIS LIMITS (EQUIVALENT OF XLIM=C(0,100)) AND MAKE SURE THAT YLIM IS AT LEAST WITHIN 5% OF ORIGINAL FCR

fix(plotSmeModel) 
#original xlim code - range(as.numeric(colnames(x$coefficients)))
#change xlim code -  range(as.numeric(c(colnames(x$coefficients),100)))


#show individual studies makes it clearer
#old code - lines(fs[[i]], lty = "dashed")
#change code - lines(fs[[i]], lty = "dotted", col=alpha("grey80", 1))




#Colours to use for species grousp

brewer.pal(10, "Spectral")

#[1] "#9E0142" "#D53E4F" "#F46D43" "#FDAE61" "#FEE08B" "#E6F598"
# [7] "#ABDDA4" "#66C2A5" "#3288BD" "#5E4FA2"


viridisLite::viridis(n=10)
# [1] "#440154FF" "#482878FF" "#3E4A89FF" "#31688EFF" "#26828EFF" "#1F9E89FF"
#  [7] "#35B779FF" "#6DCD59FF" "#B4DE2CFF" "#FDE725FF"
# 
# viridisLite::viridis(n=9)
# [1] "#440154FF" "#472D7BFF" "#3B528BFF" "#2C728EFF" "#21908CFF" "#27AD81FF"
# [7] "#5DC863FF" "#AADC32FF" "#FDE725FF"



```



#Sort data

```{r}

fish_oil_tradeoffs <- 
  fishmeal %>% 
  filter(!(is.na(Marine_ingredient_change)))



```

#CARPS
```{r}

carp_fo_algae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Carps" & Feed_general=="Algae") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor)

myknots <- seq(min(carp_fo_algae$Replacement), max(carp_fo_algae$Replacement), length.out = 4)[-c(1,4)]

fit_carp_fo_algae <- sme(object = carp_fo_algae$Marine_ingredient_change, tme = carp_fo_algae$Replacement, ind = carp_fo_algae$Study_id, criteria = "AICc",knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_carp_fo_algae$info
plot(fit_carp_fo_algae, "diagnostic")


plotSmeModel(fit_carp_fo_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#FDE725FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(v=0.1, lty=2, lwd=1, col='black')) ))



#carps and bacteria

carp_fo_bacteria <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Carps" & Feed_general=="Bacteria") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor)

myknots <- c(30,80) 
  
  seq(min(carp_fo_bacteria$Replacement), max(carp_fo_bacteria$Replacement), length.out = 4)[-c(1,4)]

fit_carp_fo_bacteria <- sme(object = carp_fo_bacteria$Marine_ingredient_change, tme = carp_fo_bacteria$Replacement, ind = carp_fo_bacteria$Study_id, criteria = "AICc",knots = myknots, deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_carp_fo_bacteria$info
plot(fit_carp_fo_bacteria, "diagnostic")


plotSmeModel(fit_carp_fo_bacteria, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#FDE725FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(h=0.1, lty=2, lwd=1, col='black')) ))




#carps and yeast

carp_fo_yeast <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Carps" & Feed_general=="Yeast") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor) 

myknots <- seq(min(carp_fo_yeast$Replacement), max(carp_fo_yeast$Replacement), length.out = 4)[-c(1,4)]

fit_carp_fo_yeast <- sme(object = carp_fo_yeast$Marine_ingredient_change, tme = carp_fo_yeast$Replacement, ind = carp_fo_yeast$Study_id, criteria = "AICc", deltaNM =0.1)#knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_carp_fo_yeast$info
plot(fit_carp_fo_yeast, "diagnostic")


plotSmeModel(fit_carp_fo_yeast, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#FDE725FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=66, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='black'))




#carps and soy

carp_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Carps" & Feed_general=="Soy") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor) 

myknots <- seq(min(carp_fo_soy$Replacement), max(carp_fo_soy$Replacement), length.out = 4)[-c(1,4)]

fit_carp_fo_soy <- sme(object = carp_fo_soy$Marine_ingredient_change, tme = carp_fo_soy$Replacement, ind = carp_fo_soy$Study_id, criteria = "AICc", deltaEM =0.1,knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_carp_fo_soy$info
plot(fit_carp_fo_soy, "diagnostic")


plotSmeModel(fit_carp_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#FDE725FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=66, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='black'))



# Carps and insects

carp_fo_insects <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Carps" & Feed_general=="Insect") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor) 

myknots <- seq(min(carp_fo_insects$Replacement), max(carp_fo_insects$Replacement), length.out = 4)[-c(1,4)]

fit_carp_fo_insects <- sme(object = carp_fo_insects$Marine_ingredient_change, tme = carp_fo_insects$Replacement, ind = carp_fo_insects$Study_id, criteria = "AICc", deltaEM =0.1,knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_carp_fo_insects$info
plot(fit_carp_fo_insects, "diagnostic")


plotSmeModel(fit_carp_fo_insects, xlab="",ylab="", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#FDE725FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=66, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='black'))



```


#CATFISHES
```{r}


#Catfishes and algae

catfish_fo_algae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Catfishes" & Feed_general=="Algae") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor)

myknots <- seq(min(catfish_fo_algae$Replacement), max(catfish_fo_algae$Replacement), length.out = 4)[-c(1,4)]

fit_catfish_fo_algae <- sme(object = catfish_fo_algae$Marine_ingredient_change, tme = catfish_fo_algae$Replacement, ind = catfish_fo_algae$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_catfish_fo_algae$info
plot(fit_catfish_fo_algae, "diagnostic")


plotSmeModel(fit_catfish_fo_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#AADC32FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=10, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))






#carps and bacteria



#catfishes and yeast

catfishes_fo_yeast <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Catfishes" & Feed_general=="Yeast") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor) 

myknots <- seq(min(catfishes_fo_yeast$Replacement), max(catfishes_fo_yeast$Replacement), length.out = 4)[-c(1,4)]

fit_catfishes_fo_yeast <- sme(object = catfishes_fo_yeast$Marine_ingredient_change, tme = catfishes_fo_yeast$Replacement, ind = catfishes_fo_yeast$Study_id, criteria = "AICc", deltaNM =0.1,knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_catfishes_fo_yeast$info
plot(fit_catfishes_fo_yeast, "diagnostic")


plotSmeModel(fit_catfishes_fo_yeast, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#AADC32FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=66, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='black'))




#carps and soy

catfishes_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Catfishes" & Feed_general=="Soy") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor) 

myknots <- seq(min(catfishes_fo_soy$Replacement), max(catfishes_fo_soy$Replacement), length.out = 4)[-c(1,4)]

fit_catfishes_fo_soy <- sme(object = catfishes_fo_soy$Marine_ingredient_change, tme = catfishes_fo_soy$Replacement, ind = catfishes_fo_soy$Study_id, criteria = "AICc", deltaEM =0.1,knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_catfishes_fo_soy$info
plot(fit_catfishes_fo_soy, "diagnostic")


plotSmeModel(fit_catfishes_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#AADC32FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=50, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='black'))



# catfish and insects

catfishes_fo_insects <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Catfishes" & Feed_general=="Insect") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor) 

myknots <- seq(min(catfishes_fo_insects$Replacement), max(catfishes_fo_insects$Replacement), length.out = 10)[-c(1,10)]

fit_catfishes_fo_insects <- sme(object = catfishes_fo_insects$Marine_ingredient_change, tme = catfishes_fo_insects$Replacement, ind = catfishes_fo_insects$Study_id, criteria = "AICc")#, knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_catfishes_fo_insects$info
plot(fit_catfishes_fo_insects, "diagnostic")


plotSmeModel(fit_catfishes_fo_insects, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#AADC32FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='black'))





```

#FW FISHES
```{r}

#freshwater fishes and soy



fwfishes_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Freshwater fishes" & Feed_general=="Soy") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor)

myknots <- seq(min(fwfishes_fo_soy$Replacement), max(fwfishes_fo_soy$Replacement), length.out = 8)[-c(1,8)]

fit_fwfishes_fo_soy <- sme(object = fwfishes_fo_soy$Marine_ingredient_change, tme = fwfishes_fo_soy$Replacement, ind = fwfishes_fo_soy$Study_id, criteria = "AICc")#,knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_fwfishes_fo_soy$info
plot(fit_fwfishes_fo_soy, "diagnostic")


plotSmeModel(fit_fwfishes_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#5DC863FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=57, lty=2, lwd=1, col='black')),(abline(h=.9, lty=2, lwd=1, col='black')) ))






```

#TILAPIAS
```{r}

#tilapias and algae

tilapia_fo_algae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Tilapias" & Feed_general=="Algae") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor)

myknots <- seq(min(tilapia_fo_algae$Replacement), max(tilapia_fo_algae$Replacement), length.out = 4)[-c(1,4)]

fit_tilapia_fo_algae <- sme(object = tilapia_fo_algae$Marine_ingredient_change, tme = tilapia_fo_algae$Replacement, ind = tilapia_fo_algae$Study_id, criteria = "AICc",knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_tilapia_fo_algae$info
plot(fit_tilapia_fo_algae, "diagnostic")


plotSmeModel(fit_tilapia_fo_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#27AD81FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=24, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))







#tilapia and bacteria

tilapia_fo_bacteria <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Tilapias" & Feed_general=="Bacteria") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor)

myknots <- seq(min(tilapia_fo_bacteria$Replacement), max(tilapia_fo_bacteria$Replacement), length.out = 8)[-c(1,8)]

fit_tilapia_fo_bacteria <- sme(object = tilapia_fo_bacteria$Marine_ingredient_change, tme = tilapia_fo_bacteria$Replacement, ind = tilapia_fo_bacteria$Study_id, criteria = "AICc")#,knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_tilapia_fo_bacteria$info
plot(fit_tilapia_fo_bacteria, "diagnostic")


plotSmeModel(fit_tilapia_fo_bacteria, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#27AD81FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=24, lty=2, lwd=1, col='black')),(abline(h=.46, lty=2, lwd=1, col='black')) ))




#tilapia and yeast 


tilapia_fo_yeast <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Tilapias" & Feed_general=="Yeast") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor)

myknots <-   seq(min(tilapia_fo_yeast$Replacement), max(tilapia_fo_yeast$Replacement), length.out = 4)[-c(1,4)]

fit_tilapia_fo_yeast <- sme(object = tilapia_fo_yeast$Marine_ingredient_change, tme = tilapia_fo_yeast$Replacement, ind = tilapia_fo_yeast$Study_id, criteria = "AICc",knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_tilapia_fo_yeast$info
plot(fit_tilapia_fo_yeast, "diagnostic")


plotSmeModel(fit_tilapia_fo_yeast, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#27AD81FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=38, lty=2, lwd=1, col='black')),(abline(h=-.215, lty=2, lwd=1, col='black')) ))






#tilapia and soy


tilapia_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Tilapias" & Feed_general=="Soy") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)

myknots <- seq(min(tilapia_fo_soy$Replacement), max(tilapia_fo_soy$Replacement), length.out = 4)[-c(1,4)]

fit_tilapia_fo_soy <- sme(object = tilapia_fo_soy$Marine_ingredient_change, tme = tilapia_fo_soy$Replacement, ind = tilapia_fo_soy$Study_id, criteria = "AICc",knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_tilapia_fo_soy$info
plot(fit_tilapia_fo_soy, "diagnostic")


plotSmeModel(fit_tilapia_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#27AD81FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=24, lty=2, lwd=1, col='black')),(abline(h=.46, lty=2, lwd=1, col='black')) ))




#tilapias and insects
tilapia_fo_insect <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Tilapias" & Feed_general=="Insect") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)

myknots <- seq(min(tilapia_fo_insect$Replacement), max(tilapia_fo_insect$Replacement), length.out = 4)[-c(1,4)]

fit_tilapia_fo_insect <- sme(object = tilapia_fo_insect$Marine_ingredient_change, tme = tilapia_fo_insect$Replacement, ind = tilapia_fo_insect$Study_id, criteria = "AICc",knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_tilapia_fo_insect$info
plot(fit_tilapia_fo_insect, "diagnostic")


plotSmeModel(fit_tilapia_fo_insect, xlab="",ylab="", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#27AD81FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=95, lty=2, lwd=1, col='black')),(abline(h=.46, lty=2, lwd=1, col='black')) ))


```

#CRUSTACEANS
```{r}

#crustaceans and soy

crustaceans_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Crustaceans" & Feed_general=="Soy") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)

myknots <- seq(min(crustaceans_fo_soy$Replacement), max(crustaceans_fo_soy$Replacement), length.out = 4)[-c(1,4)]

fit_crustaceans_fo_soy <- sme(object = crustaceans_fo_soy$Marine_ingredient_change, tme = crustaceans_fo_soy$Replacement, ind = crustaceans_fo_soy$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_crustaceans_fo_soy$info
plot(fit_crustaceans_fo_soy, "diagnostic")


plotSmeModel(fit_crustaceans_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#21908CFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=67, lty=2, lwd=1, col='black')),(abline(h=1.61, lty=2, lwd=1, col='black')) ))





```

#DIADROMOUS FISHES
```{r}

#Diadromous fishes and algae

diad_fo_algae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Diadromous fishes" & Feed_general=="Algae") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(diad_fo_algae$Replacement), max(diad_fo_algae$Replacement), length.out = 4)[-c(1,4)]

fit_diad_fo_algae <- sme(object = diad_fo_algae$Marine_ingredient_change, tme = diad_fo_algae$Replacement, ind = diad_fo_algae$Study_id, criteria = "AICc",knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_diad_fo_algae$info
plot(fit_diad_fo_algae, "diagnostic")


plotSmeModel(fit_diad_fo_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#2C728EFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=9, lty=2, lwd=1, col='black')),(abline(h=0.25, lty=2, lwd=1, col='black')) ))






#Diadromous fishes and soy

diad_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Diadromous fishes" & Feed_general=="Soy") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(diad_fo_soy$Replacement), max(diad_fo_soy$Replacement), length.out = 4)[-c(1,4)]

fit_diad_fo_soy <- sme(object = diad_fo_soy$Marine_ingredient_change, tme = diad_fo_soy$Replacement, ind = diad_fo_soy$Study_id, criteria = "AICc",knots = myknots,deltaEM = 0.2)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_diad_fo_soy$info
plot(fit_diad_fo_soy, "diagnostic")


plotSmeModel(fit_diad_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#2C728EFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=70, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))




#Diadromous fishes and insects

diad_fo_insect <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Diadromous fishes" & Feed_general=="Insect") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(diad_fo_insect$Replacement), max(diad_fo_insect$Replacement), length.out = 7)[-c(1,7)]

fit_diad_fo_insect <- sme(object = diad_fo_insect$Marine_ingredient_change, tme = diad_fo_insect$Replacement, ind = diad_fo_insect$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_diad_fo_insect$info
plot(fit_diad_fo_insect, "diagnostic")


plotSmeModel(fit_diad_fo_insect, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#2C728EFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=73, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))





```

#SALMONIDS
```{r}

salmonids_fo_algae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Salmonids" & Feed_general=="Algae") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(salmonids_fo_algae$Replacement), max(salmonids_fo_algae$Replacement), length.out = 4)[-c(1,4)]

fit_salmonids_fo_algae <- sme(object = salmonids_fo_algae$Marine_ingredient_change, tme = salmonids_fo_algae$Replacement, ind = salmonids_fo_algae$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_fo_algae$info
plot(fit_salmonids_fo_algae, "diagnostic")


plotSmeModel(fit_salmonids_fo_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=30, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))



#Salmonids and yeast


salmonids_fo_yeast <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Salmonids" & Feed_general=="Yeast") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(salmonids_fo_yeast$Replacement), max(salmonids_fo_yeast$Replacement), length.out = 4)[-c(1,4)]

fit_salmonids_fo_yeast <- sme(object = salmonids_fo_yeast$Marine_ingredient_change, tme = salmonids_fo_yeast$Replacement, ind = salmonids_fo_yeast$Study_id, criteria = "AICc",knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_fo_yeast$info
plot(fit_salmonids_fo_yeast, "diagnostic")


plotSmeModel(fit_salmonids_fo_yeast, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=56, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))




#Salmonids and soy


salmonids_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Salmonids" & Feed_general=="Soy") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(salmonids_fo_soy$Replacement), max(salmonids_fo_soy$Replacement), length.out = 4)[-c(1,4)]

fit_salmonids_fo_soy <- sme(object = salmonids_fo_soy$Marine_ingredient_change, tme = salmonids_fo_soy$Replacement, ind = salmonids_fo_soy$Study_id, criteria = "AICc",knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_fo_soy$info
plot(fit_salmonids_fo_soy, "diagnostic")


plotSmeModel(fit_salmonids_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=.75, lty=2, lwd=1, col='black')) ))





#Salmonids and insect


salmonids_fo_insect <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Salmonids" & Feed_general=="Insect") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(salmonids_fo_insect$Replacement), max(salmonids_fo_insect$Replacement), length.out = 4)[-c(1,4)]

fit_salmonids_fo_insect <- sme(object = salmonids_fo_insect$Marine_ingredient_change, tme = salmonids_fo_insect$Replacement, ind = salmonids_fo_insect$Study_id, criteria = "AICc")#,knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_fo_insect$info
plot(fit_salmonids_fo_insect, "diagnostic")


plotSmeModel(fit_salmonids_fo_insect, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))



```

#SHRIMPS
```{r}

shrimps_fo_algae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Shrimps" & Feed_general=="Algae") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(shrimps_fo_algae$Replacement), max(shrimps_fo_algae$Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_fo_algae <- sme(object = shrimps_fo_algae$Marine_ingredient_change, tme = shrimps_fo_algae$Replacement, ind = shrimps_fo_algae$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimps_fo_algae$info
plot(fit_shrimps_fo_algae, "diagnostic")


plotSmeModel(fit_shrimps_fo_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=90, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))





#Shrimps and bacteria


shrimps_fo_bacteria <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Shrimps" & Feed_general=="Bacteria") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)


myknots <- seq(min(shrimps_fo_bacteria$Replacement), max(shrimps_fo_bacteria$Replacement), length.out = 4)[-c(1,4)]

#fit_shrimps_fo_bacteria <- sme(object = shrimps_fo_bacteria$Marine_ingredient_change, tme = shrimps_fo_bacteria$Replacement, ind = shrimps_fo_bacteria$Study_id, criteria = "AICc",knots = myknots,deltaEM = 0.1)

plot(shrimps_fo_bacteria$Replacement, shrimps_fo_bacteria$Marine_ingredient_change, xlim=c(0,100), pch=16, col=alpha("grey50", 0.5), xlab="", ylab="")+
  abline(lm(shrimps_fo_bacteria$Marine_ingredient_change~shrimps_fo_bacteria$Replacement), col="#472D7BFF")




#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimps_fo_bacteria$info
plot(fit_shrimps_fo_bacteria, "diagnostic")


plotSmeModel(fit_shrimps_fo_bacteria, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=90, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))





#Shrimps and yeast 


shrimps_fo_yeast <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Shrimps" & Feed_general=="Yeast") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(shrimps_fo_yeast$Replacement), max(shrimps_fo_yeast$Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_fo_yeast <- sme(object = shrimps_fo_yeast$Marine_ingredient_change, tme = shrimps_fo_yeast$Replacement, ind = shrimps_fo_yeast$Study_id, criteria = "AICc",knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimps_fo_yeast$info
plot(fit_shrimps_fo_yeast, "diagnostic")


plotSmeModel(fit_shrimps_fo_yeast, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=19, lty=2, lwd=1, col='black')),(abline(h=0.21, lty=2, lwd=1, col='black')) ))





#Shrimps and soy


shrimps_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Shrimps" & Feed_general=="Soy") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(shrimps_fo_soy$Replacement), max(shrimps_fo_soy$Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_fo_soy <- sme(object = shrimps_fo_soy$Marine_ingredient_change, tme = shrimps_fo_soy$Replacement, ind = shrimps_fo_soy$Study_id, criteria = "AICc")#,knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimps_fo_soy$info
plot(fit_shrimps_fo_soy, "diagnostic")


plotSmeModel(fit_shrimps_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(h=.9, lty=2, lwd=1, col='black')) ))






#Shrimps and insect


shrimps_fo_insect<- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Shrimps" & Feed_general=="Insect") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(shrimps_fo_insect$Replacement), max(shrimps_fo_insect$Replacement), length.out = 6)[-c(1,6)]

fit_shrimps_fo_insect <- sme(object = shrimps_fo_insect$Marine_ingredient_change, tme = shrimps_fo_insect$Replacement, ind = shrimps_fo_insect$Study_id, criteria = "AICc")#,knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimps_fo_insect$info
plot(fit_shrimps_fo_insect, "diagnostic")


plotSmeModel(fit_shrimps_fo_insect, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(h=100, lty=2, lwd=1, col='black')) ))




```



#MARINE FISHES
```{r}

#Marine fishes and algae

marine_fo_algae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Marine fishes" & Feed_general=="Algae") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(marine_fo_algae$Replacement), max(marine_fo_algae$Replacement), length.out = 4)[-c(1,4)]

fit_marine_fo_algae <- sme(object = marine_fo_algae$Marine_ingredient_change, tme = marine_fo_algae$Replacement, ind = marine_fo_algae$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_fo_algae$info
plot(fit_marine_fo_algae, "diagnostic")


plotSmeModel(fit_marine_fo_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=47, lty=2, lwd=1, col='black')),(abline(h=-1.1, lty=2, lwd=1, col='black')) ))



# Marine fishes and bacteria 




marine_fo_bacteria <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Marine fishes" & Feed_general=="Bacteria") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(marine_fo_bacteria$Replacement),max(marine_fo_bacteria$Replacement), length.out = 5)[-c(1,5)]

fit_marine_fo_bacteria <- sme(object = marine_fo_bacteria$Marine_ingredient_change, tme = marine_fo_bacteria$Replacement, ind = marine_fo_bacteria$Study_id, criteria = "AICc", deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_fo_bacteria$info
plot(fit_marine_fo_bacteria, "diagnostic")


plotSmeModel(fit_marine_fo_bacteria, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=49, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))





# Marine fishes and yeast 




marine_fo_yeast <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Marine fishes" & Feed_general=="Yeast") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(marine_fo_yeast$Replacement),max(marine_fo_yeast$Replacement), length.out = 4)[-c(1,4)]

fit_marine_fo_yeast <- sme(object = marine_fo_yeast$Marine_ingredient_change, tme = marine_fo_yeast$Replacement, ind = marine_fo_yeast$Study_id, criteria = "AICc", knots = myknots)#, deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_fo_yeast$info
plot(fit_marine_fo_yeast, "diagnostic")


plotSmeModel(fit_marine_fo_yeast, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=49, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))

#Plot zero plot and put in table?




# Marine fishes and soy 




marine_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Marine fishes" & Feed_general=="Soy") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(marine_fo_soy$Replacement),max(marine_fo_soy$Replacement), length.out = 4)[-c(1,4)]

fit_marine_fo_soy <- sme(object = marine_fo_soy$Marine_ingredient_change, tme = marine_fo_soy$Replacement, ind = marine_fo_soy$Study_id, criteria = "AICc", deltaNM = 0.1)#, knots = myknots)#, deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_fo_soy$info
plot(fit_marine_fo_soy, "diagnostic")


plotSmeModel(fit_marine_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=1.4, lty=2, lwd=1, col='red')) ))



#Marine fishes amd insect


marine_fo_insect <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Marine fishes" & Feed_general=="Insect") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(marine_fo_insect$Replacement),max(marine_fo_insect$Replacement), length.out = 4)[-c(1,4)]

fit_marine_fo_insect <- sme(object = marine_fo_insect$Marine_ingredient_change, tme = marine_fo_insect$Replacement, ind = marine_fo_insect$Study_id, criteria = "AICc")#, knots = myknots)#, deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_fo_insect$info
plot(fit_marine_fo_insect, "diagnostic")


plotSmeModel(fit_marine_fo_insect, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=78, lty=2, lwd=1, col='black')),(abline(h=-1.1, lty=2, lwd=1, col='red')) ))




```



#FIGURE XX - Fish oil change with fishmeal replacement

```{r}

pdf("Supplementary Figure 2 - fish oil change with FM replacement.pdf", 
    width=7.20472441,
    height=8.1)
op <- par(mfrow=c(9,5), 
          mai=c(0.2,0.3,0.1,0.1), #spacing around each plot
          mgp=c(3,0.5,0), # middle value distance of labels to ticks
          oma = c(3, 3, 3, 3)) #space for the overall x and y axis titles

#carp_algae
plotSmeModel(fit_carp_fo_algae, xlab="",ylab="", xaxt="n", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#FDE725FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(v=0.1, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#carps bacteria
plotSmeModel(fit_carp_fo_bacteria, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#FDE725FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(h=0.1, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#carp_yeast
plotSmeModel(fit_carp_fo_yeast, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#FDE725FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=66, lty=2, lwd=1, col='red'))), abline(h=0, lty=2, lwd=1, col='black'))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#carp_soy
plotSmeModel(fit_carp_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#FDE725FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=66, lty=2, lwd=1, col='red'))), abline(h=0, lty=2, lwd=1, col='black'))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#carp_insects
plotSmeModel(fit_carp_fo_insects, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#FDE725FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=66, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='red'))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#catfish algae
plotSmeModel(fit_catfish_fo_algae, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#AADC32FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=10, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#catfish_bacteria
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#catfish yeast
plotSmeModel(fit_catfishes_fo_yeast, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#AADC32FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=66, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='red'))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#catfish soy
plotSmeModel(fit_catfishes_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#AADC32FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=50, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='red'))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#catfish_insects
plotSmeModel(fit_catfishes_fo_insects, xlab="",ylab="", xaxt="n",showIndividuals=T, showConfidenceBands=T, col.meanCurve="#AADC32FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='red'))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#FW fishes algae
plot(1, type="n", xlab="", ylab="", xaxt="n",xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#FW fishes_bacteria
plot(1, type="n", xlab="", ylab="",xaxt="n", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#FW fishes yeast
plot(1, type="n", xlab="", ylab="", xaxt="n",xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#FW fishes soy
plotSmeModel(fit_fwfishes_fo_soy, xlab="",ylab="", xaxt="n",showIndividuals=T, showConfidenceBands=T, col.meanCurve="#5DC863FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=57, lty=2, lwd=1, col='black')),(abline(h=.9, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#FW fishes_insects
plot(1, type="n", xlab="", ylab="",xaxt="n", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#tilapias algae
plotSmeModel(fit_tilapia_fo_algae, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#5DC863FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=24, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias_bacteria
plotSmeModel(fit_tilapia_fo_bacteria, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#5DC863FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=24, lty=2, lwd=1, col='black')),(abline(h=.46, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#tilapias yeast
plotSmeModel(fit_tilapia_fo_yeast, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#5DC863FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=38, lty=2, lwd=1, col='black')),(abline(h=-.215, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#tilapias soy
plotSmeModel(fit_tilapia_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#5DC863FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=24, lty=2, lwd=1, col='black')),(abline(h=.46, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#tilapias_insects
plotSmeModel(fit_tilapia_fo_insect, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=F, col.meanCurve="#5DC863FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=95, lty=2, lwd=1, col='black')),(abline(h=.46, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#crustaceans algae
plot(1, type="n", xlab="", ylab="",xaxt="n", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#crustaceans_bacteria
plot(1, type="n", xlab="", ylab="",xaxt="n", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#crustaceans yeast
plot(1, type="n", xlab="", ylab="", xaxt="n",xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#crustaceans soy
plotSmeModel(fit_crustaceans_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#21908CFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=67, lty=2, lwd=1, col='black')),(abline(h=1.61, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#crustaceans_insects
plot(1, type="n", xlab="", ylab="",xaxt="n", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#diadromous fishes algae
plotSmeModel(fit_diad_fo_algae, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#2C728EFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=9, lty=2, lwd=1, col='black')),(abline(h=0.25, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#diadromous fishes_bacteria
plot(1, type="n", xlab="", ylab="",xaxt="n", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#diadromous fishes yeast
plot(1, type="n", xlab="", ylab="",xaxt="n", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#diadromous fishes soy
plotSmeModel(fit_diad_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#2C728EFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=70, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#diadromous fishes_insects
plotSmeModel(fit_diad_fo_insect, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#2C728EFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=73, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#salmonids algae
plotSmeModel(fit_salmonids_fo_algae, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=30, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#salmonids_bacteria
plot(1, type="n", xlab="", ylab="",xaxt="n", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#salmonids yeast
plotSmeModel(fit_salmonids_fo_yeast, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=56, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#salmonids soy
plotSmeModel(fit_salmonids_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=.75, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#salmonids_insects
plotSmeModel(fit_salmonids_fo_insect, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#shrimps algae
plotSmeModel(fit_shrimps_fo_algae, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=90, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#shrimps_bacteria
plotSmeModel(fit_shrimps_fo_bacteria, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=90, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#shrimps yeast
plotSmeModel(fit_shrimps_fo_yeast, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=19, lty=2, lwd=1, col='black')),(abline(h=0.21, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#shrimps soy
plotSmeModel(fit_shrimps_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(h=.9, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#shrimps_insects
plotSmeModel(fit_shrimps_fo_insect, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(h=100, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#marine fishes algae
plotSmeModel(fit_marine_fo_algae, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=47, lty=2, lwd=1, col='black')),(abline(h=-1.1, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#marine fishes_bacteria
plotSmeModel(fit_marine_fo_bacteria, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=49, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#marine fishes yeast
plotSmeModel(fit_marine_fo_yeast, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=49, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#marine fishes soy
plotSmeModel(fit_marine_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=1.4, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#marine fishes_insects
plotSmeModel(fit_marine_fo_insect, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=78, lty=2, lwd=1, col='black')),(abline(h=-1.1, lty=2, lwd=1, col='red')) ))
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#tunas algae
# plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
#   abline(0,1, col="grey90")
# axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
# #tunas_bacteria
# plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n")+
#   abline(0,1, col="grey90")
# axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
# #tunas yeast
# plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n")+
#   abline(0,1, col="grey90")
# axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
# #tunas soy
# plotSmeModel(fit_tuna_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3288BD', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=18, lty=2, lwd=1, col='grey20'))))
# axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
# 
# #tunas_insects
# plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n")+
#   abline(0,1, col="grey90")
# axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

mtext("Fishmeal replacement (%)", side = 1, line=1, outer = T)
mtext("Change in dietary fish oil (%)",side = 2, line=1, outer = T)
mtext(c("Algae", "Bacteria", "Yeast", "Soy", "Insects"), side=3, line = 0, outer = T, at=c(.12, .32, .52, .72, .92), cex = 0.8, font=3)
mtext(c("Carps", "Catfishes", "FW fishes", "Tilapias", "Crustaceans", "Diad.fishes", "Salmonids", "Shrimps", "Marine fishes"), side=4, line = 0, outer = T, at=rev(seq(from =.06, to=.95, length.out = 9)), cex = 0.75, font=3)


par(op)
dev.off()


```





#OLD CODE

```{r}
#Data sources for scenario building

#Scenarios - 1. Business as usual 2. Shifting diets in China 3. Faster aquaculture growth to compensate for pescetarian diets




# #Using Tacon and Metian growth rates
# bau_growth_rates <- matrix(data = c(rep(c(1.05,1.04,1.03), each=5), rep(c(1.08,1.06,1.06), each=5), rep(c(1.08,1.06,1.05), each=5), rep(c(1.0,1.0,1.0), each=5), rep(c(1.05,1.05,1.05), each=5), rep(c(1.08,1.06,1.05), each=5) , rep(c(1.08, 1.06,1.05), each=5),rep(c(1.1,1.08,1.05), each=5),rep(c(1.03,1.03,1.03), each=5), rep(c(1.1,1.08,1.08), each=5)), nrow = length(levels(fed_aqua$Broad_group)), ncol=length(seq(2015:2029)), byrow = T)
# 
# rownames(bau_growth_rates) <- levels(fed_aqua$Broad_group)
# colnames(bau_growth_rates) <- seq(2015:2029)
# 
# Carps <-c(fed_aqua.global$Value[fed_aqua.global$Group=="Carps" & fed_aqua.global$Year==2015])
# Catfish <-c(fed_aqua.global$Value[fed_aqua.global$Group=="Catfish" & fed_aqua.global$Year==2015])
# Diadromous_fishes <-c(fed_aqua.global$Value[fed_aqua.global$Group=="Diadromous fishes" & fed_aqua.global$Year==2015])
# Eels <-c(fed_aqua.global$Value[fed_aqua.global$Group=="Eels" & fed_aqua.global$Year==2015])
# FW_Crustaceans <-c(fed_aqua.global$Value[fed_aqua.global$Group=="FW Crustaceans" & fed_aqua.global$Year==2015])
# FW_fishes <-c(fed_aqua.global$Value[fed_aqua.global$Group=="FW fishes" & fed_aqua.global$Year==2015]) 
# Marine_fishes <-c(fed_aqua.global$Value[fed_aqua.global$Group=="Marine fishes" & fed_aqua.global$Year==2015])
# Salmonids <-c(fed_aqua.global$Value[fed_aqua.global$Group=="Salmonids" & fed_aqua.global$Year==2015])
# Shrimps <-c(fed_aqua.global$Value[fed_aqua.global$Group=="Shrimps" & fed_aqua.global$Year==2015])
# Tilapias <-c(fed_aqua.global$Value[fed_aqua.global$Group=="Tilapias" & fed_aqua.global$Year==2015])
# 
# 
# #Carps
# for (i in 1:length(seq(2015:2029))){
#   Carps <- c(Carps, Carps[i]*bau_growth_rates[1,i])
# }
# #Catfish
# for (i in 1:length(seq(2015:2029))){
#   Catfish <- c(Catfish, Catfish[i]*bau_growth_rates[2,i])
# }
# #diadromous fishes
# for (i in 1:length(seq(2015:2029))){
#   Diadromous_fishes <- c(Diadromous_fishes, Diadromous_fishes[i]*bau_growth_rates[3,i])
# }
# #Eels
# for (i in 1:length(seq(2015:2029))){
#   Eels <- c(Eels, Eels[i]*bau_growth_rates[4,i])
# }
# #FW crustaceans
# for (i in 1:length(seq(2015:2029))){
#   FW_Crustaceans <- c(FW_Crustaceans, FW_Crustaceans[i]*bau_growth_rates[5,i])
# }
# #FW fishes
# for (i in 1:length(seq(2015:2029))){
#   FW_fishes <- c(FW_fishes, FW_fishes[i]*bau_growth_rates[6,i])
# }
# #Marine fishes
# for (i in 1:length(seq(2015:2029))){
#   Marine_fishes <- c(Marine_fishes, Marine_fishes[i]*bau_growth_rates[7,i])
# }
# #salmonids
# for (i in 1:length(seq(2015:2029))){
#   Salmonids <- c(Salmonids, Salmonids[i]*bau_growth_rates[8,i])
# }
# #Shrimps
# for (i in 1:length(seq(2015:2029))){
#   Shrimps <- c(Shrimps,Shrimps[i]*bau_growth_rates[9,i])
# }
# #Tilapia
# for (i in 1:length(seq(2015:2029))){
#   Tilapias <- c(Tilapias, Tilapias[i]*bau_growth_rates[10,i])
# }
# 
# rowSums(cbind.data.frame(Carps, Catfish, Diadromous_fishes, Eels, FW_fishes, FW_Crustaceans, Marine_fishes, Salmonids, Shrimps, Tilapias))
# 
# plot(Salmonids)

###################   Tacon and Metian produce ~ 90 million by 2030 with these growth rates - very high - probably won't use for BAU ####



##PROJECTIONS BASED FDOR DIFFERENT GROUPS


# PROJECTION SCENARIO 1 - Business as usual
#Create projections from expected changes to total production and proportional among farmed groups

fed_projections <- data.frame(Year=rep(2050), Group=levels(fed_aqua.global$Group), Value = NA)

fed_projections$Group<-factor(fed_projections$Group, levels(fed_projections$Group)[c(1,11,12,2,10, 5, 3, 6, 4, 7, 8, 9)])



#Expected doubled fed aquaculture production to 2050 - see Froehlich 2018 & Tilman and Clark 

Proj_total <- 2* sum(fed_aqua.global$Value[fed_aqua.global$Year==2015])
Growth_rates <- data.frame(Group = levels(fed_aqua.global$Group), Growth= c(1.02, 1.04, 1.04, 1, 1, 1.02, 1,1,1,1,1,0.996 ))



#Calculate the change in production assuming growth rates from impact model (conservative as this is growth in share of total production -  not fed production) - see World Bank to 2030


for (i in 1:length(levels(fed_aqua.global$Group))){
  Prop <- sum(fed_aqua.global$Value[fed_aqua.global$Group==levels(fed_aqua.global$Group)[i] & fed_aqua.global$Year==2015])/ sum(fed_aqua.global$Value[fed_aqua.global$Year==2015])
  fed_projections$Value[i] <- Proj_total*(Prop*Growth_rates$Growth[i])
}

years <- seq(from = 2015, to = 2049, by=1)

interpolations <- data.frame(Year = rep(years, length(levels(fed_projections$Group))), Group=rep(levels(fed_projections$Group), each=length(years),1))

interpolations$Group<-factor(interpolations$Group, levels(interpolations$Group)[c(1,11,12,2,10, 5, 3, 6, 4, 7, 8, 9)])


#add the current data for 2015 for new projections layer

interpolations$Value <- NA
for (i in 1:length(levels(fed_aqua.global$Group))){
  interpolations$Value[interpolations$Group==levels(interpolations$Group)[i] & interpolations$Year==2015] <- fed_aqua.global$Value[fed_aqua.global$Group==levels(fed_aqua.global$Group)[i] & fed_aqua.global$Year==2015]
}

# add 2050 projections and interpolate between 2015 and 2050
fed_projections <- rbind(interpolations, fed_projections)
fed_projections <- arrange(fed_projections, (Group), (Year))

for (i in 1:length(levels(fed_projections$Group))){
  fed_projections$Value[fed_projections$Group==levels(fed_projections$Group)[i]]<-na.approx(fed_projections$Value[fed_projections$Group==levels(fed_projections$Group)[i]])

}

fed_projections








#test if this works in the plot
ggplot(data = fed_aqua.global, aes(x=Year, y=(Value), colour=Group))+
  geom_line()+
  geom_line(data = fed_projections,aes(x=Year, y=Value, colour=Group), linetype=2)+
  theme_bw()+
  theme(panel.grid = element_blank(), 
        legend.text = element_text(size=6),
        legend.title = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8))+
  scale_x_continuous(limits = c(1950,2055))+
  scale_y_continuous()+
  geom_vline(xintercept = 2015, lty=2)+
  labs(y=bquote(Production~(T~x10^6)))+
  guides(colour=F)

ggsave("basic linear proj.tiff", device = "tiff", dpi=600, width = 9, height = 6, unit="cm")





#add scenarios for confidence around trajectories

#PROJECTIONS SCENARIO 2 - Shifting preference to high value fish in china

China_Proj_total <- Proj_total*1.24
Growth_rates <- data.frame(Group = levels(fed_aqua.global$Group), Growth= c(1.03, 3.11, 1.03, 1.03, 2.96, 1.03, 3.05 , 0.96, 1.03, 0.96, 0.96 ,0.87))


Chn_projections <- data.frame(Year=rep(2050), Group=levels(fed_aqua.global$Group), Value = (NA) )


for (i in 1:length(levels(fed_aqua.global$Group))){
  Chn_projections$Value[i]<- fed_projections$Value[fed_projections$Year==2050 & fed_projections$Group==levels(fed_aqua.global$Group)[i]]*Growth_rates$Growth[i]
}

#add 2015 and 2050 data from data and projections and interpolate

interpolations <- data.frame(Year = rep(years, length(levels(fed_projections$Group))), Group=rep(levels(fed_projections$Group), each=length(years),1))

interpolations$Group<-factor(interpolations$Group, levels(interpolations$Group)[c(1,11,12,2,10, 5, 3, 6, 4, 7, 8, 9)])


#add the current data for 2015 for new projections layer

interpolations$Value <- NA
for (i in 1:length(levels(fed_aqua.global$Group))){
  interpolations$Value[interpolations$Group==levels(interpolations$Group)[i] & interpolations$Year==2015] <- fed_aqua.global$Value[fed_aqua.global$Group==levels(fed_aqua.global$Group)[i] & fed_aqua.global$Year==2015]
}

# add 2050 projections and interpolate between 2015 and 2050
Chn_projections <- rbind(interpolations, Chn_projections)
Chn_projections <- arrange(Chn_projections, (Group), (Year))


for (i in 1:length(levels(Chn_projections$Group))){
  Chn_projections$Value[Chn_projections$Group==levels(Chn_projections$Group)[i]]<-na.approx(Chn_projections$Value[Chn_projections$Group==levels(Chn_projections$Group)[i]])

}

#test china projections work with plot

ggplot(data = fed_aqua.global, aes(x=Year, y=(Value), colour=Group))+
  geom_line()+
  geom_line(data = Chn_projections,aes(x=Year, y=Value, colour=Group), linetype="dotted")+
  theme_bw()+
  theme(panel.grid = element_blank(), 
        legend.text = element_text(size=6),
        legend.title = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8))+
  scale_x_continuous(limits = c(1950,2055))+
  scale_y_continuous()+
  geom_vline(xintercept = 2015, lty=2)+
  labs(y=bquote(Production~(T~x10^6)))+
  guides(colour=F)


# SCENARIO THREE - PESCETARIAN DIETS


pesc_projections <- data.frame(Year=rep(2050), Group=levels(fed_aqua.global$Group), Value = NA )

pesc_projections$Group<-factor(pesc_projections$Group, levels(pesc_projections$Group)[c(1,11,12,2,10, 5, 3, 6, 4, 7, 8, 9)])



#Expected tripled fed aquaculture production to 2050 under rapid change scenario - see Froehlich 2018 & Tilman and Clark 

Pesc_Proj_total <- 3* sum(fed_aqua.global$Value[fed_aqua.global$Year==2015])
Growth_rates <- data.frame(Group = levels(fed_aqua.global$Group), Growth= c(1.04, 1.1, 1.29, 1.01, 1.11, 1.01, 1.09, 1.06, 1.02, 1.36, 1.15, 0.998))



#Calculate the change in production assuming growth rates from impact model (conservative as this is growth in share of total production -  not fed production) - see World Bank to 2030


for (i in 1:length(levels(fed_projections$Group))){
  Prop <- sum(fed_aqua.global$Value[fed_aqua.global$Group==levels(fed_aqua.global$Group)[i] & fed_aqua.global$Year==2015])/ sum(fed_aqua.global$Value[fed_aqua.global$Year==2015])
  pesc_projections$Value[i] <- (Pesc_Proj_total*Prop)*Growth_rates$Growth[i]
}

#Adjust new production to stay in line with x3 growth
adj<-Pesc_Proj_total/ sum(pesc_projections$Value)

pesc_projections$Value <- pesc_projections$Value*adj



years <- seq(from = 2015, to = 2049, by=1)

interpolations <- data.frame(Year = rep(years, length(levels(pesc_projections$Group))), Group=rep(levels(pesc_projections$Group), each=length(years),1))

interpolations$Group<-factor(interpolations$Group, levels(interpolations$Group)[c(1,11,12,2,10, 5, 3, 6, 4, 7, 8, 9)])


#add the current data for 2015 for new projections layer

interpolations$Value <- NA
for (i in 1:length(levels(fed_aqua.global$Group))){
  interpolations$Value[interpolations$Group==levels(interpolations$Group)[i] & interpolations$Year==2015] <- fed_aqua.global$Value[fed_aqua.global$Group==levels(fed_aqua.global$Group)[i] & fed_aqua.global$Year==2015]
}

# add 2050 projections and interpolate between 2015 and 2050
pesc_projections <- rbind(interpolations, pesc_projections)
pesc_projections <- arrange(pesc_projections, (Group), (Year))

for (i in 1:length(levels(pesc_projections$Group))){
  pesc_projections$Value[pesc_projections$Group==levels(pesc_projections$Group)[i]]<-na.approx(pesc_projections$Value[pesc_projections$Group==levels(pesc_projections$Group)[i]])

}

pesc_projections


ggplot(data = fed_aqua.global, aes(x=Year, y=(Value), colour=Group))+
  geom_line()+
  geom_line(data = pesc_projections,aes(x=Year, y=Value, colour=Group), linetype=2)+
  theme_bw()+
  theme(panel.grid = element_blank(), 
        legend.text = element_text(size=6),
        legend.title = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8))+
  scale_x_continuous(limits = c(1950,2055))+
  scale_y_continuous()+
  geom_vline(xintercept = 2015, lty=2)+
  labs(y=bquote(Production~(T~x10^6)))+
  guides(colour=F)

ggsave("basic linear proj.tiff", device = "tiff", dpi=600, width = 9, height = 6, unit="cm")


#now create min and maxs of all projections from the scenarios

Proj_all <-cbind.data.frame(fed_projections$Value, Chn_projections$Value, pesc_projections$Value)
names(Proj_all)[1] <- "BAU"
names(Proj_all)[2] <- "CHN"
names(Proj_all)[3] <- "PESC"

Proj_all$Group <- fed_projections$Group
Proj_all$Year <- fed_projections$Year
Proj_all$min <- pmin(Proj_all$BAU, Proj_all$CHN, Proj_all$PESC)
Proj_all$max <- pmax(Proj_all$BAU, Proj_all$CHN, Proj_all$PESC)
Proj_all$Value <- rowMeans(Proj_all[,c(6,7)])

Proj_all$Group <-factor(Proj_all$Group, levels(Proj_all$Group)[c(1:5, 8, 7,9, 6,10,11,12)])



#make indepdent legend
cbbPalette <- c("#000000", "#009E73", "#e79f00", "#9ad0f3", "#0072B2", "#D55E00", 
    "#CC79A7", "#F0E442")

colourCount <- length(unique(Proj_all$Group))
cols <- colorRampPalette(cbbPalette)
#Colours
#"#000000" "#006449" "#7DBEE7" "#D29E0A" "#BCB984" "#3F9E53" "#1C83BD" "#606861" "#D4600F" "#CE7179" #"#D99F82" "#F0E442"

#create custom legend
# ggplot()+
#   theme(panel.grid = element_blank(),
#         panel.background = element_blank(),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         axis.title = element_blank())+
#   scale_x_continuous(limits=c(0,1.4))+
#   scale_y_continuous(limits=c(0.1,1.3))+
#   annotate("segment", x=c(0.0, 0.0,0,0,0,0), xend = c(0.1, 0.1, 0.1, 0.1, 0.1, 0.1), y=c(1.2, 1, 0.8, 0.6, 0.4, 0.2), yend = c(1.2, 1, 0.8, 0.6, 0.4, 0.2), colour = c("#000000", "#006449", "#3F9E53", "#D29E0A", "#BCB984" ,"#7DBEE7"), size=1)+
#   annotate("text", x=c(0.16, 0.17, 0.17, 0.17, 0.20, 0.28), y=c(1.2, 1, 0.8, 0.6, 0.4, 0.2), label =c("Carp", "Shrimp", "Tilapia", "Catfish", "Salmonids", "Freshwater fish, other"))+
#   annotate("segment", x=c(0.65, 0.65,0.65,0.65,0.65,0.65), xend = c(0.75, 0.75, 0.75, 0.75, 0.75, 0.75), y=c(1.2, 1, 0.8, 0.6, 0.4, 0.2), yend = c(1.2, 1, 0.8, 0.6, 0.4, 0.2), colour = c("#1C83BD", "#606861", "#D4600F", "#CE7179", "#D99F82", "#F0E442"), size=1)+
#   annotate("text", x=c(0.91, 0.88, 0.81, 0.9, 0.82, 0.9), y=c(1.2, 1, 0.8, 0.6, 0.4, 0.2), label =c("Crustaceans, other", "Demersal fish", "Eels", "Marine fish, other" , "Mullet" ,                "Pelagic fish, other"))+
#   annotation_custom(grob = carp_img, xmin = 0.25, xmax = 0.4, ymin=1.1, ymax = 1.3)+
#   annotation_custom(grob = shrimp_img, xmin = 0.25, xmax = 0.4, ymin=0.9, ymax = 1.1)+
#   annotation_custom(grob = tilapia_img, xmin = 0.25, xmax = 0.4, ymin=0.7, ymax = 0.9)+
#   annotation_custom(grob = catfish_img, xmin = 0.25, xmax = 0.43, ymin=0.5, ymax = 0.7)+
#   annotation_custom(grob = salmon_img, xmin = 0.3, xmax = 0.47, ymin=0.3, ymax = 0.5)+
#   annotation_custom(grob = snakehead_img, xmin = 0.47, xmax = 0.6, ymin=0.1, ymax = 0.3)+
#   annotation_custom(grob = crab_img, xmin = 1, xmax = 1.3, ymin=1.1, ymax = 1.26)+
#   annotation_custom(grob = bass_img, xmin = 1, xmax = 1.21, ymin=0.9, ymax = 1.1)+
#   annotation_custom(grob = eel_img, xmin = 0.85, xmax = 1.1, ymin=0.7, ymax = 0.9)+
#   annotation_custom(grob = grouper_img, xmin = 1.05, xmax = 1.25, ymin=0.5, ymax = 0.7)+
#   annotation_custom(grob = mullet_img, xmin = 0.89, xmax = 1.07, ymin=0.3, ymax = 0.5)+
#   annotation_custom(grob = jack_img, xmin = 1.08, xmax = 1.26, ymin=0.1, ymax = 0.3)
# 
# 
# ggsave("f1legend.png", device = "png", dpi=300, width=18, height=13, units="cm")

# legend_grob <- readPNG("f1legend.png")
# legend_grob <-rasterGrob(legend_grob, interpolate = T)

BAU <- Proj_all[,c(1,4,5)]
names(BAU)[1] <-"Value"
CHN <- Proj_all[,c(2,4,5)]
names(CHN)[1] <-"Value"
PESC <- Proj_all[,c(3,4,5)]
names(PESC)[1] <-"Value"




#MAIN PLOT
(fig1 <- ggplot(data = fed_aqua.global, aes(x=Year, y=Value, colour=Group))+
  #annotation_custom(legend_grob, xmin = 1932, xmax = 2035, ymin = 19e+06, ymax = 55e+06)+
  geom_line(size=0.4)+
  geom_ribbon(data = Proj_all, aes(x=Year, ymin=min, ymax=max, fill=Group), colour=NA, alpha=0.08)+
  # geom_line(data = BAU, aes(x=Year, y=Value, colour=Group), linetype="dashed", size=0.3)+
  # geom_line(data = CHN, aes(x=Year, y=Value, colour=Group), linetype="dotted", size=0.3)+
  # geom_line(data = PESC, aes(x=Year, y=Value, colour=Group), linetype="dotdash", size=0.3)+
  geom_line(data = Proj_all, aes(x=Year, y=Value, colour=Group), linetype="dashed", size=0.3)+
  theme_bw()+
  scale_colour_manual(values=c("#000000" ,"#006449", "#7DBEE7", "#D29E0A", "#BCB984", "#3F9E53", "#1C83BD", "#606861", "#D4600F", "#CE7179", "#D99F82", "#F0E442"))+
  scale_fill_manual(values=c("#000000" ,"#006449", "#7DBEE7", "#D29E0A", "#BCB984", "#3F9E53", "#1C83BD", "#606861", "#D4600F", "#CE7179", "#D99F82", "#F0E442"))+
  theme(panel.grid = element_blank(), 
        legend.text = element_text(size=6),
        legend.title = element_blank(),
        legend.key.size = unit(0.3,"cm"),
        legend.background = element_blank(),
        legend.position = c(0.3, 0.85),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8))+
  scale_x_continuous(limits = c(1950,2030), breaks = c(1950, 1970, 1990, 2010, 2030), labels = c(1950, 1970, 1990, 2010, 2030))+
  scale_y_continuous(breaks = c(0, 1e+07, 2e+07, 3e+07, 4e+07, 5e+07), labels = c(0,10,20,30,40,50), limits = c(0, 3.28e+07))+
  geom_vline(xintercept = 2015, lty=2)+
  labs(y=bquote(Production~(T~x10^6)))+
  guides(colour=guide_legend(ncol = 2), fill=F))  

ggsave("f1maint.tiff", device = "tiff", width=9, height=7, units = "cm")



  # annotation_custom(carp_img, xmin = 2050, xmax = 2060, ymin = c(42e+06), ymax = 44e+06)+ 
  # annotation_custom(shrimp_img, xmin = 2050, xmax = 2060, ymin = c(18e+06), ymax = 24e+06)+ 
  # annotation_custom(salmon_img, xmin = 2050, xmax = 2060, ymin = c(9e+06), ymax = 15e+06)+ 
  # annotation_custom(tilapia_img, xmin = 2050, xmax = 2060, ymin = c(6e+06), ymax = 12e+06)+ 
  # annotation_custom(catfish_img, xmin = 2050, xmax = 2060, ymin = c(5e+06), ymax = 11e+06)+ 
  # annotation_custom(snakehead_img, xmin = 2050, xmax = 2060, ymin = c(4e+06), ymax = 10e+06)+ 
  # annotation_custom(bass_img, xmin = 2050, xmax = 2060, ymin = c(3e+06), ymax = 9e+06)+ 
  # annotation_custom(eel_img, xmin = 2050, xmax = 2060, ymin = c(2e+06), ymax = 8e+06)+ 
  # annotation_custom(grouper_img, xmin = 2050, xmax = 2060, ymin = c(1e+06), ymax = 7e+06)+ 
  # annotation_custom(mullet_img, xmin = 2050, xmax = 2060, ymin = c(0.1e+06), ymax = 6.1e+06)+ 
  # annotation_custom(jack_img, xmin = 2050, xmax = 2060, ymin = c(-0.5e+06), ymax = 5.5e+06)+ 
  # annotation_custom(carp_img, xmin = 2050, xmax = 2060, ymin = c(-1e+06), ymax = 5e+06)



(fed_aqua_proj[1,])
class(fed_aqua_proj[1,])

lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row){
  x <- fed_aqua_proj[target_row,]
  print(x)
})
  
x <- list(foo = "", bar = 0)
bind_rows(rep(list(x), 2))


Production_list <- lapply(Countries_list_of_df, function(target_country){
  # expand.grid(Country=target_country$Country,
  #             Broad_group=target_country$Broad_group,
  #             Current_production = target_country$Value)
   data.frame(Country=target_country$Country,
               Broad_group=target_country$Broad_group,
               Current_production = target_country$Value)

    })

length(Countries_df[[2]]$Broad_group)
Production_list[[2]]
names(fed_aqua_proj)


Countries_df[[2]][["Broad_group"]]

a_different_a <- bind_rows(
  lapply(feeds_as_list, function(target_animal){
    x <- target_animal[["FCR_min"]]*0.5; 
    y <- target_animal[["FCR_max"]]; 
    z <- abs(y-x); 
    out_df <- data.frame(testx=x, y=y, z=z); 
    return(out_df) 
  }), 
.id="Broad Group"
)





ggsave("basic linear proj with scenarios.tiff", device = "tiff", dpi=600, width = 9, height = 7, unit="cm")

```

# ADD DIET INFORMATION TO PRODUCTION TRENDS TO CALCULATE CHANGING DEMANDS FOR SEAFOOD


```{r}






```





#need to assign diets at species levels then calculate current demands

sum(fed_aqua$Value[fed_aqua$Species %in% c("Catla", "Roho labeo", "Mrigal carp") & fed_aqua$Year==2015])/sum(fed_aqua$Value[fed_aqua$Broad_group=="Carp" & fed_aqua$Year==2015]) #Indian Major carps represent 28% of carp production in 2015 - assume that 10% are fed (from Pahlow 2015) - so subtract 90% of IMC from carp production so....

sum(fed_aqua$Value[fed_aqua$Species %in% c("Catla", "Roho labeo", "Mrigal carp") & fed_aqua$Year==2015])/sum(fed_aqua$Value[fed_aqua$Broad_group=="Carp" & fed_aqua$Year==2015])*0.9 #i.e. subtract 25.4% from carp production if doing by totals







fed_aqua <- arrange(fed_aqua, desc(Year), desc(Value))
diets<-read.csv("fishmeal diet data.csv", header = T)

fed_aqua_plot1<-  filter(fed_aqua, fed_aqua$Year %in% c(2015)) %>% group_by(Broad_group) %>% summarise(sum(Value))

ggplot(data=fed_aqua_plot1, aes(x=reorder(Broad_group, -`sum(Value)`), y=`sum(Value)`))+geom_bar(stat = "identity")+guides(fill=F)+coord_flip()







diets2 <- aggregate(diets$Percent ~ diets$Species+diets$Ingredient+diets$FCR, FUN = mean)
diets2 <- aggregate(diets2$`diets$Percent` ~ diets2$`diets$Species` +diets2$`diets$FCR`, FUN = sum)
names(diets2)[1] <- "Species"
names(diets2)[2] <- "FCR"
names(diets2)[3] <- "Percent"



fed_aqua_diets <- left_join(fed_aqua, diets2, by="Species")
names(fed_aqua_diets)


fed_aqua_diets$Prop <- fed_aqua_diets$Percent/100

## Total fishmeal/oil demand = total production * proportion of feed from fishmeal oil * FCR 

#work out consumption based on average of 2013-2015

fed_aqua_diets <- fed_aqua_diets[fed_aqua_diets$Year>2012,]

#sum country production
fed_aqua_diets <-  aggregate(fed_aqua_diets$Value ~ fed_aqua_diets$Species +fed_aqua_diets$Broad_group + fed_aqua_diets$Year  +  fed_aqua_diets$FCR + fed_aqua_diets$Prop, FUN = sum)

#mean across 2013 to 2015
fed_aqua_diets<-aggregate(fed_aqua_diets$`fed_aqua_diets$Value` ~ fed_aqua_diets$`fed_aqua_diets$Species` + fed_aqua_diets$`fed_aqua_diets$Broad_group` + fed_aqua_diets$`fed_aqua_diets$FCR` + fed_aqua_diets$`fed_aqua_diets$Prop`, FUN = mean)

names(fed_aqua_diets)[1] <- "Species"
names(fed_aqua_diets)[2] <- "Broad_group"
names(fed_aqua_diets)[3] <- "FCR"
names(fed_aqua_diets)[4] <- "Prop"
names(fed_aqua_diets)[5] <- "Value"

#current consumption levels

#make assumption that 10% of IMC are fed so adjust production value

fed_aqua_diets$Value[fed_aqua_diets$Species %in% c("Catla", "Roho labeo", "Mrigal carp")] <- fed_aqua_diets$Value[fed_aqua_diets$Species %in% c("Catla", "Roho labeo", "Mrigal carp")]*0.1

sum(fed_aqua_diets$Value) #average total production at 31 million tonnes of fed aquaculture across 2013 - 2015


fed_aqua_diets$Consumption <- fed_aqua_diets$Prop * fed_aqua_diets$FCR * fed_aqua_diets$Value
fed_aqua_diets$Scenario <-NA

sum(fed_aqua_diets$Consumption)
fed_aqua_diets$Broad_group <- as.factor(fed_aqua_diets$Broad_group)

fed_summary <- aggregate(fed_aqua_diets$Consumption ~ fed_aqua_diets$Broad_group, FUN = sum)
names(fed_summary)[1] <- "Broad_group"
names(fed_summary)[2] <- "Consumption"

fed_summary <- arrange(fed_summary, desc(Consumption))
levels(fed_summary$Broad_group)
fed_summary


ggplot(data=fed_summary, aes(x=reorder(Broad_group, -Consumption),y=Consumption))+geom_bar(stat="identity", fill="blue4")+coord_flip()


```

```{r}
ToothGrowth

data1 <- data.frame(
  group=c("A","A","A","A","B","B","B","B"), 
  x= c(1,2,3,4,5,6,7,8),
  y = c(1,2,3,4,5,6,7,8), 
  z= c(10,20,30,40,50,60,70,80))  

```
data2 <- data1 %>% 
  gather(key = Metric, value = Value, -group) %>%
  group_by(group, Metric) %>%
  summarise(
    MU = mean(Value),
    SD = sd(Value, na.rm = TRUE),
    N = sum(!is.na(Value)),
    upper_limit = MU + SD/sqrt(N),
    lower_limit = MU - SD/sqrt(N)
  )


data2 <- data1 %>% 
  gather(key = Metric, value = Value, -group, -x) %>%
  group_by(group, Metric) %>%
  summarise(
    MU = mean(Value),
    SD = sd(Value, na.rm = TRUE),
    N = sum(!is.na(Value)),
    upper_limit = MU + SD/sqrt(N),
    lower_limit = MU - SD/sqrt(N)
  )



```

