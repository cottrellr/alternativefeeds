---
title: "Alternative aquafeeds"
author: "Richard Cottrell"
date: "11 May 2018"
output: word_document
---
#LIBRARIES
```{r}

#devtools::install_github("dill/beyonce")
#devtools::install_github('LaCroixColoR','johannesbjork')


library(gridExtra)
library(data.table)
library(purrr)
library(mgcv)
library(visreg)
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(devtools)
library(readr)
library(broom)
library(stringr)
library(ggsci)
library(ggforce) #geom circle and others
library(ggpubr) #ggarrange
library(png) #load png files
library(grid) 
library(taxize)
library(zoo)
library(colorspace)
library(grDevices)
library(RColorBrewer)
library(scales)
library(viridis)
library(car)
library(sme)
library(beyonce)
library(LaCroixColoR)
library(pBrackets)#curly brackets

```

#CUSTOM GROBS
```{r}

#bracket shape on ggplot
bracketsGrob <- function(...){
l <- list(...)
e <- new.env()
e$l <- l
  grid:::recordGrob(  {
    do.call(grid.brackets, l)
  }, e)
}



#theme for ggplto


theme_nothing <- 
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank())

```


####AQUACULTURE PRODUCTION DATA AND FED SPECIES

```{r}
 
#Sort the symbols in values out
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information

fed_spp <- fread("fed_spp.csv", header=TRUE) %>% 
  rename(Species="Name_en") %>%
  group_by(Species) %>%
  mutate(id = row_number()) #data  from Halley Froehlich




prod.aqua <-
  fread("aquaculture-prod-raw.csv", header=T) %>% 
  rename(Country="Country (Country)",
         Species="Species (ASFIS species)" ,
         Area="Aquaculture area (FAO major fishing area)",
         Environment="Environment (Environment)")%>% 
  gather(Year, Value, -c(Country, Species, Area, Environment, Unit)) %>% 
  mutate(Year = gsub("X", "", Year) %>% 
           as.numeric) %>% 
  mutate(Value = case_when(Value=="0 0" ~ "0.5",
                           Value=="-" ~ "0",
                           T ~ Value)) %>% 
  filter(!(Value=="..." | Value=="") | Country=="Totals") %>% 
  mutate(Value = gsub(" F", "", Value) %>% 
           as.numeric) %>%
  select(-Unit) %>% 
  group_by(Country, Species, Area, Year, Environment) %>%
  mutate(id= row_number()) %>% 
  filter(Species %in% fed_spp$Species) %>% 
  left_join(.,fed_spp, by=c("Species", "id"))%>% 
  mutate(Taxa_adj = case_when(Taxa %in% c("Trouts", "Salmons", "Smelts") ~ "Salmonids",
                              Taxa %in% c("Flatfishes","Marine fishes","Cods") ~ "Marine fishes",
                              Taxa == "Shrimps" ~ "Shrimps",
                              Taxa == "Carps" ~ "Carps",
                              Taxa == "FW fishes" ~ "FW fishes",
                              Taxa == "FW crustaceans" ~ "FW crustaceans",
                              Taxa == "Marine crustaceans" ~ "Marine crustaceans",
                              Taxa == "Diadromous fishes" ~ "Diadromous fishes",
                              Taxa == "Tilapias" ~ "Tilapias",
                              Taxa == "Eels" ~ "Eels",
                              Taxa == "Shads" ~ "FW fishes",
                              Taxa == "Tunas" ~ "Tunas",
                              T ~ Taxa)) 
  

#rev(lacroix_palette("PassionFruit", n=4, "continuous"))

```


#### IMPORT SPECIES PICS
```{r}

# IMPORT AND NAME IMAGES

carp_img<- readPNG("carp.png")
carp_img <- rasterGrob(carp_img, interpolate = T)

shrimp_img<- readPNG("shrimp.png")
shrimp_img <- rasterGrob(shrimp_img, interpolate = T)

salmon_img<- readPNG("salmon.png")
salmon_img <- rasterGrob(salmon_img, interpolate = T)
 
tilapia_img<- readPNG("tilapia.png")
tilapia_img <- rasterGrob(tilapia_img, interpolate = T)

catfish_img<- readPNG("catfish.png")
catfish_img <- rasterGrob(catfish_img, interpolate = T)

snakehead_img<- readPNG("snakehead.png")
snakehead_img <- rasterGrob(snakehead_img, interpolate = T)

crab_img<- readPNG("crab.png")
crab_img <- rasterGrob(crab_img, interpolate = T)

bass_img<- readPNG("bass.png")
bass_img <- rasterGrob(bass_img, interpolate = T)

eel_img<- readPNG("eel.png")
eel_img <- rasterGrob(eel_img, interpolate = T)

grouper_img<- readPNG("grouper.png")
grouper_img <- rasterGrob(grouper_img, interpolate = T)

mullet_img<- readPNG("mullet.png")
mullet_img <- rasterGrob(mullet_img, interpolate = T)

jack_img<- readPNG("jack.png")
jack_img <- rasterGrob(jack_img, interpolate = T)


aqua_img<- readPNG("Aquapen.png")
aqua_img <- rasterGrob(aqua_img, interpolate = T)

```



###### CONSUMPTION SIMULATIONS ACROSS ALL SCENARIOS - Current Diets
```{r}
# Construct diet information table for FCRs and fishmeal inclusion and percentage fed


#Tacon and Metain 2015 Feed matters - Pahlow 2015 Water footprint - Tacon and Metian 2008 Fishmeal inclusion - Chiu 2013 Fishmeal use in China


feeds <- 
  fread("diets.csv", header=T)


feeds_as_list <- split(feeds, feeds$Group)

MEDCs <- c("Canada", "United States of America", "Austria", "Belgium", "Denmark", "Finland", "France", "Germany", "Greece", "Ireland", "Italy", "Luxembourg", "Netherlands", "Portugal",  "Spain", "Sweden", "United Kingdom", "Bulgaria", "Croatia", "Cyprus","Czechia", "Estonia", "Hungary", "Latvia", "Lithuania", "Malta", "Poland", "Romania", "Slovakia", "Slovenia", "Iceland","Norway", "Switzerland", "Australia", "Japan", "New Zealand")

LDCs<- c("Angola", "Benin", "Burkina Faso" ,"Burundi","Central African Republic", "Chad", "Comoros", "Congo, Dem. Rep. of the",  "Djibouti", "Eritrea", "Ethiopia", "Gambia" , "Guinea", "Guinea-Bissau", "Lesotho", "Liberia", "Madagascar", "Malawi", "Mali", "Mauritania", "Mozambique", "Niger", "Rwanda", "Sao Tome and Principe", "Senegal", "Sierra Leone", "Somalia", "South Sudan", "Sudan", "Togo", "Uganda", "Tanzania, United Rep. of", "Zambia", "Cambodia", "Kiribati", "Lao People's Dem. Rep.", "Myanmar", "Solomon Islands", "Timor Leste", "Tuvalu", "Vanuatu", "Afghanistan", "Bangladesh", "Bhutan", "Nepal", "Yemen", "Haiti")

#Create data frame with projections in different columns

fed_aqua_proj <- 
  prod.aqua %>%
  filter(Year==2015) %>% 
  mutate(FAO_2030 = case_when(Country %in% MEDCs ~ Value*1.281,
                              Country %in% LDCs ~ Value*1.463,
                              T ~ Value*1.37)) %>% 
  mutate(WorldBank_RG_2030 = case_when(Country %in% MEDCs ~ Value*1.42,
                           Country %in% LDCs ~ Value*1.69,
                           T ~Value*1.56)) %>% 
  mutate(WorldBank_CD_2030 = case_when(Taxa_adj %in% c("Shrimps", "Salmonids", "FW crustaceans","Marine crustaceans", "Tunas") ~ Value*3,
                           T ~ FAO_2030))









#DEMAND SIMULATIONS 

a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Taxa"]]]] 
    
    #assign consumption parameters
    b <- runif(n = 1, min = a[["FCR_min"]], max = a[["FCR_max"]])  # assign random fcr from group range
    c <- runif(n = 1, min = a[["FM_min"]], max = a[["FM_max"]])   # assign random fishmeal inclusion from range 
    d <- runif(n = 1, min = a[["FO_min"]], max = a[["FO_max"]])   #assign random fish oil inclusion from range
    e <- runif(n = 1, min = a[["Fed_min"]], max = a[["Fed_max"]])    #assign random fed proportion from 2015 -2025 range
    f <- a[["Fed_max"]]    # assume highest proportion are fed for future scenarios
    
    #Consumption calculations
    
    #current consumption
    g <- target_row[["Value"]]*b*c*e    #fm demand
    h <- g/0.225       # forage fish biomass needed for fm demand
    i <- target_row[["Value"]]*b*d*e    #fo demand
    j <- h*0.05   # amount of fish oil coming from the fm biomass
    k <- (i-j)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    l <-  case_when(i<j ~ h-(j-i),
                    T ~ h+k) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
                   
    
    #FAO_2030 projections
    m <- target_row[["FAO_2030"]]*b*c*f    #fm demand
    n <- m/0.225       # forage fish biomass needed for fm demand
    o <- target_row[["FAO_2030"]]*b*d*f    #fo demand
    p <- n*0.05   # amount of fish oil coming from the fm biomass
    q <- (o-p)/0.05
    r <- case_when(o<p ~ n-(p-o),
                    T ~ n+q)
    
    # faster aquaculture growth
    s <- target_row[["WorldBank_RG_2030"]]*b*c*f    #fm demand
    t <- s/0.225       # forage fish biomass needed for fm demand
    u <- target_row[["WorldBank_RG_2030"]]*b*d*f    #fo demand
    v <- t*0.05   #amount of fish oil coming from the fm biomass
    w <- (u-v)/0.05
    x <- case_when(u<v ~ t-(v-u),
                    T ~ t+w)
    
    # chinese dietary shift
    aa <- target_row[["WorldBank_CD_2030"]]*b*c*f    #fm demand
    bb <- aa/0.225       # forage fish biomass needed for fm demand
    cc <- target_row[["WorldBank_CD_2030"]]*b*d*f    #fo demand
    dd <- bb*0.05   # amount of fish oil coming from the fm biomass
    ee <- (cc-dd)/0.05
    ff <- case_when(cc<dd ~ bb-(dd-cc),
                    T ~ bb+ee)
    
    # #chinese + more efficient scenario (fcrs decrease by 0.2)
    # gg <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*c*f    #fm demand
    # hh <- gg/0.225       # forage fish biomass needed for fm demand
    # ii <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*d*f    #fo demand
    # jj <- hh*0.05   # amount of fish oil coming from the fm biomass
    # kk <- (ii-jj)/0.05
    # ll <- case_when(kk>=0 ~ hh+kk,
    #                kk<0 ~ hh)
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        #params
        fcr=b, 
        fm=c, 
        fo=d,  
        fed=e, 
        fed_future = f, 
        
        #2015 consumption
        fm_demand_2015 = g, 
        fm_biomass_2015 = h,
        fo_demand_2015 = i,
        fo_from_fm_2015 = j, 
        surplus_2015 = k,
        consumption_2015 = l,
        
        #baseline consumption
        fao_demand = m, 
        fao_fm_biomass = n,
        fao_fo_demand = o,
        fao_from_fm = p, 
        fao_surplus = q,
        fao_consumption = r,
        
        #pesc consumption
        WB_RG_demand = s, 
        WB_RG_biomass = t,
        WB_RG_demand = u,
        WB_RG_from_fm = v, 
        WB_RG_surplus = w,
        WB_RG_consumption = x,
        
        #chinese consumption
        WB_CD_demand = aa, 
        WB_CD_fm_biomass = bb,
        WB_CD_fo_demand = cc,
        WB_CD_from_fm = dd, 
        WB_CD_surplus = ee,
        WB_CD_consumption = ff
        
        #chinese diets and more efficient
        # effchn_demand = gg, 
        # effchn_fm_biomass = hh,
        # effchn_fo_demand = ii,
        # effchn_from_fm = jj, 
        # effchn_surplus = kk,
        # effchn_consumption = ll
        ))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows

write_csv(a_test, "forage fish consumption.csv")


```

#Figure 1
```{r}



ff_consumption <- 
  fread("forage fish consumption.csv", header=T) 



#feed supply data from FAOSTAT
feed_fish <- read_csv("forage_feed.csv")

feed_use <- feed_fish %>%
  filter(Item=="Pelagic Fish") %>% 
  group_by(Year) %>%
  summarise(Value = sum(Value)*1000) %>% 
  mutate(Element = "Total animal feed use")
  


#forage fish species used in Froehlich et al

feed_spp <- c("Engraulis ringens",  "Clupea harengus", "Engraulis japonicus", "Decapterus", "Decapterus macrosoma" ,"Decapterus maruadsi" , "Decapterus russelli",  "Sardina pilchardus", "Mallotus villosus",   "Sardinella",  "Mallotus villosus", "Brevoortia patronus", "Engraulis encrasicolus", "Cololabis saira", "Clupea pallasii pallasii", "Trachurus murphyi", "Larimichthys polyactis", "Clupeidae", "Sprattus sprattus", "Sardinops sagax", "Trachurus", "Trachurus trecae" , "Trachurus capensis","Trachurus lathami", "Trachurus declivis", "Trachurus trachurus", "Trachurus murphyi" , "Trachurus mediterraneus", "Trachurus symmetricus","Trachurus japonicus", "Trachurus picturatus") 


#Sort the symbols in values out
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information


##IF USING FAO PRODUCTION DATA - Feed use of pelagic fish is greater than production!

#Capture production
forage_fish <-
  fread("Marine fisheries Production 1950-2014.csv", header=T) %>% 
  filter(TaxonName %in% feed_spp) %>% 
  select(CountryName, Year, TaxonName, Value) %>% 
  group_by(Year) %>% 
  summarise(Value=sum(Value)) %>% 
  mutate(Element="Historical supply")

#Management into legend
management <- 
  data_frame(Year= NA, Vaue = NA, Element="Proposed EBFM limit")


#fishmeal use in aquaculture

fishmeal_prop <- 
  data_frame(Year=c(1960,1980,2010), Prop=c(0.04, 0.1,0.73))


fishmeal_aqua <- 
  data_frame(Year=seq(1961,2013)) %>% 
  mutate(Prop = case_when(Year==1961 ~0.04,
                          Year==1980~0.1,
                          Year==2010~0.73))
  
  
predictions <- predict(lm(Prop~Year, data=fishmeal_aqua), newdata = data_frame(Year=seq(1961,2013)))+0.05

fishmeal_aqua <- 
  fishmeal_aqua %>% 
  select(Year) %>% 
  mutate(Value=feed_use$Value*predictions) %>% 
  mutate(Element="Aquaculture use")

anchovy <- readPNG("anchovy.png")
anchovy <- rasterGrob(anchovy)


limit <- mean(forage_fish$Value[forage_fish$Year>1979])
feed_limit <- mean(feed_use$Value[feed_use$Year>1979])



(supply_demand <- 
    bind_rows(forage_fish, feed_use, fishmeal_aqua) %>% 
    mutate(Element = factor(Element, levels=c("Historical supply", "Proposed EBFM limit","Total animal feed use", "Aquaculture use"))) %>%
    ggplot(aes(x=Year, y=Value, colour=Element, linetype=Element))+geom_line()+
    scale_linetype_manual(values=c(1,1,1))+
    scale_colour_manual(values=c("black", "grey50", "dodgerblue"))+
    scale_y_continuous(limits=c(0,4.2e+7), labels=c(0,10,20,30,40), expand=c(0,0))+
    scale_x_continuous(breaks = c(1970,1990, 2010, 2030), limits = c(1960,2037), expand = c(0,0))+
    theme_pubr()+
    geom_vline(xintercept=2015, linetype=2, colour="grey80", alpha=0)+
    theme(
      #text=element_text(size=10),
      legend.title = element_blank(),
      legend.background=element_blank(),
      legend.position = c(0.22,0.96),
      legend.text = element_text(size=7),
      legend.key.height = unit(0.3, "cm"),
      plot.margin = unit(c(0.5,-.2, 0.2,0.2), "cm"),
      axis.text.x = element_text(size=10),
      #axis.line.x = element_blank(),
      axis.title.x = element_text(size=10),
      axis.text.y = element_text(size=10),
      axis.title.y = element_text(size=10)
    )+
    annotate("segment", x=2013, xend=2035, y=limit, yend = limit)+
    annotate("segment", x=2013, xend=2035, y=feed_limit, yend = feed_limit, colour="grey50")+
    annotate("segment", x=2013, xend=2035, y=limit*0.8, yend = limit*0.8, linetype=2)+
    annotate("segment", x=2013, xend=2013, y=-Inf, yend = Inf, colour="grey80", linetype=2)+
    #geom_segment(x=2013, xend=2031, y=14514473.94, yend = 14514473.94, colour="lightskyblue", linetype=1, alpha=0.3))+
    #annotate("segment", x=1960, xend=2030.5, y=0, yend = 0, colour="black", linetype=1, size=0.95)+
    annotate("text", x=2014, y=32.5e+6, label="Average supply\n1980-2013", size=2.5, hjust=0)+
    annotate("text", x=2014, y=26.5e+6, label="Proposed\nEBFM limit", size=2.5, hjust=0)+
    annotate("text", x=2014, y= 18.9e+6, label="Average feed use \n1980-2013", size=2.5, hjust=0)+
    #annotate("text", x=2031.5, y=15078983.9, label="?", size=3)+
    annotation_custom(anchovy, xmin = 2015, xmax = 2029, ymin=34e+6, ymax=44e+6)+
    labs(y=bquote(Forage~fish~demand~(Tx10^6)))+
    #annotation_custom(ggplotGrob(future_scenarios) , xmin = 2020, xmax=2034, ymin = 6e+6, ymax=20e+6)+
    ggsave("total forage fish landings plot2.tiff", device="tiff", dpi=600, width = 8.9, height=8, units = "cm"))
  



#Predicted 2030 demand

current_diets <- 
      bind_rows(
        
        # fread("forage fish consumption.csv", header=T) %>% 
        #   select(Country, Species, Taxa_adj, rep_id,consumption_2015 ) %>% 
        #   group_by(rep_id) %>% 
        #   summarise(Rep_Value = sum(consumption_2015)) %>% 
        #   summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
        #   mutate(Scenario = "2015") %>% 
        #   mutate(Diet="2015"),
        
        fread("forage fish consumption.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "BAU") %>% 
          mutate(Diet = "2030") ,
        
        fread("forage fish consumption.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "Rap.Gr.") %>% 
          mutate(Diet = "2030") ,
        
        
        fread("forage fish consumption.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "Con.Shft") %>% 
          mutate(Diet = "2030") 
      ) %>%
  mutate(Scenario = factor(Scenario, levels = c("BAU", "Rap.Gr.", "Con.Shft")))


    
current_diets    

demand <- ggplot(data=current_diets, aes(x=Scenario, y=Value, fill=Scenario))+
  geom_bar(stat="identity", position = "dodge", width=0.6)+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=0.1, position = position_dodge(0.9))+
  scale_fill_manual(values=rev(lacroix_palette("PassionFruit", n=3, type = "continuous")))+
  #scale_x_discrete(labels = "2030")+
  scale_y_continuous(limits=c(0,4.2e+7), labels=c(0,10,20,30,40), expand=c(0,0))+
  theme_pubr()+
  theme(text = element_text(size=10),
        legend.position = "right")+
  labs(y=bquote(Forage~fish~demand~(Tx10^6)), x="Aquaculture 2030 scenarios")+
  # annotate("text", x=.5, y=32e+6, label="Historical supply", size=3)+
  # annotate("text", x=7.5, y=25e+6, label="EBFM supply", size=3)
  geom_segment( x=0.5, xend = 8.5, y=c(limit), yend=c(limit), linetype=c(1))+
  geom_segment( x=0.5, xend = 8.5, y=c(limit*.8), yend=c(limit*.8), linetype=c(2))+
  geom_segment( x=0.5, xend = 8.5, y=c(feed_limit), yend=c(feed_limit), linetype=c(1), colour="grey50")+
  guides(fill=FALSE)



ggarrange(supply_demand, demand,
          nrow = 1, ncol=2, 
          labels = c("a", "b"), 
          font.label = list(size=10),
          widths = c(1,0.65),
          align = "hv"
          )+
  ggsave("Fig 1 - Resubmission.tiff", device="tiff", dpi=600, width = 18, height = 8, units="cm")+
   ggsave("Fig 1 - Resubmission.pdf", device="pdf", dpi=600, width = 18, height = 8, units="cm")

```




##### SECTION 2 - METANALYSIS DATA TO INFORM NOVEL FEEDS SCENARIOS

```{r}

#Tidy - unique/levels etc

relative_FCR <- function(x){
  fcr <- x$FCR/(x$FCR[1])
}

relative_n3_index <- function(x){
  n3_index <- x$n3_index/(x$n3_index[1])
}


growth_data <- 
  fread("growth_data_update.csv", header=T) %>% 
  select(-c(V29, Author, Journal, Supplement_type))%>% 
  filter(Year>2007) %>% #  & Study_id!= 206.1) %>% 
  mutate(Amino_supp = case_when(Amino_supp=="" ~ "N",
                                T ~ Amino_supp)) %>% 
  mutate(Fish_group = case_when(Fish_group=="Shrimp" ~ "Shrimps",
                                Fish_group=="Tilapia" ~ "Tilapias",
                                Fish_group=="Carp" ~ "Carps",
                                Fish_group=="Diadromous fish" ~ "Diadromous fishes",
                                Fish_group=="Catfish" ~ "Catfishes",
                                T ~ Fish_group)) %>% 
  mutate(Fish_sp = case_when(Fish_sp == "Chinese Mittern Crab" ~ "Chinese Mitten Crab",
                             T~ Fish_sp)) %>% 
  mutate(Fish_scientific = case_when(Fish_scientific == "Acanthopagrus schlegeli" ~ "Acanthopagrus schlegelii",
                                     Fish_scientific =="Cyprinus carpio var.  Jian"~ "Cyprinus carpio var. Jian",
                                     Fish_scientific %in% c("Machrobrachium rosenbergii", "Macrobrachium rosenbergiiS" ) ~ "Macrobrachium rosenbergii",
                                     Fish_scientific =="Morone chrysops x Morone saxatilis"~ "Morone chrysops x M. saxatilis",
                                     Fish_scientific =="Oreochromis niolticus"~ "Oreochromis niloticus",
                                     Fish_scientific =="Sciaenops ocellatus:" ~ "Sciaenops ocellatus",
                                     T ~ Fish_scientific)) %>% 
  mutate(Life_stage = case_when(Life_stage %in% c("Juveniles") ~  "Juvenile",
                                Life_stage == "Smolts" ~ "Smolt",
                                T ~ Life_stage)) %>% 
  mutate(Tissue = case_when(Tissue == "Total lipids" ~ "Whole body",
                            T ~ Tissue)) %>% 
  group_by(Broad_feed, Fish_group,  Study_id) %>% 
  nest() %>% 
  mutate(Relative_FCR = purrr::map(data, relative_FCR)) %>% 
  unnest(data, Relative_FCR) %>% 
  ungroup() %>% 
  group_by(Broad_feed, Fish_group, Study_id, FM_FO) %>% 
  nest() %>% 
  mutate(Relative_n3_index = purrr::map(data, relative_n3_index)) %>% 
  unnest(data, Relative_n3_index) %>% 
  ungroup()




#Exploration

fishmeal <- growth_data %>% 
  filter(FM_FO == "FM")




fish_oil <- growth_data %>% 
  filter(FM_FO == "FO")

  

# ggplot(data = fishmeal, aes(x=Replacement, y=Relative_FCR))+
#   #geom_line(aes(colour=Feed_general, group=Study_id, alpha=Year))+
#   geom_point(alpha=.2)+
#   facet_grid(cols = vars(Feed_general), rows= vars(Fish_group), scales="free")+
#   geom_smooth(method="loess", aes(colour=interaction(Feed_general, Fish_group)))+
#   guides(colour=F)+
#   theme_bw()+
#   theme(panel.grid = element_blank())+
#   labs(x= "Fishmeal replacement (%)", y=bquote(Relative~FCR))+
#   #scale_y_continuous(limits = c(0,80))+
#   ggsave("growth_fishmeal.tiff", device="tiff", dpi=300, width=20, height=22, units = "cm")
# 
#   ggplot(data = fish_oil, aes(x=Replacement, y=Relative_FCR))+
#     geom_point(alpha=.4)+
#     #geom_line(aes(colour=Feed_general, group=Study_id))+
#     facet_grid(cols = vars(Feed_general), rows= vars(Fish_group), scales="free")+
#   geom_smooth(method="loess", aes(colour=interaction(Feed_general, Fish_group)))+
#   guides(colour=F)+
#   theme_bw()+
#   theme(panel.grid = element_blank())+
#   labs(x= "Fish oil replacement (%)", y=bquote(Relative~FCR))+
#   ggsave("growth_fish-oil.tiff", device="tiff", dpi=300, width=11, height=7)
# 
# ggplot(data = complete, aes(x=Replacement, y=FCR, colour=Feed_general))+geom_point(alpha=.7)+
#   facet_grid(rows = vars(Fish_group), cols= vars(Feed_general), scales="free")+
#   ggsave("both_growth.tiff", device="tiff", dpi=150, width=7, height=10)
# 
# ggplot(data = fish_oil, aes(x=Replacement, y=n3n6))+geom_point(alpha=.7)+geom_line(aes(colour=Feed_general, group=Study_id))+
#   facet_grid(rows = vars(Feed_general), cols= vars(Fish_group), scales="free")+
#   ggsave("nutrition_fish_oil.tiff", device="tiff", dpi=300, width=11, height=7)
# 
# ggplot(data = fish_oil, aes(x=Replacement, y=n3n6, colour=Feed_general))+geom_point(alpha=.7)+geom_line(aes(colour=Feed_general, group=Study_id))+
#   facet_grid(rows = vars(Fish_group), cols= vars(Feed_general), scales="free")+
#   ggsave("nutrition_both.tiff", device="tiff", dpi=150, width=7, height=10)
# 
# #fish oil change with fishmeal replacement
# 
# ggplot(data = fishmeal, aes(x=Replacement, y=Marine_ingredient_change))+geom_point(alpha=.7)+geom_line(aes(colour=Feed_general, group=Study_id))+
#   facet_grid(rows = vars(Feed_general), cols= vars(Fish_group), scales="free")+
#   ggsave("fish_oil trade off.tiff", device="tiff", dpi=300, width=11, height=7)
# 
# 
# ggplot(data = fish_oil, aes(x=Replacement, y=Marine_ingredient_change))+geom_point(alpha=.7)+geom_line(aes(colour=Feed_general, group=Study_id))+
#   facet_grid(rows = vars(Feed_general), cols= vars(Fish_group), scales="free")+
#   ggsave("fishmeal trade off.tiff", device="tiff", dpi=300, width=11, height=7)
# 
# 
# arrange(fishmeal, Feed_general, Fish_group)

#calculations
length((which((unique(growth_data$Study_id[growth_data$Broad_feed== "Insect"]))%%1==0)==TRUE))/length(which((unique(growth_data$Study_id)%%1==0)==TRUE))

length((which((unique(growth_data$Study_id[growth_data$Fish_group=="Marine fishes"]))%%1==0)==TRUE))/ length(which((unique(growth_data$Study_id)%%1==0)==TRUE))


length(unique(growth_data$Study_id[growth_data$Fish_group=="Marine fishes"]))/length(unique(growth_data$Study_id))


row_per_study <- growth_data$Life_stage[c(1,1+which(diff(growth_data$Study_id)!=0))]
row_per_study <- row_per_study[row_per_study!="None"]

unique(row_per_study)
juveniles <- c("Juvenile", "Fry", "Fingerlings", "Larvae")
length(row_per_study[row_per_study %in% juveniles])/length(row_per_study)#92% of studies that mentioned life stages used juveniles


#median replacement across taxa and feeds

#microalgae
median(c(100, 75, 10, 100, 100, 30, 80))#fm 80


#macroalgae
median(c(25, 5, 40, 50, 15, 30))#fm #27.5

#bacteria and yeasts
median(c(65, 100, 100, 20, 100, 45))#fm #82.5

#insects
median(c(100, 80, 100, 100, 95, 100))#fm #100

#soy
median(c(15,50,55,70, 100, 50,50))#fm #50

#carps
median(c(100, 25, 65, 100, 15))

#catfishes 
median(c(75,5, 100, 100, 50))

#fw fishes
median(c(10,55))

#tilapias
median(c(100,40, 95,100, 70))

#shrimps
median(c(100,50,20, 100, 100))
median(c(100,30))

#salmonids
median(c(30,15,100,100, 50))
median(c(100,10))

#marine fishes
median(c(80,30, 45, 80, 50))
median(c(100,25))





#number of replicates in each experiemtal treatment 

#FISHMEAL
#carps and algae
length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Microalgae" & fishmeal$Fish_group=="Carps"])) #10

#carps and macroalgae
length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Macroalgae" & fishmeal$Fish_group=="Carps"])) #1

#carps and bacteria 

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Bacteria and yeasts" & fishmeal$Fish_group=="Carps"])) #2


#carps and soy 

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Soy" & fishmeal$Fish_group=="Carps"])) #3


#carps and insect

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Insect" & fishmeal$Fish_group=="Carps"])) #5


 



#Catfishes and algae
length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Microalgae" & fishmeal$Fish_group=="Catfishes"])) #2

#macroalgae 

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Macroalgae" & fishmeal$Fish_group=="Catfishes"])) #1


#Catfishes and bacteria 

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Bacteria and yeasts" & fishmeal$Fish_group=="Catfishes"])) #2


#Catfishes and soy 

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Soy" & fishmeal$Fish_group=="Catfishes"])) #10


#Catfishes and insect

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Feed_general=="Insect" & fishmeal$Fish_group=="Catfishes"])) #18






#Freshwater fishes and algae
length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Microalgae" & fishmeal$Fish_group=="Freshwater fishes"])) #1

#Freshwater fishes and bacteria and yeasts

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Bacteria and yeasts" & fishmeal$Fish_group=="Freshwater fishes"])) #0



#Freshwater fishes and soy 

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Soy" & fishmeal$Fish_group=="Freshwater fishes"])) #12


#Freshwater fishes and insect

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Insect" & fishmeal$Fish_group=="Freshwater fishes"])) #0



#Tilapias and algae
length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Microalgae" & fishmeal$Fish_group=="Tilapias"])) #6
length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Macroalgae" & fishmeal$Fish_group=="Tilapias"])) #4

#Tilapias and bacteria 

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Bacteria and yeasts" & fishmeal$Fish_group=="Tilapias"])) #9


#Tilapias and soy 

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Soy" & fishmeal$Fish_group=="Tilapias"])) #14


#Tilapias and insect

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Insect" & fishmeal$Fish_group=="Tilapias"])) #7




#Shrimps and algae
length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Microalgae" & fishmeal$Fish_group=="Shrimps"])) #6
length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Macroalgae" & fishmeal$Fish_group=="Shrimps"])) #1
#Shrimps and scps 

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Bacteria and yeasts" & fishmeal$Fish_group=="Shrimps"])) #1

#Shrimps and soy

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Soy" & fishmeal$Fish_group=="Shrimps"])) #9


#Shrimps and insect

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Insect" & fishmeal$Fish_group=="Shrimps"])) #3



#Salmonids and algae
length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Microalgae" & fishmeal$Fish_group=="Salmonids"])) #8
length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Macroalgae" & fishmeal$Fish_group=="Salmonids"])) #2
#Salmonids and scps 

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Bacteria and yeasts" & fishmeal$Fish_group=="Salmonids"])) #9


#Salmonids and soy 

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Soy" & fishmeal$Fish_group=="Salmonids"])) #16


#Salmonids and insect

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Insect" & fishmeal$Fish_group=="Salmonids"])) #6





#Marine fishes and algae
length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Microalgae" & fishmeal$Fish_group=="Marine fishes"])) #20
length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Macroalgae" & fishmeal$Fish_group=="Marine fishes"])) #2

#Marine fishes and bacteria 

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Bacteria and yeasts" & fishmeal$Fish_group=="Marine fishes"])) #2


#Marine fishes and soy 

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Soy" & fishmeal$Fish_group=="Marine fishes"])) #142


#Marine fishes and insect

length(unique(fishmeal$Study_id[(!is.na(fishmeal$FM_Replacement)) & fishmeal$Broad_feed=="Insect" & fishmeal$Fish_group=="Marine fishes"])) #5


unique(growth_data$Fish_group)



unique(growth_data$Study_id)[(which((unique(growth_data$Study_id)%%1==0)==TRUE))]

growth_data2 <- growth_data[!growth_data$Fish_group %in% c("FW Crustaceans" ,"Diadromous fishes" ,"Tunas" ),]


unique(growth_data2$Study_id)[(which((unique(growth_data2$Study_id)%%1==0)==TRUE))]

unique(growth_data$Study_id)

```


###### SPECIES PLOTS AND MODEL FITTING - FISHMEAL


#Plotting settings

```{r}

#Smoothing splines mixed effects models. SME package


######   BEFORE PLOTTING GO INTO BACKDOOR OF plotSmeModel TO MANUALLY STANDARDISE X AXIS LIMITS (EQUIVALENT OF XLIM=C(0,100)) AND MAKE SURE THAT YLIM IS AT LEAST WITHIN 5% OF ORIGINAL FCR

fix(plotSmeModel) 


#original xlim code - range(as.numeric(colnames(x$coefficients)))
#change xlim code -  range(as.numeric(c(colnames(x$coefficients),100)))

#original ylim code - range(x$data$y, mu$y, sapply(fs, "[[", "y"))
#change ylim with this code - range(c(x$data$y, mu$y, sapply(fs, "[[", "y"),1.15))

#tick marks
#at <- round(seq(round(ylim[1],2), round(ylim[2],2), length.out = 3),2)
#axis(side = 2, las=1, tck = -0.01, at = at, cex=0.8) #under the plot call

#show individual studies makes it clearer
#old code - lines(fs[[i]], lty = "dashed")
#change code - lines(fs[[i]], lty = "dotted", col=alpha("grey40", 1))




#Colours to use for species grousp

# brewer.pal(10, "Spectral")
# 
# #[1] "#9E0142" "#D53E4F" "#F46D43" "#FDAE61" "#FEE08B" "#E6F598"
# # [7] "#ABDDA4" "#66C2A5" "#3288BD" "#5E4FA2"
# 
# 
# viridisLite::viridis(n=10)
# [1] "#440154FF" "#482878FF" "#3E4A89FF" "#31688EFF" "#26828EFF" "#1F9E89FF"
#  [7] "#35B779FF" "#6DCD59FF" "#B4DE2CFF" "#FDE725FF"
# 
# viridisLite::viridis(n=9)
# [1] "#440154FF" "#472D7BFF" "#3B528BFF" "#2C728EFF" "#21908CFF" "#27AD81FF"
# [7] "#5DC863FF" "#AADC32FF" "#FDE725FF"

rev(lacroix_palette("PeachPear", n=5, "continuous"))


```


#Carps


```{r}


ggplot(data = fishmeal, aes(x=FM_Replacement, y=Relative_FCR ))+geom_point()+guides(colour=F)+geom_smooth(method = "loess", level=95)+
  facet_grid(rows = vars(Fish_group), cols = vars(Broad_feed))




#=================================================


#Carps and Algae - model looks good

(carp_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Carps" & Broad_feed=="Microalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor))


#Analysis
myknots <- seq(min(carp_algae$FM_Replacement), max(carp_algae$FM_Replacement), length.out = 4)[-c(1,4)]
fit_carp_algae <- sme(object = carp_algae$Relative_FCR, tme = carp_algae$FM_Replacement, ind = carp_algae$Study_id, criteria = "AICc", deltaEM = 0.1, knots = myknots)




 plotSmeModel(fit_carp_algae, xlab="", ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", lwd=3, col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_carp_algae$info
plot(fit_carp_algae, type="diagnostic")

plotSmeModel(fit_carp_algae, xlab=F, ylab=F, xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", lwd=3, col=alpha("grey50", 0.5), pch=16, yaxt="n", bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2.8, labels = expression(italic("100%  (6)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#carp and macroalgae 
(carp_macroalgae <- 
  fishmeal %>% 
  filter(Fish_group=="Carps" & Broad_feed=="Macroalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor))


#Analysis
myknots <- seq(min(carp_macroalgae$FM_Replacement), max(carp_macroalgae$FM_Replacement), length.out = 4)[-c(1,4)]
fit_carp_macroalgae <- sme(object = carp_macroalgae$Relative_FCR, tme = carp_macroalgae$FM_Replacement, ind = carp_macroalgae$Study_id, criteria = "AICc", deltaEM = 0.1)# knots = myknots)

fit_carp_macroalgae$info
plot(fit_carp_macroalgae, type="diagnostic")


plotSmeModel(fit_carp_macroalgae, xlab="", ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", lwd=3, col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=25, lty=2, lwd=1, col='red')) ))

 

#============================================

#carps and bacteria/yeasts

carp_scps <- 
  fishmeal %>% 
  filter(Fish_group=="Carps" & Broad_feed=="Bacteria and yeast") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(carp_scps$FM_Replacement), max(carp_scps$FM_Replacement), length.out = 5)[-c(1,5)]
fit_carp_scps <- sme(object = carp_scps$Relative_FCR, tme = carp_scps$FM_Replacement, ind = carp_scps$Study_id, criteria = "AICc", deltaEM=.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_carp_scps$info
plot(fit_carp_scps, "diagnostic")


plotSmeModel(fit_carp_bacteria, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#0686B8", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=66, lty=2, lwd=1, col='black')) ))




#==========================================================



#carps and soy - model is satisfactory


(carp_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Carps" & Broad_feed=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)
)

#Analysis
myknots <- seq(min(carp_soy$FM_Replacement), max(carp_soy$FM_Replacement), length.out = 4)[-c(1,4)]
fit_carp_soy <- sme(object = carp_soy$Relative_FCR, tme = carp_soy$FM_Replacement, ind = carp_soy$Study_id,criteria = "AICc",  deltaEM=.1)

#Diagnostics 
fit_carp_soy$info
plot(fit_carp_soy, type="diagnostic")


plotSmeModel(fit_carp_soy,xlab="",ylab="", showIndividuals=T,  xaxs="i", showConfidenceBands=T, col.meanCurve='#9E0142', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=15, lty=2, lwd=1, col='black'))))





#carps and insects - model looks good


carp_insects <- 
  fishmeal %>% 
  filter(Fish_group=="Carps" & Feed_general=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(carp_insects$FM_Replacement), max(carp_insects$FM_Replacement), length.out = 7)[-c(1,7)]
fit_carp_insects <- sme(object = carp_insects$Relative_FCR, tme = carp_insects$FM_Replacement, ind = carp_insects$Study_id,criteria = "AICc", knots=myknots)

#Diagnostics - no real patterns in residuals or in qq-plot except in the extremes - which is largely to be expected with diverging data sets. No difference between AIC and BICn lambda selection. Use data points as knots creates better fit 


fit_carp_insects$info
plot(fit_carp_insects, type="diagnostic")

plotSmeModel(fit_carp_insects,xlab="",ylab="Relative FCR", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#9E0142", pch=16, col=alpha("grey50", 0.5), yaxt="n",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black'))))


op<-par(mfrow=c(1,5))



par(op)

```

#Catfishes

```{r}

#Catfish and Algae - model looks good

catfish_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Catfishes" & Broad_feed=="Microalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(catfish_algae$FM_Replacement), max(catfish_algae$FM_Replacement), length.out = 4)[-c(1,4)]

fit_catfish_algae <- sme(object = catfish_algae$Relative_FCR, tme = catfish_algae$FM_Replacement, ind = catfish_algae$Study_id,criteria = "AICc", deltaEM = 0.1, knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_catfish_algae$info
plot(fit_catfish_algae, type="diagnostic")



#PLOT
plotSmeModel(fit_catfish_algae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=2, lty=2, lwd=1, col='black'))))




#====================================================
#Catfish and macroalgae




(catfish_macroalgae<- 
  fishmeal %>% 
  filter(Fish_group=="Catfishes" & Broad_feed=="Macroalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor))

#Analysis
myknots <- seq(min(catfish_macroalgae$FM_Replacement), max(catfish_macroalgae$FM_Replacement), length.out = 4)[-c(1,4)]

fit_catfish_macroalgae <- sme(object = catfish_macroalgae$Relative_FCR, tme = catfish_macroalgae$FM_Replacement, ind = catfish_macroalgae$Study_id,criteria = "AICc")#, deltaEM = 0.1, knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_catfish_macroalgae$info
plot(fit_catfish_macroalgae, type="diagnostic")



#PLOT
plotSmeModel(fit_catfish_macroalgae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=8, lty=2, lwd=1, col='black'))))





#====================================================

#Catfish and scps



catfish_scps <- 
  fishmeal %>% 
  filter(Fish_group=="Catfishes" & Broad_feed=="Bacteria and yeasts") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(catfish_scps$FM_Replacement), max(catfish_scps$FM_Replacement), length.out = 5)[-c(1,5)]

fit_catfish_scps <- sme(object = catfish_scps$Relative_FCR, tme = catfish_scps$FM_Replacement, ind = catfish_scps$Study_id,criteria = "AICc", knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_catfish_scps$info
plot(fit_catfish_scps, type="diagnostic") ##NUP linear model for trends of thre points

plotSmeModel(fit_catfish_scps, xlab="",ylab="Relative FCR", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='grey50', col=alpha("black", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red'))))



#PLOT

# plot(x=catfish_bacteria$FM_Replacement, y=catfish_bacteria$Relative_FCR, xlab="",ylab="", col=alpha("grey50", 0.5), pch=16, xlim=c(0,100), ylim=c(min(catfish_bacteria$Relative_FCR),1.05))+
#   abline(lm(Relative_FCR~FM_Replacement, data = catfish_bacteria), col="#D53E4F", lwd=3)+
#   abline(h=1.05, lwd=1, lty=2)

# 
# plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
#   abline(0,1)
# 





# #===========================================================
# ##Catfish and yeast
# 
# catfish_yeast <- 
#   fishmeal %>% 
#   filter(Fish_group=="Catfishes" & Feed_general=="Yeast") %>% 
#   mutate(Study_id = Study_id %>% 
#            as.factor)
# 
# 
# 
# #Analysis
# myknots <- seq(min(catfish_yeast$FM_Replacement), max(catfish_yeast$FM_Replacement), length.out = 5)[-c(1,5)]
# 
# fit_catfish_yeast <- sme(object = catfish_yeast$Relative_FCR, tme = catfish_yeast$FM_Replacement, ind = catfish_yeast$Study_id,criteria = "AICc",  knots = myknots)
# 
# #Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
# fit_catfish_yeast$info
# plot(fit_catfish_yeast, type="diagnostic")
# 
# 
# plotSmeModel(fit_catfish_yeast, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#D53E4F', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='grey20'))))



#=========================================================

#Catfish and Soy



(catfish_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Catfishes" & Broad_feed=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(FM_Replacement==0 ~ 1,
                                  T ~ Relative_FCR))

)


#Analysis
myknots <- seq(min(catfish_soy$FM_Replacement), max(catfish_soy$FM_Replacement), length.out = 4)[-c(1,4)]

fit_catfish_soy <- sme(object = catfish_soy$Relative_FCR, tme = catfish_soy$FM_Replacement, ind = catfish_soy$Study_id,criteria = "AICc")
#,  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_catfish_soy$info
plot(fit_catfish_soy, type="diagnostic")


plotSmeModel(fit_catfish_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#D53E4F', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='grey20'))))



#==================================================

#Catfish and Insects

catfish_insects <- 
  fishmeal %>% 
  filter(Fish_group=="Catfishes" & Broad_feed=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) 


#Analysis
myknots <- seq(min(catfish_insects$FM_Replacement), max(catfish_insects$FM_Replacement), length.out = 6)[-c(1,6)]

fit_catfish_insects <- sme(object = catfish_insects$Relative_FCR, tme = catfish_insects$FM_Replacement, ind = catfish_insects$Study_id,criteria = "AICc")#,  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_catfish_insects$info
plot(fit_catfish_insects, type="diagnostic")


plotSmeModel(fit_catfish_insects, xlab="",ylab="Relative FCR", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#9E0142', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='grey20'))))



```


#FW fishes


```{r}

#FW fishes & Algae (no data)


FW_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Freshwater fishes" & Broad_feed=="Microalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(FM_Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(FW_algae$FM_Replacement), max(FW_algae$FM_Replacement), length.out = 4)[-c(1,4)]

fit_FW_algae <- sme(object = FW_algae$Relative_FCR, tme = FW_algae$FM_Replacement, ind =FW_algae$Study_id,criteria = "AICc")#,  knots = myknots)

fit_FW_algae$info
plot(fit_FW_algae, type="diagnostic")


plotSmeModel(fit_FW_algae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#F46D43', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=10, lty=2, lwd=1, col='grey20'))))


#FW fishes and macro algae (no data)


#FW fishes & Bacteria and yeasts
#no data 

#FW fishes & Soy 


FW_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Freshwater fishes" & Broad_feed=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(FM_Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(FW_soy$FM_Replacement), max(FW_soy$FM_Replacement), length.out = 4)[-c(1,4)]

fit_FW_soy <- sme(object = FW_soy$Relative_FCR, tme = FW_soy$FM_Replacement, ind = FW_soy$Study_id,criteria = "AICc")#,  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_FW_soy$info
plot(fit_FW_soy, type="diagnostic")


plotSmeModel(fit_FW_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#F46D43', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=57, lty=2, lwd=1, col='grey20'))))



#FW fishes & Insects (no data)

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)


```

#Tilapias   

```{r}

#Tilapias and algae


(tilapia_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Tilapias" & Broad_feed=="Microalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(FM_Replacement==0 ~ 1,
                                  T ~ Relative_FCR))
)

myknots <- seq(min(tilapia_algae$FM_Replacement), max(tilapia_algae$FM_Replacement), length.out = 9)[-c(1,9)]

fit_tilapia_algae <- sme(object = tilapia_algae$Relative_FCR, tme = tilapia_algae$FM_Replacement, ind = tilapia_algae$Study_id,criteria = "AICc")#,  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_tilapia_algae$info
plot(fit_tilapia_algae, type="diagnostic")


plotSmeModel(fit_tilapia_algae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=62, lty=2, lwd=1, col='grey20'))))





#Tilapias and macroalgae


(tilapia_macroalgae <- 
  fishmeal %>% 
  filter(Fish_group=="Tilapias" & Broad_feed=="Macroalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(FM_Replacement==0 ~ 1,
                                  T ~ Relative_FCR))
)

myknots <- seq(min(tilapia_macroalgae$FM_Replacement), max(tilapia_macroalgae$FM_Replacement), length.out = 9)[-c(1,9)]

fit_tilapia_macroalgae <- sme(object = tilapia_macroalgae$Relative_FCR, tme = tilapia_macroalgae$FM_Replacement, ind = tilapia_macroalgae$Study_id,criteria = "AICc")#,  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_tilapia_macroalgae$info
plot(fit_tilapia_macroalgae, type="diagnostic")


plotSmeModel(fit_tilapia_macroalgae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=40, lty=2, lwd=1, col='grey20'))))



#Tilapias and bacteria/yeasts

tilapia_scps<- 
  fishmeal %>% 
  filter(Fish_group=="Tilapias" & Broad_feed=="Bacteria and yeasts") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(FM_Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(tilapia_bacteria$FM_Replacement), max(tilapia_bacteria$FM_Replacement), length.out = 4)[-c(1,4)]

fit_tilapia_scps <- sme(object = tilapia_scps$Relative_FCR, tme = tilapia_scps$FM_Replacement, ind = tilapia_scps$Study_id,criteria = "AICc")#,  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_tilapia_scps$info
plot(fit_tilapia_scps, type="diagnostic")


plotSmeModel(fit_tilapia_scps, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#0686B8", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=25, lty=2, lwd=1, col='red'))))






  #Tilapias and soy


tilapia_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Tilapias" & Broad_feed=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(FM_Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(tilapia_soy$FM_Replacement), max(tilapia_soy$FM_Replacement), length.out = 4)[-c(1,4)]

fit_tilapia_soy <- sme(object = tilapia_soy$Relative_FCR, tme = tilapia_soy$FM_Replacement, ind = tilapia_soy$Study_id,criteria = "AICc",  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_tilapia_soy$info
plot(fit_tilapia_soy, type="diagnostic")


plotSmeModel(fit_tilapia_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#FDAE61', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=71, lty=2, lwd=1, col='grey20'))))






#Tilapias and insects


tilapia_insect <- 
  fishmeal %>% 
  filter(Fish_group=="Tilapias" & Broad_feed=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(FM_Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(tilapia_insect$FM_Replacement), max(tilapia_insect$FM_Replacement), length.out = 8)[-c(1,8)]

fit_tilapia_insect <- sme(object = tilapia_insect$Relative_FCR, tme = tilapia_insect$FM_Replacement, ind = tilapia_insect$Study_id,criteria = "AICc")#,  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_tilapia_insect$info
plot(fit_tilapia_insect, type="diagnostic")


plotSmeModel(fit_tilapia_insect, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#FDAE61', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=95, lty=2, lwd=1, col='red'))))





```
#CRUSTACEANS

```{r}



#Crustaceans and algae

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)

#Crustaceans and bacteria

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)

#Crustaceans and yeast

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)

#Crustaceans and Soy


crustaceans_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Crustaceans" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)%>% 
  mutate(Relative_FCR = case_when(Replacement==0 ~ 1,
                                  T ~ Relative_FCR))


myknots <- seq(min(crustaceans_soy$Replacement), max(crustaceans_soy$Replacement), length.out = 5)[-c(1,5)]

fit_crustaceans_soy <- sme(object = crustaceans_soy$Relative_FCR, tme = crustaceans_soy$Replacement, ind = crustaceans_soy$Study_id,criteria = "AICc",  knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_crustaceans_soy$info
plot(fit_crustaceans_soy, type="diagnostic")


plotSmeModel(fit_crustaceans_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#FEE08B', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=69, lty=2, lwd=1, col='grey20'))))




#Crustaceans and insects

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)

```


#DIADROMOUS FISHES

```{r}

#DIADROMOUS FISHES


#Diadromous fishes and algae

diadromous_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Diadromous fishes" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(diadromous_algae$Replacement), max(diadromous_algae$Replacement), length.out = 10)[-c(1,10)]

fit_diadromous_algae <- sme(object = diadromous_algae$Relative_FCR, tme = diadromous_algae$Replacement, ind = diadromous_algae$Study_id,criteria = "AICc")

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_diadromous_algae$info
plot(fit_diadromous_algae, type="diagnostic")



#PLOT
plotSmeModel(fit_diadromous_algae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#E6F598', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=9, lty=2, lwd=1, col='grey20'))))



#Diadromous fishes and bacteria

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)

#Diadromous fishes and yeast

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), yaxt= "n")+
  abline(0,1)





#Diadromous fishes and soy

diadromous_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Diadromous fishes" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(diadromous_soy$Replacement), max(diadromous_soy$Replacement), length.out = 10)[-c(1,10)]

fit_diadromous_soy <- sme(object = diadromous_soy$Relative_FCR, tme = diadromous_soy$Replacement, ind = diadromous_soy$Study_id,criteria = "AICc")#, knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_diadromous_soy$info
plot(fit_diadromous_soy, type="diagnostic")



#PLOT
plotSmeModel(fit_diadromous_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, lwd=2, col.meanCurve='#D9EF8B', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=70, lty=2, lwd=1, col='grey20'))))



#Diadromous fishes and insect


diadromous_insects <- 
  fishmeal %>% 
  filter(Fish_group=="Diadromous fishes" & Feed_general=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(diadromous_insects$Replacement), max(diadromous_insects$Replacement), length.out = 4)[-c(1,4)]

fit_diadromous_insect <- sme(object = diadromous_insects$Relative_FCR, tme = diadromous_insects$Replacement, ind = diadromous_insects$Study_id,criteria = "AICc", knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_diadromous_insect$info
plot(fit_diadromous_insect, type="diagnostic")



#PLOT
plotSmeModel(fit_diadromous_insect, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, lwd=2, col.meanCurve='#D9EF8B', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=73, lty=2, lwd=1, col='grey20'))))


```

#Salmonids

```{r}

salmon_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Salmonids" & Broad_feed=="Microalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(salmon_algae$FM_Replacement), max(salmon_algae$FM_Replacement), length.out = 5)[-c(1,5)]

fit_salmon_algae <- sme(object = salmon_algae$Relative_FCR, tme = salmon_algae$FM_Replacement, ind = salmon_algae$Study_id,criteria = "AICc", knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_salmon_algae$info
plot(fit_salmon_algae, type="diagnostic")



#PLOT
plotSmeModel(fit_salmon_algae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=30, lty=2, lwd=1, col='grey20'))))




#Salmmonids and macroalgae

salmon_macroalgae <- 
  fishmeal %>% 
  filter(Fish_group=="Salmonids" & Broad_feed=="Macroalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(salmon_macroalgae$FM_Replacement), max(salmon_macroalgae$FM_Replacement), length.out = 5)[-c(1,5)]

fit_salmon_macroalgae <- sme(object = salmon_macroalgae$Relative_FCR, tme = salmon_macroalgae$FM_Replacement, ind = salmon_macroalgae$Study_id,criteria = "AICc")#, knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_salmon_macroalgae$info
plot(fit_salmon_macroalgae, type="diagnostic")



#PLOT
plotSmeModel(fit_salmon_macroalgae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=15, lty=2, lwd=1, col='grey20'))))






#Bacteria and yeasts and Salmonids

salmon_scps <- 
  fishmeal %>% 
  filter(Fish_group=="Salmonids" & Broad_feed=="Bacteria and yeasts") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(salmon_scps$FM_Replacement), max(salmon_scps$FM_Replacement), length.out = 6)[-c(1,6)]

fit_salmon_scps <- sme(object = salmon_scps$Relative_FCR, tme = salmon_scps$FM_Replacement, ind = salmon_scps$Study_id,criteria = "AICc")#, knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_salmon_scps$info
plot(fit_salmon_scps, type="diagnostic")



#PLOT
plotSmeModel(fit_salmon_scps, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#ABDDA4', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))



# Salmon and Soy


salmon_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Salmonids" & Broad_feed=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(salmon_soy$FM_Replacement), max(salmon_soy$FM_Replacement), length.out = 4)[-c(1,4)]

fit_salmon_soy <- sme(object = salmon_soy$Relative_FCR, tme = salmon_soy$FM_Replacement, ind = salmon_soy$Study_id,criteria = "AICc", knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_salmon_soy$info
plot(fit_salmon_soy, type="diagnostic")



#PLOT
plotSmeModel(fit_salmon_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#ABDDA4', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='grey20'))))





#Salmon and insects


salmon_insect <- 
  fishmeal %>% 
  filter(Fish_group=="Salmonids" & Broad_feed=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(salmon_insect$FM_Replacement), max(salmon_insect$FM_Replacement), length.out = 4)[-c(1,4)]

fit_salmon_insect <- sme(object = salmon_insect$Relative_FCR, tme = salmon_insect$FM_Replacement, ind = salmon_insect$Study_id, criteria = "AICc", deltaEM = 0.01, knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_salmon_insect$info
plot(fit_salmon_insect, type="diagnostic")



#PLOT
plotSmeModel(fit_salmon_insect, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#ABDDA4', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='grey20'))))


```



#Shrimps

```{r}

#Shrimp and Algae

shrimps_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Shrimps" & Broad_feed=="Microalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(shrimps_algae$FM_Replacement), max(shrimps_algae$FM_Replacement), length.out = 10)[-c(1,10)]

fit_shrimps_algae <- sme(object = shrimps_algae$Relative_FCR, tme = shrimps_algae$FM_Replacement, ind = shrimps_algae$Study_id,criteria = "AICc")

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_shrimps_algae$info
plot(fit_shrimps_algae, type="diagnostic")



#PLOT
plotSmeModel(fit_shrimps_algae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))



#Shrimps and macroalgae


shrimps_macroalgae <- 
  fishmeal %>% 
  filter(Fish_group=="Shrimps" & Broad_feed=="Macroalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(shrimps_macroalgae$FM_Replacement), max(shrimps_macroalgae$FM_Replacement), length.out = 5)[-c(1,5)]

fit_shrimps_macroalgae <- sme(object = shrimps_macroalgae$Relative_FCR, tme = shrimps_macroalgae$FM_Replacement, ind = shrimps_macroalgae$Study_id,criteria = "AICc", knots = myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_shrimps_macroalgae$info
plot(fit_shrimps_macroalgae, type="diagnostic")



#PLOT
plotSmeModel(fit_shrimps_macroalgae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=45, lty=2, lwd=1, col='red'))))







# SHrimps and Bacteria

shrimps_scps <- 
  fishmeal %>% 
  filter(Fish_group=="Shrimps" & Broad_feed=="Bacteria and yeasts") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(shrimps_scps$FM_Replacement), max(shrimps_scps$FM_Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_scps <- sme(object = shrimps_scps$Relative_FCR, tme = shrimps_scps$FM_Replacement, ind = shrimps_scps$Study_id,criteria = "AICc", knots=myknots)# knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_shrimps_scps$info
plot(fit_shrimps_scps, type="diagnostic")



#PLOT
plotSmeModel(fit_shrimps_scps, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#66C2A5', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='grey20'))))




# SHrimps and soy



shrimps_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Shrimps" & Broad_feed=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(shrimps_soy$FM_Replacement), max(shrimps_soy$FM_Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_soy <- sme(object = shrimps_soy$Relative_FCR, tme = shrimps_soy$FM_Replacement, ind = shrimps_soy$Study_id,criteria = "AICc")#, knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_shrimps_soy$info
plot(fit_shrimps_soy, type="diagnostic")



#PLOT
plotSmeModel(fit_shrimps_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#66C2A5', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='grey20'))))





#Shrimps and insects 



shrimps_insect <- 
  fishmeal %>% 
  filter(Fish_group=="Shrimps" & Broad_feed=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(shrimps_insect$FM_Replacement), max(shrimps_insect$FM_Replacement), length.out = 5)[-c(1,5)]

fit_shrimps_insect <- sme(object = shrimps_insect$Relative_FCR, tme = shrimps_insect$FM_Replacement, ind = shrimps_insect$Study_id,criteria = "AICc")#, knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_shrimps_insect$info
plot(fit_shrimps_insect, type="diagnostic")



#PLOT
plotSmeModel(fit_shrimps_insect, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#66C2A5', col=alpha("grey50", 0.5), pch=16, las=1,tck=-0.01, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='grey20'))))







```

#Marine fishes

```{r}

#Marine fishes and algae


marine_algae <- 
  fishmeal %>% 
  filter(Fish_group=="Marine fishes" & Broad_feed=="Microalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(marine_algae$FM_Replacement), max(marine_algae$FM_Replacement), length.out = 10)[-c(1,10)]

fit_marine_algae <- sme(object = marine_algae$Relative_FCR, tme = marine_algae$FM_Replacement, ind = marine_algae$Study_id,criteria = "AICc")

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_marine_algae$info
plot(fit_marine_algae, type="diagnostic")



#PLOT
plotSmeModel(fit_marine_algae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=80, lty=2, lwd=1, col='grey20'))))





#Marine fishes and macroalgae

marine_macroalgae <- 
  fishmeal %>% 
  filter(Fish_group=="Marine fishes" & Broad_feed=="Macroalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(marine_macroalgae$FM_Replacement), max(marine_macroalgae$FM_Replacement), length.out = 6)[-c(1,6)]

fit_marine_macroalgae <- sme(object = marine_macroalgae$Relative_FCR, tme = marine_macroalgae$FM_Replacement, ind = marine_macroalgae$Study_id,criteria = "AICc")

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_marine_macroalgae$info
plot(fit_marine_macroalgae, type="diagnostic")



#PLOT
plotSmeModel(fit_marine_macroalgae, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=30, lty=2, lwd=1, col='grey20'))))



#Marine fishes and bacteria




marine_Scps <- 
  fishmeal %>% 
  filter(Fish_group=="Marine fishes" & Broad_feed=="Bacteria and yeasts") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(marine_Scps$FM_Replacement), max(marine_Scps$FM_Replacement), length.out = 6)[-c(1,6)]

fit_marine_scps <- sme(object = marine_Scps$Relative_FCR, tme = marine_Scps$FM_Replacement, ind = marine_Scps$Study_id,criteria = "AICc")#, knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_marine_scps$info
plot(fit_marine_scps, type="diagnostic")



#PLOT
plotSmeModel(fit_marine_scps, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3288BD', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=49, lty=2, lwd=1, col='grey20'))))




#Marine fishes and yeast



#marine fishes and soy



marine_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Marine fishes" & Broad_feed=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(marine_soy$FM_Replacement), max(marine_soy$FM_Replacement), length.out = 10)[-c(1,10)]

fit_marine_soy <- sme(object = marine_soy$Relative_FCR, tme = marine_soy$FM_Replacement, ind = marine_soy$Study_id,criteria = "AICc", deltaNM = 0.01)#,knots=myknots)


#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_marine_soy$info
plot(fit_marine_soy, type="diagnostic")


#PLOT
plotSmeModel(fit_marine_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3288BD', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=40, lty=2, lwd=1, col='grey20'))))





#MARINE FISHES AND INSECTS


marine_insect <- 
  fishmeal %>% 
  filter(Fish_group=="Marine fishes" & Broad_feed=="Insect") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(marine_insect$FM_Replacement), max(marine_insect$FM_Replacement), length.out = 6)[-c(1,6)]

fit_marine_insect <- sme(object = marine_insect$Relative_FCR, tme = marine_insect$FM_Replacement, ind = marine_insect$Study_id,criteria = "AICc",knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_marine_insect$info
plot(fit_marine_insect, type="diagnostic")

  
#PLOT
plotSmeModel(fit_marine_insect, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve='#3288BD', col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=78, lty=2, lwd=1, col='grey20'))))




```



#Tunas

```{r}

tuna_soy <- 
  fishmeal %>% 
  filter(Fish_group=="Tunas" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(tuna_soy$Replacement), max(tuna_soy$Replacement), length.out = 4)[-c(1,4)]

fit_tuna_soy <- sme(object = tuna_soy$Relative_FCR, tme = tuna_soy$Replacement, ind = tuna_soy$Study_id, criteria = "AICc", knots=myknots)

#Diagnostics - no real patterns in residuals and qq-plot satisfactory given the diverging data sets and expected outliers in the extremes
fit_tuna_soy$info
plot(fit_tuna_soy, type="diagnostic")


#PLOT
plotSmeModel(fit_tuna_soy, xlab="",ylab="", showIndividuals=T,  showConfidenceBands=T, col.meanCurve=, col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=18, lty=2, lwd=1, col='grey20'))))



```



#####Figure 2 - FISHMEAL REPLACEMENT AND FCR RESPONSE

```{r}


pdf("Fig 2 - FCR and fishmeal replacement.pdf", 
    width=7.20472441,
    height=7.1)
op <- par(mfrow=c(7,5), 
          mai=c(0.2,0.3,0.1,0.1), #spacing around each plot
          mgp=c(3,0.5,0), # middle value distance of labels to ticks
          oma = c(3, 4, 3, 1.5)) #space for the overall x and y axis titles
#carp_microalgae
plotSmeModel(fit_carp_algae, xlab=F, ylab=F, xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", lwd=3, col=alpha("grey50", 0.5), pch=16, yaxt="n", bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.38, labels = expression(italic("100%  (10)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#carp_macroalgae
plotSmeModel(fit_carp_macroalgae, xlab=F, ylab=F, xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#0C95BA", lwd=3, col=alpha("grey50", 0.5), pch=16, yaxt="n", bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=25, lty=2, lwd=1, col='red'))))+
text(x=-2, y=2.4, labels = expression(italic("25%  (1)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#carps scps
plotSmeModel(fit_carp_scps, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16, yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=66, lty=2, lwd=1, col='red')) ))+
text(x=-5, y=1.11, labels = expression(italic("65%  (2)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#carp_insects
plotSmeModel(fit_carp_insects,xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F5D523", pch=16, col=alpha("grey50", 0.5), yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.16, labels = expression(italic("100%  (5)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#carp_soy
plotSmeModel(fit_carp_soy,xlab="",ylab="",  xaxt="n",showIndividuals=T,  xaxs="i", showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=15, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.8, labels = expression(italic("15%  (3)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)






#catfish algae
plotSmeModel(fit_catfish_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, yaxt="n", bty = "l",panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=75, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.11, labels = expression(italic("75%  (2)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
  
#catfish macroalgae
plotSmeModel(fit_catfish_macroalgae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#0C95BA", col=alpha("grey50", 0.5), pch=16, yaxt="n", bty = "l",panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=5, lty=2, lwd=1, col='red'))))+
text(x=45, y=1.6, labels = expression(italic("5%  (1)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#catfish scps
plotSmeModel(fit_catfish_scps, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.2, labels = expression(italic("100%  (2)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#catfish_insects
plotSmeModel(fit_catfish_insects, xlab="",ylab="",  xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.45, labels = expression(italic("100%  (18)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#catfish soy
plotSmeModel(fit_catfish_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2.8, labels = expression(italic("50%  (10)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#FW fishes algae

plotSmeModel(fit_FW_algae, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=10, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.55, labels = expression(italic("10% (1)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#FW fishes macroalgae

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n",bty = "l")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(italic("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#FW fishes_scps
plot(1, type="n", xlab="", ylab="", xaxt="n", xlim=c(0, 100), ylim=c(0,100), yaxt= "n",bty = "l")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(italic("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#FW fishes insects
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n",bty = "l")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(italic("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#FW fishes soy
plotSmeModel(fit_FW_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=57, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.85, labels = expression(italic("55%  (12)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#tilapias algae
plotSmeModel(fit_tilapia_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, yaxt="n",  bty = "l",panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2.6, labels = expression(italic("100%  (6)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias macroalgae
plotSmeModel(fit_tilapia_macroalgae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#0C95BA", col=alpha("grey50", 0.5), pch=16, yaxt="n",  bty = "l",panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=40, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.89, labels = expression(italic("40%  (4)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias_scps
plotSmeModel(fit_tilapia_scps, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2.55, labels = expression(italic("100%  (9)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias_insects
plotSmeModel(fit_tilapia_insect, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=95, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.65, labels = expression(italic("95%  (7)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias soy
plotSmeModel(fit_tilapia_soy, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16, yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=71, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2.1, labels = expression(italic("70%  (14)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#shrimps algae
plotSmeModel(fit_shrimps_algae, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=4.4, labels = expression(italic("100%  (6)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#shrimps macroalgae
plotSmeModel(fit_shrimps_macroalgae, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#0C95BA", col=alpha("grey50", 0.5), pch=16,yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='red'))))+
text(x=45, y=1.18, labels = expression(italic("50%  (1)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#shrimps_scps
plotSmeModel(fit_shrimps_scps, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=20, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.26, labels = expression(italic("20%  (1)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#shrimps_insects
plotSmeModel(fit_shrimps_insect, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l",panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2, labels = expression(italic("100%  (3)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#shrimps soy
plotSmeModel(fit_shrimps_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.27, labels = expression(italic("100%  (9)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#salmonids algae
plotSmeModel(fit_salmon_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=32, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.62, labels = expression(italic("30%  (8)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#salmonids macroalgae

plotSmeModel(fit_salmon_macroalgae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#0C95BA", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=15, lty=2, lwd=1, col='red'))))+
text(x=45, y=1.75, labels = expression(italic("15%  (2)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#salmonids scps
plotSmeModel(fit_salmon_scps, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.6, labels = expression(italic("100%  (9)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#salmonids_insects
plotSmeModel(fit_salmon_insect, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
text(x=-5, y=1.11, labels = expression(italic("100%  (6)")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#salmonids soy
plotSmeModel(fit_salmon_soy, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2, labels = expression(italic("50%  (16)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#marine fishes algae
plotSmeModel(fit_marine_algae, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=80, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2.19, labels = expression(italic("80%  (20)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes macroalgae
plotSmeModel(fit_marine_macroalgae, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#0C95BA", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=30, lty=2, lwd=1, col='red'))))+
text(x=40, y=1.12, labels = expression(italic("30%  (2)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#marine fishes_scp
plotSmeModel(fit_marine_scps, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=45, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.63, labels = expression(italic("45%  (2)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes_insects
plotSmeModel(fit_marine_insect, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=78, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.5, labels = expression(italic("80%  (5)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#marine fishes soy
plotSmeModel(fit_marine_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='red'))))+
text(x=-5, y=5.8, labels = expression(italic("50%  (142)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


mtext("Fishmeal replacement (%)", side = 1, line=1, outer = T)
mtext(c("Carps", "Catfishes", "FW fishes", "Tilapias",   "Shrimps", "Salmonids","Marine fishes"), side=2, outer = T, line = 0.5,  at=rev(seq(from =.08, to=.94, length.out = 7)), cex = 0.75, font=3)
mtext("Relative feed conversion ratio",side = 2, line=2, outer = T)
mtext(c("Microalgae", "Macroalgae", "Bacteria & yeasts", "Insects", "Soy"), side=3, line = 0, outer = T, at=c(.12, .32, .52, .72, .92), cex = 0.8, font=4)

par(op)
dev.off()



tiff("Fig 2 - FCR and fishmeal replacement.tiff", 
    width=7.20472441,
    height=7.1,
    units = 'in',
    res=300)
op <- par(mfrow=c(7,5), 
          mai=c(0.2,0.3,0.1,0.1), #spacing around each plot
          mgp=c(3,0.5,0), # middle value distance of labels to ticks
          oma = c(3, 4, 3, 1.5)) #space for the overall x and y axis titles
#carp_microalgae
plotSmeModel(fit_carp_algae, xlab=F, ylab=F, xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", lwd=3, col=alpha("grey50", 0.5), pch=16, yaxt="n", bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.38, labels = expression(italic("100%  (10)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#carp_macroalgae
plotSmeModel(fit_carp_macroalgae, xlab=F, ylab=F, xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#0C95BA", lwd=3, col=alpha("grey50", 0.5), pch=16, yaxt="n", bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=25, lty=2, lwd=1, col='red'))))+
text(x=-2, y=2.4, labels = expression(italic("25%  (1)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#carps scps
plotSmeModel(fit_carp_scps, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16, yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=66, lty=2, lwd=1, col='red')) ))+
text(x=-5, y=1.11, labels = expression(italic("65%  (2)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#carp_insects
plotSmeModel(fit_carp_insects,xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F5D523", pch=16, col=alpha("grey50", 0.5), yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.16, labels = expression(italic("100%  (5)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#carp_soy
plotSmeModel(fit_carp_soy,xlab="",ylab="",  xaxt="n",showIndividuals=T,  xaxs="i", showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=15, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.8, labels = expression(italic("15%  (3)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)






#catfish algae
plotSmeModel(fit_catfish_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, yaxt="n", bty = "l",panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=75, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.11, labels = expression(italic("75%  (2)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
  
#catfish macroalgae
plotSmeModel(fit_catfish_macroalgae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#0C95BA", col=alpha("grey50", 0.5), pch=16, yaxt="n", bty = "l",panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=5, lty=2, lwd=1, col='red'))))+
text(x=45, y=1.6, labels = expression(italic("5%  (1)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#catfish scps
plotSmeModel(fit_catfish_scps, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.2, labels = expression(italic("100%  (2)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#catfish_insects
plotSmeModel(fit_catfish_insects, xlab="",ylab="",  xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.45, labels = expression(italic("100%  (18)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#catfish soy
plotSmeModel(fit_catfish_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2.8, labels = expression(italic("50%  (10)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#FW fishes algae

plotSmeModel(fit_FW_algae, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=10, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.55, labels = expression(italic("10% (1)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#FW fishes macroalgae

plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n",bty = "l")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(italic("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#FW fishes_scps
plot(1, type="n", xlab="", ylab="", xaxt="n", xlim=c(0, 100), ylim=c(0,100), yaxt= "n",bty = "l")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(italic("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#FW fishes insects
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100), xaxt="n", yaxt= "n",bty = "l")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(italic("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#FW fishes soy
plotSmeModel(fit_FW_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=57, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.85, labels = expression(italic("55%  (12)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#tilapias algae
plotSmeModel(fit_tilapia_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, yaxt="n",  bty = "l",panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2.6, labels = expression(italic("100%  (6)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias macroalgae
plotSmeModel(fit_tilapia_macroalgae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#0C95BA", col=alpha("grey50", 0.5), pch=16, yaxt="n",  bty = "l",panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=40, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.89, labels = expression(italic("40%  (4)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias_scps
plotSmeModel(fit_tilapia_scps, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2.55, labels = expression(italic("100%  (9)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias_insects
plotSmeModel(fit_tilapia_insect, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=95, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.65, labels = expression(italic("95%  (7)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias soy
plotSmeModel(fit_tilapia_soy, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16, yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=71, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2.1, labels = expression(italic("70%  (14)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#shrimps algae
plotSmeModel(fit_shrimps_algae, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=4.4, labels = expression(italic("100%  (6)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#shrimps macroalgae
plotSmeModel(fit_shrimps_macroalgae, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#0C95BA", col=alpha("grey50", 0.5), pch=16,yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='red'))))+
text(x=45, y=1.18, labels = expression(italic("50%  (1)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#shrimps_scps
plotSmeModel(fit_shrimps_scps, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=20, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.26, labels = expression(italic("20%  (1)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#shrimps_insects
plotSmeModel(fit_shrimps_insect, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l",panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2, labels = expression(italic("100%  (3)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#shrimps soy
plotSmeModel(fit_shrimps_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.27, labels = expression(italic("100%  (9)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#salmonids algae
plotSmeModel(fit_salmon_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=32, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.62, labels = expression(italic("30%  (8)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#salmonids macroalgae

plotSmeModel(fit_salmon_macroalgae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#0C95BA", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=15, lty=2, lwd=1, col='red'))))+
text(x=45, y=1.75, labels = expression(italic("15%  (2)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#salmonids scps
plotSmeModel(fit_salmon_scps, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.6, labels = expression(italic("100%  (9)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#salmonids_insects
plotSmeModel(fit_salmon_insect, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
text(x=-5, y=1.11, labels = expression(italic("100%  (6)")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#salmonids soy
plotSmeModel(fit_salmon_soy, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2, labels = expression(italic("50%  (16)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#marine fishes algae
plotSmeModel(fit_marine_algae, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=80, lty=2, lwd=1, col='red'))))+
text(x=-5, y=2.19, labels = expression(italic("80%  (20)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes macroalgae
plotSmeModel(fit_marine_macroalgae, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#0C95BA", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=30, lty=2, lwd=1, col='red'))))+
text(x=40, y=1.12, labels = expression(italic("30%  (2)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#marine fishes_scp
plotSmeModel(fit_marine_scps, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt="n",bty = "l",  panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=45, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.63, labels = expression(italic("45%  (2)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes_insects
plotSmeModel(fit_marine_insect, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=78, lty=2, lwd=1, col='red'))))+
text(x=-5, y=1.5, labels = expression(italic("80%  (5)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#marine fishes soy
plotSmeModel(fit_marine_soy, xlab="",ylab="", xaxt="n", showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=50, lty=2, lwd=1, col='red'))))+
text(x=-5, y=5.8, labels = expression(italic("50%  (142)")), cex=1,pos = 4)+
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


mtext("Fishmeal replacement (%)", side = 1, line=1, outer = T)
mtext(c("Carps", "Catfishes", "FW fishes", "Tilapias",   "Shrimps", "Salmonids","Marine fishes"), side=2, outer = T, line = 0.5,  at=rev(seq(from =.08, to=.94, length.out = 7)), cex = 0.75, font=3)
mtext("Relative feed conversion ratio",side = 2, line=2, outer = T)
mtext(c("Microalgae", "Macroalgae", "Bacteria & yeasts", "Insects", "Soy"), side=3, line = 0, outer = T, at=c(.12, .32, .52, .72, .92), cex = 0.8, font=4)
par(op)
dev.off()





```


###FISH OIL SUBSTITUTION _ FCR response??

#sort fish oil nutrition data first
```{r}


FO <- 
  fish_oil

```




#catfishes 

```{r}
catfishes_algae <- 
  fish_oil %>% 
  filter(Fish_group=="Catfishes" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(catfishes_algae$Replacement), max(catfishes_algae$Replacement), length.out = 4)[-c(1,4)]

fit_catfishes_algae <- sme(object = catfishes_algae$Relative_FCR, tme = catfishes_algae$Replacement, ind = catfishes_algae$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_catfishes_algae$info
plot(fit_catfishes_algae, "diagnostic")


plotSmeModel(fit_catfishes_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#D53E4F", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=50, lty=2, lwd=1, col='black')) ))




```


#FRESHWATER FISHES

```{r}

#NOT ENOUGH DATA

fwfishes_soy <- 
  fish_oil %>% 
  filter(Fish_group=="Freshwater fishes" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#Analysis
myknots <- seq(min(fwfishes_soy$Replacement), max(fwfishes_soy$Replacement), length.out = 4)[-c(1,4)]

fit_fwfishes_soy <- sme(object = fwfishes_soy$Relative_FCR, tme = fwfishes_soy$Replacement, ind = fwfishes_soy$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_fwfishes_soy$info
plot(fit_fwfishes_soy, "diagnostic")


plotSmeModel(fit_fwfishes_soy, xlab="",ylab="", showIndividuals=F, showConfidenceBands=F, col.meanCurve="#F46D43", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=50, lty=2, lwd=1, col='black')) ))






```

#SALMONIDS 

```{r}

salmonids_algae <- 
  FO %>% 
  filter(Fish_group=="Salmonids" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) 


myknots <- seq(min(salmonids_algae$FO_replacement), max(salmonids_algae$FO_replacement), length.out = 4)[-c(1,4)]

fit_salmonids_algae <- sme(object = salmonids_algae$Relative_FCR, tme = salmonids_algae$FO_replacement, ind = salmonids_algae$Study_id, criteria = "AICc")



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_algae$info
plot(fit_salmonids_algae, "diagnostic")


plotSmeModel(fit_salmonids_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
text(x=10, y=1.1, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#Salmonids and soy


salmonids_soy <- 
  FO %>% 
  filter(Fish_group=="Salmonids" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) %>% 
  drop_na(Relative_FCR)


myknots <- seq(min(salmonids_soy$FO_replacement), max(salmonids_soy$FO_replacement), length.out = 4)[-c(1,4)]

fit_salmonids_soy <- sme(object = salmonids_soy$Relative_FCR, tme = salmonids_soy$FO_replacement, ind = salmonids_soy$Study_id, criteria = "AICc",knots = myknots)


#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_soy$info #won't converge - plotting model to describe trend
plot(fit_salmonids_soy, "diagnostic")


plotSmeModel(fit_salmonids_soy, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#E9B186", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=10, lty=2, lwd=1, col='red'))))
text(x=10, y=1.1, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


# #Won't converge two few data points  - leave out?
# 
# salmonids_yeast <- 
#   FO %>% 
#   filter(Fish_group=="Salmonids" & Feed_general=="Yeast") %>% 
#   mutate(Study_id = Study_id %>% 
#            as.factor) %>% 
#   drop_na(Relative_FCR)
# 
# 
# myknots <- seq(min(salmonids_yeast$FO_replacement), max(salmonids_yeast$FO_replacement), length.out = 4)[-c(1,4)]
# 
# fit_salmonids_yeast <- sme(object = salmonids_yeast$Relative_FCR, tme = salmonids_yeast$FO_replacement, ind = salmonids_yeast$Study_id, criteria = "AICc",knots = myknots)
# 
# 
# #Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
# fit_salmonids_yeast$info #won't converge - plotting model to describe trend
# plot(fit_salmonids_yeast, "diagnostic")
# 
# 
# plotSmeModel(fit_salmonids_yeast, xlab="",ylab="", showIndividuals=F, showConfidenceBands=F, col.meanCurve="#ABDDA4", col=alpha("grey50", 0.5), pch=16, lwd=2, panel.first = c((abline(h=1.05, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black'))))




```


#SHRIMPS

```{r}


shrimpy_algae <- 
  FO %>% 
  filter(Fish_group=="Shrimps" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) %>% 
  drop_na(Relative_FCR)


myknots <- seq(min(shrimpy_algae$FO_replacement), max(shrimpy_algae$FO_replacement), length.out = 4)[-c(1,4)]

fit_shrimpy_algae <- sme(object = shrimpy_algae$Relative_FCR, tme = shrimpy_algae$FO_replacement, ind = shrimpy_algae$Study_id, criteria = "AICc", knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model (LOESS)
fit_shrimpy_algae$info
plot(fit_shrimpy_algae, "diagnostic")

#fit_shrimpy_algae <- loess(shrimpy_algae$Relative_FCR~shrimpy_algae$FO_replacement)


plotSmeModel(fit_shrimpy_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
text(x=10, y=1.1, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Shrimps and soy

shrimpy_soy <- 
  FO %>% 
  filter(Fish_group=="Shrimps" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) %>% 
  drop_na(Relative_FCR)


myknots <- seq(min(shrimpy_soy$FO_replacement), max(shrimpy_soy$FO_replacement), length.out = 4)[-c(1,4)]

fit_shrimpy_soy <- sme(object = shrimpy_soy$Relative_FCR, tme = shrimpy_soy$FO_replacement, ind = shrimpy_soy$Study_id, criteria = "AICc")



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimpy_soy$info
plot(fit_shrimpy_soy, "diagnostic")


plotSmeModel(fit_shrimpy_soy, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#E9B186", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=30, lty=2, lwd=1, col='red'))))
text(x=10, y=1.1, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




```


#MARINE FISHES

```{r}
marinefishes_algae <- 
  FO %>% 
  filter(Fish_group=="Marine fishes" & Feed_general=="Algae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) %>% 
  drop_na(Relative_FCR)

#Analysis
myknots <- seq(min(marinefishes_algae$FO_replacement), max(marinefishes_algae$FO_replacement), length.out = 7)[-c(1,7)]

fit_marinefishes_algae <- sme(object = marinefishes_algae$Relative_FCR, tme = marinefishes_algae$FO_replacement, ind = marinefishes_algae$Study_id, criteria = "AICc")



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marinefishes_algae$info
plot(fit_marinefishes_algae, "diagnostic")


plotSmeModel(fit_marinefishes_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
text(x=10, y=1.35, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#marine fishes and soy

marinefishes_soy <- 
  FO %>% 
  filter(Fish_group=="Marine fishes" & Feed_general=="Soy") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) %>% 
  drop_na(Relative_FCR)

#Analysis
myknots <- seq(min(marinefishes_soy$FO_replacement), max(marinefishes_soy$FO_replacement), length.out = 5)[-c(1,5)]

fit_marinefishes_soy <- sme(object = marinefishes_soy$Relative_FCR, tme = marinefishes_soy$FO_replacement, ind = marinefishes_soy$Study_id, criteria = "AICc")



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marinefishes_soy$info
plot(fit_marinefishes_soy, "diagnostic")


plotSmeModel(fit_marinefishes_soy, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#E9B186", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=17, lty=2, lwd=1, col='red'))))
text(x=10, y=1.4, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


```

###SUPPLEMENTARY FIG - FISH OIL REPLACEMENT AND FCR RESPONSE

```{r}

pdf("Supplementary Figure 1 - FCR and fish oil replacement.pdf", 
    width=3.5,
    height=3.7)
op <- par(mfrow=c(3,2), 
          mai=c(0.2,0.3,0.1,0.1), #spacing around each plot
          mgp=c(3,0.5,0), # middle value distance of labels to ticks
          oma = c(3, 4, 1.5, 1.5)) #space for the overall x and y axis titles





#Shrimps and algae 
plotSmeModel(fit_shrimpy_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
#text(x=2, y=1.13, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Shrimps and soy 
plotSmeModel(fit_shrimpy_soy, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=30, lty=2, lwd=1, col='red'))))
#text(x=2, y=1.14, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#Salmonids and algae 
plotSmeModel(fit_salmonids_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
#text(x=2, y=1.14, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#Salmonids and soy 
plotSmeModel(fit_salmonids_soy, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=10, lty=2, lwd=1, col='red'))))
#text(x=2, y=1.14, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#Marine fishes and algae
plotSmeModel(fit_marinefishes_algae, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=100, lty=2, lwd=1, col='red'))))
#text(x=2, y=1.35, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Marine fishes and soy
plotSmeModel(fit_marinefishes_soy, xlab="",ylab="",  xaxt="n",showIndividuals=T,  showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt="n", bty = "l", panel.first = c((abline(h=1.05, lty=2, lwd=1, col='grey20')),(abline(v=17, lty=2, lwd=1, col='red'))))
#text(x=2, y=1.4, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


mtext("Fish oil replacement (%)", side = 1, line=1, outer = T, cex=1)
mtext("Relative feed conversion ratio",side = 2, line=2, outer = T, cex=1)
mtext(c("Microalgae", "Soy-oil blends"), side=3, line = 0, outer = T, at=c(0.27,0.77), cex = 0.75, font=3)
mtext(c("Shrimps", "Salmonids","Marine fishes"), side=2, line = 0.5, outer = T, at=rev(seq(from =.2, to=.85, length.out = 3)), cex = 0.75, font=3)
par(op)
dev.off()


```


##### SECTION 3 HUMAN HEALTH TRADE OFFS WITH FISH OIL SUBSTITUITION

#sort fish oil nutrition data first
```{r}

FO <- 
  fish_oil %>% 
  mutate(n3n6 = as.numeric(n3n6))%>% 
  filter(!is.na(n3n6))%>%
  mutate(Relative_n3_index = as.numeric(Relative_n3_index))




#Shrimps and algae
length(unique(FO$Study_id[(!is.na(FO$FO_replacement)) & FO$Broad_feed=="Microalgae" & FO$Fish_group=="Shrimps"])) #3



#Shrimps and soy 

length(unique(FO$Study_id[(!is.na(FO$FO_replacement)) & FO$Broad_feed=="Soy-oil mix" & FO$Fish_group=="Shrimps"])) #4






#Salmonids and algae
length(unique(FO$Study_id[(!is.na(FO$FO_replacement)) & FO$Broad_feed=="Microalgae" & FO$Fish_group=="Salmonids"])) #5


#Salmonids and soy 

length(unique(FO$Study_id[(!is.na(FO$FO_replacement)) & FO$Broad_feed=="Soy-oil mix" & FO$Fish_group=="Salmonids"])) #6





#Marine fishes and algae
length(unique(FO$Study_id[(!is.na(FO$FO_replacement)) & FO$Broad_feed=="Microalgae" & FO$Fish_group=="Marine fishes"])) #21




#Marine fishes and soy 

length(unique(FO$Study_id[(!is.na(FO$FO_replacement)) & FO$Broad_feed=="Soy-oil mix" & FO$Fish_group=="Marine fishes"])) #17

unique(FO$Broad_feed)
FO[FO$Broad_feed=="Bacteria and yeasts",]


```


#SALMONIDS 

```{r}

#Salmonids and algae

salmon_algae_n3 <- 
  FO %>% 
  filter(Fish_group=="Salmonids" & Broad_feed=="Microalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

myknots <- c(13,70)
  
myknots <- seq(min(salmon_algae_n3$FO_replacement), max(salmon_algae_n3$FO_replacement), length.out = 5)[-c(1,5)]

fit_salmonids_algae_n3 <- sme(object = salmon_algae_n3$Relative_n3_index, tme = salmon_algae_n3$FO_replacement, ind = salmon_algae_n3$Study_id, criteria = "AICc", knots = myknots)


#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_algae_n3$info
plot(fit_salmonids_algae_n3, "diagnostic")


plotSmeModel(fit_salmonids_algae_n3, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=55, lty=2, lwd=1, col='black')) ))



#Salmonids and soy

salmon_soy_n3 <- 
  FO %>% 
  filter(Fish_group=="Salmonids" & Broad_feed=="Soy-oil mix") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor) 

unique(salmon_soy_n3$Study_id)

myknots <-  seq(min(salmon_soy_n3$FO_replacement), max(salmon_soy_n3$FO_replacement), length.out = 6)[-c(1,6)]

fit_salmon_soy_n3 <- sme(object = salmon_soy_n3$Relative_n3_index, tme = salmon_soy_n3$FO_replacement, ind = salmon_soy_n3$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmon_soy_n3$info
plot(fit_salmon_soy_n3, "diagnostic")


plotSmeModel(fit_salmon_soy_n3, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=8, lty=2, lwd=1, col='black')) ))




```


#SHRIMPS

```{r}

#shrimps and algae
shrimps_algae_n3 <- 
  FO %>% 
  filter(Fish_group=="Shrimps" & Broad_feed=="Microalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)


myknots <- c(60, 90)
  
  
myknots <- seq(min(shrimps_algae_n3$FO_replacement), max(shrimps_algae_n3$FO_replacement), length.out = 4)[-c(1,4)]

fit_shrimps_algae_n3 <- sme(object = shrimps_algae_n3$Relative_n3_index, tme = shrimps_algae_n3$FO_replacement, ind = shrimps_algae_n3$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimps_algae_n3$info

plot(fit_shrimps_algae_n3, "diagnostic")


plotSmeModel(fit_shrimps_algae_n3, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))




#SHRIMPS AND SOY

shrimps_soy_n3 <- 
  FO %>% 
  filter(Fish_group=="Shrimps" & Broad_feed=="Soy-oil mix") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)


myknots <- seq(min(shrimps_soy_n3$FO_replacement), max(shrimps_soy_n3$FO_replacement), length.out = 7)[-c(1,7)]

fit_shrimps_soy_n3 <- sme(object = shrimps_soy_n3$Relative_n3_index, tme = shrimps_soy_n3$FO_replacement, ind = shrimps_soy_n3$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics 
fit_shrimps_soy_n3$info
plot(fit_shrimps_soy_n3, "diagnostic")


plotSmeModel(fit_shrimps_soy_n3, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, yaxt="n", col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=25, lty=2, lwd=1, col='black')) ))
text(x=-5, y=2.8, labels = expression(bold("100%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)





```


#MARINE FISHES

```{r}

#Marine fishes and algae

marine_algae_n3 <- 
  FO %>% 
  filter(Fish_group=="Marine fishes" & Broad_feed=="Microalgae") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)

#myknots <- c(10,20,30,40,50,60, 80)
myknots <- seq(min(marine_algae_n3$FO_replacement), max(marine_algae_n3$FO_replacement), length.out = 7)[-c(1,7)]

fit_marine_algae_n3 <- sme(object = marine_algae_n3$Relative_n3_index, tme = marine_algae_n3$FO_replacement, ind = marine_algae_n3$Study_id, criteria = "AICc",knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_algae_n3$info
plot(fit_marine_algae_n3, "diagnostic")


plotSmeModel(fit_marine_algae_n3, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='black')) ))

#Marine and soy


marine_soy_n3 <- 
  FO %>% 
  filter(Fish_group=="Marine fishes" & Broad_feed=="Soy-oil mix") %>% 
  mutate(Study_id = Study_id %>% 
           as.factor)


myknots <- seq(min(marine_soy_n3$FO_replacement), max(marine_soy_n3$FO_replacement), length.out = 7)[-c(1,7)]

fit_marine_soy_n3 <- sme(object = marine_soy_n3$Relative_n3_index, tme = marine_soy_n3$FO_replacement, ind = marine_soy_n3$Study_id, criteria = "AICc")#,knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_soy_n3$info
plot(fit_marine_soy_n3, "diagnostic")


plotSmeModel(fit_marine_soy_n3, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=26, lty=2, lwd=1, col='black')) ))



```


#FIG 3 - FISH OIL REPLACEMENT HEALTH TRADE_OFFS


```{r}

pdf("Fig 3  - omega 3 and fish oil replacement.pdf", 
    width=3.5,
    height=3.7)
# op <- par(mfrow=c(3,2), 
#           mai=c(0.2,0.3,0.1,0.1), #spacing around each plot
#           mgp=c(3,0.5,0), # middle value distance of labels to ticks
#           oma = c(3, 4, 3, 1.5)) #space for the overall x and y axis titles

op <- par(mfrow=c(3,2), 
          mai=c(0.2,0.3,0.1,0.05), #spacing around each plot
          mgp=c(3,0.5,0), # middle value distance of labels to ticks
          oma = c(3, 4, 3, 1.5)) #space for the overall x and y axis titles




#Shrimps and algae
plotSmeModel(fit_shrimps_algae_n3, xlab="",ylab="",xaxt="n",yaxt="n", bty = "l", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red')) ))
text(x=-5, y=1.13, labels = "100%  (3)", cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Shrimps and soy
plotSmeModel(fit_shrimps_soy_n3, xlab="",ylab="",xaxt="n",yaxt="n", bty = "l", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=32, lty=2, lwd=1, col='red')) ))
text(x=50, y=1.05, labels = "30%  (4)", cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Salmonids algae n3
plotSmeModel(fit_salmonids_algae_n3, xlab="",ylab="", xaxt="n",yaxt="n", bty = "l", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red')) ))
text(x=-5, y=1.55, labels = "100%  (5)", cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Salmonids soy n3
plotSmeModel(fit_salmon_soy_n3, xlab="",ylab="",xaxt="n",yaxt="n", bty = "l", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=8, lty=2, lwd=1, col='red')) ))
text(x=50, y=1.05, labels = "10%  (6)", cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes and algae
plotSmeModel(fit_marine_algae_n3, xlab="",ylab="",xaxt="n",yaxt="n", bty = "l",showIndividuals=T, showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red')) ))
text(x=-5, y=4.1, labels = "100%  (21)", cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes and soy
plotSmeModel(fit_marine_soy_n3, xlab="",ylab="", xaxt="n",yaxt="n", bty = "l",showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=25,lty=2, lwd=1, col='red')) ))
text(x=-5, y=.3, labels = "25%  (17)", cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

# mtext("Fish oil replacement (%)", side = 1, line=1, outer = T, cex=1)
# mtext("Relative n-3:n-6 fatty acid ratio",side = 2, line=2, outer = T, cex=1)
# mtext(c("Algae", "Soy"), side=2, line = 0.5, outer = T, at=c(0.27,0.77), cex = 0.75, font=3)
# mtext(c(  "Shrimps", "Salmonids","Marine fishes"), side=1, line = 0.3, outer = T, at=rev(seq(from =.2, to=.85, length.out = 3)), cex = 0.75, font=3)



mtext("Fish oil replacement (%)", side = 1, line=1, outer = T, cex=1)
mtext("Relative omega-3 index",side = 2, line=2, outer = T, cex=1)
mtext(c("Microalgae", "Soy-oil blends"), side=3, line = 0, outer = T, at=c(0.27,0.77), cex = 0.75, font=3)
mtext(c(  "Shrimps", "Salmonids","Marine fishes"), side=2, line = 0.5, outer = T, at=rev(seq(from =.2, to=.85, length.out = 3)), cex = 0.75, font=3)

par(op)
dev.off()




tiff("Fig 3  - omega-3 and fish oil replacement.tiff", 
    width=3.5,
    height=3.7,
    units='in',
    res=300)
op <- par(mfrow=c(3,2), 
          mai=c(0.2,0.3,0.1,0.05), #spacing around each plot
          mgp=c(3,0.5,0), # middle value distance of labels to ticks
          oma = c(3, 4, 3, 1.5)) #space for the overall x and y axis titles







#Shrimps and algae
plotSmeModel(fit_shrimps_algae_n3, xlab="",ylab="",xaxt="n",yaxt="n", bty = "l", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red')) ))
text(x=-5, y=1.13, labels = "100%  (3)", cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Shrimps and soy
plotSmeModel(fit_shrimps_soy_n3, xlab="",ylab="",xaxt="n",yaxt="n", bty = "l", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=32, lty=2, lwd=1, col='red')) ))
text(x=50, y=1.05, labels = "30%  (4)", cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Salmonids algae n3
plotSmeModel(fit_salmonids_algae_n3, xlab="",ylab="", xaxt="n",yaxt="n", bty = "l", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red')) ))
text(x=-5, y=1.55, labels = "100%  (5)", cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#Salmonids soy n3
plotSmeModel(fit_salmon_soy_n3, xlab="",ylab="",xaxt="n",yaxt="n", bty = "l", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=8, lty=2, lwd=1, col='red')) ))
text(x=50, y=1.05, labels = "10%  (6)", cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes and algae
plotSmeModel(fit_marine_algae_n3, xlab="",ylab="",xaxt="n",yaxt="n", bty = "l",showIndividuals=T, showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=100, lty=2, lwd=1, col='red')) ))
text(x=-5, y=4.1, labels = "100%  (21)", cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes and soy
plotSmeModel(fit_marine_soy_n3, xlab="",ylab="", xaxt="n",yaxt="n", bty = "l",showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(h=0.95, lty=2, lwd=1, col='black')),(abline(v=25,lty=2, lwd=1, col='red')) ))
text(x=-5, y=.3, labels = "25%  (17)", cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



mtext("Fish oil replacement (%)", side = 1, line=1, outer = T, cex=1)
mtext("Relative omega-3 index",side = 2, line=2, outer = T, cex=1)
mtext(c("Microalgae", "Soy-oil blends"), side=3, line = 0, outer = T, at=c(0.27,0.77), cex = 0.75, font=3)
mtext(c(  "Shrimps", "Salmonids","Marine fishes"), side=2, line = 0.5, outer = T, at=rev(seq(from =.2, to=.85, length.out = 3)), cex = 0.75, font=3)

mtext(c(  "Shrimps", "Salmonids","Marine fishes"), side=2, line = 0.5, outer = T, at=rev(seq(from =.2, to=.85, length.out = 3)), cex = 0.75, font=3)
par(op)
dev.off()

```


# Supplementary -  Change in fish oil from fishmeal replacement


#Plotting settings
```{r}
#Smoothing splines mixed effects models. SME package

######   BEFORE PLOTTING GO INTO BACKDOOR OF plotSmeModel TO MANUALLY STANDARDISE X AXIS LIMITS (EQUIVALENT OF XLIM=C(0,100)) AND MAKE SURE THAT YLIM IS AT LEAST WITHIN 5% OF ORIGINAL FCR

fix(plotSmeModel) 


#original xlim code - range(as.numeric(colnames(x$coefficients)))
#change xlim code -  range(as.numeric(c(colnames(x$coefficients),100)))

#original ylim code - range(x$data$y, mu$y, sapply(fs, "[[", "y"))
#change ylim with this code - range(c(x$data$y, mu$y, sapply(fs, "[[", "y"),1.15))

#tick marks
#at <- round(seq(round(ylim[1],2), round(ylim[2],2), length.out = 3),2)
#axis(side = 2, las=1, tck = -0.01, at = at, cex=0.8) #under the plot call

#show individual studies makes it clearer
#old code - lines(fs[[i]], lty = "dashed")
#change code - lines(fs[[i]], lty = "dotted", col=alpha("grey40", 1))



#Colours to use for species grousp

brewer.pal(10, "Spectral")

#[1] "#9E0142" "#D53E4F" "#F46D43" "#FDAE61" "#FEE08B" "#E6F598"
# [7] "#ABDDA4" "#66C2A5" "#3288BD" "#5E4FA2"


viridisLite::viridis(n=10)
# [1] "#440154FF" "#482878FF" "#3E4A89FF" "#31688EFF" "#26828EFF" "#1F9E89FF"
#  [7] "#35B779FF" "#6DCD59FF" "#B4DE2CFF" "#FDE725FF"
# 
# viridisLite::viridis(n=9)
# [1] "#440154FF" "#472D7BFF" "#3B528BFF" "#2C728EFF" "#21908CFF" "#27AD81FF"
# [7] "#5DC863FF" "#AADC32FF" "#FDE725FF"



```

#Sort data

```{r}

fish_oil_tradeoffs <- 
  fishmeal %>% 
  filter(!(is.na(FO_response)))



```

#CARPS
```{r}

#Macroalgae
#no dtaa

#Microalgae
  #no data





#Bacteria and yeasts
carp_fo_scp <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Carps" & Broad_feed=="Bacteria and yeasts") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor)


myknots <- seq(min(carp_fo_scp$FM_Replacement), max(carp_fo_scp$FM_Replacement), length.out = 4)[-c(1,4)]

fit_carp_fo_scp <- sme(object = carp_fo_scp$FO_response, tme = carp_fo_scp$FM_Replacement, ind = carp_fo_scp$Study_id, criteria = "AICc", deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_carp_fo_scp$info
plot(fit_carp_fo_scp, "diagnostic")


plotSmeModel(fit_carp_fo_scp, xlab="",ylab="", showIndividuals=T, showConfidenceBands=TRUE, col.meanCurve="#FDE725FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(v=0.1, lty=2, lwd=1, col='black')) ))






#carps and soy

#insufficient data

# Carps and insects

#insufficient data

```


#CATFISHES
```{r}


# #Catfishes and microalgae
#no data
# 
# 
# 
# #carps and macroalgae
# 
# no data
# 
# #catfishes and bacteria/yeast
# 
# no data

#carps and soy

catfishes_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Catfishes" & Broad_feed=="Soy") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor) 

myknots <- seq(min(catfishes_fo_soy$FM_Replacement), max(catfishes_fo_soy$FM_Replacement), length.out = 4)[-c(1,4)]

fit_catfishes_fo_soy <- sme(object = catfishes_fo_soy$FO_response, tme = catfishes_fo_soy$FM_Replacement, ind = catfishes_fo_soy$Study_id, criteria = "AICc", deltaEM =0.1,knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_catfishes_fo_soy$info
plot(fit_catfishes_fo_soy, "diagnostic")


plotSmeModel(fit_catfishes_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#AADC32FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=50, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='black'))



# catfish and insects

catfishes_fo_insects <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Catfishes" & Feed_general=="Insect") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor) 

myknots <- seq(min(catfishes_fo_insects$FM_Replacement), max(catfishes_fo_insects$FM_Replacement), length.out = 10)[-c(1,10)]

fit_catfishes_fo_insects <- sme(object = catfishes_fo_insects$FO_response, tme = catfishes_fo_insects$FM_Replacement, ind = catfishes_fo_insects$Study_id, criteria = "AICc")#, knots = myknots)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_catfishes_fo_insects$info
plot(fit_catfishes_fo_insects, "diagnostic")


plotSmeModel(fit_catfishes_fo_insects, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#AADC32FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='black'))





```

#FW FISHES
```{r}


#freshwater fishes and soy



fwfishes_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Freshwater fishes" & Broad_feed=="Soy") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor)

myknots <- seq(min(fwfishes_fo_soy$FM_Replacement), max(fwfishes_fo_soy$FM_Replacement), length.out = 8)[-c(1,8)]

fit_fwfishes_fo_soy <- sme(object = fwfishes_fo_soy$FO_response, tme = fwfishes_fo_soy$FM_Replacement, ind = fwfishes_fo_soy$Study_id, criteria = "AICc")#,knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_fwfishes_fo_soy$info
plot(fit_fwfishes_fo_soy, "diagnostic")


plotSmeModel(fit_fwfishes_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#5DC863FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=57, lty=2, lwd=1, col='black')),(abline(h=.9, lty=2, lwd=1, col='black')) ))






```

#TILAPIAS
```{r}

#tilapia and scps '


tilapia_fo_scps <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Tilapias" & Broad_feed=="Bacteria and yeasts") %>% 
  mutate(Study_id=Study_id %>% 
           as.factor)


myknots <- c(40,80)
#myknots <-   seq(min(tilapia_fo_yeast$FM_Replacement), max(tilapia_fo_yeast$FM_Replacement), length.out = 4)[-c(1,4)]

fit_tilapia_fo_scps <- sme(object = tilapia_fo_scps$FO_response, tme = tilapia_fo_scps$FM_Replacement, ind = tilapia_fo_scps$Study_id, criteria = "AICc",  deltaEM = 0.1, knots = myknots )



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_tilapia_fo_scps$info
plot(fit_tilapia_fo_scps, "diagnostic")


plotSmeModel(fit_tilapia_fo_scps, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#27AD81FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=38, lty=2, lwd=1, col='black')),(abline(h=-.215, lty=2, lwd=1, col='black')) ))







```

#CRUSTACEANS
```{r}

#crustaceans and soy

crustaceans_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Crustaceans" & Feed_general=="Soy") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)

myknots <- seq(min(crustaceans_fo_soy$FM_Replacement), max(crustaceans_fo_soy$FM_Replacement), length.out = 4)[-c(1,4)]

fit_crustaceans_fo_soy <- sme(object = crustaceans_fo_soy$FO_response, tme = crustaceans_fo_soy$FM_Replacement, ind = crustaceans_fo_soy$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_crustaceans_fo_soy$info
plot(fit_crustaceans_fo_soy, "diagnostic")


plotSmeModel(fit_crustaceans_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#21908CFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=67, lty=2, lwd=1, col='black')),(abline(h=1.61, lty=2, lwd=1, col='black')) ))





```

#DIADROMOUS FISHES
```{r}

#Diadromous fishes and algae

diad_fo_algae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Diadromous fishes" & Feed_general=="Algae") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(diad_fo_algae$FM_Replacement), max(diad_fo_algae$FM_Replacement), length.out = 4)[-c(1,4)]

fit_diad_fo_algae <- sme(object = diad_fo_algae$FO_response, tme = diad_fo_algae$FM_Replacement, ind = diad_fo_algae$Study_id, criteria = "AICc",knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_diad_fo_algae$info
plot(fit_diad_fo_algae, "diagnostic")


plotSmeModel(fit_diad_fo_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#2C728EFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=9, lty=2, lwd=1, col='black')),(abline(h=0.25, lty=2, lwd=1, col='black')) ))






#Diadromous fishes and soy

diad_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Diadromous fishes" & Feed_general=="Soy") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(diad_fo_soy$FM_Replacement), max(diad_fo_soy$FM_Replacement), length.out = 4)[-c(1,4)]

fit_diad_fo_soy <- sme(object = diad_fo_soy$FO_response, tme = diad_fo_soy$FM_Replacement, ind = diad_fo_soy$Study_id, criteria = "AICc",knots = myknots,deltaEM = 0.2)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_diad_fo_soy$info
plot(fit_diad_fo_soy, "diagnostic")


plotSmeModel(fit_diad_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#2C728EFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=70, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))




#Diadromous fishes and insects

diad_fo_insect <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Diadromous fishes" & Feed_general=="Insect") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(diad_fo_insect$FM_Replacement), max(diad_fo_insect$FM_Replacement), length.out = 7)[-c(1,7)]

fit_diad_fo_insect <- sme(object = diad_fo_insect$FO_response, tme = diad_fo_insect$FM_Replacement, ind = diad_fo_insect$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_diad_fo_insect$info
plot(fit_diad_fo_insect, "diagnostic")


plotSmeModel(fit_diad_fo_insect, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#2C728EFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=73, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))





```

#SALMONIDS
```{r}

salmonids_fo_algae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Salmonids" & Broad_feed=="Microalgae") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(salmonids_fo_algae$FM_Replacement), max(salmonids_fo_algae$FM_Replacement), length.out = 4)[-c(1,4)]

fit_salmonids_fo_algae <- sme(object = salmonids_fo_algae$FO_response, tme = salmonids_fo_algae$FM_Replacement, ind = salmonids_fo_algae$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_fo_algae$info
plot(fit_salmonids_fo_algae, "diagnostic")


plotSmeModel(fit_salmonids_fo_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=30, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))


#Macroalgae

salmonids_fo_macroalgae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Salmonids" & Broad_feed=="Macroalgae") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(salmonids_fo_macroalgae$FM_Replacement), max(salmonids_fo_macroalgae$FM_Replacement), length.out = 4)[-c(1,4)]

fit_salmonids_fo_macroalgae <- sme(object = salmonids_fo_macroalgae$FO_response, tme = salmonids_fo_macroalgae$FM_Replacement, ind = salmonids_fo_macroalgae$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_fo_macroalgae$info
plot(fit_salmonids_fo_macroalgae, "diagnostic")


plotSmeModel(fit_salmonids_fo_macroalgae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=30, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))






#Salmonids and bacteria/ yeast


salmonids_fo_yeast <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Salmonids" & Broad_feed=="Bacteria and yeasts") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(salmonids_fo_yeast$FM_Replacement), max(salmonids_fo_yeast$FM_Replacement), length.out = 4)[-c(1,4)]

fit_salmonids_fo_yeast <- sme(object = salmonids_fo_yeast$FO_response, tme = salmonids_fo_yeast$FM_Replacement, ind = salmonids_fo_yeast$Study_id, criteria = "AICc",knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_fo_yeast$info
plot(fit_salmonids_fo_yeast, "diagnostic")


plotSmeModel(fit_salmonids_fo_yeast, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=56, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))




#Salmonids and soy


salmonids_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Salmonids" & Feed_general=="Soy") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(salmonids_fo_soy$FM_Replacement), max(salmonids_fo_soy$FM_Replacement), length.out = 4)[-c(1,4)]

fit_salmonids_fo_soy <- sme(object = salmonids_fo_soy$FO_response, tme = salmonids_fo_soy$FM_Replacement, ind = salmonids_fo_soy$Study_id, criteria = "AICc",knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_fo_soy$info
plot(fit_salmonids_fo_soy, "diagnostic")


plotSmeModel(fit_salmonids_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=.75, lty=2, lwd=1, col='black')) ))





#Salmonids and insect


salmonids_fo_insect <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Salmonids" & Feed_general=="Insect") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(salmonids_fo_insect$FM_Replacement), max(salmonids_fo_insect$FM_Replacement), length.out = 4)[-c(1,4)]

fit_salmonids_fo_insect <- sme(object = salmonids_fo_insect$FO_response, tme = salmonids_fo_insect$FM_Replacement, ind = salmonids_fo_insect$Study_id, criteria = "AICc")#,knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_salmonids_fo_insect$info
plot(fit_salmonids_fo_insect, "diagnostic")


plotSmeModel(fit_salmonids_fo_insect, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#3B528BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))



```

#SHRIMPS
```{r}


shrimps_fo_microalgae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Shrimps" & Broad_feed=="Microalgae") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(shrimps_fo_microalgae$FM_Replacement), max(shrimps_fo_microalgae$FM_Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_fo_microalgae <- sme(object = shrimps_fo_microalgae$FO_response, tme = shrimps_fo_microalgae$FM_Replacement, ind = shrimps_fo_microalgae$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimps_fo_microalgae$info
plot(fit_shrimps_fo_microalgae, "diagnostic")


plotSmeModel(fit_shrimps_fo_microalgae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=90, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))


#macroalgae

shrimps_fo_macroalgae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Shrimps" & Broad_feed=="Macroalgae") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(shrimps_fo_macroalgae$FM_Replacement), max(shrimps_fo_macroalgae$FM_Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_fo_macroalgae <- sme(object = shrimps_fo_macroalgae$FO_response, tme = shrimps_fo_macroalgae$FM_Replacement, ind = shrimps_fo_macroalgae$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimps_fo_macroalgae$info
plot(fit_shrimps_fo_macroalgae, "diagnostic")


plotSmeModel(fit_shrimps_fo_macroalgae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=90, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))





#bacteria and yeasest


shrimps_fo_scps <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Shrimps" & Broad_feed=="Bacteria and yeasts") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)


myknots <- seq(min(shrimps_fo_scps$FM_Replacement), max(shrimps_fo_scps$FM_Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_fo_scps <- sme(object = shrimps_fo_scps$FO_response, tme = shrimps_fo_scps$FM_Replacement, ind = shrimps_fo_scps$Study_id, criteria = "AICc", deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimps_fo_scps$info
plot(fit_shrimps_fo_scps, "diagnostic")


plotSmeModel(fit_shrimps_fo_bacteria, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=90, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='black')) ))






#Shrimps and soy


shrimps_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Shrimps" & Broad_feed=="Soy") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(shrimps_fo_soy$FM_Replacement), max(shrimps_fo_soy$FM_Replacement), length.out = 4)[-c(1,4)]

fit_shrimps_fo_soy <- sme(object = shrimps_fo_soy$FO_response, tme = shrimps_fo_soy$FM_Replacement, ind = shrimps_fo_soy$Study_id, criteria = "AICc")#,knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimps_fo_soy$info
plot(fit_shrimps_fo_soy, "diagnostic")


plotSmeModel(fit_shrimps_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(h=.9, lty=2, lwd=1, col='black')) ))






#Shrimps and insect


shrimps_fo_insect<- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Shrimps" & Broad_feed=="Insect") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(shrimps_fo_insect$FM_Replacement), max(shrimps_fo_insect$FM_Replacement), length.out = 6)[-c(1,6)]

fit_shrimps_fo_insect <- sme(object = shrimps_fo_insect$FO_response, tme = shrimps_fo_insect$FM_Replacement, ind = shrimps_fo_insect$Study_id, criteria = "AICc")#knots = myknots)#,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_shrimps_fo_insect$info
plot(fit_shrimps_fo_insect, "diagnostic")


plotSmeModel(fit_shrimps_fo_insect, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#472D7BFF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(h=100, lty=2, lwd=1, col='black')) ))




```



#MARINE FISHES
```{r}

#Marine fishes and algae


marine_fo_algae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Marine fishes" & Broad_feed=="Microalgae") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(marine_fo_algae$FM_Replacement), max(marine_fo_algae$FM_Replacement), length.out = 4)[-c(1,4)]

fit_marine_fo_algae <- sme(object = marine_fo_algae$FO_response, tme = marine_fo_algae$FM_Replacement, ind = marine_fo_algae$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_fo_algae$info
plot(fit_marine_fo_algae, "diagnostic")


plotSmeModel(fit_marine_fo_algae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=47, lty=2, lwd=1, col='black')),(abline(h=-1.1, lty=2, lwd=1, col='black')) ))


#macroalgae

marine_fo_macroalgae <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Marine fishes" & Broad_feed=="Macroalgae") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(marine_fo_macroalgae$FM_Replacement), max(marine_fo_macroalgae$FM_Replacement), length.out = 4)[-c(1,4)]

fit_marine_fo_macroalgae <- sme(object = marine_fo_macroalgae$FO_response, tme = marine_fo_macroalgae$FM_Replacement, ind = marine_fo_macroalgae$Study_id, criteria = "AICc")#,knots = myknots,deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_fo_macroalgae$info
plot(fit_marine_fo_macroalgae, "diagnostic")


plotSmeModel(fit_marine_fo_macroalgae, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=47, lty=2, lwd=1, col='black')),(abline(h=-1.1, lty=2, lwd=1, col='black')) ))




# Marine fishes and bacteria 




marine_fo_scps <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Marine fishes" & Broad_feed=="Bacteria and yeasts") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(marine_fo_scps$FM_Replacement),max(marine_fo_scps$FM_Replacement), length.out = 6)[-c(1,6)]

fit_marine_fo_scps <- sme(object = marine_fo_scps$FO_response, tme = marine_fo_scps$FM_Replacement, ind = marine_fo_scps$Study_id, criteria = "AICc", knots = myknots, deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_fo_scps$info
plot(fit_marine_fo_scps, "diagnostic")


plotSmeModel(fit_marine_fo_scps, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=49, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))









# Marine fishes and soy 




marine_fo_soy <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Marine fishes" & Broad_feed=="Soy") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(marine_fo_soy$FM_Replacement),max(marine_fo_soy$FM_Replacement), length.out = 4)[-c(1,4)]

fit_marine_fo_soy <- sme(object = marine_fo_soy$FO_response, tme = marine_fo_soy$FM_Replacement, ind = marine_fo_soy$Study_id, criteria = "AICc", deltaNM = 0.1)#, knots = myknots)#, deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_fo_soy$info
plot(fit_marine_fo_soy, "diagnostic")


plotSmeModel(fit_marine_fo_soy, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=1.4, lty=2, lwd=1, col='red')) ))



#Marine fishes amd insect


marine_fo_insect <- fish_oil_tradeoffs %>% 
  filter(Fish_group == "Marine fishes" & Broad_feed=="Insect") %>%
  mutate(Study_id=Study_id %>% 
           as.factor)



myknots <- seq(min(marine_fo_insect$FM_Replacement),max(marine_fo_insect$FM_Replacement), length.out = 4)[-c(1,4)]

fit_marine_fo_insect <- sme(object = marine_fo_insect$FO_response, tme = marine_fo_insect$FM_Replacement, ind = marine_fo_insect$Study_id, criteria = "AICc")#,  deltaEM = 0.1)



#Diagnostics - numerical instability in model - likely insufficient data points for parameters estimated - go to simpler model
fit_marine_fo_insect$info
plot(fit_marine_fo_insect, "diagnostic")


plotSmeModel(fit_marine_fo_insect, xlab="",ylab="", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#440154FF", col=alpha("grey50", 0.5), pch=16, panel.first = c((abline(v=78, lty=2, lwd=1, col='black')),(abline(h=-1.1, lty=2, lwd=1, col='red')) ))




```



#Supplementary Figure  - Fish oil change with fishmeal replacement

```{r}

pdf("Supplementary Figure 2 - fish oil change with FM replacement.pdf", 
    width=7.20472441,
    height=7)
op <- par(mfrow=c(7,5), 
          mai=c(0.2,0.3,0.1,0.1), #spacing around each plot
          mgp=c(3,0.5,0), # middle value distance of labels to ticks
          oma = c(3, 3, 3, 3)) #space for the overall x and y axis titles




#carp_microalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#carps macroalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#carp scps
plotSmeModel(fit_carp_fo_scp, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=66, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='red'))
text(x=-5, y=3.1, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#carp_insects
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#carp_soy
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#catfish algae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#catfish_bacteria
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#catfish yeast
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#catfish_insects
plotSmeModel(fit_catfishes_fo_insects, xlab="",ylab="", xaxt="n",showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=100, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='red'))
text(x=-5, y=1.2, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#catfish soy
plotSmeModel(fit_catfishes_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=50, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='red'))
text(x=-5, y=3.8, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)





#FW fishes microalgae
plot(1, type="n", xlab="", ylab="", xaxt="n",xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#FW macroalgae
plot(1, type="n", xlab="", ylab="",xaxt="n", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#FW fishes scps
plot(1, type="n", xlab="", ylab="", xaxt="n",xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#FW fishes_insects
plot(1, type="n", xlab="", ylab="",xaxt="n", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#FW fishes soy
plotSmeModel(fit_fwfishes_fo_soy, xlab="",ylab="", xaxt="n",showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=57, lty=2, lwd=1, col='black')),(abline(h=.9, lty=2, lwd=1, col='red')) ))
text(x=-5, y=5, labels = expression(bold("1%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#tilapias microalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias macroalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias scps
plotSmeModel(fit_tilapia_fo_scps, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=38, lty=2, lwd=1, col='black')),(abline(h=-.215, lty=2, lwd=1, col='red')) ))
text(x=-5, y=1, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias_insects
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias soy
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#shrimps algae
plotSmeModel(fit_shrimps_fo_microalgae, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=0.12, lty=2, lwd=1, col='red'))))
text(x=-5, y=1.8, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#shrimps macroalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#shrimps scps
plotSmeModel(fit_shrimps_fo_scps, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=19, lty=2, lwd=1, col='black')),(abline(h=0.21, lty=2, lwd=1, col='red')) ))
text(x=-5, y=2.2, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#shrimps_insects
plotSmeModel(fit_shrimps_fo_insect, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
text(x=-5, y=6.5, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#shrimps soy
plotSmeModel(fit_shrimps_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(h=.9, lty=2, lwd=1, col='red')) ))
text(x=-5, y=10, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#salmonids microalgae
plotSmeModel(fit_salmonids_algae, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=30, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
text(x=70, y=2, labels =expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#macroalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#salmonids scps
plotSmeModel(fit_salmonids_fo_yeast, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=56, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
text(x=-5, y=4, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#salmonids_insects
plotSmeModel(fit_salmonids_fo_insect, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
text(x=-5, y=-8, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#salmonids soy
plotSmeModel(fit_salmonids_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=.75, lty=2, lwd=1, col='red')) ))
text(x=-5, y=5.2, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#marine fishes microalgae
plotSmeModel(fit_marine_fo_algae, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=47, lty=2, lwd=1, col='black')),(abline(h=-1.1, lty=2, lwd=1, col='red')) ))
text(x=-5, y=-10, labels = expression(bold("-1%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#marine fishes macroalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#marine fishes scps
plotSmeModel(fit_marine_fo_scps, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16, yaxt= "n",panel.first = c((abline(v=49, lty=2, lwd=1, col='black')),(abline(h=-1.9, lty=2, lwd=1, col='red')) ))
text(x=-5, y=1.1, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes_insects
plotSmeModel(fit_marine_fo_insect, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=78, lty=2, lwd=1, col='black')),(abline(h=-1.1, lty=2, lwd=1, col='red')) ))
text(x=-5, y=-7, labels = expression(bold("-1%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes soy
plotSmeModel(fit_marine_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=1.4, lty=2, lwd=1, col='red')) ))
text(x=-5, y=6.5, labels = expression(bold("1.5%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


mtext("Fishmeal replacement (%)", side = 1, line=1, outer = T)
mtext("Change in dietary fish oil inclusion (%)",side = 2, line=2, outer = T)
mtext(c("Microalgae", "Macroalgae", "Bacteria & yeasts", "Insects", "Soy"), side=3, line = 0, outer = T, at=c(.12, .32, .52, .72, .92), cex = 0.8, font=4)
mtext(c("Carps", "Catfishes", "FW fishes", "Tilapias",   "Shrimps", "Salmonids","Marine fishes"), side=2, outer = T, line = 0.5,  at=rev(seq(from =.08, to=.94, length.out = 7)), cex = 0.75, font=3)


par(op)
dev.off()



tiff("Supplementary Figure 2 - fish oil change with FM replacement.tiff", 
    width=7.20472441,
    height=7,
    units='in',
    res = 300)
op <- par(mfrow=c(7,5), 
          mai=c(0.2,0.3,0.1,0.1), #spacing around each plot
          mgp=c(3,0.5,0), # middle value distance of labels to ticks
          oma = c(3, 3, 3, 3)) #space for the overall x and y axis titles

#carp_microalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#carps macroalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#carp scps
plotSmeModel(fit_carp_fo_scp, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=66, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='red'))
text(x=-5, y=3.1, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#carp_insects
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#carp_soy
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#catfish algae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#catfish_bacteria
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#catfish yeast
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#catfish_insects
plotSmeModel(fit_catfishes_fo_insects, xlab="",ylab="", xaxt="n",showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=100, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='red'))
text(x=-5, y=1.2, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#catfish soy
plotSmeModel(fit_catfishes_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=50, lty=2, lwd=1, col='black'))), abline(h=0, lty=2, lwd=1, col='red'))
text(x=-5, y=3.8, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)





#FW fishes microalgae
plot(1, type="n", xlab="", ylab="", xaxt="n",xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#FW macroalgae
plot(1, type="n", xlab="", ylab="",xaxt="n", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#FW fishes scps
plot(1, type="n", xlab="", ylab="", xaxt="n",xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#FW fishes_insects
plot(1, type="n", xlab="", ylab="",xaxt="n", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#FW fishes soy
plotSmeModel(fit_fwfishes_fo_soy, xlab="",ylab="", xaxt="n",showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=57, lty=2, lwd=1, col='black')),(abline(h=.9, lty=2, lwd=1, col='red')) ))
text(x=-5, y=5, labels = expression(bold("1%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#tilapias microalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias macroalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias scps
plotSmeModel(fit_tilapia_fo_scps, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=38, lty=2, lwd=1, col='black')),(abline(h=-.215, lty=2, lwd=1, col='red')) ))
text(x=-5, y=1, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias_insects
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#tilapias soy
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)




#shrimps algae
plotSmeModel(fit_shrimps_fo_microalgae, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=0.12, lty=2, lwd=1, col='red'))))
text(x=-5, y=1.8, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#shrimps macroalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#shrimps scps
plotSmeModel(fit_shrimps_fo_scps, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=19, lty=2, lwd=1, col='black')),(abline(h=0.21, lty=2, lwd=1, col='red')) ))
text(x=-5, y=2.2, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#shrimps_insects
plotSmeModel(fit_shrimps_fo_insect, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
text(x=-5, y=6.5, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#shrimps soy
plotSmeModel(fit_shrimps_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=100, lty=2, lwd=1, col='black')),(abline(h=.9, lty=2, lwd=1, col='red')) ))
text(x=-5, y=10, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#salmonids microalgae
plotSmeModel(fit_salmonids_algae, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=30, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
text(x=70, y=2, labels =expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#macroalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#salmonids scps
plotSmeModel(fit_salmonids_fo_yeast, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=56, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
text(x=-5, y=4, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#salmonids_insects
plotSmeModel(fit_salmonids_fo_insect, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=0, lty=2, lwd=1, col='red')) ))
text(x=-5, y=-8, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#salmonids soy
plotSmeModel(fit_salmonids_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=.75, lty=2, lwd=1, col='red')) ))
text(x=-5, y=5.2, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)



#marine fishes microalgae
plotSmeModel(fit_marine_fo_algae, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#172869", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=47, lty=2, lwd=1, col='black')),(abline(h=-1.1, lty=2, lwd=1, col='red')) ))
text(x=-5, y=-10, labels = expression(bold("-1%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)
#marine fishes macroalgae
plot(1, type="n", xlab="", ylab="", xlim=c(0, 100), ylim=c(0,100),  xaxt="n",yaxt= "n")+
  abline(0,1, col="grey90")
text(x=-5, y=85, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


#marine fishes scps
plotSmeModel(fit_marine_fo_scps, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#89CE9F", col=alpha("grey50", 0.5), pch=16, yaxt= "n",panel.first = c((abline(v=49, lty=2, lwd=1, col='black')),(abline(h=-1.9, lty=2, lwd=1, col='red')) ))
text(x=-5, y=1.1, labels = expression(bold("0%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes_insects
plotSmeModel(fit_marine_fo_insect, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F5D523", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=78, lty=2, lwd=1, col='black')),(abline(h=-1.1, lty=2, lwd=1, col='red')) ))
text(x=-5, y=-7, labels = expression(bold("-1%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)

#marine fishes soy
plotSmeModel(fit_marine_fo_soy, xlab="",ylab="",xaxt="n", showIndividuals=T, showConfidenceBands=T, col.meanCurve="#F7AA14", col=alpha("grey50", 0.5), pch=16,yaxt= "n", panel.first = c((abline(v=50, lty=2, lwd=1, col='black')),(abline(h=1.4, lty=2, lwd=1, col='red')) ))
text(x=-5, y=6.5, labels = expression(bold("1.5%")), cex=1,pos = 4)
axis(side=1, at=c(0,50,100), tick = T, tck=-0.05)


mtext("Fishmeal replacement (%)", side = 1, line=1, outer = T)
mtext("Change in dietary fish oil inclusion (%)",side = 2, line=2, outer = T)
mtext(c("Microalgae", "Macroalgae", "Bacteria & yeasts", "Insects", "Soy"), side=3, line = 0, outer = T, at=c(.12, .32, .52, .72, .92), cex = 0.8, font=4)
mtext(c("Carps", "Catfishes", "FW fishes", "Tilapias",   "Shrimps", "Salmonids","Marine fishes"), side=2, outer = T, line = 0.5,  at=rev(seq(from =.08, to=.94, length.out = 7)), cex = 0.75, font=3)

par(op)
dev.off()


```



#REPLACEMENT SIMULATIONS
# Adjusting diets to reflect replacement by novel feeds


```{r}


#Import diets to manipulate to simulate replacement

feeds <- 
  fread("diets.csv", header=T)



feeds_as_list <- split(feeds, feeds$Group)

MEDCs <- c("Canada", "United States of America", "Austria", "Belgium", "Denmark", "Finland", "France", "Germany", "Greece", "Ireland", "Italy", "Luxembourg", "Netherlands", "Portugal",  "Spain", "Sweden", "United Kingdom", "Bulgaria", "Croatia", "Cyprus","Czechia", "Estonia", "Hungary", "Latvia", "Lithuania", "Malta", "Poland", "Romania", "Slovakia", "Slovenia", "Iceland","Norway", "Switzerland", "Australia", "Japan", "New Zealand")

LDCs<- c("Angola", "Benin", "Burkina Faso" ,"Burundi","Central African Republic", "Chad", "Comoros", "Congo, Dem. Rep. of the",  "Djibouti", "Eritrea", "Ethiopia", "Gambia" , "Guinea", "Guinea-Bissau", "Lesotho", "Liberia", "Madagascar", "Malawi", "Mali", "Mauritania", "Mozambique", "Niger", "Rwanda", "Sao Tome and Principe", "Senegal", "Sierra Leone", "Somalia", "South Sudan", "Sudan", "Togo", "Uganda", "Tanzania, United Rep. of", "Zambia", "Cambodia", "Kiribati", "Lao People's Dem. Rep.", "Myanmar", "Solomon Islands", "Timor Leste", "Tuvalu", "Vanuatu", "Afghanistan", "Bangladesh", "Bhutan", "Nepal", "Yemen", "Haiti")



fed_aqua_proj <- 
  prod.aqua %>%
  filter(Year==2015) %>% 
  mutate(FAO_2030 = case_when(Country %in% MEDCs ~ Value*1.281,
                              Country %in% LDCs ~ Value*1.463,
                              T ~ Value*1.37)) %>% 
  mutate(WorldBank_RG_2030 = case_when(Country %in% MEDCs ~ Value*1.42,
                           Country %in% LDCs ~ Value*1.69,
                           T ~Value*1.56)) %>% 
  mutate(WorldBank_CD_2030 = case_when(Taxa_adj %in% c("Shrimps", "Salmonids", "FW crustaceans","Marine crustaceans", "Tunas") ~ Value*3,
                           T ~ FAO_2030))



#feed supply data from FAOSTAT
feed_fish <- read_csv("forage_feed.csv")

feed_use <- feed_fish %>%
  filter(Item=="Pelagic Fish") %>% 
  group_by(Year) %>%
  summarise(Value = sum(Value)*1000) %>% 
  mutate(Element = "Historical & average feed use")


#forage fish species used in Froehlich et al

feed_spp <- c("Engraulis ringens",  "Clupea harengus", "Engraulis japonicus", "Decapterus", "Decapterus macrosoma" ,"Decapterus maruadsi" , "Decapterus russelli",  "Sardina pilchardus", "Mallotus villosus",   "Sardinella",  "Mallotus villosus", "Brevoortia patronus", "Engraulis encrasicolus", "Cololabis saira", "Clupea pallasii pallasii", "Trachurus murphyi", "Larimichthys polyactis", "Clupeidae", "Sprattus sprattus", "Sardinops sagax", "Trachurus", "Trachurus trecae" , "Trachurus capensis","Trachurus lathami", "Trachurus declivis", "Trachurus trachurus", "Trachurus murphyi" , "Trachurus mediterraneus", "Trachurus symmetricus","Trachurus japonicus", "Trachurus picturatus") 


#Sort the symbols in values out
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information


##IF USING FAO PRODUCTION DATA - Feed use of pelagic fish is greater than production!

#Capture production
forage_fish <-
  fread("Marine fisheries Production 1950-2014.csv", header=T) %>% 
  filter(TaxonName %in% feed_spp) %>% 
  select(CountryName, Year, TaxonName, Value) %>% 
  group_by(Year) %>% 
  summarise(Value=sum(Value)) %>% 
  mutate(Element="Historical & average supply")

  



```


#Algae - proportions reflect 1- optimal replacement levels

```{r}

FM_replace <- c("Carps" = 0 , "Catfishes"= .9, "FW fishes"= 1, "Tilapias"=.4, "Shrimps"=.5, "Salmonids"=.7, "Marine fishes"=.2, "Eels"=1, "Diadromous fishes"=1, "FW crustaceans"=1, "Tunas" =1,  "Marine crustaceans"=1)
FO_replace <- c("Carps" = 1 , "Catfishes"=1, "FW fishes"=1, "Tilapias"=1, "Shrimps"=0, "Salmonids"=.45, "Marine fishes"=0, "Eels"=1, "Diadromous fishes"=1, "FW crustaceans"=1, "Tunas" =1,  "Marine crustaceans"=1)


a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Taxa"]]]] 
    
    #assign consumption parameters
    b <- runif(n = 1, min = a[["FCR_min"]], max = a[["FCR_max"]])  # assign random fcr from group range
    c <- (runif(n = 1, min = a[["FM_min"]], max = a[["FM_max"]]))*as.numeric(FM_replace[target_row[["Taxa_adj"]]])   # assign random fishmeal inclusion from range 
    d <- runif(n = 1, min = a[["FO_min"]], max = a[["FO_max"]]) *as.numeric(FO_replace[target_row[["Taxa_adj"]]])    #assign random fish oil inclusion from range
    e <- runif(n = 1, min = a[["Fed_min"]], max = a[["Fed_max"]])    #assign random fed proportion from 2015 -2025 range
    f <- a[["Fed_max"]]    # assume highest proportion are fed for future scenarios
    
    #Consumption calculations
    
    #current consumption
    g <- target_row[["Value"]]*b*c*e    #fm demand
    h <- g/0.225       # forage fish biomass needed for fm demand
    i <- target_row[["Value"]]*b*d*e    #fo demand
    j <- h*0.05   # amount of fish oil coming from the fm biomass
    k <- (i-j)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    l <-  case_when(i<j ~ h-(j-i),
                    T ~ h+k) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
                   
    
    #FAO_2030 projections
    m <- target_row[["FAO_2030"]]*b*c*f    #fm demand
    n <- m/0.225       # forage fish biomass needed for fm demand
    o <- target_row[["FAO_2030"]]*b*d*f    #fo demand
    p <- n*0.05   # amount of fish oil coming from the fm biomass
    q <- (o-p)/0.05
    r <- case_when(o<p ~ n-(p-o),
                    T ~ n+q)
    
    # faster aquaculture growth
    s <- target_row[["WorldBank_RG_2030"]]*b*c*f    #fm demand
    t <- s/0.225       # forage fish biomass needed for fm demand
    u <- target_row[["WorldBank_RG_2030"]]*b*d*f    #fo demand
    v <- t*0.05   # amount of fish oil coming from the fm biomass
    w <- (u-v)/0.05
    x <- case_when(u<v ~ t-(v-u),
                    T ~ t+w)
    
    # chinese dietary shift
    aa <- target_row[["WorldBank_CD_2030"]]*b*c*f    #fm demand
    bb <- aa/0.225       # forage fish biomass needed for fm demand
    cc <- target_row[["WorldBank_CD_2030"]]*b*d*f    #fo demand
    dd <- bb*0.05   # amount of fish oil coming from the fm biomass
    ee <- (cc-dd)/0.05
    ff <- case_when(cc<dd ~ bb-(dd-cc),
                    T ~ bb+ee)
    
    # #chinese + more efficient scenario (fcrs decrease by 0.2)
    # gg <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*c*f    #fm demand
    # hh <- gg/0.225       # forage fish biomass needed for fm demand
    # ii <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*d*f    #fo demand
    # jj <- hh*0.05   # amount of fish oil coming from the fm biomass
    # kk <- (ii-jj)/0.05
    # ll <- case_when(kk>=0 ~ hh+kk,
    #                kk<0 ~ hh)
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        #params
        fcr=b, 
        fm=c, 
        fo=d,  
        fed=e, 
        fed_future = f, 
        
        #2015 consumption
        fm_demand_2015 = g, 
        fm_biomass_2015 = h,
        fo_demand_2015 = i,
        fo_from_fm_2015 = j, 
        surplus_2015 = k,
        consumption_2015 = l,
        
        #baseline consumption
        fao_demand = m, 
        fao_fm_biomass = n,
        fao_fo_demand = o,
        fao_from_fm = p, 
        fao_surplus = q,
        fao_consumption = r,
        
        #pesc consumption
        WB_RG_demand = s, 
        WB_RG_biomass = t,
        WB_RG_demand = u,
        WB_RG_from_fm = v, 
        WB_RG_surplus = w,
        WB_RG_consumption = x,
        
        #chinese consumption
        WB_CD_demand = aa, 
        WB_CD_fm_biomass = bb,
        WB_CD_fo_demand = cc,
        WB_CD_from_fm = dd, 
        WB_CD_surplus = ee,
        WB_CD_consumption = ff
        
        #chinese diets and more efficient
        # effchn_demand = gg, 
        # effchn_fm_biomass = hh,
        # effchn_fo_demand = ii,
        # effchn_from_fm = jj, 
        # effchn_surplus = kk,
        # effchn_consumption = ll
        ))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows

write_csv(a_test, "forage fish consumption - algae replacement.csv")
```


#Bacteria - proportions reflect 1- optimal replacement levels for fishmeal. For fish oil and bacteria as no replacement studies are modelled we adjust the dietary fish oil inclusion by the percentage change oiutlined in Tabl-e S1


```{r}
FM_replace <- c("Carps" = 0 , "Catfishes"= 1, "FW fishes"= .9, "Tilapias"=0, "Shrimps"=.15, "Salmonids"=1, "Marine fishes"=.9, "Eels"=1, "Diadromous fishes"=1, "FW crustaceans"=1, "Tunas" =1,  "Marine crustaceans"=1)
FO_replace <- c("Carps" = 0 , "Catfishes"=0, "FW fishes"=0, "Tilapias"=0, "Shrimps"=0, "Salmonids"=0, "Marine fishes"=-0.02, "Eels"=0, "Diadromous fishes"=0, "FW crustaceans"=0, "Tunas" =0,  "Marine crustaceans"=0)


a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Taxa"]]]] 
    
    #assign consumption parameters
    b <- runif(n = 1, min = a[["FCR_min"]], max = a[["FCR_max"]])  # assign random fcr from group range
    c <- (runif(n = 1, min = a[["FM_min"]], max = a[["FM_max"]]))*as.numeric(FM_replace[target_row[["Taxa_adj"]]])   # assign random fishmeal inclusion from range and adjust for fish meal replacement
    d <- max(0, runif(n = 1, min = a[["FO_min"]], max = a[["FO_max"]])+as.numeric(FO_replace[target_row[["Taxa_adj"]]]))    #assign random fish oil inclusion from range and adjust for fish oil replacement
    e <- runif(n = 1, min = a[["Fed_min"]], max = a[["Fed_max"]])    #assign random fed proportion from 2015 -2025 range
    f <- a[["Fed_max"]]    # assume highest proportion are fed for future scenarios
    
    #Consumption calculations
    
    #current consumption
    g <- target_row[["Value"]]*b*c*e    #fm demand
    h <- g/0.225       # forage fish biomass needed for fm demand
    i <- target_row[["Value"]]*b*d*e    #fo demand
    j <- h*0.05   # amount of fish oil coming from the fm biomass
    k <- (i-j)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    l <-  case_when(i<j ~ h-(j-i),
                    T ~ h+k) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
                   
    
    #FAO_2030 projections
    m <- target_row[["FAO_2030"]]*b*c*f    #fm demand
    n <- m/0.225       # forage fish biomass needed for fm demand
    o <- target_row[["FAO_2030"]]*b*d*f    #fo demand
    p <- n*0.05   # amount of fish oil coming from the fm biomass
    q <- (o-p)/0.05
    r <- case_when(o<p ~ n-(p-o),
                    T ~ n+q)
    
    # faster aquaculture growth
    s <- target_row[["WorldBank_RG_2030"]]*b*c*f    #fm demand
    t <- s/0.225       # forage fish biomass needed for fm demand
    u <- target_row[["WorldBank_RG_2030"]]*b*d*f    #fo demand
    v <- t*0.05   # amount of fish oil coming from the fm biomass
    w <- (u-v)/0.05
    x <- case_when(u<v ~ t-(v-u),
                    T ~ t+w)
    
    # chinese dietary shift
    aa <- target_row[["WorldBank_CD_2030"]]*b*c*f    #fm demand
    bb <- aa/0.225       # forage fish biomass needed for fm demand
    cc <- target_row[["WorldBank_CD_2030"]]*b*d*f    #fo demand
    dd <- bb*0.05   # amount of fish oil coming from the fm biomass
    ee <- (cc-dd)/0.05
    ff <- case_when(cc<dd ~ bb-(dd-cc),
                    T ~ bb+ee)
    
    # #chinese + more efficient scenario (fcrs decrease by 0.2)
    # gg <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*c*f    #fm demand
    # hh <- gg/0.225       # forage fish biomass needed for fm demand
    # ii <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*d*f    #fo demand
    # jj <- hh*0.05   # amount of fish oil coming from the fm biomass
    # kk <- (ii-jj)/0.05
    # ll <- case_when(kk>=0 ~ hh+kk,
    #                kk<0 ~ hh)
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        #params
        fcr=b, 
        fm=c, 
        fo=d,  
        fed=e, 
        fed_future = f, 
        
        #2015 consumption
        fm_demand_2015 = g, 
        fm_biomass_2015 = h,
        fo_demand_2015 = i,
        fo_from_fm_2015 = j, 
        surplus_2015 = k,
        consumption_2015 = l,
        
        #baseline consumption
        fao_demand = m, 
        fao_fm_biomass = n,
        fao_fo_demand = o,
        fao_from_fm = p, 
        fao_surplus = q,
        fao_consumption = r,
        
        #pesc consumption
        WB_RG_demand = s, 
        WB_RG_biomass = t,
        WB_RG_demand = u,
        WB_RG_from_fm = v, 
        WB_RG_surplus = w,
        WB_RG_consumption = x,
        
        #chinese consumption
        WB_CD_demand = aa, 
        WB_CD_fm_biomass = bb,
        WB_CD_fo_demand = cc,
        WB_CD_from_fm = dd, 
        WB_CD_surplus = ee,
        WB_CD_consumption = ff
        
        #chinese diets and more efficient
        # effchn_demand = gg, 
        # effchn_fm_biomass = hh,
        # effchn_fo_demand = ii,
        # effchn_from_fm = jj, 
        # effchn_surplus = kk,
        # effchn_consumption = ll
        ))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows

write_csv(a_test, "forage fish consumption - bacteria replacement.csv")
```


#Yeast - proportions reflect 1- optimal replacement levels for fishmeal. No change to dietary fish oil required so not adjusted within simulations

```{r}

FM_replace <- c("Carps" = 0.35 , "Catfishes"= 0, "FW fishes"= 1, "Tilapias"=0.6, "Shrimps"=.8, "Salmonids"=.45, "Marine fishes"=.25, "Eels"=1, "Diadromous fishes"=1, "FW crustaceans"=1, "Tunas" =1,  "Marine crustaceans"=1)
#FO_replace <- c("Carps" = 0 , "Catfishes" = 0, "FW fishes"=0, "Tilapias"=0, "Shrimps"=0, "Salmonids"=0, "Marine fishes"=0, "Eels"=0, "Diadromous fishes"=0, "FW crustaceans"=0, "Tunas" =0,  "Marine crustaceans"=0)


a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Taxa"]]]] 
    
    #assign consumption parameters
    b <- runif(n = 1, min = a[["FCR_min"]], max = a[["FCR_max"]])  # assign random fcr from group range
    c <- (runif(n = 1, min = a[["FM_min"]], max = a[["FM_max"]]))*as.numeric(FM_replace[target_row[["Taxa_adj"]]])   # assign random fishmeal inclusion from range and adjust for fish meal replacement
    d <- runif(n = 1, min = a[["FO_min"]], max = a[["FO_max"]])    #assign random fish oil inclusion from range and adjust for fish oil replacement
    e <- runif(n = 1, min = a[["Fed_min"]], max = a[["Fed_max"]])    #assign random fed proportion from 2015 -2025 range
    f <- a[["Fed_max"]]    # assume highest proportion are fed for future scenarios
    
    #Consumption calculations
    
    #current consumption
    g <- target_row[["Value"]]*b*c*e    #fm demand
    h <- g/0.225       # forage fish biomass needed for fm demand
    i <- target_row[["Value"]]*b*d*e    #fo demand
    j <- h*0.05   # amount of fish oil coming from the fm biomass
    k <- (i-j)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    l <-  case_when(i<j ~ h-(j-i),
                    T ~ h+k) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
                   
    
    #FAO_2030 projections
    m <- target_row[["FAO_2030"]]*b*c*f    #fm demand
    n <- m/0.225       # forage fish biomass needed for fm demand
    o <- target_row[["FAO_2030"]]*b*d*f    #fo demand
    p <- n*0.05   # amount of fish oil coming from the fm biomass
    q <- (o-p)/0.05
    r <- case_when(o<p ~ n-(p-o),
                    T ~ n+q)
    
    # faster aquaculture growth
    s <- target_row[["WorldBank_RG_2030"]]*b*c*f    #fm demand
    t <- s/0.225       # forage fish biomass needed for fm demand
    u <- target_row[["WorldBank_RG_2030"]]*b*d*f    #fo demand
    v <- t*0.05   # amount of fish oil coming from the fm biomass
    w <- (u-v)/0.05
    x <- case_when(u<v ~ t-(v-u),
                    T ~ t+w)
    
    # chinese dietary shift
    aa <- target_row[["WorldBank_CD_2030"]]*b*c*f    #fm demand
    bb <- aa/0.225       # forage fish biomass needed for fm demand
    cc <- target_row[["WorldBank_CD_2030"]]*b*d*f    #fo demand
    dd <- bb*0.05   # amount of fish oil coming from the fm biomass
    ee <- (cc-dd)/0.05
    ff <- case_when(cc<dd ~ bb-(dd-cc),
                    T ~ bb+ee)
    
    # #chinese + more efficient scenario (fcrs decrease by 0.2)
    # gg <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*c*f    #fm demand
    # hh <- gg/0.225       # forage fish biomass needed for fm demand
    # ii <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*d*f    #fo demand
    # jj <- hh*0.05   # amount of fish oil coming from the fm biomass
    # kk <- (ii-jj)/0.05
    # ll <- case_when(kk>=0 ~ hh+kk,
    #                kk<0 ~ hh)
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        #params
        fcr=b, 
        fm=c, 
        fo=d,  
        fed=e, 
        fed_future = f, 
        
        #2015 consumption
        fm_demand_2015 = g, 
        fm_biomass_2015 = h,
        fo_demand_2015 = i,
        fo_from_fm_2015 = j, 
        surplus_2015 = k,
        consumption_2015 = l,
        
        #baseline consumption
        fao_demand = m, 
        fao_fm_biomass = n,
        fao_fo_demand = o,
        fao_from_fm = p, 
        fao_surplus = q,
        fao_consumption = r,
        
        #pesc consumption
        WB_RG_demand = s, 
        WB_RG_biomass = t,
        WB_RG_demand = u,
        WB_RG_from_fm = v, 
        WB_RG_surplus = w,
        WB_RG_consumption = x,
        
        #chinese consumption
        WB_CD_demand = aa, 
        WB_CD_fm_biomass = bb,
        WB_CD_fo_demand = cc,
        WB_CD_from_fm = dd, 
        WB_CD_surplus = ee,
        WB_CD_consumption = ff
        
        #chinese diets and more efficient
        # effchn_demand = gg, 
        # effchn_fm_biomass = hh,
        # effchn_fo_demand = ii,
        # effchn_from_fm = jj, 
        # effchn_surplus = kk,
        # effchn_consumption = ll
        ))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows

write_csv(a_test, "forage fish consumption - yeast replacement.csv")

```

#SOY - proportions reflect 1- optimal replacement levels for fishmeal. Fishmeal proportions reflect the threshold replacement based on no change (within 5%) to the n3:n6 ratio. Note freshwater fishes indicate an increase of 1% dietary inclusion of fo with fishmeal replacement. To keep this consistent with proportions we multiply the randomly selected proportion within the stipulated range for fw fishes by 1.42. This is based on adding 1% to to the lower bound of 2% (fo inclusion for fw fishes) is the same as increasing by 50%. By adding 1% to the upper bound for fw fishes of 3% is increasing by 33%. We take the mean of these two by increasing this value by 42%.


```{r}
FM_replace <- c("Carps" = 0.65 , "Catfishes"= 0.5, "FW fishes"= 0.45, "Tilapias"=0.3, "Shrimps"=0, "Salmonids"=.5, "Marine fishes"=.5, "Eels"=1, "Diadromous fishes"=1, "FW crustaceans"=1, "Tunas" =1,  "Marine crustaceans"=1)
FO_replace <- c("Carps" = 1 , "Catfishes" = 1, "FW fishes"=1.42, "Tilapias"=1, "Shrimps"=0.7, "Salmonids"=0.9, "Marine fishes"=0, "Eels"=0, "Diadromous fishes"=0, "FW crustaceans"=0, "Tunas" =0,  "Marine crustaceans"=0)


a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Taxa"]]]] 
    
    #assign consumption parameters
    b <- runif(n = 1, min = a[["FCR_min"]], max = a[["FCR_max"]])  # assign random fcr from group range
    c <- (runif(n = 1, min = a[["FM_min"]], max = a[["FM_max"]]))*as.numeric(FM_replace[target_row[["Taxa_adj"]]])   # assign random fishmeal inclusion from range and adjust for fish meal replacement
    d <- runif(n = 1, min = a[["FO_min"]], max = a[["FO_max"]]) *as.numeric(FO_replace[target_row[["Taxa_adj"]]])   #assign random fish oil inclusion from range and adjust for fish oil replacement
    e <- runif(n = 1, min = a[["Fed_min"]], max = a[["Fed_max"]])    #assign random fed proportion from 2015 -2025 range
    f <- a[["Fed_max"]]    # assume highest proportion are fed for future scenarios
    
    #Consumption calculations
    
    #current consumption
    g <- target_row[["Value"]]*b*c*e    #fm demand
    h <- g/0.225       # forage fish biomass needed for fm demand
    i <- target_row[["Value"]]*b*d*e    #fo demand
    j <- h*0.05   # amount of fish oil coming from the fm biomass
    k <- (i-j)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    l <-  case_when(i<j ~ h-(j-i),
                    T ~ h+k) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
                   
    
    #FAO_2030 projections
    m <- target_row[["FAO_2030"]]*b*c*f    #fm demand
    n <- m/0.225       # forage fish biomass needed for fm demand
    o <- target_row[["FAO_2030"]]*b*d*f    #fo demand
    p <- n*0.05   # amount of fish oil coming from the fm biomass
    q <- (o-p)/0.05
    r <- case_when(o<p ~ n-(p-o),
                    T ~ n+q)
    
    # faster aquaculture growth
    s <- target_row[["WorldBank_RG_2030"]]*b*c*f    #fm demand
    t <- s/0.225       # forage fish biomass needed for fm demand
    u <- target_row[["WorldBank_RG_2030"]]*b*d*f    #fo demand
    v <- t*0.05   # amount of fish oil coming from the fm biomass
    w <- (u-v)/0.05
    x <- case_when(u<v ~ t-(v-u),
                    T ~ t+w)
    
    # chinese dietary shift
    aa <- target_row[["WorldBank_CD_2030"]]*b*c*f    #fm demand
    bb <- aa/0.225       # forage fish biomass needed for fm demand
    cc <- target_row[["WorldBank_CD_2030"]]*b*d*f    #fo demand
    dd <- bb*0.05   # amount of fish oil coming from the fm biomass
    ee <- (cc-dd)/0.05
    ff <- case_when(cc<dd ~ bb-(dd-cc),
                    T ~ bb+ee)
    
    # #chinese + more efficient scenario (fcrs decrease by 0.2)
    # gg <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*c*f    #fm demand
    # hh <- gg/0.225       # forage fish biomass needed for fm demand
    # ii <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*d*f    #fo demand
    # jj <- hh*0.05   # amount of fish oil coming from the fm biomass
    # kk <- (ii-jj)/0.05
    # ll <- case_when(kk>=0 ~ hh+kk,
    #                kk<0 ~ hh)
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        #params
        fcr=b, 
        fm=c, 
        fo=d,  
        fed=e, 
        fed_future = f, 
        
        #2015 consumption
        fm_demand_2015 = g, 
        fm_biomass_2015 = h,
        fo_demand_2015 = i,
        fo_from_fm_2015 = j, 
        surplus_2015 = k,
        consumption_2015 = l,
        
        #baseline consumption
        fao_demand = m, 
        fao_fm_biomass = n,
        fao_fo_demand = o,
        fao_from_fm = p, 
        fao_surplus = q,
        fao_consumption = r,
        
        #pesc consumption
        WB_RG_demand = s, 
        WB_RG_biomass = t,
        WB_RG_demand = u,
        WB_RG_from_fm = v, 
        WB_RG_surplus = w,
        WB_RG_consumption = x,
        
        #chinese consumption
        WB_CD_demand = aa, 
        WB_CD_fm_biomass = bb,
        WB_CD_fo_demand = cc,
        WB_CD_from_fm = dd, 
        WB_CD_surplus = ee,
        WB_CD_consumption = ff
        
        #chinese diets and more efficient
        # effchn_demand = gg, 
        # effchn_fm_biomass = hh,
        # effchn_fo_demand = ii,
        # effchn_from_fm = jj, 
        # effchn_surplus = kk,
        # effchn_consumption = ll
        ))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows

write_csv(a_test, "forage fish consumption - soy replacement.csv")

```

#Insects - proportions reflect optimal replacement levels



```{r}
FM_replace <- c("Carps" = 0 , "Catfishes"= 0, "FW fishes"= 1, "Tilapias"=0.05, "Shrimps"=0, "Salmonids"=0, "Marine fishes"=.2, "Eels"=1, "Diadromous fishes"=1, "FW crustaceans"=1, "Tunas" =1,  "Marine crustaceans"=1)
FO_replace <- c("Carps" = 0 , "Catfishes"=0, "FW fishes"=0, "Tilapias"=0, "Shrimps"=0, "Salmonids"=0, "Marine fishes"=-0.01, "Eels"=0, "Diadromous fishes"=0, "FW crustaceans"=0, "Tunas" =0,  "Marine crustaceans"=0)


a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Taxa"]]]] 
    
    #assign consumption parameters
    b <- runif(n = 1, min = a[["FCR_min"]], max = a[["FCR_max"]])  # assign random fcr from group range
    c <- (runif(n = 1, min = a[["FM_min"]], max = a[["FM_max"]]))*as.numeric(FM_replace[target_row[["Taxa_adj"]]])   # assign random fishmeal inclusion from range 
    d <- max(0, runif(n = 1, min = a[["FO_min"]], max = a[["FO_max"]])+as.numeric(FO_replace[target_row[["Taxa_adj"]]]))   #assign random fish oil inclusion from range
    e <- runif(n = 1, min = a[["Fed_min"]], max = a[["Fed_max"]])    #assign random fed proportion from 2015 -2025 range
    f <- a[["Fed_max"]]    # assume highest proportion are fed for future scenarios
    
    #Consumption calculations
    
    #current consumption
    g <- target_row[["Value"]]*b*c*e    #fm demand
    h <- g/0.225       # forage fish biomass needed for fm demand
    i <- target_row[["Value"]]*b*d*e    #fo demand
    j <- h*0.05   # amount of fish oil coming from the fm biomass
    k <- (i-j)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    l <-  case_when(i<j ~ h-(j-i),
                    T ~ h+k) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
                   
    
    #FAO_2030 projections
    m <- target_row[["FAO_2030"]]*b*c*f    #fm demand
    n <- m/0.225       # forage fish biomass needed for fm demand
    o <- target_row[["FAO_2030"]]*b*d*f    #fo demand
    p <- n*0.05   # amount of fish oil coming from the fm biomass
    q <- (o-p)/0.05
    r <- case_when(o<p ~ n-(p-o),
                    T ~ n+q)
    
    # faster aquaculture growth
    s <- target_row[["WorldBank_RG_2030"]]*b*c*f    #fm demand
    t <- s/0.225       # forage fish biomass needed for fm demand
    u <- target_row[["WorldBank_RG_2030"]]*b*d*f    #fo demand
    v <- t*0.05   # amount of fish oil coming from the fm biomass
    w <- (u-v)/0.05
    x <- case_when(u<v ~ t-(v-u),
                    T ~ t+w)
    
    # chinese dietary shift
    aa <- target_row[["WorldBank_CD_2030"]]*b*c*f    #fm demand
    bb <- aa/0.225       # forage fish biomass needed for fm demand
    cc <- target_row[["WorldBank_CD_2030"]]*b*d*f    #fo demand
    dd <- bb*0.05   # amount of fish oil coming from the fm biomass
    ee <- (cc-dd)/0.05
    ff <- case_when(cc<dd ~ bb-(dd-cc),
                    T ~ bb+ee)
    
    # #chinese + more efficient scenario (fcrs decrease by 0.2)
    # gg <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*c*f    #fm demand
    # hh <- gg/0.225       # forage fish biomass needed for fm demand
    # ii <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*d*f    #fo demand
    # jj <- hh*0.05   # amount of fish oil coming from the fm biomass
    # kk <- (ii-jj)/0.05
    # ll <- case_when(kk>=0 ~ hh+kk,
    #                kk<0 ~ hh)
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        #params
        fcr=b, 
        fm=c, 
        fo=d,  
        fed=e, 
        fed_future = f, 
        
        #2015 consumption
        fm_demand_2015 = g, 
        fm_biomass_2015 = h,
        fo_demand_2015 = i,
        fo_from_fm_2015 = j, 
        surplus_2015 = k,
        consumption_2015 = l,
        
        #baseline consumption
        fao_demand = m, 
        fao_fm_biomass = n,
        fao_fo_demand = o,
        fao_from_fm = p, 
        fao_surplus = q,
        fao_consumption = r,
        
        #pesc consumption
        WB_RG_demand = s, 
        WB_RG_biomass = t,
        WB_RG_demand = u,
        WB_RG_from_fm = v, 
        WB_RG_surplus = w,
        WB_RG_consumption = x,
        
        #chinese consumption
        WB_CD_demand = aa, 
        WB_CD_fm_biomass = bb,
        WB_CD_fo_demand = cc,
        WB_CD_from_fm = dd, 
        WB_CD_surplus = ee,
        WB_CD_consumption = ff
        
        #chinese diets and more efficient
        # effchn_demand = gg, 
        # effchn_fm_biomass = hh,
        # effchn_fo_demand = ii,
        # effchn_from_fm = jj, 
        # effchn_surplus = kk,
        # effchn_consumption = ll
        ))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows

write_csv(a_test, "forage fish consumption - insects replacement.csv")



```


#Optimal use of feeds across all species and feed types. 

#For carps, catfishes, tilapias, shrimps, salmonids - 100% of fishmeal is replaceable without FCR change. 55% for freshwater fishes and 80% for marine fishes. All other families held constant. For fish oil, replacement wa sonly investigated in shrmps, salmonids and marine fishes where 100, 55, and 100% of fish oil could be replaced without change to n-3:n-6 ratios respectively. Freshwater fishes had no fishoil replacement but average fish oil inclusion increased by 1% with 55% fishmeal relacement using soy. 1% increase is a 33 to 50% increase and so we take the mean of 42% to increase inclusion rates by.

```{r}
FM_replace <- c("Carps" = 0 , "Catfishes"= 0, "FW fishes"= 0.45, "Tilapias"=0, "Shrimps"=0, "Salmonids"=0, "Marine fishes"=.2, "Eels"=1, "Diadromous fishes"=1, "FW crustaceans"=1, "Tunas" =1,  "Marine crustaceans"=1)
FO_replace <- c("Carps" = 1 , "Catfishes"=1, "FW fishes"=1.42, "Tilapias"=1, "Shrimps"=0, "Salmonids"=0, "Marine fishes"= 0, "Eels"=1, "Diadromous fishes"=1, "FW crustaceans"=1, "Tunas" =1,  "Marine crustaceans"=1)
'

a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Taxa"]]]] 
    
    #assign consumption parameters
    b <- runif(n = 1, min = a[["FCR_min"]], max = a[["FCR_max"]])  # assign random fcr from group range
    c <- (runif(n = 1, min = a[["FM_min"]], max = a[["FM_max"]]))*as.numeric(FM_replace[target_row[["Taxa_adj"]]])   # assign random fishmeal inclusion from range and adjust for fish meal replacement
    d <- runif(n = 1, min = a[["FO_min"]], max = a[["FO_max"]]) *as.numeric(FO_replace[target_row[["Taxa_adj"]]])   #assign random fish oil inclusion from range and adjust for fish oil replacement
    e <- runif(n = 1, min = a[["Fed_min"]], max = a[["Fed_max"]])    #assign random fed proportion from 2015 -2025 range
    f <- a[["Fed_max"]]    # assume highest proportion are fed for future scenarios
    
    #Consumption calculations
    
    #current consumption
    g <- target_row[["Value"]]*b*c*e    #fm demand
    h <- g/0.225       # forage fish biomass needed for fm demand
    i <- target_row[["Value"]]*b*d*e    #fo demand
    j <- h*0.05   # amount of fish oil coming from the fm biomass
    k <- (i-j)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    l <-  case_when(i<j ~ h-(j-i),
                    T ~ h+k) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
                   
    
    #FAO_2030 projections
    m <- target_row[["FAO_2030"]]*b*c*f    #fm demand
    n <- m/0.225       # forage fish biomass needed for fm demand
    o <- target_row[["FAO_2030"]]*b*d*f    #fo demand
    p <- n*0.05   # amount of fish oil coming from the fm biomass
    q <- (o-p)/0.05
    r <- case_when(o<p ~ n-(p-o),
                    T ~ n+q)
    
    # faster aquaculture growth
    s <- target_row[["WorldBank_RG_2030"]]*b*c*f    #fm demand
    t <- s/0.225       # forage fish biomass needed for fm demand
    u <- target_row[["WorldBank_RG_2030"]]*b*d*f    #fo demand
    v <- t*0.05   # amount of fish oil coming from the fm biomass
    w <- (u-v)/0.05
    x <- case_when(u<v ~ t-(v-u),
                    T ~ t+w)
    
    # chinese dietary shift
    aa <- target_row[["WorldBank_CD_2030"]]*b*c*f    #fm demand
    bb <- aa/0.225       # forage fish biomass needed for fm demand
    cc <- target_row[["WorldBank_CD_2030"]]*b*d*f    #fo demand
    dd <- bb*0.05   # amount of fish oil coming from the fm biomass
    ee <- (cc-dd)/0.05
    ff <- case_when(cc<dd ~ bb-(dd-cc),
                    T ~ bb+ee)
    
    # #chinese + more efficient scenario (fcrs decrease by 0.2)
    # gg <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*c*f    #fm demand
    # hh <- gg/0.225       # forage fish biomass needed for fm demand
    # ii <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*d*f    #fo demand
    # jj <- hh*0.05   # amount of fish oil coming from the fm biomass
    # kk <- (ii-jj)/0.05
    # ll <- case_when(kk>=0 ~ hh+kk,
    #                kk<0 ~ hh)
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        #params
        fcr=b, 
        fm=c, 
        fo=d,  
        fed=e, 
        fed_future = f, 
        
        #2015 consumption
        fm_demand_2015 = g, 
        fm_biomass_2015 = h,
        fo_demand_2015 = i,
        fo_from_fm_2015 = j, 
        surplus_2015 = k,
        consumption_2015 = l,
        
        #baseline consumption
        fao_demand = m, 
        fao_fm_biomass = n,
        fao_fo_demand = o,
        fao_from_fm = p, 
        fao_surplus = q,
        fao_consumption = r,
        
        #pesc consumption
        WB_RG_demand = s, 
        WB_RG_biomass = t,
        WB_RG_demand = u,
        WB_RG_from_fm = v, 
        WB_RG_surplus = w,
        WB_RG_consumption = x,
        
        #chinese consumption
        WB_CD_demand = aa, 
        WB_CD_fm_biomass = bb,
        WB_CD_fo_demand = cc,
        WB_CD_from_fm = dd, 
        WB_CD_surplus = ee,
        WB_CD_consumption = ff
        
        #chinese diets and more efficient
        # effchn_demand = gg, 
        # effchn_fm_biomass = hh,
        # effchn_fo_demand = ii,
        # effchn_from_fm = jj, 
        # effchn_surplus = kk,
        # effchn_consumption = ll
        ))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows

write_csv(a_test, "forage fish consumption - optimal replacement.csv")


optimal <- 
      bind_rows(
        
        fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nBAU"),
        
        fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nRap.Gr."),
        
        
        fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nCon.Shft")
      ) %>% 
      mutate(Diet = "Optimal global")

```

#Species optimal use
#same as optimal but only applied to salmon and shrimps

```{r}


#if using high value species
high_val_spp <- c("Shrimps", "Salmonids")


FM_replace <- c("Carps" = 1, "Catfishes"= 1, "FW fishes"= 1, "Tilapias"=1, "Shrimps"=0, "Salmonids"=0, "Marine fishes"=1, "Eels"=1, "Diadromous fishes"=1, "FW crustaceans"=1, "Tunas" =1,  "Marine crustaceans"=1)
FO_replace <- c("Carps" = 1 , "Catfishes"=1, "FW fishes"=1.42, "Tilapias"=1, "Shrimps"=0, "Salmonids"=0, "Marine fishes"= 1, "Eels"=1, "Diadromous fishes"=1, "FW crustaceans"=1, "Tunas" =1,  "Marine crustaceans"=1)

a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Taxa"]]]] 
    
    #assign consumption parameters
    b <- runif(n = 1, min = a[["FCR_min"]], max = a[["FCR_max"]])  # assign random fcr from group range
    c <- (runif(n = 1, min = a[["FM_min"]], max = a[["FM_max"]]))*as.numeric(FM_replace[target_row[["Taxa_adj"]]])   # assign random fishmeal inclusion from range and adjust for fish meal replacement
    d <- runif(n = 1, min = a[["FO_min"]], max = a[["FO_max"]]) *as.numeric(FO_replace[target_row[["Taxa_adj"]]])   #assign random fish oil inclusion from range and adjust for fish oil replacement
    e <- runif(n = 1, min = a[["Fed_min"]], max = a[["Fed_max"]])    #assign random fed proportion from 2015 -2025 range
    f <- a[["Fed_max"]]    # assume highest proportion are fed for future scenarios
    
    #Consumption calculations
    
    #current consumption
    g <- target_row[["Value"]]*b*c*e    #fm demand
    h <- g/0.225       # forage fish biomass needed for fm demand
    i <- target_row[["Value"]]*b*d*e    #fo demand
    j <- h*0.05   # amount of fish oil coming from the fm biomass
    k <- (i-j)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    l <-  case_when(i<j ~ h-(j-i),
                    T ~ h+k) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
                   
    
    #FAO_2030 projections
    m <- target_row[["FAO_2030"]]*b*c*f    #fm demand
    n <- m/0.225       # forage fish biomass needed for fm demand
    o <- target_row[["FAO_2030"]]*b*d*f    #fo demand
    p <- n*0.05   # amount of fish oil coming from the fm biomass
    q <- (o-p)/0.05
    r <- case_when(o<p ~ n-(p-o),
                    T ~ n+q)
    
    # faster aquaculture growth
    s <- target_row[["WorldBank_RG_2030"]]*b*c*f    #fm demand
    t <- s/0.225       # forage fish biomass needed for fm demand
    u <- target_row[["WorldBank_RG_2030"]]*b*d*f    #fo demand
    v <- t*0.05   # amount of fish oil coming from the fm biomass
    w <- (u-v)/0.05
    x <- case_when(u<v ~ t-(v-u),
                    T ~ t+w)
    
    # chinese dietary shift
    aa <- target_row[["WorldBank_CD_2030"]]*b*c*f    #fm demand
    bb <- aa/0.225       # forage fish biomass needed for fm demand
    cc <- target_row[["WorldBank_CD_2030"]]*b*d*f    #fo demand
    dd <- bb*0.05   # amount of fish oil coming from the fm biomass
    ee <- (cc-dd)/0.05
    ff <- case_when(cc<dd ~ bb-(dd-cc),
                    T ~ bb+ee)
    
    # #chinese + more efficient scenario (fcrs decrease by 0.2)
    # gg <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*c*f    #fm demand
    # hh <- gg/0.225       # forage fish biomass needed for fm demand
    # ii <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*d*f    #fo demand
    # jj <- hh*0.05   # amount of fish oil coming from the fm biomass
    # kk <- (ii-jj)/0.05
    # ll <- case_when(kk>=0 ~ hh+kk,
    #                kk<0 ~ hh)
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        #params
        fcr=b, 
        fm=c, 
        fo=d,  
        fed=e, 
        fed_future = f, 
        
        #2015 consumption
        fm_demand_2015 = g, 
        fm_biomass_2015 = h,
        fo_demand_2015 = i,
        fo_from_fm_2015 = j, 
        surplus_2015 = k,
        consumption_2015 = l,
        
        #baseline consumption
        fao_demand = m, 
        fao_fm_biomass = n,
        fao_fo_demand = o,
        fao_from_fm = p, 
        fao_surplus = q,
        fao_consumption = r,
        
        #pesc consumption
        WB_RG_demand = s, 
        WB_RG_biomass = t,
        WB_RG_demand = u,
        WB_RG_from_fm = v, 
        WB_RG_surplus = w,
        WB_RG_consumption = x,
        
        #chinese consumption
        WB_CD_demand = aa, 
        WB_CD_fm_biomass = bb,
        WB_CD_fo_demand = cc,
        WB_CD_from_fm = dd, 
        WB_CD_surplus = ee,
        WB_CD_consumption = ff
        
        #chinese diets and more efficient
        # effchn_demand = gg, 
        # effchn_fm_biomass = hh,
        # effchn_fo_demand = ii,
        # effchn_from_fm = jj, 
        # effchn_surplus = kk,
        # effchn_consumption = ll
        ))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows


write_csv(a_test, "forage fish consumption - development optimal replacement.csv")




```

#Fishmeal replacement only
```{r}

FM_replace <- c("Carps" = 0 , "Catfishes"= 0, "FW fishes"= 0.45, "Tilapias"=0, "Shrimps"=0, "Salmonids"=0, "Marine fishes"=.2, "Eels"=1, "Diadromous fishes"=1, "FW crustaceans"=1, "Tunas" =1,  "Marine crustaceans"=1)


a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Taxa"]]]] 
    
    #assign consumption parameters
    b <- runif(n = 1, min = a[["FCR_min"]], max = a[["FCR_max"]])  # assign random fcr from group range
    c <- (runif(n = 1, min = a[["FM_min"]], max = a[["FM_max"]]))*as.numeric(FM_replace[target_row[["Taxa_adj"]]])   # assign random fishmeal inclusion from range and adjust for fish meal replacement
    d <- runif(n = 1, min = a[["FO_min"]], max = a[["FO_max"]])   #assign random fish oil inclusion from range and adjust for fish oil replacement
    e <- runif(n = 1, min = a[["Fed_min"]], max = a[["Fed_max"]])    #assign random fed proportion from 2015 -2025 range
    f <- a[["Fed_max"]]    # assume highest proportion are fed for future scenarios
    
    #Consumption calculations
    
    #current consumption
    g <- target_row[["Value"]]*b*c*e    #fm demand
    h <- g/0.225       # forage fish biomass needed for fm demand
    i <- target_row[["Value"]]*b*d*e    #fo demand
    j <- h*0.05   # amount of fish oil coming from the fm biomass
    k <- (i-j)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    l <-  case_when(i<j ~ h-(j-i),
                    T ~ h+k) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
                   
    
    #FAO_2030 projections
    m <- target_row[["FAO_2030"]]*b*c*f    #fm demand
    n <- m/0.225       # forage fish biomass needed for fm demand
    o <- target_row[["FAO_2030"]]*b*d*f    #fo demand
    p <- n*0.05   # amount of fish oil coming from the fm biomass
    q <- (o-p)/0.05
    r <- case_when(o<p ~ n-(p-o),
                    T ~ n+q)
    
    # faster aquaculture growth
    s <- target_row[["WorldBank_RG_2030"]]*b*c*f    #fm demand
    t <- s/0.225       # forage fish biomass needed for fm demand
    u <- target_row[["WorldBank_RG_2030"]]*b*d*f    #fo demand
    v <- t*0.05   # amount of fish oil coming from the fm biomass
    w <- (u-v)/0.05
    x <- case_when(u<v ~ t-(v-u),
                    T ~ t+w)
    
    # chinese dietary shift
    aa <- target_row[["WorldBank_CD_2030"]]*b*c*f    #fm demand
    bb <- aa/0.225       # forage fish biomass needed for fm demand
    cc <- target_row[["WorldBank_CD_2030"]]*b*d*f    #fo demand
    dd <- bb*0.05   # amount of fish oil coming from the fm biomass
    ee <- (cc-dd)/0.05
    ff <- case_when(cc<dd ~ bb-(dd-cc),
                    T ~ bb+ee)
    
    # #chinese + more efficient scenario (fcrs decrease by 0.2)
    # gg <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*c*f    #fm demand
    # hh <- gg/0.225       # forage fish biomass needed for fm demand
    # ii <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*d*f    #fo demand
    # jj <- hh*0.05   # amount of fish oil coming from the fm biomass
    # kk <- (ii-jj)/0.05
    # ll <- case_when(kk>=0 ~ hh+kk,
    #                kk<0 ~ hh)
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        #params
        fcr=b, 
        fm=c, 
        fo=d,  
        fed=e, 
        fed_future = f, 
        
        #2015 consumption
        fm_demand_2015 = g, 
        fm_biomass_2015 = h,
        fo_demand_2015 = i,
        fo_from_fm_2015 = j, 
        surplus_2015 = k,
        consumption_2015 = l,
        
        #baseline consumption
        fao_demand = m, 
        fao_fm_biomass = n,
        fao_fo_demand = o,
        fao_from_fm = p, 
        fao_surplus = q,
        fao_consumption = r,
        
        #pesc consumption
        WB_RG_demand = s, 
        WB_RG_biomass = t,
        WB_RG_demand = u,
        WB_RG_from_fm = v, 
        WB_RG_surplus = w,
        WB_RG_consumption = x,
        
        #chinese consumption
        WB_CD_demand = aa, 
        WB_CD_fm_biomass = bb,
        WB_CD_fo_demand = cc,
        WB_CD_from_fm = dd, 
        WB_CD_surplus = ee,
        WB_CD_consumption = ff
        
        #chinese diets and more efficient
        # effchn_demand = gg, 
        # effchn_fm_biomass = hh,
        # effchn_fo_demand = ii,
        # effchn_from_fm = jj, 
        # effchn_surplus = kk,
        # effchn_consumption = ll
        ))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows


write_csv(a_test, "forage fish consumption - fishmeal only replacement.csv")



```

#Fish oil replacement only 

```{r}
FO_replace <- c("Carps" = 1 , "Catfishes"=1, "FW fishes"=1, "Tilapias"=1, "Shrimps"=0, "Salmonids"=0, "Marine fishes"= 0, "Eels"=1, "Diadromous fishes"=1, "FW crustaceans"=1, "Tunas" =1,  "Marine crustaceans"=1)



a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Taxa"]]]] 
    
    #assign consumption parameters
    b <- runif(n = 1, min = a[["FCR_min"]], max = a[["FCR_max"]])  # assign random fcr from group range
    c <- (runif(n = 1, min = a[["FM_min"]], max = a[["FM_max"]]))   # assign random fishmeal inclusion from range and adjust for fish meal replacement
    d <- runif(n = 1, min = a[["FO_min"]], max = a[["FO_max"]]) *as.numeric(FO_replace[target_row[["Taxa_adj"]]])   #assign random fish oil inclusion from range and adjust for fish oil replacement
    e <- runif(n = 1, min = a[["Fed_min"]], max = a[["Fed_max"]])    #assign random fed proportion from 2015 -2025 range
    f <- a[["Fed_max"]]    # assume highest proportion are fed for future scenarios
    
    #Consumption calculations
    
    #current consumption
    g <- target_row[["Value"]]*b*c*e    #fm demand
    h <- g/0.225       # forage fish biomass needed for fm demand
    i <- target_row[["Value"]]*b*d*e    #fo demand
    j <- h*0.05   # amount of fish oil coming from the fm biomass
    k <- (i-j)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    l <-  case_when(i<j ~ h-(j-i),
                    T ~ h+k) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
                   
    
    #FAO_2030 projections
    m <- target_row[["FAO_2030"]]*b*c*f    #fm demand
    n <- m/0.225       # forage fish biomass needed for fm demand
    o <- target_row[["FAO_2030"]]*b*d*f    #fo demand
    p <- n*0.05   # amount of fish oil coming from the fm biomass
    q <- (o-p)/0.05
    r <- case_when(o<p ~ n-(p-o),
                    T ~ n+q)
    
    # faster aquaculture growth
    s <- target_row[["WorldBank_RG_2030"]]*b*c*f    #fm demand
    t <- s/0.225       # forage fish biomass needed for fm demand
    u <- target_row[["WorldBank_RG_2030"]]*b*d*f    #fo demand
    v <- t*0.05   # amount of fish oil coming from the fm biomass
    w <- (u-v)/0.05
    x <- case_when(u<v ~ t-(v-u),
                    T ~ t+w)
    
    # chinese dietary shift
    aa <- target_row[["WorldBank_CD_2030"]]*b*c*f    #fm demand
    bb <- aa/0.225       # forage fish biomass needed for fm demand
    cc <- target_row[["WorldBank_CD_2030"]]*b*d*f    #fo demand
    dd <- bb*0.05   # amount of fish oil coming from the fm biomass
    ee <- (cc-dd)/0.05
    ff <- case_when(cc<dd ~ bb-(dd-cc),
                    T ~ bb+ee)
    
    # #chinese + more efficient scenario (fcrs decrease by 0.2)
    # gg <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*c*f    #fm demand
    # hh <- gg/0.225       # forage fish biomass needed for fm demand
    # ii <- target_row[["WorldBank_CD_2030"]]*(b-0.2)*d*f    #fo demand
    # jj <- hh*0.05   # amount of fish oil coming from the fm biomass
    # kk <- (ii-jj)/0.05
    # ll <- case_when(kk>=0 ~ hh+kk,
    #                kk<0 ~ hh)
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        #params
        fcr=b, 
        fm=c, 
        fo=d,  
        fed=e, 
        fed_future = f, 
        
        #2015 consumption
        fm_demand_2015 = g, 
        fm_biomass_2015 = h,
        fo_demand_2015 = i,
        fo_from_fm_2015 = j, 
        surplus_2015 = k,
        consumption_2015 = l,
        
        #baseline consumption
        fao_demand = m, 
        fao_fm_biomass = n,
        fao_fo_demand = o,
        fao_from_fm = p, 
        fao_surplus = q,
        fao_consumption = r,
        
        #pesc consumption
        WB_RG_demand = s, 
        WB_RG_biomass = t,
        WB_RG_demand = u,
        WB_RG_from_fm = v, 
        WB_RG_surplus = w,
        WB_RG_consumption = x,
        
        #chinese consumption
        WB_CD_demand = aa, 
        WB_CD_fm_biomass = bb,
        WB_CD_fo_demand = cc,
        WB_CD_from_fm = dd, 
        WB_CD_surplus = ee,
        WB_CD_consumption = ff
        
        #chinese diets and more efficient
        # effchn_demand = gg, 
        # effchn_fm_biomass = hh,
        # effchn_fo_demand = ii,
        # effchn_from_fm = jj, 
        # effchn_surplus = kk,
        # effchn_consumption = ll
        ))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows


write_csv(a_test, "forage fish consumption - fish oil only replacement.csv")

```

#Figure 4

```{r}

optimal_global_use <- 
      bind_rows(
        
        # fread("forage fish consumption.csv", header=T) %>% 
        #   select(Country, Species, Taxa_adj, rep_id,consumption_2015 ) %>% 
        #   group_by(rep_id) %>% 
        #   summarise(Rep_Value = sum(consumption_2015)) %>% 
        #   summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
        #   mutate(Scenario = "2015") %>% 
        #   mutate(Diet="2015"),
        
        fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "BAU") %>% 
          mutate(Diet = "2030") ,
        
        fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "Rap.Gr.") %>% 
          mutate(Diet = "2030") ,
        
        
        fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "Con.Shft") %>% 
          mutate(Diet = "2030") 
      ) %>%
  mutate(Scenario = factor(Scenario, levels = c("BAU", "Rap.Gr.", "Con.Shft")))





salmon_shrimp <- 
      bind_rows(
        
        # fread("forage fish consumption.csv", header=T) %>% 
        #   select(Country, Species, Taxa_adj, rep_id,consumption_2015 ) %>% 
        #   group_by(rep_id) %>% 
        #   summarise(Rep_Value = sum(consumption_2015)) %>% 
        #   summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
        #   mutate(Scenario = "2015") %>% 
        #   mutate(Diet="2015"),
        
        fread("forage fish consumption - development optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "BAU") %>% 
          mutate(Diet = "2030") ,
        
        fread("forage fish consumption - development optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "Rap.Gr.") %>% 
          mutate(Diet = "2030") ,
        
        
        fread("forage fish consumption - development optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "Con.Shft") %>% 
          mutate(Diet = "2030") 
      ) %>%
  mutate(Scenario = factor(Scenario, levels = c("BAU", "Rap.Gr.", "Con.Shft")))



fishmeal_only <- 
      bind_rows(
        
        # fread("forage fish consumption.csv", header=T) %>% 
        #   select(Country, Species, Taxa_adj, rep_id,consumption_2015 ) %>% 
        #   group_by(rep_id) %>% 
        #   summarise(Rep_Value = sum(consumption_2015)) %>% 
        #   summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
        #   mutate(Scenario = "2015") %>% 
        #   mutate(Diet="2015"),
        
        fread("forage fish consumption - fishmeal only replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "BAU") %>% 
          mutate(Diet = "2030") ,
        
        fread("forage fish consumption - fishmeal only replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "Rap.Gr.") %>% 
          mutate(Diet = "2030") ,
        
        
        fread("forage fish consumption - fishmeal only replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "Con.Shft") %>% 
          mutate(Diet = "2030") 
      ) %>%
  mutate(Scenario = factor(Scenario, levels = c("BAU", "Rap.Gr.", "Con.Shft")))





fish_oil_only <- 
      bind_rows(
        
        # fread("forage fish consumption.csv", header=T) %>% 
        #   select(Country, Species, Taxa_adj, rep_id,consumption_2015 ) %>% 
        #   group_by(rep_id) %>% 
        #   summarise(Rep_Value = sum(consumption_2015)) %>% 
        #   summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
        #   mutate(Scenario = "2015") %>% 
        #   mutate(Diet="2015"),
        
        fread("forage fish consumption - fish oil only replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "BAU") %>% 
          mutate(Diet = "2030") ,
        
        fread("forage fish consumption - fish oil only replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "Rap.Gr.") %>% 
          mutate(Diet = "2030") ,
        
        
        fread("forage fish consumption - fish oil only replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "Con.Shft") %>% 
          mutate(Diet = "2030") 
      ) %>%
  mutate(Scenario = factor(Scenario, levels = c("BAU", "Rap.Gr.", "Con.Shft")))


==============================================================

#Capture production
forage_fish <-
  fread("Marine fisheries Production 1950-2014.csv", header=T) %>% 
  filter(TaxonName %in% feed_spp) %>% 
  select(CountryName, Year, TaxonName, Value) %>% 
  group_by(Year) %>% 
  summarise(Value=sum(Value)) %>% 
  mutate(Element="Historical supply")

#Management into legend
management <- 
  data_frame(Year= NA, Vaue = NA, Element="Proposed EBFM limit")


#fishmeal use in aquaculture

fishmeal_prop <- 
  data_frame(Year=c(1960,1980,2010), Prop=c(0.04, 0.1,0.73))


fishmeal_aqua <- 
  data_frame(Year=seq(1961,2013)) %>% 
  mutate(Prop = case_when(Year==1961 ~0.04,
                          Year==1980~0.1,
                          Year==2010~0.73))
  
  
predictions <- predict(lm(Prop~Year, data=fishmeal_aqua), newdata = data_frame(Year=seq(1961,2013)))+0.05

fishmeal_aqua <- 
  fishmeal_aqua %>% 
  select(Year) %>% 
  mutate(Value=feed_use$Value*predictions) %>% 
  mutate(Element="Aquaculture use")

anchovy <- readPNG("anchovy.png")
anchovy <- rasterGrob(anchovy)


limit <- mean(forage_fish$Value[forage_fish$Year>1979])
feed_limit <- mean(feed_use$Value[feed_use$Year>1979])

#========================================================================

optimal_use <- ggplot(data=optimal_global_use, aes(x=Scenario, y=Value, fill=Scenario))+
  geom_bar(stat="identity", position = "dodge", width=0.6)+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=0.1, position = position_dodge(0.9))+
  scale_fill_manual(values=rev(lacroix_palette("PassionFruit", n=3, type = "continuous")))+
  #scale_x_discrete(labels = "2030")+
  scale_y_continuous(limits=c(0,4.2e+7), labels=c(0,10,20,30,40), expand=c(0,0))+
  theme_pubr()+
  theme(text = element_text(size=10),
        legend.position = "right",
        axis.text.x = element_text(angle=45, hjust=1),
        axis.title.x = element_blank())+
  labs(y=bquote(Forage~fish~demand~(Tx10^6)), x="Diets")+
  # annotate("text", x=.5, y=32e+6, label="Historical supply", size=3)+
  # annotate("text", x=7.5, y=25e+6, label="EBFM supply", size=3)
  geom_segment( x=0.5, xend = 8.5, y=c(limit), yend=c(limit), linetype=c(1))+
  geom_segment( x=0.5, xend = 8.5, y=c(limit*.8), yend=c(limit*.8), linetype=c(2))+
  geom_segment( x=0.5, xend = 8.5, y=c(feed_limit), yend=c(feed_limit), linetype=c(1), colour="grey50")+
  annotate("text", x=0.5, y=31.5e+6, label="Average supply 1980-2013", size=2.5, hjust=0)+
    annotate("text", x=0.5, y=25.5e+6, label="Proposed EBFM supply", size=2.5, hjust=0)+
    annotate("text", x=0.5, y= 19.9e+6, label="Average feed use 1980-2013", size=2.5, hjust=0)+
  annotate("text", x=0.65, y=40.2e+6, label=expression(bold("Optimal global use")), size=2.5, hjust=0)
  




salmon_shrimp_only <- ggplot(data=salmon_shrimp, aes(x=Scenario, y=Value, fill=Scenario))+
  geom_bar(stat="identity", position = "dodge", width=0.6)+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=0.1, position = position_dodge(0.9))+
  scale_fill_manual(values=rev(lacroix_palette("PassionFruit", n=3, type = "continuous")))+
  #scale_x_discrete(labels = "2030")+
  scale_y_continuous(limits=c(0,4.2e+7), labels=c(0,10,20,30,40), expand=c(0,0))+
  theme_pubr()+
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1),
        legend.position = "right",
        axis.title=  element_blank())+
  labs(y=bquote(Forage~fish~demand~(Tx10^6)), x="Diets")+
  # annotate("text", x=.5, y=32e+6, label="Historical supply", size=3)+
  # annotate("text", x=7.5, y=25e+6, label="EBFM supply", size=3)
  geom_segment( x=0.5, xend = 8.5, y=c(limit), yend=c(limit), linetype=c(1))+
  geom_segment( x=0.5, xend = 8.5, y=c(limit*.8), yend=c(limit*.8), linetype=c(2))+
  geom_segment( x=0.5, xend = 8.5, y=c(feed_limit), yend=c(feed_limit), linetype=c(1), colour="grey50")+
  annotate("text", x=0.65, y=38e+6, label=expression(bold("Salmonids & shrimps\nonly")), size=2.5, hjust=0)


fish_meal_only <- ggplot(data=fishmeal_only, aes(x=Scenario, y=Value, fill=Scenario))+
  geom_bar(stat="identity", position = "dodge", width=0.6)+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=0.1, position = position_dodge(0.9))+
  scale_fill_manual(values=rev(lacroix_palette("PassionFruit", n=3, type = "continuous")))+
  #scale_x_discrete(labels = "2030")+
  scale_y_continuous(limits=c(0,4.2e+7), labels=c(0,10,20,30,40), expand=c(0,0))+
  theme_pubr()+
  theme(text = element_text(size=10),
        legend.position = "right",
        axis.text.x = element_text(angle=45, hjust=1),
        axis.title = element_blank())+
  labs(y=bquote(Forage~fish~demand~(Tx10^6)), x="Diets")+
  # annotate("text", x=.5, y=32e+6, label="Historical supply", size=3)+
  # annotate("text", x=7.5, y=25e+6, label="EBFM supply", size=3)
  geom_segment( x=0.5, xend = 8.5, y=c(limit), yend=c(limit), linetype=c(1))+
  geom_segment( x=0.5, xend = 8.5, y=c(limit*.8), yend=c(limit*.8), linetype=c(2))+
  geom_segment( x=0.5, xend = 8.5, y=c(feed_limit), yend=c(feed_limit), linetype=c(1), colour="grey50")+
  annotate("text", x=0.65, y=38e+6, label=expression(bold("Fishmeal\nreplacement only")), size=2.5, hjust=0)



fishoil_only <- ggplot(data=fish_oil_only, aes(x=Scenario, y=Value, fill=Scenario))+
  geom_bar(stat="identity", position = "dodge", width=0.6)+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=0.1, position = position_dodge(0.9))+
  scale_fill_manual(values=rev(lacroix_palette("PassionFruit", n=3, type = "continuous")))+
  #scale_x_discrete(labels = "2030")+
  scale_y_continuous(limits=c(0,4.2e+7), labels=c(0,10,20,30,40), expand=c(0,0))+
  theme_pubr()+
  theme(text = element_text(size=10),
        legend.position = "right",
        axis.text.x = element_text(angle=45, hjust=1),
        axis.title = element_blank())+
  labs(y=bquote(Forage~fish~demand~(Tx10^6)), x="Diets")+
  # annotate("text", x=.5, y=32e+6, label="Historical supply", size=3)+
  # annotate("text", x=7.5, y=25e+6, label="EBFM supply", size=3)
  geom_segment( x=0.5, xend = 8.5, y=c(limit), yend=c(limit), linetype=c(1))+
  geom_segment( x=0.5, xend = 8.5, y=c(limit*.8), yend=c(limit*.8), linetype=c(2))+
  geom_segment( x=0.5, xend = 8.5, y=c(feed_limit), yend=c(feed_limit), linetype=c(1), colour="grey50")+
  annotate("text", x=0.65, y=38e+6, label=expression(bold("Fish oil\nreplacement only")), size=2.5, hjust=0)


#legend <- get_legend(optimal_use)


annotate_figure(ggarrange(optimal_use, salmon_shrimp_only, fish_meal_only, fishoil_only, 
          nrow = 1, ncol = 4,
          legend = "none", 
          labels=c("a", "b", "c", "d"),
          widths = c(1.15,1,1,1),
          font.label = list(size=10),
          label.x = c(0,-0.1,-0.1, -0.1)),
          bottom = textGrob("Aquaculture 2030 scenarios"))+
  ggsave("Fig 4 - revision.tiff", dpi = 600, device = "tiff", width = 18, height=9, units = "cm")+
  ggsave("Fig 4 - revision.pdf", dpi = 600, device = "pdf", width = 18, height=9, units = "cm")


```




```{r}
optimal <- 
      bind_rows(
        
        fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nBAU"),
        
        fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nRap.Gr."),
        
        
        fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nCon.Shft")
      ) %>% 
      mutate(Diet = "Optimal global use")


high_value_only <- 
   bind_rows(
        
        fread("forage fish consumption - development optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nBAU"),
        
        fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nRap.Gr."),
        
        
        fread("forage fish consumption - development optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nCon.Shft")
      ) %>% 
      mutate(Diet = "High-value spp. only")


optimal
high_value_only


```

####SECTION 1 COMBINE CONSUMPTION SCENARIOS ACROSS DIETS


## All diets and growth scenarios

```{r}


(all_diets_scenarios <- 
  bind_rows(
    
    #current diets
    
    current_diets <- 
      bind_rows(
        
        fread("forage fish consumption.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nBAU"),
        
        fread("forage fish consumption.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nRap.Gr."),
        
        
        fread("forage fish consumption.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nCon.Shft")
      ) %>% 
      mutate(Diet = "Current diets"),
    
    #algal diets 
    
    Algae <- 
      bind_rows(
        
        fread("forage fish consumption - algae replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nBAU"),
        
        fread("forage fish consumption - algae replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nRap.Gr."),
        
        
        fread("forage fish consumption - algae replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nCon.Shft")
      ) %>% 
      mutate(Diet = "Algae"),
    
    
    
    
    
    Bacteria <- 
      bind_rows(
        
        fread("forage fish consumption - bacteria replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nBAU"),
        
        fread("forage fish consumption - bacteria replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nRap.Gr."),
        
        
        fread("forage fish consumption - bacteria replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nCon.Shft")
      ) %>% 
      mutate(Diet = "Bacteria"),
    
    
    
    yeast <- 
      bind_rows(
        
        fread("forage fish consumption - yeast replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nBAU"),
        
        fread("forage fish consumption - yeast replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nRap.Gr."),
        
        
        fread("forage fish consumption - yeast replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nCon.Shft")
      ) %>% 
      mutate(Diet = "Yeast"),
    
    
    
    
    
    insects <- 
      bind_rows(
        
        fread("forage fish consumption - insects replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nBAU"),
        
        fread("forage fish consumption - insects replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nRap.Gr."),
        
        
        fread("forage fish consumption - insects replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nCon.Shft")
      ) %>% 
      mutate(Diet = "Insects"),
    
    
    
    
    Soy <- 
      bind_rows(
        
        fread("forage fish consumption - soy replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nBAU"),
        
        fread("forage fish consumption - soy replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nRap.Gr."),
        
        
        fread("forage fish consumption - soy replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nCon.Shft")
      ) %>% 
      mutate(Diet = "Soy"),
    
    
    
    optimal <- 
      bind_rows(
        
        fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nBAU"),
        
        fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nRap.Gr."),
        
        
        fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nCon.Shft")
      ) %>% 
      mutate(Diet = "Optimal global"),
    
    optimal_high_value <- 
      bind_rows(
        
        fread("forage fish consumption - development optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(fao_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nBAU"),
        
        fread("forage fish consumption - development optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nRap.Gr."),
        
        
        fread("forage fish consumption - development optimal replacement.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2030\nCon.Shft")
      ) %>% 
      mutate(Diet = "Optimal \nSalmon & Shrimp")
    
  ) %>% 
   mutate(Scenario = factor(Scenario, levels=c("2030\nBAU",  "2030\nRap.Gr.", "2030\nCon.Shft"))) %>% 
   mutate(limitbreach = case_when(Value+sd>=limit ~"TRUE", 
                                   TRUE ~ "FALSE")) %>% 
   mutate(EBFM_breach = case_when(Value+sd>=limit*0.8 ~"TRUE", 
                                   TRUE ~ "FALSE"))
)



(demand_scenarios <- ggplot(data = all_diets_scenarios, aes(x=Scenario, y=reorder(Diet,Value)))+
  geom_tile(aes(fill=Value))+
  theme_pubclean()+
  scale_x_discrete(expand = c(0,0))+
  scale_y_discrete(expand = c(0,0))+
  theme(
    #axis.title.y = element_blank(),
    legend.position = "right",
    aspect.ratio = 50/25,
    text = element_text(size=10),
    legend.title = element_text(size=7),
    legend.box.spacing = unit(0.11, "cm"),
    legend.text = element_text(size=7),
    axis.text.x = element_text(size=7),
    plot.margin = unit(c(t=0., b=0, r=0, l=0), units="cm")
  )+
    annotate("segment", x=c(0.5, 0.5, 1.5, 1.5,1.5, 2.5, 2.5),xend = c(0.5,1.5, 1.5, 1.5, 2.5, 2.5, 3.5),  y=c(7.5, 7.5, 7.5, 6.5, 5.5, 5.5, 2.5), yend = c(8.5,7.5, 6.5, 5.5, 5.5, 2.5, 2.5), linetype=2)+
    annotate("segment", x=c(2.5, 2.5), xend = c(2.5, 3.5), y=c(8.5, 3.5), yend=c(3.5, 3.5))+
  guides(fill=guide_colorbar(barwidth = 0.7, barheight = 5, units="cm", ticks=FALSE))+
  labs(x="Growth scenario", fill="Forage fish demand\n(million tonnes)", y="")+
  scale_fill_gradientn(colours = rev(lacroix_palette("PeachPear", n=5, type = "continuous")), breaks=c(15e+6, 20e+6, limit*0.8, limit, 35e+6), labels=c("15", "20", "EBFM supply", "Historical supply", "35")))+
  ggsave("forage_fish_heatmap.tiff", dpi=600, device = "tiff", width = 8.9, height = 7, units = "cm")+
  ggsave("forage_fish_heatmap.pdf", dpi=600, device = "pdf", width = 8.9, height = 7, units = "cm")


(Baseline <- fread("forage fish consumption.csv", header=T) %>% 
          select(Country, Species, Taxa_adj, rep_id, consumption_2015) %>% 
          group_by(rep_id) %>% 
          summarise(Rep_Value = sum(consumption_2015)) %>% 
          summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
          mutate(Scenario = "2015")
)

Baseline$Value

ggplot(all_diets_scenarios %>% 
         add_row(Value = Baseline$Value, sd=Baseline$sd, Scenario="2015", Diet="Current diets") %>% 
         mutate(Scenario = factor(Scenario, levels=c("2015","2030\nBAU",  "2030\nRap.Gr.", "2030\nCon.Shft"))) %>% 
         mutate(Diet = factor(Diet, levels=c("Current diets", "Yeast", "Insects", "Bacteria", "Soy", "Optimal \nSalmon & Shrimp", "Algae", "Optimal global"))),
       aes(x=Diet, y=Value, fill=Scenario))+
  geom_segment( x=0.5, xend = 8.5, y=c(limit), yend=c(limit), linetype=c(1))+
  geom_segment( x=0.5, xend = 8.5, y=c(limit*.8), yend=c(limit*.8), linetype=c(2))+
  geom_bar(stat="identity", position ="dodge")+
geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=0.2,position =  position_dodge(0.9))+
  scale_fill_manual(values=rev(lacroix_palette("PassionFruit", n=4, type = "continuous")))+
  scale_y_continuous(labels = c(0,10,20,30,40))+
  theme_pubr()+
  theme(text = element_text(size=10))+
  labs(y=bquote(Forage~fish~demand~(Tx10^6)), x="Diets")+
  annotate("text", x=7.5, y=32e+6, label="Historical supply", size=3)+
  annotate("text", x=7.5, y=25e+6, label="EBFM supply", size=3)+
  ggsave("Figure S1 - Demand with uncertainty.tiff", device = "tiff", dpi=600, width = 18, height=10, units = "cm")
  





```

#Historical supply

```{r}


ff_consumption <- 
  fread("forage fish consumption.csv", header=T) 



#feed supply data from FAOSTAT
feed_fish <- read_csv("forage_feed.csv")

feed_use <- feed_fish %>%
  filter(Item=="Pelagic Fish") %>% 
  group_by(Year) %>%
  summarise(Value = sum(Value)*1000) %>% 
  mutate(Element = "Total animal feed use")
  


#forage fish species used in Froehlich et al

feed_spp <- c("Engraulis ringens",  "Clupea harengus", "Engraulis japonicus", "Decapterus", "Decapterus macrosoma" ,"Decapterus maruadsi" , "Decapterus russelli",  "Sardina pilchardus", "Mallotus villosus",   "Sardinella",  "Mallotus villosus", "Brevoortia patronus", "Engraulis encrasicolus", "Cololabis saira", "Clupea pallasii pallasii", "Trachurus murphyi", "Larimichthys polyactis", "Clupeidae", "Sprattus sprattus", "Sardinops sagax", "Trachurus", "Trachurus trecae" , "Trachurus capensis","Trachurus lathami", "Trachurus declivis", "Trachurus trachurus", "Trachurus murphyi" , "Trachurus mediterraneus", "Trachurus symmetricus","Trachurus japonicus", "Trachurus picturatus") 


#Sort the symbols in values out
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information


##IF USING FAO PRODUCTION DATA - Feed use of pelagic fish is greater than production!

#Capture production
forage_fish <-
  fread("Marine fisheries Production 1950-2014.csv", header=T) %>% 
  filter(TaxonName %in% feed_spp) %>% 
  select(CountryName, Year, TaxonName, Value) %>% 
  group_by(Year) %>% 
  summarise(Value=sum(Value)) %>% 
  mutate(Element="Historical supply")

#Management into legend
management <- 
  data_frame(Year= NA, Vaue = NA, Element="Proposed EBFM limit")


#fishmeal use in aquaculture

fishmeal_prop <- 
  data_frame(Year=c(1960,1980,2010), Prop=c(0.04, 0.1,0.73))


fishmeal_aqua <- 
  data_frame(Year=seq(1961,2013)) %>% 
  mutate(Prop = case_when(Year==1961 ~0.04,
                          Year==1980~0.1,
                          Year==2010~0.73))
  
  
predictions <- predict(lm(Prop~Year, data=fishmeal_aqua), newdata = data_frame(Year=seq(1961,2013)))+0.08

fishmeal_aqua <- 
  fishmeal_aqua %>% 
  select(Year) %>% 
  mutate(Value=feed_use$Value*predictions) %>% 
  mutate(Element="Aquaculture use")

anchovy <- readPNG("anchovy.png")
anchovy <- rasterGrob(anchovy)


limit <- mean(forage_fish$Value[forage_fish$Year>1979])

(future_scenarios <- ggplot(data = all_diets_scenarios, aes(x=Scenario, y=reorder(Diet,Value)))+
  geom_tile(aes(fill=Value))+
  theme_pubclean()+
  scale_x_discrete(expand = c(0,0))+
  scale_y_discrete(expand = c(0,0))+
  theme(
    #axis.title.y = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_text(size=7),
    axis.title.y = element_blank(),
    aspect.ratio = 50/25,
    plot.margin = unit(c(t=0., b=0, r=0, l=0), units="cm")
  )+
  guides(fill=FALSE)+
  labs(x="2030\nScenarios")+
  scale_fill_gradientn(colours = rev(lacroix_palette("PeachPear", n=5, type = "continuous")), breaks=c(15e+6, 20e+6, limit*0.8, limit, 35e+6), labels=c("15", "20", "EBFM supply", "Historical supply", "35")))



(supply_demand <- 
    bind_rows(forage_fish, feed_use, fishmeal_aqua, management) %>% 
    mutate(Element = factor(Element, levels=c("Historical supply", "Proposed EBFM limit","Total animal feed use", "Aquaculture use"))) %>%
    ggplot(aes(x=Year, y=Value, colour=Element, linetype=Element))+geom_line()+
    scale_linetype_manual(values=c(1,2,1,1))+
    scale_colour_manual(values=c("black", "black", "grey50", "dodgerblue"))+
    scale_y_continuous(limits=c(0,4.2e+7), labels=c(0,10,20,30,40), expand=c(0,0))+
    scale_x_continuous(breaks = c(1970,1990, 2010, 2030), limits = c(1960,2036), expand = c(0,0))+
                         theme_pubr()+
                         geom_vline(xintercept=2015, linetype=2, colour="grey80", alpha=0)+
                         theme(
                           #text=element_text(size=10),
                           legend.title = element_blank(),
                           legend.background=element_blank(),
                           legend.position = c(0.2,0.9),
                           legend.text = element_text(size=7),
                           legend.key.height = unit(0.3, "cm"),
                           plot.margin = unit(c(0.5,-.2, 0.2,0.2), "cm"),
                           axis.text.x = element_text(size=10),
                           #axis.line.x = element_blank(),
                           axis.title.x = element_text(size=10),
                           axis.text.y = element_text(size=10),
                           axis.title.y = element_text(size=10)
                         )+
                         annotate("segment", x=2013, xend=2035, y=limit, yend = limit)+
                         annotate("segment", x=2013, xend=2035, y=limit*0.8, yend = limit*0.8, linetype=2)+
                         annotate("segment", x=2013, xend=2013, y=-Inf, yend = Inf, colour="grey80", linetype=2)+
    geom_segment(x=2013, xend=2023, y=15078983.9, yend = 15078983.9, colour="lightskyblue", linetype=1, alpha=0.3, arrow = arrow(length = unit(2, "mm"), type = "closed"))+
                         #annotate("segment", x=1960, xend=2030.5, y=0, yend = 0, colour="black", linetype=1, size=0.95)+
                         annotate("text", x=2014, y=32.5e+6, label="Average supply\n1980-2013", size=2.5, hjust=0)+
    #annotate("text", x=2031.5, y=15078983.9, label="?", size=3)+
    annotation_custom(anchovy, xmin = 2020, xmax = 2034, ymin=34e+6, ymax=44e+6)+
                         labs(y=bquote(Forage~fish~biomass~(million~tonnes)))+
    annotation_custom(ggplotGrob(future_scenarios) , xmin = 2020, xmax=2034, ymin = 6e+6, ymax=20e+6)+
                         ggsave("total forage fish landings plot2.tiff", device="tiff", dpi=600, width = 8.9, height=8, units = "cm"))
                       


#bracket <- 

ggarrange(supply_demand, demand_scenarios,
          nrow = 1,
          ncol=2,
          labels=c("a", "b"),
          font.label = list(size=9),
          align = "hv", 
          widths = c(0.51,0.49),
          label.x = c(0.001, 0.05))+
  #annotation_custom(bracketsGrob(0.56, 0.13 , 0.56, 0.92 , h=0.14, col="grey70"))+
  annotation_custom(segmentsGrob(x0=c(0.853, 0.853), x1=c(0.871, 0.871), y0=c(0.504, 0.573), y1=c(0.504, 0.573), default.units = "npc", gp = gpar(lty=c(2,1))))+
  ggsave("Figure - supply and demand.tiff", dpi=600, device = "tiff", width = 18, height=7.5, units="cm")+
  ggsave("Figure - supply and demand.pdf", dpi=600, device = "pdf", width = 18, height=7.5, units="cm")

70/2.4


29.2/7.5







############################   FOR THE POSTER




(demand_scenarios <- ggplot(data = all_diets_scenarios, aes(x=Scenario, y=reorder(Diet,Value)))+
  geom_tile(aes(fill=Value))+
  theme_pubclean()+
  scale_x_discrete(expand = c(0,0))+
  scale_y_discrete(expand = c(0,0))+
  theme(
    #axis.title.y = element_blank(),
    legend.position = "right",
    aspect.ratio = 50/25,
    text = element_text(size=10*3.9),
    axis.title.x = element_text(margin = margin(c(t =20, r = 0, b = 0, l = 0))),
    legend.title = element_text(size=7*3.9),
    legend.box.spacing = unit(0.11, "cm"),
    legend.text = element_text(size=7*3.9),
    axis.text.x = element_text(size=7*3.9),
    plot.margin = unit(c(t=0, r=0,b=0, l=0), units="cm")
  )+
    annotate("segment", x=c(0.5, 0.5, 1.5, 1.5,1.5, 2.5, 2.5),xend = c(0.5,1.5, 1.5, 1.5, 2.5, 2.5, 3.5),  y=c(7.5, 7.5, 7.5, 6.5, 5.5, 5.5, 2.5), yend = c(8.5,7.5, 6.5, 5.5, 5.5, 2.5, 2.5), linetype=2, size=2.5)+
    annotate("segment", x=c(2.5, 2.5), xend = c(2.5, 3.5), y=c(8.5, 3.5), yend=c(3.5, 3.5), size=2.5)+
  guides(fill=guide_colorbar(barwidth = 0.7*3.9, barheight = 5*3.9, units="cm", ticks=FALSE))+
  labs(x="Growth scenario", fill="Forage fish demand\n(million tonnes)", y="")+
  scale_fill_gradientn(colours = rev(lacroix_palette("PeachPear", n=5, type = "continuous")), breaks=c(15e+6, 20e+6, limit*0.8, limit, 35e+6), labels=c("15", "20", "EBFM supply", "Historical supply", "35")))+
  ggsave("forage_fish_heatmap - poster.tiff", dpi=600, device = "tiff", width = 35, height = 29, units = "cm")+
  ggsave("forage_fish_heatmap - poster.pdf", dpi=600, device = "pdf", width = 8.9, height = 29, units = "cm")


(future_scenarios <- ggplot(data = all_diets_scenarios, aes(x=Scenario, y=reorder(Diet,Value)))+
  geom_tile(aes(fill=Value))+
  theme_pubclean()+
  scale_x_discrete(expand = c(0,0))+
  scale_y_discrete(expand = c(0,0))+
  theme(
    #axis.title.y = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_text(size=7*3.9),
    axis.title.y = element_blank(),
    aspect.ratio = 50/25,
    plot.margin = unit(c(t=0., b=0, r=0, l=0), units="cm")
  )+
  guides(fill=FALSE)+
  labs(x="2030\nScenarios")+
  scale_fill_gradientn(colours = rev(lacroix_palette("PeachPear", n=5, type = "continuous")), breaks=c(15e+6, 20e+6, limit*0.8, limit, 35e+6), labels=c("15", "20", "EBFM supply", "Historical supply", "35")))

(supply_demand <- 
    bind_rows(forage_fish, feed_use, fishmeal_aqua, management) %>% 
    mutate(Element = factor(Element, levels=c("Historical supply", "Proposed EBFM limit","Total animal feed use", "Aquaculture use"))) %>%
    ggplot(aes(x=Year, y=Value, colour=Element, linetype=Element))+geom_line(size=2.5)+
    scale_linetype_manual(values=c(1,2,1,1))+
    scale_colour_manual(values=c("black", "black", "grey50", "dodgerblue"))+
    scale_y_continuous(limits=c(0,4.2e+7), labels=c(0,10,20,30,40), expand=c(0,0))+
    scale_x_continuous(breaks = c(1970,1990, 2010, 2030), limits = c(1960,2036), expand = c(0,0))+
                         theme_pubr()+
                         geom_vline(xintercept=2015, linetype=2, colour="grey80", alpha=0)+
                         theme(
                           #text=element_text(size=10),
                           legend.title = element_blank(),
                           legend.background=element_blank(),
                           legend.position = c(0.2,0.9),
                           legend.text = element_text(size=7*3.9),
                           legend.key.height = unit(0.3*3.9, "cm"),
                           legend.key.width = unit(2.4, "cm"),
                           plot.margin = unit(c(0.5,-.2, 0.2,0.2), "cm"),
                           axis.text.x = element_text(size=10*3.9),
                           axis.line = element_line(size=2.5),
                           axis.title.x = element_text(size=10*3.9),
                           axis.text.y = element_text(size=10*3.9),
                           axis.title.y = element_text(size=10*3.9)
                         )+
                         annotate("segment", x=2013, xend=2035, y=limit, yend = limit,  size=2.5)+
                         annotate("segment", x=2013, xend=2035, y=limit*0.8, yend = limit*0.8, linetype=2, size=2.5)+
                         annotate("segment", x=2013, xend=2013, y=-Inf, yend = Inf, colour="grey80", linetype=2, size=2.5)+
    geom_segment(x=2013, xend=2022, y=15078983.9, yend = 15078983.9, colour="lightskyblue", linetype=1, size= 2.5, alpha=0.3, arrow = arrow(length = unit(2*3, "mm"), type = "closed"))+
                         #annotate("segment", x=1960, xend=2030.5, y=0, yend = 0, colour="black", linetype=1, size=0.95)+
                         annotate("text", x=2014, y=32.5e+6, label="Average supply\n1980-2013", size=2.5*3.9, hjust=0)+
    #annotate("text", x=2031.5, y=15078983.9, label="?", size=3)+
    annotation_custom(anchovy, xmin = 2020, xmax = 2034, ymin=34e+6, ymax=44e+6)+
                         labs(y=bquote(Forage~fish~biomass~(million~tonnes)))+
    annotation_custom(ggplotGrob(future_scenarios) , xmin = 2020, xmax=2034, ymin = 6e+6, ymax=20e+6)+
                         ggsave("total forage fish landings plot2 -poster .tiff", device="tiff", dpi=300, width = 35, height=29, units = "cm"))
                       

ggarrange(supply_demand, demand_scenarios,
          nrow = 1,
          ncol=2,
          labels=c("a", "b"),
          font.label = list(size=9),
          align = "hv", 
          widths = c(0.51,0.49),
          label.x = c(0.001, 0.05))+
  #annotation_custom(bracketsGrob(0.56, 0.13 , 0.56, 0.92 , h=0.14, col="grey70"))+
  annotation_custom(segmentsGrob(x0=c(0.8675, 0.8675), x1=c(0.8855, 0.8855), y0=c(0.504, 0.573), y1=c(0.504, 0.573), default.units = "npc", gp = gpar(lty=c(2,1), lwd=4)))+
   ggsave("Figure - supply and demand - poster.tiff", dpi=600, device = "tiff", width = 70, height=33.3, units="cm")
  
```


#Figure 4

```{r}

#original consumption 

ff_consumption <- 
  fread("forage fish consumption.csv", header=T) 


base_consumption_2015 <- 
   #by taxa for 2015
   ff_consumption %>%  
   select(Country, Species, Taxa_adj, rep_id, Value, consumption_2015) %>% 
   group_by(Taxa_adj, rep_id) %>% 
   summarise(Consumption_taxa = sum(consumption_2015))%>% 
   group_by(Taxa_adj) %>% 
   summarise(Mean = mean(Consumption_taxa), sd = sd(Consumption_taxa), Scenario = "2015" ) %>% 
   mutate(Taxa_adj = factor(Taxa_adj, levels = c("Tunas", "Eels","Marine crustaceans", "Diadromous fishes", "FW crustaceans", "Marine fishes","Salmonids", "FW fishes", "Catfishes", "Shrimps", "Tilapias",  "Carps" , "Total")))



(development_consumption <- 
  bind_rows(
  
  algae_2015 <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, consumption_2015) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(consumption_2015)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2015"),

ff_2030_fao <- 
  fread("forage fish consumption - development optimal replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(fao_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nBAU"),

ff_2030_WB1 <- 
  fread("forage fish consumption - development optimal replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nRap.Gr."),
  

ff_2030_WB2 <- 
  fread("forage fish consumption - development optimal replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nCon.Shft")
) %>% 
    mutate(Element = factor(Element, levels= c("2015", "2030\nBAU", "2030\nRap.Gr.", "2030\nCon.Shft")))
    
)






(optimal_consumption <- 
  bind_rows(
  
  algae_2015 <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, consumption_2015) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(consumption_2015)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2015"),

ff_2030_fao <- 
  fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(fao_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nBAU"),

ff_2030_WB1 <- 
  fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nRap.Gr."),
  

ff_2030_WB2 <- 
  fread("forage fish consumption - optimal replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nCon.Shft")
) %>% 
    mutate(Element = factor(Element, levels= c("2015", "2030\nBAU", "2030\nRap.Gr.", "2030\nCon.Shft")))
    
)





(algae_consumption <- 
  bind_rows(
  
  algae_2015 <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, consumption_2015) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(consumption_2015)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2015"),

ff_2030_fao <- 
  fread("forage fish consumption - algae replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(fao_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nBAU"),

ff_2030_WB1 <- 
  fread("forage fish consumption - algae replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nRap.Gr."),
  

ff_2030_WB2 <- 
  fread("forage fish consumption - algae replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nCon.Shft")
) %>% 
    mutate(Element = factor(Element, levels= c("2015", "2030\nBAU", "2030\nRap.Gr.", "2030\nCon.Shft")))
    
)




# ff_algae <- 
#   fread("forage fish consumption - algae replacement.csv", header=T) 
# 
# algae_consumption_2015 <- 
#    #by taxa for 2015
#    ff_algae %>%  
#    select(Country, Species, Taxa_adj, rep_id, Value, consumption_2015) %>% 
#    group_by(Taxa_adj, rep_id) %>% 
#    summarise(Consumption_taxa = sum(consumption_2015))%>% 
#    group_by(Taxa_adj) %>% 
#    summarise(Mean = mean(Consumption_taxa), sd = sd(Consumption_taxa), Scenario = "2015" ) %>% 
#    mutate(Taxa_adj = factor(Taxa_adj, levels = c("Tunas", "Eels","Marine crustaceans", "Diadromous fishes", "FW crustaceans", "Marine fishes","Salmonids", "FW fishes", "Catfishes", "Shrimps", "Tilapias",  "Carps" , "Total")))
# 





(bacteria_consumption <- 
  bind_rows(
  
  algae_2015 <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, consumption_2015) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(consumption_2015)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2015"),

ff_2030_fao <- 
  fread("forage fish consumption - bacteria replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(fao_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nBAU"),

ff_2030_WB1 <- 
  fread("forage fish consumption - bacteria replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nRap.Gr."),
  

ff_2030_WB2 <- 
  fread("forage fish consumption - bacteria replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nCon.Shft")
) %>% 
    mutate(Element = factor(Element, levels= c("2015", "2030\nBAU", "2030\nRap.Gr.", "2030\nCon.Shft")))
    
)

(yeast_consumption <- 
  bind_rows(
  
  algae_2015 <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, consumption_2015) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(consumption_2015)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2015"),

ff_2030_fao <- 
  fread("forage fish consumption - yeast replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(fao_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nBAU"),

ff_2030_WB1 <- 
  fread("forage fish consumption - yeast replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nRap.Gr."),
  

ff_2030_WB2 <- 
  fread("forage fish consumption - yeast replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nCon.Shft")
) %>% 
    mutate(Element = factor(Element, levels= c("2015", "2030\nBAU", "2030\nRap.Gr.", "2030\nCon.Shft")))
    
)


(soy_consumption <- 
  bind_rows(
  
  algae_2015 <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, consumption_2015) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(consumption_2015)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2015"),

ff_2030_fao <- 
  fread("forage fish consumption - soy replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(fao_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nBAU"),

ff_2030_WB1 <- 
  fread("forage fish consumption - soy replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nRap.Gr."),
  

ff_2030_WB2 <- 
  fread("forage fish consumption - soy replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nCon.Shft")
) %>% 
    mutate(Element = factor(Element, levels= c("2015", "2030\nBAU", "2030\nRap.Gr.", "2030\nCon.Shft")))
    
)



(insects_consumption <- 
  bind_rows(
  
  algae_2015 <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, consumption_2015) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(consumption_2015)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2015"),

ff_2030_fao <- 
  fread("forage fish consumption - insects replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(fao_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nBAU"),

ff_2030_WB1 <- 
  fread("forage fish consumption - insects replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nRap.Gr."),
  

ff_2030_WB2 <- 
  fread("forage fish consumption - insects replacement.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nCon.Shft")
) %>% 
    mutate(Element = factor(Element, levels= c("2015", "2030\nBAU", "2030\nRap.Gr.", "2030\nCon.Shft")))
    
)




(optimal_consumption_plot <- 
  ggplot(data=optimal_consumption, aes(x=Element, y=Value, fill=Element))+
  geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979]), yend=mean(forage_fish$Value[forage_fish$Year>1979]), linetype=1, size=0.25)+
    geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979])*.8, yend=mean(forage_fish$Value[forage_fish$Year>1979])*.8, linetype=3, size=0.25)+
  geom_segment(x=0, xend=Inf, y=mean(feed_use$Value[feed_use$Year>1979]), yend=mean(feed_use$Value[feed_use$Year>1979]), colour="grey30", linetype=2, size=0.25)+
  geom_bar(stat="identity", width=.5)+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=.2, size=0.25)+
  scale_fill_manual(values = rev(lacroix_palette("PassionFruit", n=4, "continuous")))+
  scale_y_continuous(limits=c(0,35e+6), expand = c(0,0), breaks=c(0,10e+6,20e+6,30e+6), labels=c(0,10,20,30))+
  theme_pubr()+
  theme(
        #axis.line.y = element_blank(),
        #axis.text.y = element_blank(),
        axis.title.y = element_text(size=8),
        #axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks = element_line(size=0.25),
        text = element_text(size=8),
        legend.title = element_blank(),
        legend.spacing.x = unit(0.2, "cm"),
        legend.key.size = unit(0.3, "cm"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(size=8, face = "bold.italic", hjust = 0),
        axis.line = element_line(size=0.25),
        panel.background =  element_blank(),
        plot.margin = unit(c(t=0.1, r=0.5, b=0, l=0), "cm")
        )+
  guides(fill=F)+
  labs(x="", y=bquote(Forage~fish~demand~(Tx10^6)), title= "Optimal global use")+
  annotate("text", x =0.6, y=31e+6, label="Average supply 1980-2013", hjust=0, size=2.5)+
  annotate("text", x =0.6, y=25e+6, label="Proposed EBFM supply", hjust=0,  size=2.5)+
  annotate("text", x =0.6, y=22.5e+6, label="Average feed use 1980-2013", hjust=0, size=2.5)+
    ggsave("Forage fish demand - optimal.tiff", device = "tiff", dpi=600, width = 9, height=7, units = "cm"))


(development_consumption_plot <- 
  ggplot(data=development_consumption, aes(x=Element, y=Value, fill=Element))+
  geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979]), yend=mean(forage_fish$Value[forage_fish$Year>1979]), linetype=1, size=0.25)+
    geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979])*.8, yend=mean(forage_fish$Value[forage_fish$Year>1979])*.8, linetype=3, size=0.25)+
  geom_segment(x=0, xend=Inf, y=mean(feed_use$Value[feed_use$Year>1979]), yend=mean(feed_use$Value[feed_use$Year>1979]), colour="grey30", linetype=2, size=0.25)+
  geom_bar(stat="identity", width=.5)+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=.2, size=0.25)+
  scale_fill_manual(values = rev(lacroix_palette("PassionFruit", n=4, "continuous")))+
  scale_y_continuous(limits=c(0,35e+6), expand = c(0,0), breaks=c(0,10e+6,20e+6,30e+6), labels=c(0,10,20,30))+
  theme_pubr()+
  theme(
        #axis.line.y = element_blank(),
        #axis.text.y = element_blank(),
        axis.title.y = element_text(size=6),
        #axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks = element_line(size=0.25),
        text = element_text(size=8),
        legend.title = element_blank(),
        legend.spacing.x = unit(0.2, "cm"),
        legend.key.size = unit(0.3, "cm"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(size=8, face = "bold.italic", hjust = 0),
        axis.line = element_line(size=0.25),
        panel.background =  element_blank(),
        plot.margin = unit(c(t=0.1, r=0.5, b=0, l=0.5), "cm")
        )+
  guides(fill=F)+
  labs(x="", y="", title= "Salmonids and shrimps only")+
  # annotate("text", x =0.6, y=31e+6, label="Average supply 1980-2013", hjust=0, size=2)+
  # annotate("text", x =0.6, y=25e+6, label="Proposed EBFM supply", hjust=0,  size=2)+
  # annotate("text", x =0.6, y=22.5e+6, label="Average feed use 1980-2013", hjust=0, size=2)+
    ggsave("Forage fish demand - development optimal.tiff", device = "tiff", dpi=600, width = 9, height=7, units = "cm"))






(algae_consumption_plot <- 
  ggplot(data=algae_consumption, aes(x=Element, y=Value, fill=Element))+
  geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979]), yend=mean(forage_fish$Value[forage_fish$Year>1979]), linetype=1, size=0.25)+
    geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979])*.8, yend=mean(forage_fish$Value[forage_fish$Year>1979])*.8, linetype=3, size=0.25)+
  geom_segment(x=0, xend=Inf, y=mean(feed_use$Value[feed_use$Year>1979]), yend=mean(feed_use$Value[feed_use$Year>1979]), colour="grey30", linetype=2, size=0.25)+
  geom_bar(stat="identity", width=.5)+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=.2, size=0.25)+
  scale_fill_manual(values = rev(lacroix_palette("PassionFruit", n=4, "continuous")))+
  scale_y_continuous(limits=c(0,40e+6), expand = c(0,0), labels=c(0,10,20,30,40))+
  theme_pubr()+
  theme(
        #axis.line.y = element_blank(),
        #axis.text.y = element_blank(),
        axis.title.y = element_text(size=8),
        #axis.ticks.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks = element_line(size=0.25),
        text = element_text(size=8),
        legend.title = element_blank(),
        legend.spacing.x = unit(0.2, "cm"),
        legend.key.size = unit(0.3, "cm"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(size=8, face = "italic", hjust = 0.5),
        axis.line = element_line(size=0.25),
        panel.background =  element_blank(),
        plot.margin = unit(c(t=0.4,r=0.1, b=0.1,l=0), "cm")
        )+
  #guides(fill=F)+
  labs(x="", y=bquote(Forage~fish~demand~(Tx10^6)), title= "Algae"))



(bacteria_consumption_plot <- 
  ggplot(data=bacteria_consumption, aes(x=Element, y=Value, fill=Element))+
  geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979]), yend=mean(forage_fish$Value[forage_fish$Year>1979]), linetype=1, size=0.25)+
    geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979])*.8, yend=mean(forage_fish$Value[forage_fish$Year>1979])*.8, linetype=3, size=0.25)+
  geom_segment(x=0, xend=Inf, y=mean(feed_use$Value[feed_use$Year>1979]), yend=mean(feed_use$Value[feed_use$Year>1979]), colour="grey30", linetype=2, size=0.25)+
  geom_bar(stat="identity", width=.5)+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=.2, size=0.25)+
  scale_fill_manual(values = rev(lacroix_palette("PassionFruit", n=4, "continuous")))+
  scale_y_continuous(limits=c(0,40e+6), expand = c(0,0))+
  theme_pubr()+
  theme(
        #axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks = element_line(size=0.25),
        #axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.line = element_line(size=0.25),
        plot.title = element_text(size=8, face = "italic", hjust = 0.5),
        panel.background =  element_blank(),
        plot.margin = unit(c(t=0.4,r=0.1, b=0.1,l=0.1), "cm")
        )+
  guides(fill=F)+
  labs(x="", title="Bacteria"))

(yeast_consumption_plot <- 
  ggplot(data=yeast_consumption, aes(x=Element, y=Value, fill=Element))+
  geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979]), yend=mean(forage_fish$Value[forage_fish$Year>1979]), linetype=1, size=0.25)+
    geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979])*.8, yend=mean(forage_fish$Value[forage_fish$Year>1979])*.8, linetype=3, size=0.25)+
  geom_segment(x=0, xend=Inf, y=mean(feed_use$Value[feed_use$Year>1979]), yend=mean(feed_use$Value[feed_use$Year>1979]), colour="grey30", linetype=2, size=0.25)+
  geom_bar(stat="identity", width=.5)+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=.2, size=0.25)+
  scale_fill_manual(values = rev(lacroix_palette("PassionFruit", n=4, "continuous")))+
  scale_y_continuous(limits=c(0,40e+6), expand = c(0,0))+
  theme_pubr()+
  theme(
        #axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks = element_line(size=0.25),
        #axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.line = element_line(size=0.25),
        plot.title = element_text(size=8, face = "italic", hjust = 0.5),
        panel.background =  element_blank(),
        plot.margin = unit(c(t=0.4,r=0.1, b=0.1,l=0.1), "cm")
        )+
  guides(fill=F)+
  labs(x="", y="", title="Yeast"))
  

(soy_consumption_plot <- 
  ggplot(data=soy_consumption, aes(x=Element, y=Value, fill=Element))+
  geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979]), yend=mean(forage_fish$Value[forage_fish$Year>1979]), linetype=1, size=0.25)+
    geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979])*.8, yend=mean(forage_fish$Value[forage_fish$Year>1979])*.8, linetype=3, size=0.25)+
  geom_segment(x=0, xend=Inf, y=mean(feed_use$Value[feed_use$Year>1979]), yend=mean(feed_use$Value[feed_use$Year>1979]), colour="grey30", linetype=2, size=0.25)+
  geom_bar(stat="identity", width=.5)+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=.2, size=0.25)+
  scale_fill_manual(values = rev(lacroix_palette("PassionFruit", n=4, "continuous")))+
  scale_y_continuous(limits=c(0,40e+6), expand = c(0,0))+
  theme_pubr()+
  theme(
        #axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks = element_line(size=0.25),
        plot.title = element_text(size=8, face = "italic", hjust = 0.5),
        #axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.line = element_line(size=0.25),
        panel.background =  element_blank(),
        plot.margin = unit(c(t=0.4,r=0.1, b=0.1,l=0.1), "cm")
        )+
  guides(fill=F)+
  labs(x="", title="Soy"))

(insects_consumption_plot <- 
  ggplot(data=insects_consumption, aes(x=Element, y=Value, fill=Element))+
  geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979]), yend=mean(forage_fish$Value[forage_fish$Year>1979]), linetype=1, size=0.25)+
    geom_segment(x=0, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979])*.8, yend=mean(forage_fish$Value[forage_fish$Year>1979])*.8, linetype=3, size=0.25)+
  geom_segment(x=0, xend=Inf, y=mean(feed_use$Value[feed_use$Year>1979]), yend=mean(feed_use$Value[feed_use$Year>1979]), colour="grey30", linetype=2, size=0.25)+
  geom_bar(stat="identity", width=.5)+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=.2, size=0.25)+
  scale_fill_manual(values = rev(lacroix_palette("PassionFruit", n=4, "continuous")))+
  scale_y_continuous(limits=c(0,40e+6), expand = c(0,0))+
  theme_pubr()+
  theme(
        #axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.ticks = element_line(size=0.25),
        #axis.ticks.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.line = element_line(size=0.25),
        plot.title = element_text(size=8, face = "italic", hjust = 0.5),
        panel.background =  element_blank(),
        plot.margin = unit(c(t=0.4,r=0.1, b=0.1,l=0.1), "cm")
        )+
  guides(fill=F)+
  labs(x="", title = "Insects"))


scenario_legend <- get_legend(algae_consumption_plot)

consumption_plots <- 
  ggarrange(
    ggarrange(optimal_consumption_plot, development_consumption_plot, 
              nrow = 1, 
              ncol = 2, 
              legend = "none", 
              labels = c("a", "b"),
              font.label = list(size=8),
              label.x = c(0.04, 0.04)),
    ggarrange(algae_consumption_plot, bacteria_consumption_plot, yeast_consumption_plot, soy_consumption_plot, insects_consumption_plot, 
              nrow = 1, ncol = 5, 
              labels = c("c", "d", "e", "f", "g"), 
              font.label = list(size=8 ),
              label.x = c(0.1, -0.05,-0.05,-0.05,-0.05),
              label.y = 0.95,
              widths = c(1.25,1,1,1,1), 
              legend = "none"),
    nrow = 2, ncol=1,
    heights = c(1.35, 0.8))+
  ggsave("Figure 4(a) - consumption across feeds.tiff", dpi=600, device = "tiff", width=18, height=10, units="cm")+
  ggsave("Figure 4(a) - consumption across feeds.pdf", dpi=600, device = "pdf", width=18, height=10, units="cm")


development_consumption

```


#Species breakdown of consumption and savings 
```{r}

#Savings


#baseline consumption on current feeds for the different scenarios
(baseline_2015 <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, consumption_2015) %>% 
  group_by(Taxa_adj, rep_id) %>%
  summarise(Taxa_rep_value = sum(consumption_2015)))
  
 
 baseline_bau <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
  group_by(Taxa_adj, rep_id) %>%
  summarise(Taxa_rep_value = sum(fao_consumption))
 
 baseline_rapgr <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption)%>% 
  group_by(Taxa_adj, rep_id) %>%
  summarise(Taxa_rep_value = sum(WB_RG_consumption))
 
 baseline_cons <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption)%>% 
  group_by(Taxa_adj, rep_id) %>%
  summarise(Taxa_rep_value = sum(WB_CD_consumption))


 #Savings by scenario and animal group 
 
 #ALGAE
 
 (algae_total <- 
     bind_rows(
       
       
       algae_bau <- 
         fread("forage fish consumption - algae replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(fao_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_bau$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>% 
         mutate(Element = "2030 BAU"),
       
       
       
       algae_rapgr <- 
         fread("forage fish consumption - algae replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(WB_RG_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_rapgr$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>%
         mutate(Element = "2030 Rap.Gr"),
       
       
       
       algae_conshft <- 
         fread("forage fish consumption - algae replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(WB_CD_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_cons$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>% 
         mutate(Element = "2030 Cons.Shft")
     ) %>% 
     mutate(Element = factor(Element, levels = c("2030 BAU", "2030 Rap.Gr", "2030 Cons.Shft"))) %>% 
     ggplot(aes(x=Taxa_adj, y=Mean_savings, fill=Element))+
     geom_bar(stat="identity", colour="grey40",  size=0.2, position=position_dodge())+ #fill="#359DA9",
     geom_errorbar(aes(ymin=Mean_savings-SD_savings, ymax=Mean_savings+SD_savings), width=0.2, size=0.3, position = position_dodge(0.9))+
     coord_polar()+
     scale_fill_manual(values=c("#359DA9", "#C2B72B", "#C70E7B"))+
     scale_y_continuous(limits=c(0,9.5e+6), breaks = c(0,2e+6, 4e+6,6e+6,8e+6))+
     theme(
       panel.grid.major.x =  element_line(color = "grey90", linetype=1, size=0.15),
       panel.grid.major.y =  element_line(colour="grey75", linetype=1, size=0.3),
       panel.grid.minor = element_blank(),
       panel.background = element_blank(),
       panel.border = element_blank(),
       #axis.text.x = element_text(vjust = 1),
       axis.text.y = element_blank(),
       axis.ticks.y = element_blank(),
       axis.title.x = element_blank(),
       #axis.ticks = element_blank(),
       plot.title = element_text(size=9, face="bold", hjust=0.5, vjust=2),
       axis.title.y = element_blank(),
       axis.text.x = element_text(angle=c(335, 285, 50, 0, 310, 80, 30 ), vjust=0.5, colour="black"),
       text = element_text(size=7.8),
       plot.margin = unit(c(t=0.1, r=-0, b=-0.5, l=0.1), "cm")
     )+
     labs(title="Algae")+
     guides(fill=FALSE)+
     annotate("text", x=c(4,4,4,4), y=c(2e+06,4e+6,6e+6, 8e+6), label=c("2", "4", "6", "8"), size=2.8)+
     ggsave("radar - algae_total.tiff", device="tiff", dpi=600, width=3.6, height=3.6, units="cm")+
    ggsave("radar - algae_total.pdf", device="pdf", dpi=600, width=3.6, height=3.6, units="cm"))
 
 
  (bacteria_total <- 
     bind_rows(
       
       
       bacteria_bau <- 
         fread("forage fish consumption - bacteria replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(fao_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_bau$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>% 
         mutate(Element = "2030 BAU"),
       
       
       
       bacteria_rapgr <- 
         fread("forage fish consumption - bacteria replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(WB_RG_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_rapgr$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>%
         mutate(Element = "2030 Rap.Gr"),
       
       
       
       bacteria_conshft <- 
         fread("forage fish consumption - bacteria replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(WB_CD_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_cons$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>% 
         mutate(Element = "2030 Cons.Shft")
     ) %>% 
     mutate(Element = factor(Element, levels = c("2030 BAU", "2030 Rap.Gr", "2030 Cons.Shft"))) %>% 
     ggplot(aes(x=Taxa_adj, y=Mean_savings, fill=Element))+
     geom_bar(stat="identity", colour="grey40",  size=0.2, position=position_dodge())+ #fill="#359DA9",
     geom_errorbar(aes(ymin=Mean_savings-SD_savings, ymax=Mean_savings+SD_savings), width=0.2, size=0.15, position = position_dodge(0.9))+
     coord_polar()+
     scale_fill_manual(values=c("#359DA9", "#C2B72B", "#C70E7B"))+
     scale_y_continuous(limits=c(0,4.5e+6), breaks = c(0,2e+6, 4e+6,6e+6,8e+6))+
     theme(
       panel.grid.major.x =  element_line(color = "grey90", linetype=1, size=0.15),
       panel.grid.major.y =  element_line(colour="grey75", linetype=1, size=0.3),
       panel.grid.minor = element_blank(),
       panel.background = element_blank(),
       panel.border = element_blank(),
       #axis.text.x = element_text(vjust = 1),
       axis.text.y = element_blank(),
       axis.ticks.y = element_blank(),
       axis.title = element_blank(),
       plot.title = element_text(size=9, face="bold", hjust=0.5, vjust=2),
       #axis.ticks = element_blank(),
       text = element_text(size=7.8),
       axis.text.x = element_text(angle=c(335, 285, 50, 0, 310, 80, 30 ), vjust=0.5, colour="black"),
       plot.margin = unit(c(t=0.1, r=-0, b=-0.5, l=0.1), "cm")
     )+
      labs(title="Bacteria")+
     guides(fill=FALSE)+
     annotate("text", x=c(4,4,4,4), y=c(2e+06,4e+6,6e+6, 8e+6), label=c("2", "4", "6", "8"), size=2.8)+
     ggsave("radar - bacteria_total.tiff", device="tiff", dpi=600, width=3.6, height=3.6, units="cm")+
      ggsave("radar - bacteria_total.pdf", device="pdf", dpi=600, width=3.6, height=3.6, units="cm"))
 
 
 
 ###YEAST 
 
 
 
 (yeast_total <- 
     bind_rows(
       
       
       yeast_bau <- 
         fread("forage fish consumption - yeast replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(fao_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_bau$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>% 
         mutate(Element = "2030 BAU"),
       
       
       
       yeast_rapgr <- 
         fread("forage fish consumption - yeast replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(WB_RG_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_rapgr$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>%
         mutate(Element = "2030 Rap.Gr"),
       
       
       
       yeast_conshft <- 
         fread("forage fish consumption - yeast replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(WB_CD_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_cons$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>% 
         mutate(Element = "2030 Cons.Shft")
     ) %>% 
     mutate(Element = factor(Element, levels = c("2030 BAU", "2030 Rap.Gr", "2030 Cons.Shft"))) %>% 
     ggplot(aes(x=Taxa_adj, y=Mean_savings, fill=Element))+
     geom_bar(stat="identity", colour="grey40",  size=0.2, position=position_dodge())+ #fill="#359DA9",
     geom_errorbar(aes(ymin=Mean_savings-SD_savings, ymax=Mean_savings+SD_savings), width=0.2, size=0.15, position = position_dodge(0.9))+
     coord_polar()+
     scale_fill_manual(values=c("#359DA9", "#C2B72B", "#C70E7B"))+
     scale_y_continuous(limits=c(0,4.5e+6), breaks = c(0,2e+6, 4e+6,6e+6,8e+6))+
     theme(
       panel.grid.major.x =  element_line(color = "grey90", linetype=1, size=0.15),
       panel.grid.major.y =  element_line(colour="grey75", linetype=1, size=0.3),
       panel.grid.minor = element_blank(),
       panel.background = element_blank(),
       panel.border = element_blank(),
       #axis.text.x = element_text(vjust = 1),
       axis.text.y = element_blank(),
       axis.ticks.y = element_blank(),
       axis.title = element_blank(),
       plot.title=element_text(size=9, face="bold", hjust=0.5, vjust=2),
       #axis.ticks = element_blank(),
       text = element_text(size=7.8),
       axis.text.x = element_text(angle=c(335, 285, 50, 0, 310, 80, 30 ), vjust=0.5,colour="black"),
       plot.margin = unit(c(t=0.1, r=-0, b=-0.5, l=0.1), "cm")
     )+
     labs(title="Yeast")+
     guides(fill=FALSE)+
     annotate("text", x=c(4,4,4,4), y=c(2e+06,4e+6,6e+6, 8e+6), label=c("2", "4", "6", "8"), size=2.8)+
     ggsave("radar - yeast_total.tiff", device="tiff", dpi=600, width=3.6, height=3.6, units="cm")+
      ggsave("radar - yeast_total.pdf", device="pdf", dpi=600, width=3.6, height=3.6, units="cm"))
 
 
 
 #SOY 
 
  
 (soy_total <- 
     bind_rows(
       
       
       soy_bau <- 
         fread("forage fish consumption - soy replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(fao_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_bau$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>% 
         mutate(Element = "2030 BAU"),
       
       
       
       soy_rapgr <- 
         fread("forage fish consumption - soy replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(WB_RG_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_rapgr$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>%
         mutate(Element = "2030 Rap.Gr"),
       
       
       
       soy_conshft <- 
         fread("forage fish consumption - soy replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(WB_CD_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_cons$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>% 
         mutate(Element = "2030 Cons.Shft")
     ) %>% 
     mutate(Element = factor(Element, levels = c("2030 BAU", "2030 Rap.Gr", "2030 Cons.Shft"))) %>% 
     ggplot(aes(x=Taxa_adj, y=Mean_savings, fill=Element))+
     geom_bar(stat="identity", colour="grey40",  size=0.2, position=position_dodge())+ #fill="#359DA9",
     geom_errorbar(aes(ymin=Mean_savings-SD_savings, ymax=Mean_savings+SD_savings), width=0.2, size=0.15, position = position_dodge(0.9))+
     coord_polar()+
     scale_fill_manual(values=c("#359DA9", "#C2B72B", "#C70E7B"))+
     scale_y_continuous(limits=c(0,4.5e+6), breaks = c(0,2e+6, 4e+6,6e+6,8e+6))+
     theme(
       panel.grid.major.x =  element_line(color = "grey90", linetype=1, size=0.15),
       panel.grid.major.y =  element_line(colour="grey75", linetype=1, size=0.3),
       panel.grid.minor = element_blank(),
       panel.background = element_blank(),
       panel.border = element_blank(),
       #axis.text.x = element_text(vjust = 1),
       axis.text.y = element_blank(),
       axis.ticks.y = element_blank(),
       axis.title.x = element_blank(),
       axis.title.y = element_blank(),
       #axis.ticks = element_blank(),
       plot.title = element_text(size=9, face="bold", hjust=0.5, vjust=2),
       text = element_text(size=7.8),
       axis.text.x = element_text(angle=c(335, 285, 50, 0, 310, 80, 30 ), vjust=0.5, colour="black"),
       plot.margin = unit(c(t=0.1, r=-0, b=-0.5, l=0.1), "cm")
     )+
     labs(title = "Soy")+
     guides(fill=FALSE)+
     annotate("text", x=c(4,4,4,4), y=c(2e+06,4e+6,6e+6, 8e+6), label=c("2", "4", "6", "8"), size=2.8)+
     ggsave("radar - soy_total.tiff", device="tiff", dpi=600, width=3.6, height=3.6, units="cm")+
      ggsave("radar - soy_total.pdf", device="pdf", dpi=600, width=3.6, height=3.6, units="cm"))
 
 
 
 #INSECTS
  
 (insects_total <- 
     bind_rows(
       
       
       insects_bau <- 
         fread("forage fish consumption - insects replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(fao_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_bau$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>% 
         mutate(Element = "2030 BAU"),
       
       
       
       insects_rapgr <- 
         fread("forage fish consumption - insects replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(WB_RG_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_rapgr$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>%
         mutate(Element = "2030 Rap.Gr"),
       
       
       
       insects_conshft <- 
         fread("forage fish consumption - insects replacement.csv", header=T) %>% 
         select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
         group_by(Taxa_adj, rep_id) %>%
         summarise(Taxa_rep_value = sum(WB_CD_consumption)) %>% 
         ungroup()%>% 
         mutate(baseline=baseline_cons$Taxa_rep_value) %>% 
         mutate(Savings=baseline-Taxa_rep_value) %>%
         group_by(Taxa_adj) %>% 
         summarise(Mean_savings = mean(Savings), SD_savings = sd(Savings)) %>% 
         filter(Taxa_adj %in% c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes")) %>% 
         mutate(Taxa_adj = factor(Taxa_adj, levels = c("Carps", "Catfishes", "FW fishes", "Tilapias", "Shrimps", "Salmonids", "Marine fishes"))) %>% 
         mutate(Element = "2030 Cons.Shft")
     ) %>% 
     mutate(Element = factor(Element, levels = c("2030 BAU", "2030 Rap.Gr", "2030 Cons.Shft"))) %>% 
     ggplot(aes(x=Taxa_adj, y=Mean_savings, fill=Element))+
     geom_bar(stat="identity", colour="grey40",  size=0.2, position=position_dodge())+ #fill="#359DA9",
     geom_errorbar(aes(ymin=Mean_savings-SD_savings, ymax=Mean_savings+SD_savings), width=0.2, size=0.15, position = position_dodge(0.9))+
     coord_polar()+
     scale_fill_manual(values=c("#359DA9", "#C2B72B", "#C70E7B"))+
     scale_y_continuous(limits=c(0,4.5e+6), breaks = c(0,2e+6, 4e+6,6e+6,8e+6))+
     theme(
       panel.grid.major.x =  element_line(color = "grey90", linetype=1, size=0.15),
       panel.grid.major.y =  element_line(colour="grey75", linetype=1, size=0.3),
       panel.grid.minor = element_blank(),
       panel.background = element_blank(),
       panel.border = element_blank(),
       legend.title = element_text(size=7),
       #axis.text.x = element_text(vjust = 1),
       axis.text.y = element_blank(),
       axis.ticks.y = element_blank(),
       legend.key.width = unit(0.25, "cm"),
       legend.key.height = unit(0.45, "cm"),
       legend.direction = "horizontal",
       #legend.position = c(0.3, 0.5),
       
       axis.title = element_blank(),
       #axis.ticks = element_blank(),
       text = element_text(size=7.8),
       plot.title = element_text(size=9, face="bold", hjust=0.5, vjust=2,colour="black"),
       axis.text.x = element_text(angle=c(335, 285, 50, 0, 310, 80, 30 ), vjust=0.5),
       plot.margin = unit(c(t=0.2, r=-0, b=-0.5, l=0.1), "cm")
     )+
     labs(title = "Insects", fill="Growth scenario\n")+
     guides(fill=guide_legend(title.position = "top", title.hjust = 0.5))+
     annotate("text", x=c(4,4,4,4), y=c(2e+06,4e+6,6e+6, 8e+6), label=c("2", "4", "6", "8"), size=2.8)+
     ggsave("radar - insects_total.tiff", device="tiff", dpi=600, width=3.6, height=3.6, units="cm")+
      ggsave("radar - insects_total.pdf", device="pdf", dpi=600, width=3.6, height=3.6, units="cm"))
 
scenario_legend <- get_legend(insects_total)



(circle_legend <- 
    ggplot()+
    theme_nothing+
    scale_x_continuous(limits=c(-2,1.8))+
    scale_y_continuous(limits = c(-0.05,1))+
    geom_circle(aes(x0=1.3, y0=0.5, r=0.5), colour="grey80")+
    geom_circle(aes(x0=1.3, y0=0.5, r=0.3),colour="grey80")+
    geom_circle(aes(x0=1.3, y0=0.5, r=0.1), colour="grey80")+
    coord_equal()+
    theme(
      plot.margin = unit(c(t=0, l=-0.1, b=-0.15,r=0), "cm")
    )+
    annotate("text", x=c(1.3,1.3,1.3), y=c(0.45,0.25,0.04), label=c("2", "4", "8"), size=2.4)+
    annotate("text", x=-1.5, y=0.68, label="Forage fish savings\n (million tonnes)", size=2.4, hjust=0)+
  ggsave("legend.tiff", device = "tiff", dpi=300, width=6, height=6, units = "cm"))


legend <- ggarrange(circle_legend,scenario_legend,
                    nrow = 1,
                    ncol=2,
                    widths=c(1,0.9),
                    align = "hv")+
  ggsave("legend2.tiff", device = "tiff", dpi=300, width=13, height=1.3, units = "cm")

 
    #PUT RADARS AND BAR PLOTS TOGETHER



ggarrange(algae_total, bacteria_total,yeast_total,
          soy_total, insects_total,legend,
          legend = "none",
          nrow=2, 
          ncol=3,
          labels=c("a", "b", "C", "d", "e", ""),
          font.label = list(size=9),
          align="hv")+
  # annotation_custom(segmentsGrob(x0 = c(0.185,  0.25, 0.35, 0.13, 0.13, 0.05), x1=c(0.25, 0.35, 0.42, 0.13, 0.05, 0.05), 
  #                                y0=c(0.835,0.835, 0.94,  0.73,0.62, 0.45), y1=c(0.835,0.94,0.94,0.62,0.45,0.35), 
  #                                default.units="npc", gp=gpar(col="firebrick", lty=1)))+
  ggsave("Figure 4 - new.tiff", device = "tiff", dpi=600, width=18, height = 12, units="cm" )+
  ggsave("Figure 4 - new.pdf", device = "pdf", dpi=600, width=18, height = 12, units="cm" )





#single row

ggarrange((annotate_figure(ggarrange(algae_total, bacteria_total,yeast_total,
          soy_total, insects_total,
          legend = "none",
          nrow=1, 
          ncol=5,
          labels=c("a", "b", "c", "d", "e"),
          font.label = list(size=9),
          align="hv"),
          left =text_grob(bquote(Forage~fish~savings~(Tx10^6)), size=7, rot=90))),
          scenario_legend,
          nrow=2,
          ncol=1,
          heights = c(5,1.3))+
  annotation_custom(polygonGrob(x=c(0.13, 0.32,0.995,0.995,0.32,0.13), y=c(0.65, 0.75,0.75,0.35, 0.35, 0.45), gp=gpar(col="aliceblue", fill="royalblue",  alpha=0.05)))+ 
  #                                y0=c(0.835,0.835, 0.94,  0.73,0.62, 0.45), y1=c(0.835,0.94,0.94,0.62,0.45,0.35), 
  #                                default.units="npc", gp=gpar(col="firebrick", lty=1)))+
  ggsave("Figure 4 - new 2.tiff", device = "tiff", dpi=600, width=18, height = 6.3, units="cm" )+
  ggsave("Figure 4 - new 2.pdf", device = "pdf", dpi=600, width=18, height = 6.3, units="cm" )



 # demand_savings <- 
 #   ggarrange(
 #    ggarrange(optimal_consumption_plot, development_consumption_plot, #1st row
 #              nrow = 1, 
 #              ncol = 2, 
 #              legend = "none", 
 #              labels = c("a", "b"),
 #              font.label = list(size=8),
 #              label.x = c(0.04, 0.04)),
 #    ggarrange(algae_consumption_plot, bacteria_consumption_plot, yeast_consumption_plot,  soy_consumption_plot, insects_consumption_plot, #2nd row
 #              nrow = 1, ncol = 5, 
 #              labels = c("c", "d", "e", "f", "g"), 
 #              font.label = list(size=8 ),
 #              label.x = c(0.1, -0.05,-0.05,-0.05,-0.05),
 #              label.y = 0.95,
 #              widths = c(1.25,1,1,1,1), 
 #              legend = "none"),
 #    ggarrange(algae_total, bacteria_total, yeast_total, soy_total, insects_total, #3rd row
 #   labels= c("h", "i", "j", "k", "l"),
 #   label.x = c(0.2, 0,0,0,0),
 #   widths = c(1.22,1,1,1,1),
 #   nrow =1, 
 #   ncol=5,
 #   legend = "none",
 #   font.label = list(size=8)),
 #   scenario_legend, # 4th row
 #   ncol=1,
 #   nrow = 4,
 #   heights = c(0.9,0.5,0.5,0.08)) +
 #   ggsave("Figure 4 - Global use and savings.tiff", device = "tiff", dpi=600, width = 18, height = 16, units = "cm")+
 #  ggsave("Figure 4 - Global use and savings.pdf", device = "pdf", dpi=600, width = 18, height = 16, units = "cm")
 # 
 # 

insects_total+
  facet_zoom(y= Mean_savings =c(0,4.5e+6))
```


#SENSITIVITY OF FCRs versus FISHMEAL AND OIL INCLUSION

```{r}

#FCR
a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Taxa"]]]] 
    
    #different  parameters FCR change
    b <- runif(n = 1, min = a[["FCR_min"]], max = a[["FCR_max"]])  # assign random fcr from group range
    c <- a[["FM_min"]]   # assign minimum fishmeal inclusion 
    d <- a[["FO_min"]]   #assign minimum fish oil inclusion from range
    e <- a[["Fed_min"]]   #assign random fed proportion from 2015 -2025 range
    
    # #Consumption parameters FMFO change
    # 
    # bb <- a[["FCR_min"]]  # assign minimum fcr from group range
    # cc <- runif(n = 1, min = a[["FM_min"]], max = a[["FM_max"]])   # assign random fishmeal inclusion from range 
    # dd <- runif(n = 1, min = a[["FO_min"]], max = a[["FO_max"]])   #assign random fish oil inclusion from range
    # ee <- a[["Fed_min"]]    #assign minimum fed proportion from 2015 -2025 range
    
    # #Consumption parameters fed proportions change
    # 
    # bbb <- mean(c(a[["FCR_min"]], a[["FCR_max"]]))  # assign random fcr from group range
    # ccc <- mean(c(a[["FM_min"]], a[["FM_max"]]))   # assign random fishmeal inclusion from range 
    # ddd <- mean(c(a[["FO_min"]],  a[["FO_max"]]))  #assign random fish oil inclusion from range
    # eee <- runif(n=1, min = a[["Fed_min"]], max= a[["Fed_max"]])    #assign random fed proportion from 2015 -2025 range
    
    
    #Consumption calculations for FCR change
    g <- target_row[["Value"]]*b*c*e    #fm demand
    h <- g/0.225       # forage fish biomass needed for fm demand
    i <- target_row[["Value"]]*b*d*e    #fo demand
    j <- h*0.05   # amount of fish oil coming from the fm biomass
    k <- (i-j)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    l <-  case_when(i<j ~ h-(j-i),
                    T ~ h+k) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
                   
    #  #Consumption calculations for FMFO change
    # m <- target_row[["Value"]]*bb*cc*ee    #fm demand
    # n <- m/0.225       # forage fish biomass needed for fm demand
    # o <- target_row[["Value"]]*bb*dd*ee    #fo demand
    # p <- n*0.05   # amount of fish oil coming from the fm biomass
    # q <- (o-p)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    # r <-  case_when(o<p ~ n-(p-o),
    #                 TRUE ~ n+q) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
    
    
    #   #Consumption calculations for fed prop change
    # s <- target_row[["Value"]]*bbb*ccc*eee    #fm demand
    # t <- s/0.225       # forage fish biomass needed for fm demand
    # u <- target_row[["Value"]]*bbb*ddd*eee    #fo demand
    # v <- t*0.05   # amount of fish oil coming from the fm biomass
    # w <- (u-v)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    # x <-  case_when(u<v ~ t-(v-u),
    #                 TRUE ~ t+w) 
    # 
    # 
    
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        
        #FCR change
        fm_demand_FCR = g, 
        fm_biomass_FCR = h,
        fo_demand_FCR = i,
        fo_from_fm_FCR = j, 
        surplus_FCR = k,
        consumption_FCR = l,
        Element="FCR"
        
        # #FMFO change
        # fm_demand_FMFO = m, 
        # fm_biomass_FMFO = n,
        # fo_demand_FMFO = o,
        # from_fm_FMFO = p, 
        # surplus_FMFO = q,
        # consumption_FMFO = r
        
        # #Fed prop change
        # fm_demand_FED = s, 
        # fm_biomass_FED = t,
        # fo_demand_FED = u,
        # fo_from_fm_FED = v, 
        # surplus_FED = w,
        # consumption_FED = x
        
        
        ))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows

write_csv(a_test, "consumption sensitivity analysis - FCR.csv")


  
a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Taxa"]]]] 
    
    
    # #Consumption parameters FMFO change
    # 
    bb <- a[["FCR_min"]]  # assign minimum fcr from group range
    cc <- runif(n = 1, min = a[["FM_min"]], max = a[["FM_max"]])   # assign random fishmeal inclusion from range
    dd <- runif(n = 1, min = a[["FO_min"]], max = a[["FO_max"]])   #assign random fish oil inclusion from range
    ee <- a[["Fed_min"]]    #assign minimum fed proportion from 2015 -2025 range
    
                   
    #  #Consumption calculations for FMFO change
    m <- target_row[["Value"]]*bb*cc*ee    #fm demand
    n <- m/0.225       # forage fish biomass needed for fm demand
    o <- target_row[["Value"]]*bb*dd*ee    #fo demand
    p <- n*0.05   # amount of fish oil coming from the fm biomass
    q <- (o-p)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass
    r <-  case_when(o<p ~ n-(p-o),
                    TRUE ~ n+q) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
    
    
    
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        
      
        
        #FMFO change
        fm_demand_FMFO = m,
        fm_biomass_FMFO = n,
        fo_demand_FMFO = o,
        from_fm_FMFO = p,
        surplus_FMFO = q,
        consumption_FMFO = r,
        Element="FMFO"
        
      
        
        
        ))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows

write_csv(a_test, "consumption sensitivity analysis - FMFO.csv")

 


a_test <- bind_rows(lapply(1:dim(na.exclude(fed_aqua_proj))[1], function(target_row_id){
  target_row <- na.exclude(fed_aqua_proj)[target_row_id,]
  temp_df <- bind_rows(lapply(1:500, function(rep_id){
    #isolate each row 
    a <- feeds_as_list[[target_row[["Taxa"]]]] 
    
    #different  parameters fed prop change
    b <- a[["FCR_min"]]  # assign random fcr from group range
    c <- a[["FM_min"]]   # assign minimum fishmeal inclusion 
    d <- a[["FO_min"]]   #assign minimum fish oil inclusion from range
    e <- runif(n = 1, min = a[["Fed_min"]], max = a[["Fed_max"]])  #assign random fed proportion from 2015 -2025 range
    
    
    #Consumption calculations for Fed prop change
    g <- target_row[["Value"]]*b*c*e    #fm demand
    h <- g/0.225       # forage fish biomass needed for fm demand
    i <- target_row[["Value"]]*b*d*e    #fo demand
    j <- h*0.05   # amount of fish oil coming from the fm biomass
    k <- (i-j)/0.05 # difference in the amount of fish oil still needed (surplus) converted into forage fish biomass 
    l <-  case_when(i<j ~ h-(j-i),
                    T ~ h+k) #total forage fish required - so when fo demand is less than that produced from fishmeal consumed, the total forage fish equivalents are discounted by the weight of fish oil available for other uses (i.e. traded). If they are greater then exact forage fish equivalents of the extra fish needed are added to that needed to fulfill FM demand.
   
    
    #bind new objects to end of target row
    rep_id_row_as_df <- data.frame(
      c(target_row, 
        rep_id=rep_id,
        
        
        #FCR change
        fm_demand_Fed = g, 
        fm_biomass_Fed = h,
        fo_demand_Fed = i,
        fo_from_fm_Fed = j, 
        surplus_Fed = k,
        consumption_fed = l,
        Element="Fed"
        
        ))
    return(rep_id_row_as_df)
  })) #close lapply function, lapply call, and bind_rows
  return(temp_df)
}))#close lapply function, lapply call, and bind_rows

write_csv(a_test, "consumption sensitivity analysis - FED.csv")




```

#sensitivity of FCR vs FMFO for forage fish demand
```{r}

fcr_sens <-  read_csv("consumption sensitivity analysis - FCR.csv") 
fmfo_sens <-  read_csv("consumption sensitivity analysis - FMFO.csv")
fed_sens <-  read_csv("consumption sensitivity analysis - FED.csv")

bind_rows(
fcr_sens %>% 
  select(Country, Species, Taxa_adj, rep_id, consumption_FCR) %>% 
  group_by(rep_id) %>% 
  summarise(consumption_rep= sum(consumption_FCR)) %>% 
  summarise(consumption = mean(consumption_rep), sd=sd(consumption_rep)) %>% 
  mutate(Element = "FCR change"),

fmfo_sens %>% 
  select(Country, Species, Taxa_adj, rep_id, consumption_FMFO) %>% 
  group_by(rep_id) %>% 
  summarise(consumption_rep= sum(consumption_FMFO)) %>% 
  summarise(consumption = mean(consumption_rep), sd=sd(consumption_rep)) %>% 
  mutate(Element = "FMFO change"),

fed_sens %>% 
  select(Country, Species, Taxa_adj, rep_id, consumption_fed) %>% 
  group_by(rep_id) %>% 
  summarise(consumption_rep= sum(consumption_fed)) %>% 
  summarise(consumption = mean(consumption_rep), sd=sd(consumption_rep)) %>% 
  mutate(Element = "Fed prop. change")
) %>% 
  ggplot(aes(x=Element, y=consumption))+
  geom_bar(stat = "identity", width=0.6, fill="dodgerblue")+
  geom_errorbar(aes(ymin=consumption-sd, ymax=consumption+sd), width=0.2)+
  theme_pubr() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))+
  labs(y="Forage fish demand, 2015 (million tonnes)", x="")+
  scale_y_continuous(breaks = c(0,5e+6, 10e+6, 15e+6), labels = c(0, 5, 10, 15))+
  ggsave("FCR_FED_FMFO_sensitivity.tiff", dpi=300, width = 10, height = 12, units = "cm")
  





```





#Old Fig 1 - Against Historical supply of forage fish and use of fish in feed 

```{r}



#feed supply data from FAOSTAT
feed_fish <- read_csv("forage_feed.csv")

feed_use <- feed_fish %>%
  filter(Item=="Pelagic Fish") %>% 
  group_by(Year) %>%
  summarise(Value = sum(Value)*1000) %>% 
  mutate(Element = "Total animal feed use")
  


#forage fish species used in Froehlich et al

feed_spp <- c("Engraulis ringens",  "Clupea harengus", "Engraulis japonicus", "Decapterus", "Decapterus macrosoma" ,"Decapterus maruadsi" , "Decapterus russelli",  "Sardina pilchardus", "Mallotus villosus",   "Sardinella",  "Mallotus villosus", "Brevoortia patronus", "Engraulis encrasicolus", "Cololabis saira", "Clupea pallasii pallasii", "Trachurus murphyi", "Larimichthys polyactis", "Clupeidae", "Sprattus sprattus", "Sardinops sagax", "Trachurus", "Trachurus trecae" , "Trachurus capensis","Trachurus lathami", "Trachurus declivis", "Trachurus trachurus", "Trachurus murphyi" , "Trachurus mediterraneus", "Trachurus symmetricus","Trachurus japonicus", "Trachurus picturatus") 


#Sort the symbols in values out
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information


##IF USING FAO PRODUCTION DATA - Feed use of pelagic fish is greater than production!

#Capture production
forage_fish <-
  fread("Marine fisheries Production 1950-2014.csv", header=T) %>% 
  filter(TaxonName %in% feed_spp) %>% 
  select(CountryName, Year, TaxonName, Value) %>% 
  group_by(Year) %>% 
  summarise(Value=sum(Value)) %>% 
  mutate(Element="Historical supply")

#Management into legend
management <- 
  data_frame(Year= NA, Vaue = NA, Element="Proposed EBFM supply")


#fishmeal use in aquaculture

fishmeal_prop <- 
  data_frame(Year=c(1960,1980,2010), Prop=c(0.04, 0.1,0.73))


fishmeal_aqua <- 
  data_frame(Year=seq(1961,2013)) %>% 
  mutate(Prop = case_when(Year==1961 ~0.04,
                          Year==1980~0.1,
                          Year==2010~0.73))
  
  
predictions <- predict(lm(Prop~Year, data=fishmeal_aqua), newdata = data_frame(Year=seq(1961,2013)))+0.08

fishmeal_aqua <- 
  fishmeal_aqua %>% 
  select(Year) %>% 
  mutate(Value=feed_use$Value*predictions) %>% 
  mutate(Element="Aquaculture use")
  








mean(feed_fish$Value[feed_fish$Year>1979])
  

  # 
  # rename(Country=`Country (Country)`,
  #        Species = `Species (ASFIS species)`,
  #        Area = `Fishing area (FAO major fishing area)`,
  #        Measure = `Measure (Measure)`) %>%
  # gather(key="Year", value="Value", -c(Country, Species, Area, Measure)) %>%
  # mutate(Year = gsub("X", "", Year) %>%
  #          as.numeric) %>%
  # mutate(Value = case_when(Value=="0 0" ~ "0.5",
  #                          Value=="-" ~ "0",
  #                          T ~ Value)) %>%
  # filter(!(Value=="..." | Value=="") | Country=="Totals") %>%
  # mutate(Value = gsub(" F", "", Value) %>%
  #          as.numeric) %>%
  # filter(Species %in% feed_spp) %>%
  # group_by(Year) %>%
  # summarise(Value=sum(Value)) %>%
  # mutate(Element = "Forage fish supply")


(supply_demand <- 
  bind_rows(forage_fish, feed_use, fishmeal_aqua, management) %>% 
    mutate(Element = factor(Element, levels=c("Historical supply", "Proposed EBFM supply","Total animal feed use", "Aquaculture use"))) %>% 
  ggplot(aes(x=Year, y=Value, colour=Element, linetype=Element))+geom_line()+
  scale_linetype_manual(values=c(1,2,1,1))+
  scale_colour_manual(values=c("black", "black", "grey50", "dodgerblue"))+
  scale_y_continuous(limits=c(0,4.2e+7), labels=c(0,10,20,30,40), expand=c(0,0))+
  theme_pubr()+
  geom_vline(xintercept=2015, linetype=2, colour="grey80", alpha=0)+
  theme(
    #text=element_text(5),
    legend.title = element_blank(),
    legend.background=element_blank(),
    legend.position = c(0.25,0.85),
    legend.text = element_text(size=6),
    legend.key.size = unit(0.5, "cm"),
    plot.margin = unit(c(0.5,-.2, 0.2,0.2), "cm"),
    axis.text.x = element_text(size=8),
    axis.title.x = element_text(size=9, hjust = 0.9, margin = margin(t =10, r = 0, b = 0, l = 0)),
    axis.text.y = element_text(size=8),
    axis.title.y = element_text(size=9)
    )+
labs(y=bquote(Forage~fish~biomass~(Tx10^6)))+
ggsave("total forage fish landings plot2.tiff", device="tiff", dpi=600, width = 8, height=7, units = "cm")
  )





(total_consumption <- 
  bind_rows(
  
  ff_2015 <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, consumption_2015) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(consumption_2015)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2015"),

ff_2030_fao <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, fao_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(fao_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nBAU"),

ff_2030_WB1 <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_RG_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_RG_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nRap.Gr."),
  

ff_2030_WB2 <- 
  fread("forage fish consumption.csv", header=T) %>% 
  select(Country, Species, Taxa_adj, rep_id, WB_CD_consumption) %>% 
  group_by(rep_id) %>% 
  summarise(Rep_Value = sum(WB_CD_consumption)) %>% 
  summarise(Value = mean(Rep_Value), sd=sd(Rep_Value)) %>% 
  mutate(Element = "2030\nCon.Shft")
) %>% 
    mutate(Element = factor(Element, levels= c("2015", "2030\nBAU", "2030\nRap.Gr.", "2030\nCon.Shft")))
    
)


# #brackets grob for barplot

bracket <- bracketsGrob(0.15, 0.92,  0.85, 0.92 , h=0.04, col="grey40")

consumption <- 
  ggplot(data=total_consumption, aes(x=Element, y=Value, fill=Element))+
  geom_segment(x=1, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979]), yend=mean(forage_fish$Value[forage_fish$Year>1979]), linetype=1)+
  geom_segment(x=1, xend=Inf, y=mean(forage_fish$Value[forage_fish$Year>1979])*0.8, yend=mean(forage_fish$Value[forage_fish$Year>1979])*0.8, linetype=2)+

  #geom_segment(x=1, xend=Inf, y=mean(feed_use$Value[feed_use$Year>1979]), yend=mean(feed_use$Value[feed_use$Year>1979]), colour="grey30", linetype=2)+
  geom_bar(stat="identity", width=.4)+
  geom_errorbar(aes(ymin=Value-sd, ymax=Value+sd), width=.2)+
  scale_fill_manual(values = rev(lacroix_palette("PassionFruit", n=4, "continuous")))+
  scale_y_continuous(limits=c(0,44e+6), expand = c(0,0))+
  theme_pubr()+
  theme(axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size=8),
        axis.title.x = element_text(size=9, hjust=.64, margin = margin(t = 1.4, r = 0, b = 0, l = 0)),
        panel.background =  element_blank(),
        plot.margin = unit(c(0.5,.2, 0.2,-1.45), "cm"))+
  #guides(fill=F)+
  labs(x="", fill="Growth scenario")+
  annotation_custom(bracket)+
  annotate("text", x=2.5, y=43.5e+6, label="Demand from aquaculture", size=2.8)



# grid.locator(unit = "native")
#   
#  
# $x
# [1] 369native
# 
# $y
# [1] 315native  
#    
#   
# $x
# [1] 147native
# 
# $y
# [1] 315native  

#ggarrange(production_scenarios,
  ggarrange(supply_demand, consumption, widths = c(1,0.61), 
            nrow=1, 
            ncol=2, 
            # labels=c("e", ""),
            # label.x = 0.18,
            font.label = list(size=10))+#,
  # annotate("text", x=.665,y=.725, label="Average supply 1980-2013", size=2.5)+
  # annotate("text", x=.58,y=.53, label="Average feed usage 1980-2013", size=2.5, col= "black", hjust=0),
  # nrow=2, ncol=1,
  # heights = c(0.65,1))+

  ggsave("Figure 1 new2.tiff", device="tiff", dpi=600, width = 18, height=12, units = "cm")+
  ggsave("Figure 1 new2.pdf", device="pdf", dpi=600, width = 18, height=12, units = "cm")



#grid.brackets(220, bottom_y,   80, bottom_y, lwd=2, col="red")



ggplot(data = forage_fish, aes(x=Year, y=Value))+
  geom_line(colour="firebrick", linetype=1)+
  geom_line(data = feed_fish, aes(x=Year, y=Value), colour="black", linetype=1)+
  #annotate("segment", x=2000, xend = 2015, y=mean(forage_fish$Value[forage_fish$Year>1999]), yend = mean(forage_fish$Value[forage_fish$Year>1999]), colour="firebrick", linetype=2)+
  #annotate("segment", x=2000, xend = 2015, y=mean(feed_fish$Value[feed_fish$Year>2010])*0.75, yend = mean(feed_fish$Value[feed_fish$Year>2010])*0.75, colour="black", linetype=2)+
  # scale_x_continuous(limits=c(1960,2016), breaks = c(1985, 2015), labels = c(1985, 2015))+
  # scale_y_continuous(limits = c(0,4e+07), labels = c(0,40), breaks = c(0,  4e+07))+
  labs(x=bquote(Year), y=bquote(Biomass~(T~x10^6)))+
  theme_pubr()+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=10),
        axis.title = element_text(size=10))+
  #annotate("text", x=1983, y=5e+06, label="c", size=11)+
  ggsave("total forage fish landings plot.tiff", device="tiff", dpi=600, width = 11, height=9, units = "cm")


```







#Supplmentary  - Production scenarios 
```{r}

prod_2015 <-  
  prod.aqua %>% 
  filter(Year==2015) %>% 
  group_by(Taxa_adj) %>% 
  summarise(Value=sum(Value))%>% 
  ggplot(aes(x= reorder(Taxa_adj, Value), y=(Value)))+
  geom_point(stat = "identity", colour = "#172869", size=1.9)+
  geom_segment(aes(y = 0, 
                   x = Taxa_adj, 
                   yend = Value, 
                   xend = Taxa_adj),
               colour= "#172869",
               size=.7)+
  #geom_text(colour="white", size=2)+
  scale_y_continuous(breaks = c(0,1e+7,2e+7,3e+7), labels = c(0,10,20,30), limits=c(0,3e+7))+
  coord_flip()+
  theme_pubr()+
  theme(panel.grid.minor  = element_blank(),
        #panel.grid.major.y = element_blank(),
        text = element_text(size=8),
        axis.title = element_blank(),
        plot.title = element_text(hjust=.5))+
  labs(title="2015")+
  ggsave("2015production.tiff", device="tiff", dpi=600, width=6, height=7, units = "cm")





#Fig 1 - FAO 2030 


#FAO projections based off development levels

MEDCs <- c("Canada", "United States of America", "Austria", "Belgium", "Denmark", "Finland", "France", "Germany", "Greece", "Ireland", "Italy", "Luxembourg", "Netherlands", "Portugal",  "Spain", "Sweden", "United Kingdom", "Bulgaria", "Croatia", "Cyprus","Czechia", "Estonia", "Hungary", "Latvia", "Lithuania", "Malta", "Poland", "Romania", "Slovakia", "Slovenia", "Iceland","Norway", "Switzerland", "Australia", "Japan", "New Zealand")

LDCs<- c("Angola", "Benin", "Burkina Faso" ,"Burundi","Central African Republic", "Chad", "Comoros", "Congo, Dem. Rep. of the",  "Djibouti", "Eritrea", "Ethiopia", "Gambia" , "Guinea", "Guinea-Bissau", "Lesotho", "Liberia", "Madagascar", "Malawi", "Mali", "Mauritania", "Mozambique", "Niger", "Rwanda", "Sao Tome and Principe", "Senegal", "Sierra Leone", "Somalia", "South Sudan", "Sudan", "Togo", "Uganda", "Tanzania, United Rep. of", "Zambia", "Cambodia", "Kiribati", "Lao People's Dem. Rep.", "Myanmar", "Solomon Islands", "Timor Leste", "Tuvalu", "Vanuatu", "Afghanistan", "Bangladesh", "Bhutan", "Nepal", "Yemen", "Haiti")


#37% increase overall and in developing countries, 28% in medcs, and 46% in least developed nations (SOFIA 2018)

prod.aqua.fao2030 <- 
  prod.aqua %>% 
  filter(Year==2015) %>% 
  group_by(Country, Taxa_adj) %>%
  summarise(Value=sum(Value))%>%
  mutate(Value = case_when(Country %in% MEDCs ~ Value*1.281,
                           Country %in% LDCs ~ Value*1.463,
                           T ~Value*1.37)) %>% 
  group_by(Taxa_adj) %>% 
  summarise(Value=sum(Value)) %>%
  arrange(Value) %>%
  mutate(Taxa_adj = factor(Taxa_adj, levels = unique(Taxa_adj)))%>%#[c(4,9,1,3,7,2,6,8,10,5,11,12)])) %>% 
  ggplot( aes(x=Taxa_adj, y=(Value)))+
  geom_point(stat = "identity", colour = "#359DA9", size=1.9)+
  geom_segment(aes(y = 0, 
                   x = Taxa_adj, 
                   yend = Value, 
                   xend = Taxa_adj),
               colour= "#359DA9",
               size=.7)+
  coord_flip()+
  scale_y_continuous(breaks = c(0,1e+7,2e+7,3e+7), labels = c(0,10,20,30), limits=c(0,3e+7))+
  theme_pubr()+
  theme(panel.grid.minor  = element_blank(),
        #panel.grid.major.y = element_blank(),
        axis.title = element_blank(),
        axis.text.y = element_blank(),
        text = element_text(size=8),
        plot.title = element_text(hjust=.5))+
  labs(title="2030 BAU")+
  ggsave("2030_fao_production.tiff", device="tiff", dpi=600, width=6, height=7, units = "cm")



prod.aqua
prod.aqua %>% 
  filter(Year==2015) %>% 
  group_by(Taxa_adj) %>% 
  summarise(Value=sum(Value))



#Two world bank scenarios based off fish to 2030



#Fig 1 - World Bank Production scenario of rapid growth 


#50% faster than baseline scenario 

prod.aqua.wb_rg_2030 <- 
  prod.aqua %>% 
  filter(Year==2015) %>% 
  group_by(Country, Taxa_adj) %>%
  summarise(Value=sum(Value))%>%
  mutate(Value = case_when(Country %in% MEDCs ~ Value*1.42,
                           Country %in% LDCs ~ Value*1.69,
                           T ~Value*1.56)) %>% 
  group_by(Taxa_adj) %>% 
  summarise(Value=sum(Value)) %>%
  arrange(Value) %>%
  mutate(Taxa_adj = factor(Taxa_adj, levels = unique(Taxa_adj)))%>%#[c(4,9,1,3,7,2,6,8,10,5,11,12)])) %>% 
  ggplot( aes(x=Taxa_adj, y=(Value)))+
  geom_point(stat = "identity", colour = "#C2B72B", size=1.9)+
  geom_segment(aes(y = 0, 
                   x = Taxa_adj, 
                   yend = Value, 
                   xend = Taxa_adj),
               colour= "#C2B72B",
               size=.7)+
  coord_flip()+
  scale_y_continuous(breaks = c(0,1e+7,2e+7,3e+7), labels = c(0,10,20,30), limits=c(0,3e+7))+
  theme_pubr()+
  theme(panel.grid.minor  = element_blank(),
        #panel.grid.major.y = element_blank(),
        axis.title = element_blank(),
        axis.text.y = element_blank(),
        text = element_text(size=8),
        plot.title = element_text(hjust=.5))+
  labs(title="2030 Rap.Gr")+

  
  ggsave("2030_wb_rg_production.tiff", device="tiff", dpi=600, width=6, height=7, units = "cm")






#Fig 1 - Chinese consumer demand World Bank Scenario


#Salmonids shrimps crustaceans and tunas 3 times faster than fao sceanrio - all else at fao 


prod.aqua.wb_cd_2030 <- 
  prod.aqua %>% 
  filter(Year==2015) %>% 
  group_by(Country, Taxa_adj) %>%
  summarise(Value=sum(Value))%>%
  mutate(Value = case_when(Country %in% MEDCs ~ Value*1.281,
                           Country %in% LDCs ~ Value*1.463,
                           T ~Value*1.37)) %>%
  mutate(Value = case_when(Taxa_adj %in% c("Shrimps", "Salmonids", "FW crustaceans","Marine crustaceans", "Tunas") ~ Value*3,
                           T ~ Value)) %>% 
  group_by(Taxa_adj) %>% 
  summarise(Value=sum(Value)) %>%
  mutate(Taxa_adj = factor(Taxa_adj, levels = c("Tunas", "Eels","Marine crustaceans", "Diadromous fishes", "FW crustaceans", "Marine fishes","Salmonids", "FW fishes", "Catfishes", "Shrimps", "Tilapias",  "Carps" ))) %>% 
  ggplot( aes(x=Taxa_adj, y=(Value)))+
  geom_point(stat = "identity", colour = "#C70E7B", size=1.9)+
  geom_segment(aes(y = 0, 
                   x = Taxa_adj, 
                   yend = Value, 
                   xend = Taxa_adj),
               colour= "#C70E7B",
               size=.7)+
  coord_flip()+
  scale_y_continuous(breaks = c(0,1e+7,2e+7,3e+7), labels = c(0,10,20,30), limits=c(0,3e+7))+
  theme_pubr()+
  theme(panel.grid.minor  = element_blank(),
        #panel.grid.major.y = element_blank(),
        axis.title = element_blank(),
        axis.text.y = element_blank(),
        text = element_text(size=8),
        plot.title = element_text(hjust=.5))+
  labs(title="2030 Cons.Shft")+

  ggsave("2030_wb_cd_production.tiff", device="tiff", dpi=600, width=6, height=7, units = "cm")
unique(prod.aqua$Taxa_adj)[c(4,9,1,3,7,2,6,8,10,5,11,12)]


#Combine fig 1 plots for production


production_scenarios <- 
  annotate_figure(
    ggarrange(prod_2015, 
              prod.aqua.fao2030, prod.aqua.wb_rg_2030,prod.aqua.wb_cd_2030, 
              labels = c("a", "b", "c", "d"), 
              nrow=1, ncol=4, 
              font.label = list(size=10), 
              widths = c(1.65,1,1,1), 
              label.x = c(.35,-.05,-.05,-.05)),
    
    bottom = text_grob("Production (million tonnes)", size=8, hjust=.5, vjust = 0.1)
  )+
  ggsave("Production_Scenarios.tiff", device="tiff", dpi=600, width = 18, height=7, units="cm")


```



#Supplementary  - Consumption scenarios 

```{r}


ff_consumption <- 
  fread("forage fish consumption.csv", header=T) 




#####2015 Scenario####

(consumption_2015 <- 
   #by taxa for 2015
   ff_consumption %>%  
   select(Country, Species, Taxa_adj, rep_id, Value, consumption_2015) %>% 
   group_by(Taxa_adj, rep_id) %>% 
   summarise(Consumption_taxa = sum(consumption_2015))%>% 
   group_by(Taxa_adj) %>% 
   summarise(Mean = mean(Consumption_taxa), sd = sd(Consumption_taxa), Scenario = "2015" )%>% 
   mutate(Taxa_adj = factor(Taxa_adj, levels = c("Tunas", "Eels","Marine crustaceans", "Diadromous fishes", "FW crustaceans", "Marine fishes","Salmonids", "FW fishes", "Catfishes", "Shrimps", "Tilapias",  "Carps"))) %>% 
   ggplot(aes(x=Taxa_adj, Mean))+
   geom_bar(stat="identity", fill="#172869", width = 0.7)+
   geom_errorbar(aes(ymin=Mean-sd, 
                     ymax=Mean+sd), 
                 width=0.2, size=.3)+
   scale_y_continuous(breaks = c(0,.5e+7,1e+7, 1.5e+7, 2e+7), labels = c(0,5,10,15, 20), limits=c(0,2e+7))+
   theme_pubr()+
   coord_flip()+
   theme(
     text = element_text(size=8),
     axis.title = element_blank()
   ))


#   )
# bind_rows(
   #   #total for 2015
   #   ff_consumption %>%  
   #     select(Country, Species, Taxa_adj, rep_id, Value, consumption_2015) %>% 
   #     group_by(rep_id) %>% 
   #     summarise(Consumption_taxa = sum(consumption_2015))%>% 
   #     summarise(Taxa_adj = "Total", Mean = mean(Consumption_taxa), sd = sd(Consumption_taxa), Scenario = "2015" ),     
   
    
    
    
#####FAO_2030 scenario#####

(consumption_FAO_2030 <- 
   ff_consumption %>%  
   select(Country, Species, Taxa_adj, rep_id, Value, fao_consumption) %>% 
   group_by(Taxa_adj, rep_id) %>% 
   summarise(Consumption_taxa = sum(fao_consumption))%>% 
   group_by(Taxa_adj) %>% 
   summarise(Mean = mean(Consumption_taxa), sd = sd(Consumption_taxa), Scenario = "FAO_2030") %>% 
   mutate(Taxa_adj = factor(Taxa_adj, levels = c("Tunas", "Eels","Marine crustaceans", "Diadromous fishes", "FW crustaceans", "Marine fishes","Salmonids", "FW fishes", "Catfishes", "Shrimps", "Tilapias",  "Carps" , "Total"))) %>%
   ggplot(aes(x=Taxa_adj, Mean))+
   geom_bar(stat="identity", fill= "#359DA9", width=.7)+
   geom_errorbar(aes(ymin=Mean-sd, 
                     ymax=Mean+sd), 
                 width=0.2, size=.3)+
   scale_y_continuous(breaks = c(0,.5e+7,1e+7, 1.5e+7, 2e+7), labels = c(0,5,10,15, 20), limits=c(0,2e+7))+
   theme_pubr()+
   coord_flip()+
   theme(
     text = element_text(size=8),
     axis.text.y = element_blank(),
     axis.title = element_blank()
   )
)
   # bind_rows(
   #   #total for FAO_2030
   #   ff_consumption %>%  
   #     select(Country, Species, Taxa_adj, rep_id, Value, fao_consumption) %>% 
   #     group_by(rep_id) %>% 
   #     summarise(Consumption_taxa = sum(fao_consumption))%>% 
   #     summarise(Taxa_adj = "Total", Mean = mean(Consumption_taxa), sd = sd(Consumption_taxa), Scenario = "FAO_2030" ), 
   #by taxa for FAO_2030
   
#   )
    
    



 #####WorldBank_RG_2030 Scenario#####


(consumption_WB_RG_2030 <- 
   #by taxa for World bank rg 2030
   ff_consumption %>%  
   select(Country, Species, Taxa_adj, rep_id, Value, WB_RG_consumption) %>% 
   group_by(Taxa_adj, rep_id) %>% 
   summarise(Consumption_taxa = sum(WB_RG_consumption))%>% 
   group_by(Taxa_adj) %>% 
   summarise(Mean = mean(Consumption_taxa), sd = sd(Consumption_taxa), Scenario = "WorldBank_RG_2030")%>% 
  mutate(Taxa_adj = factor(Taxa_adj, levels = c("Tunas", "Eels","Marine crustaceans", "Diadromous fishes", "FW crustaceans", "Marine fishes","Salmonids", "FW fishes", "Catfishes", "Shrimps", "Tilapias",  "Carps" , "Total"))) %>% 
  ggplot(aes(x=Taxa_adj, Mean))+
  geom_bar(stat="identity", fill= "#C2B72B", width=.7)+
  geom_errorbar(aes(ymin=Mean-sd, 
                    ymax=Mean+sd), 
                width=0.2, size=.3)+
  scale_y_continuous(breaks = c(0,.5e+7,1e+7, 1.5e+7, 2e+7), labels = c(0,5,10,15, 20), limits=c(0,2e+7))+
  theme_pubr()+
  coord_flip()+
  theme(
    text = element_text(size=8),
    axis.text.y = element_blank(),
    axis.title = element_blank()
  ))
#    )
    
# bind_rows(
  #   #total for World bank rg 2030
  #   ff_consumption %>%  
  #     select(Country, Species, Taxa_adj, rep_id, Value, WB_RG_consumption) %>% 
  #     group_by(rep_id) %>% 
  #     summarise(Consumption_taxa = sum(WB_RG_consumption))%>% 
  #     summarise(Taxa_adj = "Total", Mean = mean(Consumption_taxa), sd = sd(Consumption_taxa), Scenario = "WorldBank_RG_2030" ),





#####WorldBank_CD_2030 Scenario#####


(consumption_WB_CD_2030 <-
   #by taxa for World bank rg 2030
   ff_consumption %>%  
   select(Country, Species, Taxa_adj, rep_id, Value, WB_CD_consumption) %>% 
   group_by(Taxa_adj, rep_id) %>% 
   summarise(Consumption_taxa = sum(WB_CD_consumption))%>% 
   group_by(Taxa_adj) %>% 
   summarise(Mean = mean(Consumption_taxa), sd = sd(Consumption_taxa), Scenario = "WorldBank_CD_2030")%>% 
   mutate(Taxa_adj = factor(Taxa_adj, levels = c("Tunas", "Eels","Marine crustaceans", "Diadromous fishes", "FW crustaceans", "Marine fishes","Salmonids", "FW fishes", "Catfishes", "Shrimps", "Tilapias",  "Carps" , "Total"))) %>% 
   ggplot(aes(x=Taxa_adj, Mean))+
   geom_bar(stat="identity", fill= "#C70E7B",width=0.7)+
   geom_errorbar(aes(ymin=Mean-sd, 
                     ymax=Mean+sd), 
                 width=0.2, size=.3)+
   scale_y_continuous(breaks = c(0,.5e+7,1e+7, 1.5e+7, 2e+7), labels = c(0,5,10,15, 20), limits=c(0,2e+7))+
   theme_pubr()+
   coord_flip()+
   theme(
     text = element_text(size=8),
     axis.text.y = element_blank(),
     axis.title = element_blank()
   ))
#)
 # bind_rows(
  #   #total for World bank cd 2030
  #   ff_consumption %>%  
  #     select(Country, Species, Taxa_adj, rep_id, Value, WB_CD_consumption) %>% 
  #     group_by(rep_id) %>% 
  #     summarise(Consumption_taxa = sum(WB_CD_consumption))%>% 
  #     summarise(Taxa_adj = "Total", Mean = mean(Consumption_taxa), sd = sd(Consumption_taxa), Scenario = "WorldBank_CD_2030" ),




consumption_scenarios <- 
  annotate_figure(
    ggarrange(
      consumption_2015, 
      consumption_FAO_2030,
      consumption_WB_RG_2030, 
      consumption_WB_CD_2030,
      labels = c("a", "b", "c", "d"), 
      nrow=1, ncol=4, 
      font.label = list(size=8), 
      widths = c(1.5,1,1,1), 
      label.x = c(.35,-.05,-.05,-.05)),
    
    bottom = text_grob("Forage fish demand (million tonnes)", size=8, hjust=.5, vjust = 0.1)
  )+
  ggsave("Consumption_Scenarios.tiff", device="tiff", dpi=600, width = 18, height=7, units="cm")


```

# Supplementary -  Combining production and consumption
```{r}
ggarrange(production_scenarios, consumption_scenarios, nrow = 2, ncol=1, align = "v")+
  ggsave("Figure S1 - production and consumption.tiff", device="tiff", dpi=600, width = 18, height=14, units="cm")+
  ggsave("Figure S1 - production and consumption.pdf", device="pdf", dpi=600, width = 18, height=14, units="cm")



```














